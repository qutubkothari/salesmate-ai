<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SAK Feature: Email Integration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/features/_shared.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      height: 100%; 
      overflow: hidden;
      background: #f8fafc;
      font-size: 15px;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    .email-item { 
      transition: all 0.2s; 
      border-left: 3px solid transparent;
      background: white;
    }
    .email-item:hover { 
      background: #f1f5f9; 
      border-left-color: #3b82f6;
    }
    .email-item.selected { 
      background: #eff6ff; 
      border-left-color: #3b82f6;
    }
    .badge { 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 12px; 
      font-size: 11px; 
      font-weight: 600;
    }
    .badge-unread { background: #ef4444; color: #fff; }
    .badge-assigned { background: #22c55e; color: #fff; }
    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="bg-white border-b border-gray-200 px-6 py-4">
    <div class="flex items-center gap-3">
      <i class="fas fa-envelope text-blue-600 text-2xl"></i>
      <h1 class="text-2xl font-bold text-gray-800">Email Management</h1>
    </div>
  </div>

  <div class="content-wrapper">
    <!-- Toolbar -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
      <div class="flex flex-wrap items-center gap-3">
        <button id="refreshBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
          <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
        <button id="connectGmailBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">
          <i class="fab fa-google mr-2"></i>Connect Gmail
        </button>
        <button id="syncGmailBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium" disabled>
          <i class="fas fa-cloud-download-alt mr-2"></i>Sync Gmail
        </button>
        <span id="gmailStatus" class="text-sm text-gray-500"></span>
        <button id="deleteSelectedBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium" disabled>
          <i class="fas fa-trash mr-2"></i>Delete (<span id="selectedCount">0</span>)
        </button>
        <select id="assignToSales" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg disabled:opacity-50 font-medium" disabled>
          <option value="">Assign to...</option>
        </select>
        <button id="assignBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium" disabled>
          <i class="fas fa-user-check mr-2"></i>Assign
        </button>
        <div class="ml-auto flex items-center gap-2">
          <input type="text" id="searchEmail" placeholder="Search emails..." class="px-4 py-2 bg-white border border-gray-300 text-gray-700 placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          <select id="filterStatus" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg font-medium">
            <option value="all">All Status</option>
            <option value="unread">Unread</option>
            <option value="assigned">Assigned</option>
            <option value="unassigned">Unassigned</option>
          </select>
        </div>
      </div>
      
      <!-- Gmail Filter Keywords -->
      <div id="gmailFilterSection" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
        <div class="flex items-start gap-3">
          <i class="fas fa-filter text-blue-600 mt-1"></i>
          <div class="flex-1">
            <label class="block text-sm font-semibold text-gray-700 mb-1">
              Gmail Filter Keywords
              <span class="font-normal text-gray-500">(only sync emails matching these keywords)</span>
            </label>
            <div class="flex gap-2">
              <input 
                type="text" 
                id="gmailKeywords" 
                placeholder="e.g. quote, enquiry, price, RFQ, purchase order"
                class="flex-1 px-3 py-2 bg-white border border-gray-300 text-gray-700 placeholder-gray-400 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
              />
              <button id="saveKeywordsBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm whitespace-nowrap">
                <i class="fas fa-save mr-2"></i>Save Keywords
              </button>
            </div>
            <p class="text-xs text-gray-600 mt-1">
              <i class="fas fa-info-circle mr-1"></i>
              Separate keywords with commas. Leave empty to sync all emails.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Email List -->
    <div class="bg-white rounded-lg shadow-sm">
      <!-- Email Header -->
      <div class="p-4 border-b border-gray-200 flex items-center gap-4 bg-gray-50">
        <input type="checkbox" id="selectAll" class="w-5 h-5 rounded border-gray-300" />
        <div class="flex-1 grid grid-cols-12 gap-4 text-sm font-semibold text-gray-700">
          <div class="col-span-1">Status</div>
          <div class="col-span-3">From</div>
          <div class="col-span-4">Subject</div>
          <div class="col-span-2">Assigned To</div>
          <div class="col-span-2">Date</div>
        </div>
      </div>

      <!-- Email Items -->
      <div id="emailList" class="divide-y divide-gray-100">
        <!-- Loading state -->
        <div id="loadingState" class="p-12 text-center text-gray-500">
          <i class="fas fa-spinner fa-spin text-4xl mb-4 text-blue-600"></i>
          <p class="text-lg">Loading emails...</p>
        </div>
        <!-- Empty state (hidden initially) -->
        <div id="emptyState" class="p-12 text-center text-gray-500 hidden">
          <i class="fas fa-inbox text-6xl mb-4 text-gray-300"></i>
          <p class="text-xl font-medium text-gray-700">No emails found</p>
          <p class="text-base mt-2">Configure your email integration to start receiving emails</p>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="mt-6 flex items-center justify-between text-gray-600 bg-white rounded-lg shadow-sm p-4 hidden">
      <div class="font-medium">
        Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalEmails">0</span> emails
      </div>
      <div class="flex items-center gap-3">
        <button id="prevPage" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed font-medium" disabled>
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="font-medium"><span id="currentPage">1</span> / <span id="totalPages">1</span></span>
        <button id="nextPage" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed font-medium" disabled>
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    let selectedEmails = new Set();
    let allEmails = [];
    let salespeople = [];
    let currentPage = 1;
    const itemsPerPage = 20;

    // Get session from localStorage
    function getSession() {
      const sessionStr = localStorage.getItem('dashboardSession');
      if (!sessionStr) return null;
      try {
        return JSON.parse(sessionStr);
      } catch (e) {
        return null;
      }
    }

    // Get token from URL params or session
    function getAuthToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');
      if (tokenFromUrl) return tokenFromUrl;

      const session = getSession();
      // Use tenantId as the auth token since there's no separate token
      return session?.tenantId || '';
    }

    function getTenantId() {
      const urlParams = new URLSearchParams(window.location.search);
      const tenantIdFromUrl = urlParams.get('tenantId');
      if (tenantIdFromUrl) return tenantIdFromUrl;

      const session = getSession();
      return session?.tenantId || session?.tenant_id || '';
    }

    // Initialize
    async function init() {
      await loadSalespeople();
      await loadEmails();
      await loadGmailStatus();
      setupEventListeners();
    }

    async function loadGmailStatus() {
      try {
        const response = await fetch(`/api/email/gmail/status`, {
          headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        });
        const data = await response.json();
        const statusEl = document.getElementById('gmailStatus');
        const syncBtn = document.getElementById('syncGmailBtn');
        const filterSection = document.getElementById('gmailFilterSection');
        const keywordsInput = document.getElementById('gmailKeywords');
        
        if (data?.success && data.connected) {
          statusEl.innerHTML = `<i class="fas fa-check-circle text-green-600 mr-1"></i>Connected: ${data.email || 'Gmail'}`;
          statusEl.className = 'text-sm text-green-600 font-medium';
          syncBtn.disabled = false;
          
          // Show filter section and populate keywords
          filterSection.classList.remove('hidden');
          if (data.filterKeywords) {
            keywordsInput.value = data.filterKeywords;
          }
        } else {
          statusEl.textContent = 'Gmail not connected';
          syncBtn.disabled = true;
          filterSection.classList.add('hidden');
        }
      } catch (_) {
        const statusEl = document.getElementById('gmailStatus');
        if (statusEl) statusEl.textContent = 'Gmail status unavailable';
      }
    }

    async function connectGmail() {
      try {
        const response = await fetch(`/api/email/gmail/connect`, {
          headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        });
        const data = await response.json();
        if (data?.success && data.authUrl) {
          window.open(data.authUrl, '_blank');
        } else {
          alert('Failed to start Gmail connection');
        }
      } catch (e) {
        alert('Failed to start Gmail connection');
      }
    }

    async function syncGmail() {
      try {
        const response = await fetch(`/api/email/gmail/sync`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${getAuthToken()}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ maxResults: 20 })
        });
        const data = await response.json();
        if (data?.success) {
          const message = data.filtered 
            ? `Synced ${data.ingested} filtered email(s) matching your keywords`
            : `Synced ${data.ingested} email(s)`;
          showSuccess(message);
          await loadEmails();
        } else {
          alert(data?.error || 'Failed to sync Gmail');
        }
      } catch (e) {
        console.error('Gmail sync error:', e);
        alert('Failed to sync Gmail');
      }
    }

    async function saveKeywords() {
      try {
        const keywords = document.getElementById('gmailKeywords').value.trim();
        const response = await fetch(`/api/email/gmail/filter-keywords`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${getAuthToken()}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ keywords })
        });
        const data = await response.json();
        if (data?.success) {
          showSuccess(keywords ? 'Filter keywords saved! Gmail will now only sync matching emails.' : 'Filter cleared. Gmail will sync all emails.');
        } else {
          alert('Failed to save keywords');
        }
      } catch (e) {
        console.error('Save keywords error:', e);
        alert('Failed to save keywords');
      }
    }

    async function loadSalespeople() {
      try {
        const tenantId = getTenantId();
        const response = await fetch(`/api/sales-team/${tenantId}`, {
          headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        });
        if (response.ok) {
          const data = await response.json();
          salespeople = data.users || [];
          populateSalesDropdown();
        }
      } catch (error) {
        console.error('Failed to load salespeople:', error);
      }
    }

    function populateSalesDropdown() {
      const select = document.getElementById('assignToSales');
      select.innerHTML = '<option value="">Assign to...</option>';
      salespeople.forEach(person => {
        const option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name;
        select.appendChild(option);
      });
    }

    async function loadEmails() {
      try {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        
        const response = await fetch('/api/email/list', {
           headers: { 
            'Authorization': `Bearer ${getAuthToken()}`,
            'X-Tenant-Id': getTenantId()
           }
        });
        
        if (response.ok) {
          const data = await response.json();
          allEmails = data.emails || [];
          renderEmails();
        } else {
          showError('Failed to load emails');
        }
      } catch (error) {
        console.error('Error loading emails:', error);
        showError('Error loading emails');
      } finally {
        document.getElementById('loadingState').classList.add('hidden');
      }
    }

    function renderEmails() {
      const emailList = document.getElementById('emailList');
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      
      // Clear existing items (except loading/empty states)
      const items = emailList.querySelectorAll('.email-item');
      items.forEach(item => item.remove());
      
      if (allEmails.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      // Apply filters
      const searchTerm = document.getElementById('searchEmail').value.toLowerCase();
      const statusFilter = document.getElementById('filterStatus').value;
      
      let filtered = allEmails.filter(email => {
        const matchesSearch = !searchTerm || 
          (email.sender || '').toLowerCase().includes(searchTerm) ||
          (email.subject || '').toLowerCase().includes(searchTerm);
        
        const matchesStatus = statusFilter === 'all' ||
          (statusFilter === 'unread' && !email.read) ||
          (statusFilter === 'assigned' && email.assigned_to) ||
          (statusFilter === 'unassigned' && !email.assigned_to);
        
        return matchesSearch && matchesStatus;
      });
      
      // Pagination
      const totalPages = Math.ceil(filtered.length / itemsPerPage);
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageEmails = filtered.slice(start, end);
      
      // Render each email
      pageEmails.forEach(email => {
        const item = createEmailItem(email);
        emailList.appendChild(item);
      });
      
      // Update pagination
      updatePagination(filtered.length, totalPages);
    }

    function createEmailItem(email) {
      const div = document.createElement('div');
      div.className = 'email-item p-4 cursor-pointer';
      div.dataset.emailId = email.id;
      
      const assignedPerson = email.assigned_to ? salespeople.find(p => p.id === email.assigned_to) : null;
      
      div.innerHTML = `
        <div class="flex items-center gap-4">
          <input type="checkbox" class="email-checkbox w-5 h-5 rounded border-gray-300" data-email-id="${email.id}" />
          <div class="flex-1 grid grid-cols-12 gap-4 items-center text-base">
            <div class="col-span-1 flex gap-1">
              ${!email.read ? '<span class="badge badge-unread">New</span>' : ''}
              ${email.assigned_to ? '<span class="badge badge-assigned">Assigned</span>' : ''}
            </div>
            <div class="col-span-3 text-gray-800 truncate font-medium">${escapeHtml(email.sender)}</div>
            <div class="col-span-4 text-gray-700 truncate font-medium">${escapeHtml(email.subject)}</div>
            <div class="col-span-2 text-gray-600 truncate">
              ${assignedPerson ? assignedPerson.name : '<span class="text-gray-400">Unassigned</span>'}
            </div>
            <div class="col-span-2 text-gray-500">${formatDate(email.received_at)}</div>
          </div>
        </div>
      `;
      
      return div;
    }

    function setupEventListeners() {
      // Select all checkbox
      document.getElementById('selectAll').addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('.email-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = e.target.checked;
          if (e.target.checked) {
            selectedEmails.add(cb.dataset.emailId);
          } else {
            selectedEmails.delete(cb.dataset.emailId);
          }
        });
        updateToolbarState();
      });
      
      // Email list delegation
      document.getElementById('emailList').addEventListener('change', (e) => {
        if (e.target.classList.contains('email-checkbox')) {
          const emailId = e.target.dataset.emailId;
          if (e.target.checked) {
            selectedEmails.add(emailId);
          } else {
            selectedEmails.delete(emailId);
          }
          updateToolbarState();
        }
      });
      
      // Toolbar buttons
      document.getElementById('refreshBtn').addEventListener('click', loadEmails);
      document.getElementById('connectGmailBtn').addEventListener('click', connectGmail);
      document.getElementById('syncGmailBtn').addEventListener('click', syncGmail);
      document.getElementById('saveKeywordsBtn').addEventListener('click', saveKeywords);
      document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelected);
      document.getElementById('assignBtn').addEventListener('click', assignSelected);
      
      // Filters
      document.getElementById('searchEmail').addEventListener('input', debounce(renderEmails, 300));
      document.getElementById('filterStatus').addEventListener('change', renderEmails);
      
      // Pagination
      document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderEmails();
        }
      });
      document.getElementById('nextPage').addEventListener('click', () => {
        const totalPages = parseInt(document.getElementById('totalPages').textContent);
        if (currentPage < totalPages) {
          currentPage++;
          renderEmails();
        }
      });
    }

    function updateToolbarState() {
      const count = selectedEmails.size;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('deleteSelectedBtn').disabled = count === 0;
      document.getElementById('assignToSales').disabled = count === 0;
      document.getElementById('assignBtn').disabled = count === 0;
    }

    async function deleteSelected() {
      if (selectedEmails.size === 0) return;
      
      if (!confirm(`Delete ${selectedEmails.size} email(s)?`)) return;
      
      try {
        const response = await fetch('/api/email/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
              'Authorization': `Bearer ${getAuthToken()}`,
              'X-Tenant-Id': getTenantId()
          },
          body: JSON.stringify({ ids: Array.from(selectedEmails) })
        });
        
        if (response.ok) {
          showSuccess(`${selectedEmails.size} email(s) deleted`);
          selectedEmails.clear();
          await loadEmails();
        } else {
          showError('Failed to delete emails');
        }
      } catch (error) {
        console.error('Error deleting emails:', error);
        showError('Error deleting emails');
      }
    }

    async function assignSelected() {
      const salesPersonId = document.getElementById('assignToSales').value;
      if (!salesPersonId || selectedEmails.size === 0) return;
      
      try {
        const response = await fetch('/api/email/assign', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
              'Authorization': `Bearer ${getAuthToken()}`,
              'X-Tenant-Id': getTenantId()
          },
          body: JSON.stringify({ 
            emailIds: Array.from(selectedEmails),
            salesPersonId 
          })
        });
        
        if (response.ok) {
          showSuccess(`${selectedEmails.size} email(s) assigned`);
          selectedEmails.clear();
          document.getElementById('assignToSales').value = '';
          await loadEmails();
        } else {
          showError('Failed to assign emails');
        }
      } catch (error) {
        console.error('Error assigning emails:', error);
        showError('Error assigning emails');
      }
    }

    function updatePagination(total, totalPages) {
      if (total === 0) {
        document.getElementById('pagination').classList.add('hidden');
        return;
      }
      
      document.getElementById('pagination').classList.remove('hidden');
      const start = (currentPage - 1) * itemsPerPage + 1;
      const end = Math.min(currentPage * itemsPerPage, total);
      
      document.getElementById('showingFrom').textContent = start;
      document.getElementById('showingTo').textContent = end;
      document.getElementById('totalEmails').textContent = total;
      document.getElementById('currentPage').textContent = currentPage;
      document.getElementById('totalPages').textContent = totalPages;
      
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    // Utilities
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
      
      return date.toLocaleDateString();
    }

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function showSuccess(message) {
      // Simple alert for now - can be replaced with toast notification
      alert(message);
    }

    function showError(message) {
      alert('Error: ' + message);
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
