<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SAK Salesmate Dashboard</title>
    <!-- Updated: Follow-ups tab added - v20251112 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; border: 1px solid rgba(255,255,255,0.1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); border-color: rgba(255,255,255,0.2); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); }
        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        .animate-pulse-soft { animation: pulseSoft 2s infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulseSoft { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .search-input { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.03) 100%); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.06); }
        .tab-active { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.2); }
        .delete-btn { transition: all 0.2s ease; }
        .delete-btn:hover { transform: scale(1.05); }
        .loading-spinner { border: 3px solid rgba(255,255,255,0.25); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .conversation-card { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); }
        .config-card { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); }
        .success-alert { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .error-alert { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        /* Hide scrollbar while maintaining scroll functionality */
        .overflow-x-auto::-webkit-scrollbar { display: none; }
        .overflow-x-auto { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Sidebar Styles */
        .sidebar { 
            width: 280px; 
            transition: width 0.3s ease, transform 0.3s ease; 
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 50;
            overflow-y: auto;
        }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: transparent; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.18); border-radius: 9999px; }
        .sidebar { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.18) transparent; }
        .sidebar.collapsed { width: 80px; }
        .sidebar-header { transition: padding 0.3s ease; }
        .sidebar.collapsed .sidebar-header { padding: 16px 12px; }
        .sidebar.collapsed .sidebar-header .flex { justify-content: center; }
        .sidebar.collapsed .sidebar-text { opacity: 0; width: 0; overflow: hidden; }
        .sidebar-item {
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 10px 14px;
            border-radius: 12px;
            margin: 4px 12px;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            font-weight: 500;
        }
        .sidebar.collapsed .sidebar-item { justify-content: center; padding: 12px; margin: 4px 10px; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .sidebar-item.active { 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        .sidebar-item i { width: 24px; min-width: 24px; text-align: center; font-size: 18px; }
        .sidebar-item span { 
            margin-left: 16px; 
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .sidebar.collapsed .sidebar-item span { opacity: 0; width: 0; overflow: hidden; }
        .main-content { 
            margin-left: 280px; 
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .main-content.expanded { margin-left: 80px; }
        .sidebar-toggle {
            position: fixed;
            top: 24px;
            left: calc(280px - 18px);
            z-index: 51;
            transition: left 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            background: rgba(255,255,255,0.14);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .sidebar-toggle:hover { background: rgba(255,255,255,0.22); }
        .sidebar-toggle.collapsed { left: calc(80px - 18px); }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .sidebar-toggle { left: 16px; }
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
            <div class="text-center glass-effect p-8 rounded-2xl">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h2 class="text-white text-xl font-semibold mb-2">Loading Dashboard</h2>
                <p class="text-white/70">Please wait while we fetch your data...</p>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Sidebar Navigation -->
            <aside id="sidebar" class="sidebar glass-effect">
                <div class="sidebar-header p-6 border-b border-white/20">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <img src="/assets/logo.png" alt="Logo" class="w-6 h-6" />
                        </div>
                        <div class="sidebar-text">
                            <h2 class="text-white font-bold text-lg">Salesmate</h2>
                            <p class="text-white/60 text-xs">Dashboard</p>
                        </div>
                    </div>
                </div>
                
                <nav class="py-4">
                    <!-- Dashboard / Overview - Always visible -->
                    <div class="sidebar-item active" onclick="switchTab('overview')" data-tab="overview">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </div>
                    
                    <!-- Hidden tabs - will be activated based on subscription modules -->
                    <div class="sidebar-item" onclick="switchTab('conversations')" data-tab="conversations" style="display: none;">
                        <i class="fas fa-comments"></i>
                        <span>Conversations</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('orders')" data-tab="orders" style="display: none;">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Orders</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('followups')" data-tab="followups">
                        <i class="fas fa-clock"></i>
                        <span>Follow-ups</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('leads')" data-tab="leads">
                        <i class="fas fa-user-tag"></i>
                        <span>Leads</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('triage')" data-tab="triage">
                        <i class="fas fa-life-ring"></i>
                        <span>Triage</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('team')" data-tab="team">
                        <i class="fas fa-user-friends"></i>
                        <span>Team</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('tasks')" data-tab="tasks">
                        <i class="fas fa-tasks"></i>
                        <span>Tasks</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('calls')" data-tab="calls">
                        <i class="fas fa-phone"></i>
                        <span>Calls</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('products')" data-tab="products">
                        <i class="fas fa-box"></i>
                        <span>Products</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('documents')" data-tab="documents">
                        <i class="fas fa-file-alt"></i>
                        <span>Documents</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('customers')" data-tab="customers">
                        <i class="fas fa-users"></i>
                        <span>Customers</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('emails')" data-tab="emails">
                        <i class="fas fa-envelope"></i>
                        <span>Email Enquiries</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('settings')" data-tab="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('analytics')" data-tab="analytics">
                        <i class="fas fa-chart-bar"></i>
                        <span>Analytics</span>
                    </div>

                    <div class="sidebar-item" onclick="switchTab('reports')" data-tab="reports">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Reports</span>
                    </div>

                    <div class="sidebar-item" onclick="switchTab('activity-feed')" data-tab="activity-feed">
                        <i class="fas fa-stream"></i>
                        <span>Activity Feed</span>
                    </div>

                    <div class="sidebar-item" onclick="switchTab('audit-logs')" data-tab="audit-logs">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Audit Logs</span>
                    </div>
                    
                    <!-- Active tabs - Based on subscription modules -->
                    <div class="sidebar-item" onclick="switchTab('broadcast')" data-tab="broadcast">
                        <i class="fas fa-bullhorn"></i>
                        <span>Broadcast</span>
                    </div>

                    <div class="sidebar-item" onclick="switchTab('templates')" data-tab="templates">
                        <i class="fas fa-message"></i>
                        <span>Templates</span>
                    </div>

                    <div class="sidebar-item" onclick="switchTab('unsubscribed')" data-tab="unsubscribed">
                        <i class="fas fa-user-slash"></i>
                        <span>Unsubscribed</span>
                    </div>
                    <!-- Hidden for now - focusing on broadcast functionality -->
                    <div class="sidebar-item" onclick="switchTab('whatsapp-web')" data-tab="whatsapp-web">
                        <i class="fas fa-qrcode"></i>
                        <span>WhatsApp Web</span>
                    </div>
                    
                    <!-- Hidden tabs -->
                    <div class="sidebar-item" onclick="window.location.href='/discounts.html'" style="display: none;">
                        <i class="fas fa-tags"></i>
                        <span>Discounts</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('website')" data-tab="website">
                        <i class="fas fa-globe"></i>
                        <span>Website Indexing</span>
                    </div>
                </nav>
            </aside>

            <!-- Sidebar Toggle Button -->
            <button id="sidebarToggle" onclick="toggleSidebar()" class="sidebar-toggle text-white transition-all" aria-label="Toggle sidebar" title="Toggle sidebar">
                <i id="sidebarToggleIcon" class="fas fa-angles-left" style="font-size: 14px;"></i>
            </button>

            <!-- Main Content Area -->
            <div id="mainContent" class="main-content">
                <!-- Header -->
                <header class="glass-effect border-b border-white/20 sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div>
                                    <h1 class="text-2xl font-bold text-white" id="businessName">Sales Dashboard</h1>
                                    <p class="text-white/70 text-sm">WhatsApp AI Assistant</p>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <input type="text" id="globalSearch" placeholder="Search conversations, orders..." class="search-input pl-10 pr-4 py-2 rounded-xl border-0 w-64 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>

                                <button onclick="toggleNotifications()" class="glass-effect p-3 rounded-xl text-white hover:bg-white/20 transition-colors relative">
                                    <i class="fas fa-bell"></i>
                                    <span id="notifBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-xs flex items-center justify-center">0</span>
                                </button>

                                <button onclick="handleLogout()" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Notifications Panel -->
                <div id="notificationsPanel" class="hidden fixed top-20 right-6 w-96 max-h-[600px] rounded-2xl shadow-2xl z-40 overflow-hidden bg-slate-900/90 backdrop-blur-xl border border-white/10">
                    <div class="p-4 border-b border-white/10 flex items-center justify-between">
                        <h3 class="text-white font-semibold text-lg"><i class="fas fa-bell mr-2"></i>Notifications</h3>
                        <button onclick="clearAllNotifications()" class="text-white/70 hover:text-white text-sm">Clear All</button>
                    </div>
                    <div id="notificationsList" class="overflow-y-auto max-h-[500px]">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>

                <!-- Stats Overview - Only visible on Dashboard/Overview tab -->
                <section id="statsSection" class="max-w-7xl mx-auto px-6 py-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8" id="statsGrid">
                        <!-- Stats will be dynamically loaded -->
                    </div>
                </section>

                <!-- Tab Content -->
                <main class="max-w-7xl mx-auto px-6 pb-8">
                    <!-- Main dynamic content area -->
                    <div id="tabContent" class="animate-fade-in">
                        <!-- Content loaded dynamically by JavaScript -->
                    </div>

                <!-- FIXED: Customers Tab (separate from tabContent) -->
                <div id="customersTab" class="hidden">
                    <div class="mb-6 flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-white">Customers</h2>
                        <button onclick="switchTab('conversations')" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors">
                            <i class="fas fa-comments mr-2"></i>Recent Conversations
                        </button>
                    </div>
                    <div class="mb-4 flex flex-col md:flex-row md:items-end gap-4">
                        <input id="customerSearchInput" type="text" placeholder="Search by phone, name..." class="search-input px-4 py-2 rounded-xl border w-full md:w-64" />
                        <input id="customerMinSpent" type="number" placeholder="Min Spent" class="search-input px-4 py-2 rounded-xl border w-full md:w-32" />
                        <input id="customerMaxSpent" type="number" placeholder="Max Spent" class="search-input px-4 py-2 rounded-xl border w-full md:w-32" />
                        <input id="customerMinOrderDate" type="date" class="search-input px-4 py-2 rounded-xl border w-full md:w-40" />
                        <input id="customerMaxOrderDate" type="date" class="search-input px-4 py-2 rounded-xl border w-full md:w-40" />
                        <button id="customerSearchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700">Search</button>
                    </div>
                    <div class="overflow-x-auto rounded-xl bg-white/80 shadow-lg">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 font-semibold">Name</th>
                                    <th class="px-4 py-2 font-semibold">Phone</th>
                                    <th class="px-4 py-2 font-semibold">Last Order</th>
                                    <th class="px-4 py-2 font-semibold">Total Spent</th>
                                    <th class="px-4 py-2 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customerListBody">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading customers...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Email Enquiries Tab -->
                <div id="emailsTab" class="hidden">
                    <div class="mb-6 flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-2">Email Enquiries</h2>
                            <p class="text-white/70">Manage incoming emails from Gmail</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="syncGmailEmails()" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Sync Now
                            </button>
                            <button onclick="window.open('/api/email/gmail/auth?key=' + localStorage.getItem('apiKey'), '_blank')" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors">
                                <i class="fas fa-plug mr-2"></i>Connect Gmail
                            </button>
                        </div>
                    </div>

                    <!-- Search and Filters -->
                    <div class="mb-4 glass-effect p-4 rounded-xl">
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <div class="flex-1 relative">
                                <input id="emailSearchInput" type="text" placeholder="Search by sender, subject..." class="search-input px-4 py-2 pl-10 rounded-xl border w-full" />
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <select id="emailFilterRead" class="search-input px-4 py-2 rounded-xl border">
                                <option value="">All Emails</option>
                                <option value="unread">Unread Only</option>
                                <option value="read">Read Only</option>
                            </select>
                            <button id="emailSearchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700">
                                <i class="fas fa-search mr-2"></i>Search
                            </button>
                        </div>
                    </div>

                    <!-- Email List -->
                    <div class="space-y-3" id="emailListContainer">
                        <!-- Loading State -->
                        <div class="glass-effect p-8 rounded-xl text-center">
                            <i class="fas fa-spinner fa-spin text-4xl text-white/50 mb-3"></i>
                            <p class="text-white/70">Loading emails...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="emailPagination" class="mt-6 flex items-center justify-between glass-effect p-4 rounded-xl">
                        <div class="text-white/70 text-sm">
                            Showing <span id="emailShowingStart">0</span>-<span id="emailShowingEnd">0</span> of <span id="emailTotalCount">0</span> emails
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="emailPrevBtn" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="emailNextBtn" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Website Content Tab -->
                <div id="websiteTab" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Stats Cards -->
                        <div class="stat-card p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-white/80 text-sm">Crawled URLs</h3>
                                <i class="fas fa-link text-blue-400"></i>
                            </div>
                            <p id="websiteUrlCount" class="text-3xl font-bold text-white">0</p>
                        </div>
                        <div class="stat-card p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-white/80 text-sm">Content Chunks</h3>
                                <i class="fas fa-cube text-purple-400"></i>
                            </div>
                            <p id="websiteChunkCount" class="text-3xl font-bold text-white">0</p>
                        </div>
                        <div class="stat-card p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-white/80 text-sm">Last Crawl</h3>
                                <i class="fas fa-clock text-green-400"></i>
                            </div>
                            <p id="websiteLastCrawl" class="text-lg font-medium text-white">Never</p>
                        </div>
                    </div>

                    <!-- Add URL Section -->
                    <div class="config-card p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-plus-circle text-blue-500 mr-2"></i>Crawl Website
                        </h3>
                        
                        <!-- Single Page Crawl -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Single Page</label>
                            <div class="flex gap-3">
                                <input 
                                    type="url" 
                                    id="websiteUrlInput" 
                                    placeholder="https://example.com/products/product-page" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                />
                                <button 
                                    onclick="crawlWebsiteUrl()" 
                                    class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-medium">
                                    <i class="fas fa-spider mr-2"></i>Crawl Page
                                </button>
                            </div>
                        </div>

                        <!-- Full Website Crawl -->
                        <div class="border-t pt-4 mt-4">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Entire Website (All Pages & Subpages)</label>
                            <div class="flex gap-3 mb-3">
                                <input 
                                    type="url" 
                                    id="websiteFullUrlInput" 
                                    placeholder="https://example.com" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                                />
                                <button 
                                    onclick="crawlEntireWebsite()" 
                                    class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all font-medium whitespace-nowrap">
                                    <i class="fas fa-globe mr-2"></i>Crawl All
                                </button>
                            </div>
                            
                            <!-- Advanced Options -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-gray-600 mb-1 block">Max Pages</label>
                                    <input 
                                        type="number" 
                                        id="maxPages" 
                                        value="100" 
                                        min="1" 
                                        max="500" 
                                        class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 mb-1 block">Max Depth</label>
                                    <input 
                                        type="number" 
                                        id="maxDepth" 
                                        value="3" 
                                        min="1" 
                                        max="5" 
                                        class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>
                            </div>
                            
                            <div class="mt-2 flex items-start gap-2">
                                <input type="checkbox" id="useSitemap" checked class="mt-1">
                                <label for="useSitemap" class="text-xs text-gray-600">
                                    <i class="fas fa-sitemap mr-1"></i>Use sitemap.xml if available (faster)
                                </label>
                            </div>
                        </div>

                        <p class="text-sm text-gray-600 mt-3">
                            <i class="fas fa-info-circle mr-1"></i>
                            Crawl entire website to index all product pages, specs, and pricing automatically
                        </p>
                        
                        <!-- Progress Indicator -->
                        <div id="crawlProgress" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-900">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Crawling website...
                                </span>
                                <span id="crawlProgressCount" class="text-xs text-blue-700">0 pages</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div id="crawlProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Website Content Section -->
                    <div class="config-card p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-search text-purple-500 mr-2"></i>Test Search
                        </h3>
                        <div class="flex gap-3 mb-4">
                            <input 
                                type="text" 
                                id="websiteSearchQuery" 
                                placeholder="Search for product info, specs, pricing..." 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                            />
                            <button 
                                onclick="searchWebsiteContent()" 
                                class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
                                <i class="fas fa-search mr-2"></i>Search
                            </button>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="websiteSearchResults" class="hidden mt-4">
                            <h4 class="font-semibold text-gray-700 mb-3">Search Results:</h4>
                            <div id="websiteSearchResultsList" class="space-y-3">
                                <!-- Results will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Crawled URLs List -->
                    <div class="config-card p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-list text-green-500 mr-2"></i>Crawled Content
                            </h3>
                            <button 
                                onclick="refreshWebsiteList()" 
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold">Page Title</th>
                                        <th class="px-4 py-3 text-left font-semibold">URL</th>
                                        <th class="px-4 py-3 text-left font-semibold">Type</th>
                                        <th class="px-4 py-3 text-left font-semibold">Chunks</th>
                                        <th class="px-4 py-3 text-left font-semibold">Crawled</th>
                                        <th class="px-4 py-3 text-left font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="websiteUrlsList">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40" onclick="document.getElementById('customerModal').classList.add('hidden')"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg p-6 overflow-hidden">
            <header class="flex justify-between items-center mb-4">
                <div>
                    <h2 id="customerModalName" class="text-lg font-semibold">Customer</h2>
                    <div id="customerModalPhone" class="text-xs text-gray-500"></div>
                </div>
                <button id="closeCustomerModalBtn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="mb-4">
                <div class="mb-2"><strong>Last Order:</strong> <span id="customerModalLastOrder">N/A</span></div>
                <div class="mb-2"><strong>Total Spent:</strong> <span id="customerModalTotalSpent">₹0.00</span></div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">Notes</h3>
                <ul id="customerNotesList" class="mb-2 space-y-2 max-h-40 overflow-y-auto">
                    <!-- Notes loaded dynamically -->
                </ul>
                <form id="addNoteForm" class="flex gap-2">
                    <input id="newNoteText" type="text" placeholder="Add a note..." class="flex-1 border rounded px-3 py-2" required />
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Add</button>
                </form>
            </div>
        </div>
    </div>
    <!-- Conversation Modal -->
    <!-- Conversation Details Modal -->
    <div id="conversationModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="modal-content relative w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
            <!-- Modal Header -->
            <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <h2 id="convTitle" class="text-2xl font-bold">Conversation Details</h2>
                                <div id="convMeta" class="text-white/80 text-sm mt-1"></div>
                            </div>
                        </div>
                        <div id="convStats" class="flex gap-4 mt-4 text-sm">
                            <!-- Stats will be added dynamically -->
                        </div>
                    </div>
                    <button id="closeConvBtn" class="ml-4 w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </header>

            <!-- Messages Area -->
            <div class="p-6">
                <div id="convMessages" class="h-96 overflow-y-auto bg-gray-50 rounded-xl p-4 space-y-3 mb-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading messages...</p>
                    </div>
                </div>

                <!-- Reply Composer (inline, no browser popup) -->
                <div id="replyComposer" class="hidden bg-white border border-gray-200 rounded-xl p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-medium text-gray-700">Reply</div>
                        <button id="replyCancelBtn" type="button" class="text-sm text-gray-500 hover:text-gray-700">Cancel</button>
                    </div>
                    <textarea id="replyText" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your reply..."></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="replySendBtn" type="button" class="px-5 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all font-medium">
                            <i class="fas fa-paper-plane mr-2"></i>Send
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 justify-between items-center">
                    <button id="loadMoreBtn" class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                        <i class="fas fa-history mr-2"></i>Load Older Messages
                    </button>
                    <div class="flex gap-3">
                        <button id="exportConvBtn" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors font-medium">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <button id="replyBtn" class="hidden px-6 py-2.5 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all font-medium">
                            <i class="fas fa-reply mr-2"></i>Send Reply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative w-full max-w-4xl bg-white rounded-lg shadow-lg p-6 z-10 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-semibold">Order <span id="orderId">#Loading...</span></h3>
                    <p id="orderPlacedAt" class="text-sm text-gray-500">Placed:</p>
                </div>
                <div class="flex items-center gap-3">
                    <select id="orderStatusSelect" class="rounded border px-3 py-1 text-sm">
                        <!-- options inserted by JS -->
                    </select>
                    <button id="saveOrderStatusBtn" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Save</button>
                    <button id="closeOrderModal" class="bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">Close</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                <div>
                    <div class="mb-2"><strong>Status:</strong> <span id="orderStatusLabel" class="text-sm">Loading...</span></div>
                    <div class="mb-2"><strong>Mobile Number:</strong> <span id="orderCustomerPhone" class="text-sm text-gray-700">Loading...</span></div>
                    <div class="mb-2"><strong>Customer Name:</strong> <span id="orderCustomerName" class="text-sm text-gray-700">Loading...</span></div>
                    <div class="mb-2"><strong>Zoho Invoice No.:</strong> <span id="orderZohoInvoiceNo" class="text-sm text-gray-700">Loading...</span></div>
                    <div class="mb-2"><strong>Shipping Address:</strong> <div id="orderShippingAddress" class="text-sm text-gray-600">Loading...</div></div>
                </div>

                <div class="md:col-span-2">
                    <div class="flex justify-end">
                        <div class="text-right space-y-1">
                            <div class="flex justify-between gap-4"><span>Subtotal:</span><span id="orderSubtotal">₹0.00</span></div>
                            <div class="flex justify-between gap-4"><span>Shipping:</span><span id="orderShipping">₹0.00</span></div>
                            <div class="flex justify-between gap-4"><span>GST:</span><span id="orderGST">₹0.00</span></div>
                            <div class="border-t pt-2 flex justify-between gap-4 font-semibold"><span>Total:</span><span id="orderTotal">₹0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products table -->
            <div>
                <h4 class="font-medium mb-2">Products</h4>
                <div class="overflow-auto max-h-48">
                    <table class="w-full text-sm" id="orderItemsTable">
                        <thead class="text-left text-xs text-gray-600">
                            <tr>
                                <th class="pb-2">Product</th>
                                <th class="pb-2">SKU</th>
                                <th class="pb-2 text-right">Qty</th>
                                <th class="pb-2 text-right">Unit Price</th>
                                <th class="pb-2 text-right">Line Total</th>
                            </tr>
                        </thead>
                        <tbody id="orderItemsTableBody">
                            <!-- JS inserts rows here -->
                        </tbody>
                    </table>
                </div>
                <div id="noItemsNotice" class="text-sm text-gray-500 mt-2 hidden">Product details not available.</div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg p-6 overflow-auto max-h-[80vh]">
            <header class="flex justify-between items-center mb-4">
                <h2 id="editProdTitle" class="text-lg font-semibold">Edit Product</h2>
                <button id="closeEditProdBtn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="space-y-3">
                <input type="hidden" id="editProdId" />
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input id="editProdName" class="w-full px-3 py-2 border rounded" />
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">SKU ID</label>
                        <input id="editProdSku" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input id="editProdDescription" class="w-full px-3 py-2 border rounded" />
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                        <input id="editProdPrice" type="number" step="0.01" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity</label>
                        <input id="editProdStock" type="number" class="w-full px-3 py-2 border rounded" />
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
                        <input id="editProdBrand" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="editProdCategory" class="w-full px-3 py-2 border rounded"></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Packaging Unit</label>
                        <input id="editProdPackagingUnit" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Units per Carton</label>
                        <input id="editProdUnitsPerCarton" type="number" class="w-full px-3 py-2 border rounded" />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                    <input id="editProdImageUrl" class="w-full px-3 py-2 border rounded" />
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="cancelEditProd" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancel</button>
                    <button id="saveEditProdBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ---------- Category Loader ----------
    async function loadCategoriesDropdown() {
        try {
            const tenantId = state.session?.tenantId;
            const response = await fetch(`/api/categories?tenantId=${tenantId}`);
            const data = await response.json();
            const dropdown = document.getElementById('editProdCategory');
            if (!dropdown) return;
            dropdown.innerHTML = '';
            if (data.success && Array.isArray(data.categories) && data.categories.length > 0) {
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    dropdown.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No categories found';
                dropdown.appendChild(option);
            }
        } catch (err) {
            console.error('Failed to load categories:', err);
        }
    }

    document.getElementById('editProductModal')?.addEventListener('show', loadCategoriesDropdown);

    // ---------- Bulk Add Products ----------
    // These will be initialized after DOM is fully loaded
    function initBulkUploadHandlers() {
        const bulkAddBtn = document.getElementById('bulkAddProductsBtn');
        const uploadBtn = document.getElementById('uploadBulkProductsBtn');
        const modal = document.getElementById('bulkAddProductsModal');
        
        if (bulkAddBtn) {
            bulkAddBtn.addEventListener('click', function() {
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            });
        }

        if (uploadBtn) {
            uploadBtn.addEventListener('click', async function() {
                const fileInput = document.getElementById('bulkProductsFile');
                if (!fileInput || !fileInput.files.length) {
                    showNotification('Please select a file to upload.', 'warning');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('tenantId', state.session?.tenantId);
                
                try {
                    showNotification('Uploading products...', 'info');
                    const response = await fetch('/api/products/bulk-upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification(`Successfully uploaded ${result.count || 0} products!`, 'success');
                        if (modal) {
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                        }
                        fileInput.value = ''; // Clear file input
                        loadProducts(); // Reload products
                    } else {
                        showNotification(result.error || 'Upload failed.', 'error');
                    }
                } catch (err) {
                    console.error('Upload error:', err);
                    showNotification('Upload failed: ' + err.message, 'error');
                }
            });
        }
    }

    // ---------- Manage Categories Modal ----------
    function initManageCategoriesHandler() {
        const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
        const modal = document.getElementById('manageCategoriesModal');
        
        if (manageCategoriesBtn) {
            manageCategoriesBtn.addEventListener('click', function() {
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    loadCategories(); // Load categories when modal opens
                }
            });
        }
    }
    
    // ---------- Application State ----------
    const state = {
        session: null,
        currentTab: 'overview',
        data: { stats: null, conversations: [], orders: [], products: [], settings: {} },
        searchQuery: '',
        isLoading: false
    };
    // ---------- API Helpers ----------
    const api = {
        authHeaders() {
            return state.session?.token ? { 'Authorization': `Bearer ${state.session.token}` } : {};
        },

        async verifyToken(token) {
            const response = await fetch('/api/verify-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token })
            });
            return await response.json();
        },

        async fetchData(endpoint, query) {
            if (!state.session?.tenantId) throw new Error('No tenant session');
            const [baseEndpoint, endpointQuery] = String(endpoint || '').split('?');
            const params = new URLSearchParams(endpointQuery || '');
            if (query && typeof query === 'object') {
                Object.entries(query).forEach(([k, v]) => {
                    if (v === undefined || v === null) return;
                    params.set(k, String(v));
                });
            }
            const qs = params.toString();
            const url = `/api/dashboard/${baseEndpoint}/${state.session.tenantId}${qs ? `?${qs}` : ''}`;

            const response = await fetch(url, {
                headers: { ...this.authHeaders() }
            });
            if (!response.ok) throw new Error(`Failed to fetch ${endpoint}`);
            return await response.json();
        },

        async updateSettings(settingsData) {
            const response = await fetch(`/api/dashboard/settings/${state.session.tenantId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                body: JSON.stringify(settingsData)
            });
            return await response.json();
        },

        async deleteItem(type, id) {
            const response = await fetch(`/api/dashboard/${type}/${state.session.tenantId}/${id}`, {
                method: 'DELETE',
                headers: { ...this.authHeaders() }
            });
            return await response.json();
        },

        async putJSON(path, payload) {
            const response = await fetch(path, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                body: JSON.stringify(payload)
            });
            return await response.json();
        },

        async postJSON(path, payload) {
            const response = await fetch(path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                body: JSON.stringify(payload)
            });
            return await response.json();
        }
    };

    // ---------- Utilities ----------
    function showNotification(message, type = 'info') {
        const colors = {
            success: 'success-alert',
            error: 'error-alert',
            info: 'bg-blue-500 text-white',
            warning: 'bg-orange-500 text-white'
        };
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[type]} px-6 py-3 rounded-xl shadow-lg z-50 animate-slide-up`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3500);
    }

    function escapeHtml(str) {
        if (typeof str !== 'string') return str;
        return str.replace(/[&<>"']/g, function (c) {
            return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c];
        });
    }

    function fmtINR(value) {
        try {
            const num = Number(value || 0);
            if (isNaN(num)) return '₹0.00';
            return '₹' + num.toLocaleString('en-IN', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        } catch (error) {
            console.warn('Error formatting currency:', error);
            return '₹0.00';
        }
    }

    // ---------- Order Modal Functions ----------
    async function loadOrderAndShowModal(orderId, tenantId) {
        try {
            console.log('Loading order modal for:', orderId);
            const modal = document.getElementById('orderModal');
            if (!modal) {
                console.error('Order modal not found in DOM');
                showNotification('Error: Order modal not available', 'error');
                return;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            const orderIdElement = document.getElementById('orderId');
            const analyticsUIState = {
                days: 30,
                sortKey: 'revenue',
                sortDir: 'desc'
            };

            function normalizePerfRow(row) {
                const heat = row?.heat || {};
                return {
                    id: row?.id ?? null,
                    name: row?.name ?? 'Salesman',
                    phone: row?.phone ?? null,
                    leads: Number(row?.leads || 0) || 0,
                    openLeads: Number(row?.openLeads || 0) || 0,
                    closedLeads: Number(row?.closedLeads || 0) || 0,
                    orders: Number(row?.orders || 0) || 0,
                    revenue: Number(row?.revenue || 0) || 0,
                    conversionRate: Number(row?.conversionRate || 0) || 0,
                    heat: {
                        ON_FIRE: Number(heat.ON_FIRE || 0) || 0,
                        VERY_HOT: Number(heat.VERY_HOT || 0) || 0,
                        HOT: Number(heat.HOT || 0) || 0,
                        WARM: Number(heat.WARM || 0) || 0,
                        COLD: Number(heat.COLD || 0) || 0
                    },
                    _isUnassigned: String(row?.id || '') === 'unassigned'
                };
            }

            function sortPerfRows(rows, sortKey, sortDir) {
                const dir = String(sortDir || 'desc').toLowerCase() === 'asc' ? 1 : -1;
                const key = String(sortKey || 'revenue');
                const list = (rows || []).slice();

                list.sort((a, b) => {
                    // Always keep Unassigned at bottom
                    if (a._isUnassigned && !b._isUnassigned) return 1;
                    if (!a._isUnassigned && b._isUnassigned) return -1;

                    if (key === 'name') return dir * String(a.name || '').localeCompare(String(b.name || ''));
                    const av = Number(a[key] || 0) || 0;
                    const bv = Number(b[key] || 0) || 0;
                    if (bv !== av) return dir * (av - bv);
                    // stable-ish tie-breakers
                    return String(a.name || '').localeCompare(String(b.name || ''));
                });
                return list;
            }

            function renderSalesTeamPerformanceTable(perfRows, sortKey, sortDir) {
                const perf = sortPerfRows(perfRows, sortKey, sortDir);
                if (!perf.length) {
                    return `
                        <div class="p-6 rounded-xl bg-gray-50 border border-gray-200 text-gray-600">
                            No salesmen performance data available yet. Add salesmen and ensure leads are assigned.
                        </div>
                    `;
                }

                return `
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr class="text-left text-gray-600">
                                    <th class="py-2 pr-4">Salesman</th>
                                    <th class="py-2 pr-4">Leads</th>
                                    <th class="py-2 pr-4">Open</th>
                                    <th class="py-2 pr-4">Orders</th>
                                    <th class="py-2 pr-4">Revenue</th>
                                    <th class="py-2 pr-4">Conv%</th>
                                    <th class="py-2 pr-4">Heat (🔥/VH/H/W/C)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${perf.map(s => {
                                    const heat = s.heat || {};
                                    const heatText = `${Number(heat.ON_FIRE||0)}/${Number(heat.VERY_HOT||0)}/${Number(heat.HOT||0)}/${Number(heat.WARM||0)}/${Number(heat.COLD||0)}`;
                                    const rowClass = s._isUnassigned ? 'bg-yellow-50' : '';
                                    return `
                                        <tr class="border-t border-gray-200 ${rowClass}">
                                            <td class="py-3 pr-4">
                                                <div class="font-semibold text-gray-900">${escapeHtml(String(s.name || 'Salesman'))}</div>
                                                ${s.phone ? `<div class="text-xs text-gray-500">${escapeHtml(String(s.phone))}</div>` : ''}
                                            </td>
                                            <td class="py-3 pr-4 text-gray-900 font-medium">${Number(s.leads)||0}</td>
                                            <td class="py-3 pr-4 text-gray-900">${Number(s.openLeads)||0}</td>
                                            <td class="py-3 pr-4 text-gray-900">${Number(s.orders)||0}</td>
                                            <td class="py-3 pr-4 text-gray-900 font-semibold">${fmtINR(s.revenue||0)}</td>
                                            <td class="py-3 pr-4 text-gray-900">${Number(s.conversionRate)||0}%</td>
                                            <td class="py-3 pr-4 text-gray-700 font-mono">${heatText}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            function downloadCsv(filename, csvText) {
                const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);
            }

            function perfRowsToCsv(rows) {
                const header = [
                    'Salesman', 'Phone', 'Leads', 'Open Leads', 'Closed Leads',
                    'Orders', 'Revenue', 'Conversion %',
                    'Heat ON_FIRE', 'Heat VERY_HOT', 'Heat HOT', 'Heat WARM', 'Heat COLD'
                ];
                const lines = [header.join(',')];

                (rows || []).forEach(r => {
                    const s = normalizePerfRow(r);
                    const cols = [
                        String(s.name || '').replace(/\"/g, '"'),
                        String(s.phone || ''),
                        s.leads,
                        s.openLeads,
                        s.closedLeads,
                        s.orders,
                        (Math.round((s.revenue || 0) * 100) / 100),
                        s.conversionRate,
                        s.heat.ON_FIRE,
                        s.heat.VERY_HOT,
                        s.heat.HOT,
                        s.heat.WARM,
                        s.heat.COLD
                    ].map(v => {
                        const str = String(v ?? '');
                        // CSV escaping
                        if (/[",\n]/.test(str)) return `"${str.replace(/"/g, '""')}"`;
                        return str;
                    });
                    lines.push(cols.join(','));
                });
                return lines.join('\n');
            }

            async function loadAnalytics(options = {}) {
                if (options.days) analyticsUIState.days = Number(options.days) || analyticsUIState.days;
                if (options.sortKey) analyticsUIState.sortKey = String(options.sortKey);
                if (options.sortDir) analyticsUIState.sortDir = String(options.sortDir);

                const data = await api.fetchData('analytics', { days: analyticsUIState.days });
                const analytics = data.analytics || {};

                const rawPerf = Array.isArray(analytics.salesmenPerformance) ? analytics.salesmenPerformance : [];
                const perfRows = rawPerf.map(normalizePerfRow);
                const unassigned = analytics.unassignedPerformance ? normalizePerfRow(analytics.unassignedPerformance) : null;
                if (unassigned && (unassigned.leads > 0 || unassigned.orders > 0 || unassigned.revenue > 0)) {
                    perfRows.push(unassigned);
                }

                document.getElementById('tabContent').innerHTML = `
            if (!response.ok) {
                throw new Error(`Failed to fetch orders: ${response.status}`);
            }
            
            const data = await response.json();
            if (!data.success || !data.orders) {
                throw new Error('Invalid response format');
            }
            
            let order = data.orders.find(o => String(o.id) === String(orderId));
            if (!order) {
                throw new Error('Order not found');
            }
            
            if (order.conversation_id && (!order.customerName || order.customerName === order.conversation?.end_user_phone)) {
                try {
                    const convResponse = await fetch(`/api/dashboard/conversation/${tenantId}/${order.conversation_id}`);
                    if (convResponse.ok) {
                        const convData = await convResponse.json();
                        if (convData.success && convData.conversation) {
                            const messages = convData.conversation.messages || [];
                            const customerMessages = messages.filter(m => m.sender === 'user' || m.sender === 'customer');
                            <div class="text-sm text-gray-500">Last ${analytics.period || analyticsUIState.days} days</div>
                                const text = msg.message_body || '';

                        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Period</label>
                                    <select id="analyticsPeriodSelect" class="w-full px-3 py-2 border border-gray-300 rounded-xl bg-white">
                                        <option value="7" ${Number(analyticsUIState.days) === 7 ? 'selected' : ''}>Last 7 days</option>
                                        <option value="30" ${Number(analyticsUIState.days) === 30 ? 'selected' : ''}>Last 30 days</option>
                                        <option value="90" ${Number(analyticsUIState.days) === 90 ? 'selected' : ''}>Last 90 days</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Sort By</label>
                                    <select id="analyticsSortSelect" class="w-full px-3 py-2 border border-gray-300 rounded-xl bg-white">
                                        <option value="revenue" ${analyticsUIState.sortKey === 'revenue' ? 'selected' : ''}>Revenue</option>
                                        <option value="leads" ${analyticsUIState.sortKey === 'leads' ? 'selected' : ''}>Leads</option>
                                        <option value="orders" ${analyticsUIState.sortKey === 'orders' ? 'selected' : ''}>Orders</option>
                                        <option value="conversionRate" ${analyticsUIState.sortKey === 'conversionRate' ? 'selected' : ''}>Conversion %</option>
                                        <option value="name" ${analyticsUIState.sortKey === 'name' ? 'selected' : ''}>Name</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Direction</label>
                                    <button id="analyticsSortDirBtn" class="w-full px-3 py-2 border border-gray-300 rounded-xl bg-white hover:bg-gray-50">
                                        ${String(analyticsUIState.sortDir).toLowerCase() === 'asc' ? 'Ascending' : 'Descending'}
                                    </button>
                                </div>
                            </div>

                            <div class="flex items-center gap-3">
                                <button id="analyticsExportCsvBtn" class="px-4 py-2 rounded-xl bg-gray-900 text-white hover:bg-black">
                                    <i class="fas fa-download mr-2"></i>Export CSV
                                </button>
                            </div>
                        </div>
                                const nameMatch = text.match(/(?:my name is|i am|i'm)\s+([a-zA-Z\s]{2,20})/i);
                        <div id="salesmenPerfTable">
                            ${renderSalesTeamPerformanceTable(perfRows, analyticsUIState.sortKey, analyticsUIState.sortDir)}
                        </div>
        safeSetText('orderStatusLabel', order.order_status || 'N/A');
        

                const periodSelect = document.getElementById('analyticsPeriodSelect');
                if (periodSelect) {
                    periodSelect.value = String(analyticsUIState.days);
                    periodSelect.onchange = () => loadAnalytics({ days: Number(periodSelect.value) || 30 });
                }

                const sortSelect = document.getElementById('analyticsSortSelect');
                if (sortSelect) {
                    sortSelect.value = String(analyticsUIState.sortKey);
                    sortSelect.onchange = () => {
                        analyticsUIState.sortKey = String(sortSelect.value);
                        const container = document.getElementById('salesmenPerfTable');
                        if (container) container.innerHTML = renderSalesTeamPerformanceTable(perfRows, analyticsUIState.sortKey, analyticsUIState.sortDir);
                    };
                }

                const sortDirBtn = document.getElementById('analyticsSortDirBtn');
                if (sortDirBtn) {
                    sortDirBtn.onclick = () => {
                        analyticsUIState.sortDir = (String(analyticsUIState.sortDir).toLowerCase() === 'asc') ? 'desc' : 'asc';
                        sortDirBtn.textContent = (String(analyticsUIState.sortDir).toLowerCase() === 'asc') ? 'Ascending' : 'Descending';
                        const container = document.getElementById('salesmenPerfTable');
                        if (container) container.innerHTML = renderSalesTeamPerformanceTable(perfRows, analyticsUIState.sortKey, analyticsUIState.sortDir);
                    };
                }

                const exportBtn = document.getElementById('analyticsExportCsvBtn');
                if (exportBtn) {
                    exportBtn.onclick = () => {
                        const sorted = sortPerfRows(perfRows, analyticsUIState.sortKey, analyticsUIState.sortDir);
                        const csv = perfRowsToCsv(sorted);
                        const filename = `sales-team-performance-${state.session?.tenantId || 'tenant'}-${analytics.period || analyticsUIState.days}d.csv`;
                        downloadCsv(filename, csv);
                    };
                }
        let customerPhone = order.conversation?.end_user_phone || order.customer_phone || 'N/A';
        if (typeof customerPhone === 'string' && customerPhone.endsWith('@c.us')) {
            customerPhone = customerPhone.replace(/@c\.us$/, '');
        }
        // Always show the cleaned phone number under Mobile Number
        safeSetText('orderCustomerPhone', customerPhone);

        // Customer Name fallback to N/A if not present or same as phone
        const customerName = order.customerName && order.customerName !== customerPhone ? order.customerName : 'N/A';
        safeSetText('orderCustomerName', customerName);

        // Show Zoho Invoice No. if present, else N/A
        let zohoInvoiceNo = order.zoho_invoice_id || order.zoho_invoice_no || 'N/A';
        if (zohoInvoiceNo === null || zohoInvoiceNo === undefined || zohoInvoiceNo === '') zohoInvoiceNo = 'N/A';
        safeSetText('orderZohoInvoiceNo', zohoInvoiceNo);

        // Show shipping address if present, else N/A
        let shippingAddress = order.shippingAddress || order.shipping_address || '';
        if (!shippingAddress || shippingAddress.trim() === '') shippingAddress = 'N/A';
        safeSetText('orderShippingAddress', shippingAddress);
        
        const subtotal = Number(order.subtotal_amount || order.subtotal || 0);
        const shipping = Number(order.shipping_charges || order.shipping || 0);
        const gst = Number(order.gst_amount || order.gst || 0);
        const total = Number(order.total_amount || order.total || 0);
        
        safeSetText('orderSubtotal', fmtINR(subtotal));
        safeSetText('orderShipping', fmtINR(shipping));
        safeSetText('orderGST', fmtINR(gst));
        safeSetText('orderTotal', fmtINR(total));
        
        const tbody = document.getElementById('orderItemsTableBody');
        const noItemsNotice = document.getElementById('noItemsNotice');
        
        if (tbody) {
            tbody.innerHTML = '';
            const items = order.items || [];
            
            if (items.length === 0) {
                if (noItemsNotice) noItemsNotice.classList.remove('hidden');
            } else {
                if (noItemsNotice) noItemsNotice.classList.add('hidden');
                
                let totalCartons = 0;
                let totalPieces = 0;
                
                items.forEach(item => {
                    const quantity = Number(item.quantity || 0);
                    const unitsPerCarton = Number(item.unitsPerCarton || item.units_per_carton || 1000);
                    const pieces = quantity * unitsPerCarton;
                    totalCartons += quantity;
                    totalPieces += pieces;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="py-2">
                            <div class="font-medium">${escapeHtml(item.productName || item.product_name || 'Unknown Product')}</div>
                            <div class="text-xs text-gray-500">${pieces.toLocaleString()} pieces total</div>
                        </td>
                        <td class="py-2">${escapeHtml(item.sku || 'N/A')}</td>
                        <td class="py-2 text-right">
                            <div class="font-medium">${quantity} cartons</div>
                            <div class="text-xs text-gray-500">${unitsPerCarton.toLocaleString()}/carton</div>
                        </td>
                        <td class="py-2 text-right">${fmtINR(item.unitPrice || item.unit_price || item.price_at_time_of_purchase || 0)}</td>
                        <td class="py-2 text-right">${fmtINR(item.lineTotal || item.line_total || (quantity * (item.unitPrice || item.unit_price || 0)))}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'border-t-2 border-gray-300 bg-gray-50 font-semibold';
                summaryRow.innerHTML = `
                    <td class="py-3 font-bold">ORDER TOTALS</td>
                    <td class="py-3"></td>
                    <td class="py-3 text-right">
                        <div class="font-bold text-blue-600">${totalCartons} cartons</div>
                        <div class="text-sm text-blue-500">${totalPieces.toLocaleString()} pieces</div>
                    </td>
                    <td class="py-3"></td>
                    <td class="py-3 text-right font-bold text-lg">${fmtINR(total)}</td>
                `;
                tbody.appendChild(summaryRow);
            }
        }
        
        populateStatusDropdown(order.order_status || 'new');
        window.currentOrderId = order.id;
    }

    function populateStatusDropdown(currentStatus) {
        const statusSelect = document.getElementById('orderStatusSelect');
        if (!statusSelect) return;
        const statuses = [
            'new', 'pending_payment', 'pending', 'confirmed', 
            'shipped', 'delivered', 'cancelled', 'refunded'
        ];
        statusSelect.innerHTML = '';
        statuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            if (status === currentStatus) option.selected = true;
            statusSelect.appendChild(option);
        });
    }

    async function openConversation(tenantId, conversationId) {
        const modal = document.getElementById('conversationModal');
        const title = document.getElementById('convTitle');
        const meta = document.getElementById('convMeta');
        const stats = document.getElementById('convStats');
        const messagesEl = document.getElementById('convMessages');

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Show loading state
        messagesEl.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading conversation...</p>
            </div>
        `;
        title.textContent = 'Loading...';
        meta.textContent = '';
        stats.innerHTML = '';

        try {
            const resp = await fetch(`/api/dashboard/conversation/${tenantId}/${conversationId}`);
            const payload = await resp.json();
            
            if (!payload.success) {
                messagesEl.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
                        <p class="text-red-600 font-medium">Error loading conversation</p>
                        <p class="text-gray-500 text-sm mt-2">${escapeHtml(payload.error || 'Unknown error')}</p>
                    </div>
                `;
                return;
            }
            
            const { conversation } = payload;
            const messages = conversation.messages || [];
            
            // Update header info
            const phone = conversation.end_user_phone || 'Unknown';
            title.textContent = phone;
            meta.textContent = `ID: ${conversationId.substring(0, 8)}... • Updated: ${conversation.updated_at ? new Date(conversation.updated_at).toLocaleString() : 'Unknown'}`;

            // Keep context for Export / Reply actions
            window.currentConversationContext = {
                tenantId,
                conversationId,
                phone,
                messages
            };
            
            // Show stats
            stats.innerHTML = `
                <div class="flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-full">
                    <i class="fas fa-comments"></i>
                    <span>${messages.length} messages</span>
                </div>
                <div class="flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-full">
                    <i class="fas fa-info-circle"></i>
                    <span>State: ${escapeHtml(conversation.state || 'active')}</span>
                </div>
                ${conversation.last_product_discussed ? `
                    <div class="flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-full">
                        <i class="fas fa-box"></i>
                        <span>${escapeHtml(conversation.last_product_discussed)}</span>
                    </div>
                ` : ''}
            `;

            // Render messages
            renderConversationMessages(messages, messagesEl);

            // Reset reply composer
            hideReplyComposer();
        } catch (error) {
            console.error('openConversation error', error);
            messagesEl.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-orange-500 text-3xl mb-3"></i>
                    <p class="text-gray-700 font-medium">Failed to load conversation</p>
                    <p class="text-gray-500 text-sm mt-2">${escapeHtml(error.message || String(error))}</p>
                </div>
            `;
        }
    }

    function renderConversationMessages(messages, messagesEl) {
        if (!messagesEl) return;
        const list = Array.isArray(messages) ? messages : [];

        function parseMessageDate(raw) {
            const s = String(raw || '').trim();
            if (!s) return new Date();
            // SQLite often returns "YYYY-MM-DD HH:MM:SS" (UTC). Treat as UTC for correct local display.
            if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(\.\d+)?$/.test(s)) {
                return new Date(s.replace(' ', 'T') + 'Z');
            }
            // ISO strings (with or without Z) are handled by Date.
            const d = new Date(s);
            return isNaN(d.getTime()) ? new Date() : d;
        }

        if (list.length === 0) {
            messagesEl.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                    <p class="text-gray-500">No messages in this conversation yet</p>
                </div>
            `;
            return;
        }

        messagesEl.innerHTML = '';
        list.forEach((m, index) => {
            const senderVal = String(m.sender || '').toLowerCase();
            const isCustomer = senderVal === 'user' || senderVal === 'customer' || /@c\.us$/.test(senderVal) || /^\+?\d+$/.test(senderVal);
            const prevMessage = list[index - 1];
            const createdAt = m.created_at || new Date().toISOString();
            const prevCreatedAt = prevMessage?.created_at || createdAt;

            const createdDate = parseMessageDate(createdAt);
            const prevDate = parseMessageDate(prevCreatedAt);

            const showDate = !prevMessage || createdDate.toDateString() !== prevDate.toDateString();

            if (showDate) {
                const dateDiv = document.createElement('div');
                dateDiv.className = 'text-center my-4';
                dateDiv.innerHTML = `
                    <span class="bg-gray-200 text-gray-600 text-xs px-3 py-1 rounded-full">
                        ${createdDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}
                    </span>
                `;
                messagesEl.appendChild(dateDiv);
            }

            const bubble = document.createElement('div');
            bubble.className = `flex ${isCustomer ? 'justify-start' : 'justify-end'}`;

            const time = createdDate.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            bubble.innerHTML = `
                <div class="max-w-[75%] ${isCustomer ? 'bg-white' : 'bg-gradient-to-r from-blue-500 to-purple-600'} rounded-2xl shadow-sm">
                    <div class="px-4 py-3">
                        ${!isCustomer ? '' : `<div class="text-xs font-semibold text-blue-600 mb-1">Customer</div>`}
                        <div class="text-sm ${isCustomer ? 'text-gray-800' : 'text-white'} break-words whitespace-pre-wrap">${escapeHtml(m.message_body || '')}</div>
                        <div class="text-xs ${isCustomer ? 'text-gray-400' : 'text-white/70'} mt-1 flex items-center justify-end space-x-1">
                            <span>${time}</span>
                            ${!isCustomer ? '<i class="fas fa-check-double text-blue-200"></i>' : ''}
                        </div>
                    </div>
                </div>
            `;
            messagesEl.appendChild(bubble);
        });

        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function exportCurrentConversation() {
        const ctx = window.currentConversationContext;
        if (!ctx?.conversationId) {
            alert('No conversation loaded');
            return;
        }

        const safePhone = String(ctx.phone || 'unknown').replace(/[^0-9a-zA-Z_\-+]/g, '_');
        const filename = `conversation_${safePhone}_${String(ctx.conversationId).substring(0, 8)}.csv`;

        const rows = [['created_at', 'sender', 'message_body']];
        (ctx.messages || []).forEach(m => {
            rows.push([
                m.created_at || '',
                m.sender || '',
                (m.message_body || '').replace(/\r?\n/g, '\\n')
            ]);
        });

        const csv = '\ufeff' + rows
            .map(cols => cols.map(v => {
                const s = String(v ?? '');
                return '"' + s.replace(/"/g, '""') + '"';
            }).join(','))
            .join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    async function sendReplyFromConversation() {
        // Toggle the inline composer UI instead of showing a browser popup
        const ctx = window.currentConversationContext;
        if (!ctx?.tenantId || !ctx?.conversationId) {
            showNotification('No conversation loaded', 'warning');
            return;
        }
        showReplyComposer();
    }

    function showReplyComposer() {
        const composer = document.getElementById('replyComposer');
        const input = document.getElementById('replyText');
        if (!composer || !input) return;
        composer.classList.remove('hidden');
        input.focus();
    }

    function hideReplyComposer() {
        const composer = document.getElementById('replyComposer');
        const input = document.getElementById('replyText');
        const sendBtn = document.getElementById('replySendBtn');
        if (composer) composer.classList.add('hidden');
        if (input) input.value = '';
        if (sendBtn) sendBtn.disabled = false;
    }

    async function submitReplyFromComposer() {
        const ctx = window.currentConversationContext;
        if (!ctx?.tenantId || !ctx?.conversationId) {
            showNotification('No conversation loaded', 'warning');
            return;
        }

        const input = document.getElementById('replyText');
        const sendBtn = document.getElementById('replySendBtn');
        const messagesEl = document.getElementById('convMessages');
        const text = String(input?.value || '').trim();

        if (!text) return;
        if (sendBtn) sendBtn.disabled = true;

        // Optimistic UI append (so user sees it immediately)
        const optimistic = {
            id: `dashboard_${Date.now()}`,
            sender: 'bot',
            message_body: text,
            message_type: 'dashboard_reply',
            created_at: new Date().toISOString()
        };
        ctx.messages = Array.isArray(ctx.messages) ? ctx.messages : [];
        ctx.messages = [...ctx.messages, optimistic];
        window.currentConversationContext = { ...ctx };
        renderConversationMessages(ctx.messages, messagesEl);

        try {
            const resp = await fetch(`/api/dashboard/conversation/${encodeURIComponent(ctx.tenantId)}/${encodeURIComponent(ctx.conversationId)}/reply`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': state.session?.token ? `Bearer ${state.session.token}` : ''
                },
                body: JSON.stringify({ text })
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data?.success) {
                throw new Error(data?.error || 'Failed to send reply');
            }

            showNotification(data?.warning ? 'Reply sent (not logged)' : 'Reply sent', data?.warning ? 'warning' : 'success');
            hideReplyComposer();

            // Refresh only when backend logged successfully; otherwise keep optimistic message visible.
            if (!data?.warning) {
                await openConversation(ctx.tenantId, ctx.conversationId);
            }
        } catch (err) {
            console.error('[submitReplyFromComposer] error', err);
            showNotification(err?.message || 'Failed to send reply', 'error');
            if (sendBtn) sendBtn.disabled = false;
        }
    }

    // Open chat history from Follow-ups / Leads by phone number
    async function openChatFromPhone(phone) {
        try {
            const tenantId = state.session?.tenantId;
            if (!tenantId) {
                showNotification('Session expired. Re-login required.', 'error');
                return;
            }
            const p = String(phone || '').trim();
            if (!p) {
                showNotification('Missing phone number', 'warning');
                return;
            }

            const resp = await fetch(`/api/followups/${tenantId}/conversation-by-phone?phone=${encodeURIComponent(p)}`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const data = await resp.json();
            if (!data?.success || !data?.conversationId) {
                throw new Error(data?.error || 'Failed to open chat');
            }

            await openConversation(tenantId, data.conversationId);
        } catch (err) {
            console.error('[openChatFromPhone] error', err);
            showNotification(err?.message || 'Failed to open chat history', 'error');
        }
    }
    // ---------- UI Components ----------
    const components = {
        statsCard(icon, title, value, change, color) {
            return `
                <div class="stat-card card-hover p-6 rounded-2xl animate-slide-up">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r ${color} rounded-xl flex items-center justify-center">
                            <i class="${icon} text-white text-xl"></i>
                        </div>
                        ${change ? `<span class="text-green-400 text-sm font-medium">+${change}%</span>` : ''}
                    </div>
                    <h3 class="text-white/70 text-sm font-medium mb-1">${title}</h3>
                    <p class="text-white text-3xl font-bold">${value}</p>
                </div>
            `;
        },

        conversationCard(conv) {
            const lastMessage = conv.lastMessage || 'No messages yet';
            const messagePreview = lastMessage.length > 80 ? lastMessage.substring(0, 80) + '...' : lastMessage;
            const heatEmojis = { 'COLD': '🔵', 'WARM': '🟡', 'HOT': '🟠', 'VERY_HOT': '🔴', 'ON_FIRE': '🔥' };
            const heatColors = { 'COLD': 'bg-blue-100 text-blue-800', 'WARM': 'bg-yellow-100 text-yellow-800', 'HOT': 'bg-orange-100 text-orange-800', 'VERY_HOT': 'bg-red-100 text-red-800', 'ON_FIRE': 'bg-red-500 text-white' };
            const heat = conv.heat || 'WARM';
            return `
                <div class="conversation-card p-6 rounded-2xl mb-4 border border-white/20">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-semibold text-gray-900">${escapeHtml(conv.end_user_phone || 'Unknown')}</h4>
                                    <span class="px-2 py-1 ${heatColors[heat]} text-xs rounded-full font-medium">${heatEmojis[heat]} ${heat.replace('_', ' ')}</span>
                                </div>
                                <p class="text-sm text-gray-500">State: ${escapeHtml(conv.state || 'Active')}</p>
                                ${conv.assigned_to ? `<p class="text-xs text-purple-600"><i class="fas fa-user-check mr-1"></i>Assigned to: Salesman #${conv.assigned_to}</p>` : ''}
                                ${conv.last_product_discussed ? `<p class="text-xs text-blue-600">Product: ${escapeHtml(conv.last_product_discussed)}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">${conv.updated_at ? new Date(conv.updated_at).toLocaleDateString() : ''}</span>
                            <button onclick="deleteConversation('${conv.id}')" class="delete-btn w-8 h-8 rounded-full bg-red-100 hover:bg-red-500 text-red-600 hover:text-white flex items-center justify-center">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl mb-4">
                        <p class="text-gray-700 text-sm">${escapeHtml(messagePreview)}</p>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-2">
                            <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full">${conv.messageCount || 0} messages</span>
                            ${conv.state === 'waiting' ? '<span class="px-3 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Needs follow-up</span>' : ''}
                        </div>
                        <button class="view-details-btn px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-sm rounded-xl" 
                                data-tenant-id="${state.session?.tenantId || ''}" data-conv-id="${conv.id}">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        },

        orderCard(order) {
            return `
                <div class="order-card conversation-card p-6 rounded-2xl mb-4 border border-white/20" data-order-id="${escapeHtml(order.id)}">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-teal-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-shopping-bag text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Order #${escapeHtml(String(order.id).substring(0, 8))}...</h4>
                                <p class="text-sm text-gray-500">${escapeHtml(order.customerName || order.conversation?.end_user_phone || 'N/A')}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-900">₹${Number(order.total || 0).toFixed(2)}</p>
                            <p class="text-sm text-gray-500">${order.created_at ? new Date(order.created_at).toLocaleDateString() : ''}</p>
                        </div>
                    </div>

                    ${order.discount > 0 ? `
                        <div class="bg-green-50 p-3 rounded-xl mb-4">
                            <p class="text-green-800 text-sm"><i class="fas fa-tag mr-2"></i>Discount Applied: ₹${Number(order.discount).toFixed(2)} saved!</p>
                        </div>
                    ` : ''}

                    ${order.shipping ? `
                        <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
                            <div class="bg-blue-50 p-2 rounded"><span class="text-blue-600">Shipping: ₹${Number(order.shipping).toFixed(2)}</span></div>
                            <div class="bg-purple-50 p-2 rounded"><span class="text-purple-600">GST: ₹${Number(order.gst || 0).toFixed(2)}</span></div>
                        </div>
                    ` : ''}

                    <div class="flex items-center justify-between space-x-3">
                        <span class="px-4 py-2 bg-green-100 text-green-800 text-sm rounded-xl font-medium">${escapeHtml(order.order_status || 'Confirmed')}</span>
                        <div class="flex space-x-2">
                            <button 
                              class="view-order-btn bg-blue-500 text-white px-3 py-1 rounded" 
                              data-order-id="${escapeHtml(order.id)}" 
                              data-tenant-id="${escapeHtml(state.session?.tenantId || '')}">
                              View Details
                            </button>
                            <button onclick="deleteOrder('${order.id}')" class="delete-btn w-10 h-10 rounded-xl bg-red-100 hover:bg-red-500 text-red-600 hover:text-white flex items-center justify-center">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    };

    // ---------- Tab & Load Management ----------
    function switchTab(tabName) {
        state.currentTab = tabName;
        
        // Update sidebar items
        document.querySelectorAll('.sidebar-item').forEach(item => {
            if (item.dataset.tab === tabName) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
        
        // Close sidebar on mobile after selection
        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('mobile-open');
        }
        
        return loadTabContent(tabName);
    }
    
    // Toggle sidebar collapse/expand
    const SIDEBAR_STORAGE_KEY = 'salesmate_sidebar_collapsed_v1';

    function setSidebarCollapsed(isCollapsed) {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleBtn = document.getElementById('sidebarToggle');
        const icon = document.getElementById('sidebarToggleIcon') || toggleBtn?.querySelector('i');

        if (!sidebar || !mainContent || !toggleBtn) return;

        sidebar.classList.toggle('collapsed', isCollapsed);
        mainContent.classList.toggle('expanded', isCollapsed);
        toggleBtn.classList.toggle('collapsed', isCollapsed);

        if (icon) {
            icon.classList.remove('fa-bars', 'fa-angles-left', 'fa-angles-right');
            icon.classList.add(isCollapsed ? 'fa-angles-right' : 'fa-angles-left');
        }
    }

    function initSidebarUI() {
        // Add a tooltip to each nav item so icon-only mode is usable.
        document.querySelectorAll('.sidebar-item').forEach((item) => {
            if (!item.getAttribute('title')) {
                const label = item.querySelector('span')?.textContent?.trim();
                if (label) item.setAttribute('title', label);
            }
        });

        // Apply persisted collapse state on desktop.
        try {
            const saved = localStorage.getItem(SIDEBAR_STORAGE_KEY);
            if (window.innerWidth > 768) setSidebarCollapsed(saved === '1');
            else setSidebarCollapsed(false);
        } catch (_) {
            // If storage is blocked, just default to expanded.
            setSidebarCollapsed(false);
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar) return;
        
        // On mobile, toggle sidebar visibility
        if (window.innerWidth <= 768) {
            sidebar.classList.toggle('mobile-open');
        } else {
            // On desktop, toggle collapse
            const nextCollapsed = !sidebar.classList.contains('collapsed');
            setSidebarCollapsed(nextCollapsed);
            try { localStorage.setItem(SIDEBAR_STORAGE_KEY, nextCollapsed ? '1' : '0'); } catch (_) {}
        }
    }

    async function loadTabContent(tabName) {
        const content = document.getElementById('tabContent');
        const customersTab = document.getElementById('customersTab');
        const websiteTab = document.getElementById('websiteTab');
        const statsSection = document.getElementById('statsSection');
        
        // Clear any auto-refresh intervals when switching tabs
        if (window.broadcastHistoryInterval && tabName !== 'broadcast') {
            clearInterval(window.broadcastHistoryInterval);
            window.broadcastHistoryInterval = null;
        }
        if (window.waWebStatusInterval && tabName !== 'whatsapp-web') {
            clearInterval(window.waWebStatusInterval);
            window.waWebStatusInterval = null;
        }
        
        // Show stats section only on overview/dashboard tab
        if (statsSection) {
            if (tabName === 'overview') {
                statsSection.classList.remove('hidden');
            } else {
                statsSection.classList.add('hidden');
            }
        }
        
        // Hide all tab content first
        content.classList.remove('hidden');
        if (customersTab) customersTab.classList.add('hidden');
        if (websiteTab) websiteTab.classList.add('hidden');
        const emailsTab = document.getElementById('emailsTab');
        if (emailsTab) emailsTab.classList.add('hidden');
        
        content.innerHTML = '<div class="flex justify-center py-20"><div class="loading-spinner"></div></div>';
        
        try {
            switch (tabName) {
                case 'overview': await loadOverview(); break;
                case 'conversations': await loadConversations(); break;
                case 'orders': await loadOrders(); break;
                case 'products': await loadProducts(); break;
                case 'settings': await loadSettings(); break;
                case 'analytics': await loadAnalytics(); break;
                case 'reports': await loadReports(); break;
                case 'activity-feed': await loadActivityFeed(); break;
                case 'audit-logs': await loadAuditLogs(); break;
                case 'broadcast': await loadBroadcast(); break;
                case 'templates': await loadMessageTemplates(); break;
                case 'unsubscribed': await loadUnsubscribed(); break;
                case 'whatsapp-web': await loadWhatsAppWeb(); break;
                case 'followups': await loadFollowUps(); break;
                case 'leads': await loadLeads(); break;
                case 'triage': await loadTriage(); break;
                case 'team': await loadTeam(); break;
                case 'tasks': await loadTasks(); break;
                case 'calls': await loadCalls(); break;
                case 'customers': 
                    content.classList.add('hidden');
                    if (customersTab) {
                        customersTab.classList.remove('hidden');
                        await loadCustomers();
                    } else {
                        content.classList.remove('hidden');
                        content.innerHTML = '<div class="p-8 text-red-500">Customers tab element not found.</div>';
                    }
                    break;
                case 'emails':
                    content.classList.add('hidden');
                    const emailsTab = document.getElementById('emailsTab');
                    if (emailsTab) {
                        emailsTab.classList.remove('hidden');
                        await loadEmails();
                    } else {
                        content.classList.remove('hidden');
                        content.innerHTML = '<div class="p-8 text-red-500">Emails tab element not found.</div>';
                    }
                    break;
                case 'documents':
                    content.classList.remove('hidden');
                    if (customersTab) customersTab.classList.add('hidden');
                    if (websiteTab) websiteTab.classList.add('hidden');
                    await loadDocuments();
                    break;
                case 'website':
                    content.classList.add('hidden');
                    if (websiteTab) {
                        websiteTab.classList.remove('hidden');
                        await loadWebsiteContent();
                    } else {
                        content.classList.remove('hidden');
                        content.innerHTML = '<div class="p-8 text-red-500">Website tab element not found.</div>';
                    }
                    break;
                default: 
                    content.innerHTML = '<div class="p-8">Unknown tab</div>';
            }
        } catch (err) {
            console.error('Error loading tab', tabName, err);
            content.innerHTML = `<div class="glass-effect p-8 rounded-2xl text-center"><i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i><h3 class="text-white text-xl font-semibold mb-2">Error Loading Data</h3><p class="text-white/70 mb-4">${escapeHtml(err.message || String(err))}</p><button onclick="loadTabContent('${tabName}')" class="px-6 py-2 bg-blue-600 text-white rounded-xl">Try Again</button></div>`;
        }
    }

    // ---------- Loaders ----------
    async function loadStats() {
        const data = await api.fetchData('stats');
        if (data.success) {
            state.data.stats = data.stats;
            document.getElementById('businessName').textContent = data.stats.businessName || 'Sales Dashboard';
            document.getElementById('statsGrid').innerHTML = [
                components.statsCard('fas fa-shopping-cart', 'Total Orders', data.stats.totalOrders || 0, data.stats.ordersChange || 0, 'from-blue-500 to-blue-600'),
                components.statsCard('fas fa-comments', 'Conversations', data.stats.totalConversations || 0, data.stats.convChange || 0, 'from-green-500 to-green-600'),
                components.statsCard('fas fa-box', 'Products', data.stats.totalProducts || 0, data.stats.productsChange || 0, 'from-purple-500 to-purple-600'),
                components.statsCard('fas fa-rupee-sign', 'Revenue', `₹${(data.stats.totalRevenue || 0)}`, data.stats.revenueChange || 0, 'from-yellow-500 to-yellow-600'),
                components.statsCard('fas fa-envelope', 'Messages', data.stats.totalMessages || 0, data.stats.messagesChange || 0, 'from-orange-500 to-orange-600')
            ].join('');
        }
    }

    async function loadOverview() {
        document.getElementById('tabContent').innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-effect p-6 rounded-2xl">
                    <h3 class="text-white text-xl font-semibold mb-4"><i class="fas fa-chart-line mr-2"></i>Sales Trend</h3>
                    <canvas id="salesChart" width="400" height="200"></canvas>
                </div>
                <div class="glass-effect p-6 rounded-2xl">
                    <h3 class="text-white text-xl font-semibold mb-4"><i class="fas fa-users mr-2"></i>Customer Activity</h3>
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="glass-effect p-6 rounded-2xl mt-8">
                <h3 class="text-white text-xl font-semibold mb-6"><i class="fas fa-tachometer-alt mr-2"></i>System Health</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center p-4 bg-green-500/20 rounded-xl border border-green-500/30">
                        <div class="text-3xl font-bold text-green-400 mb-2">98.7%</div>
                        <div class="text-green-300 text-sm">Uptime</div>
                    </div>
                    <div class="text-center p-4 bg-blue-500/20 rounded-xl border border-blue-500/30">
                        <div class="text-3xl font-bold text-blue-400 mb-2">1.2s</div>
                        <div class="text-blue-300 text-sm">Response Time</div>
                    </div>
                    <div class="text-center p-4 bg-purple-500/20 rounded-xl border border-purple-500/30">
                        <div class="text-3xl font-bold text-purple-400 mb-2">Active</div>
                        <div class="text-purple-300 text-sm">AI Status</div>
                    </div>
                </div>
            </div>
        `;
        setTimeout(initCharts, 80);
    }

    // ---------- Email Functions ----------
    let emailState = {
        currentPage: 0,
        limit: 20,
        total: 0,
        emails: [],
        searchQuery: '',
        filterRead: ''
    };

    async function loadEmails() {
        try {
            await fetchEmails();
            setupEmailEventListeners();
        } catch (err) {
            console.error('[EMAILS] Error loading emails:', err);
            showEmailError(err.message);
        }
    }

    async function fetchEmails() {
        const container = document.getElementById('emailListContainer');
        if (!container) return;

        const offset = emailState.currentPage * emailState.limit;
        let url = `api/email/list?limit=${emailState.limit}&offset=${offset}`;
        
        if (emailState.searchQuery) {
            url += `&search=${encodeURIComponent(emailState.searchQuery)}`;
        }
        if (emailState.filterRead) {
            url += `&read=${emailState.filterRead}`;
        }

        try {
            const response = await fetch(url, {
                headers: {
                    'x-api-key': localStorage.getItem('apiKey') || ''
                }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch emails: ${response.statusText}`);
            }

            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to load emails');
            }

            emailState.emails = data.emails || [];
            emailState.total = data.total || 0;

            renderEmails();
            updateEmailPagination();
        } catch (err) {
            console.error('[EMAILS] Fetch error:', err);
            showEmailError(err.message);
        }
    }

    function renderEmails() {
        const container = document.getElementById('emailListContainer');
        if (!container) return;

        if (emailState.emails.length === 0) {
            container.innerHTML = `
                <div class="glass-effect p-12 rounded-xl text-center">
                    <i class="fas fa-inbox text-6xl text-white/30 mb-4"></i>
                    <h3 class="text-white text-xl font-semibold mb-2">No Emails Found</h3>
                    <p class="text-white/70 mb-4">Connect your Gmail account to start receiving emails</p>
                    <button onclick="window.open('/api/email/gmail/auth?key=' + localStorage.getItem('apiKey'), '_blank')" 
                            class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700">
                        <i class="fas fa-plug mr-2"></i>Connect Gmail
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = emailState.emails.map(email => {
            const date = new Date(email.received_at || email.created_at);
            const dateStr = date.toLocaleString();
            const preview = extractTextFromHTML(email.body).substring(0, 150) + '...';
            
            return `
                <div class="glass-effect p-4 rounded-xl hover:bg-white/10 transition-all cursor-pointer" 
                     onclick="viewEmailDetail('${email.id}')">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1">
                                <i class="fas fa-envelope text-indigo-400"></i>
                                <span class="text-white font-semibold truncate">${escapeHtml(email.from_email || 'Unknown')}</span>
                            </div>
                            <h3 class="text-white text-lg font-semibold mb-1 truncate">${escapeHtml(email.subject || '(No Subject)')}</h3>
                        </div>
                        <div class="text-white/50 text-sm ml-4 whitespace-nowrap">
                            <i class="fas fa-clock mr-1"></i>${dateStr}
                        </div>
                    </div>
                    <p class="text-white/70 text-sm line-clamp-2">${escapeHtml(preview)}</p>
                    <div class="mt-3 flex items-center justify-between">
                        <div class="text-white/50 text-xs">
                            <i class="fas fa-calendar mr-1"></i>${date.toLocaleDateString()}
                        </div>
                        <button onclick="event.stopPropagation(); createLeadFromEmail('${email.id}')" 
                                class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg transition-colors">
                            <i class="fas fa-user-plus mr-1"></i>Create Lead
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function extractTextFromHTML(html) {
        const div = document.createElement('div');
        div.innerHTML = html || '';
        return div.textContent || div.innerText || '';
    }

    function updateEmailPagination() {
        const start = emailState.currentPage * emailState.limit + 1;
        const end = Math.min((emailState.currentPage + 1) * emailState.limit, emailState.total);
        
        document.getElementById('emailShowingStart').textContent = emailState.total > 0 ? start : 0;
        document.getElementById('emailShowingEnd').textContent = end;
        document.getElementById('emailTotalCount').textContent = emailState.total;
        
        const prevBtn = document.getElementById('emailPrevBtn');
        const nextBtn = document.getElementById('emailNextBtn');
        
        if (prevBtn) prevBtn.disabled = emailState.currentPage === 0;
        if (nextBtn) nextBtn.disabled = end >= emailState.total;
    }

    function setupEmailEventListeners() {
        const searchBtn = document.getElementById('emailSearchBtn');
        const searchInput = document.getElementById('emailSearchInput');
        const filterRead = document.getElementById('emailFilterRead');
        const prevBtn = document.getElementById('emailPrevBtn');
        const nextBtn = document.getElementById('emailNextBtn');

        if (searchBtn) {
            searchBtn.onclick = () => {
                emailState.searchQuery = searchInput?.value || '';
                emailState.filterRead = filterRead?.value || '';
                emailState.currentPage = 0;
                fetchEmails();
            };
        }

        if (searchInput) {
            searchInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    emailState.searchQuery = searchInput.value || '';
                    emailState.filterRead = filterRead?.value || '';
                    emailState.currentPage = 0;
                    fetchEmails();
                }
            };
        }

        if (prevBtn) {
            prevBtn.onclick = () => {
                if (emailState.currentPage > 0) {
                    emailState.currentPage--;
                    fetchEmails();
                }
            };
        }

        if (nextBtn) {
            nextBtn.onclick = () => {
                const maxPage = Math.ceil(emailState.total / emailState.limit) - 1;
                if (emailState.currentPage < maxPage) {
                    emailState.currentPage++;
                    fetchEmails();
                }
            };
        }
    }

    function showEmailError(message) {
        const container = document.getElementById('emailListContainer');
        if (!container) return;
        
        container.innerHTML = `
            <div class="glass-effect p-8 rounded-xl text-center">
                <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                <h3 class="text-white text-xl font-semibold mb-2">Error Loading Emails</h3>
                <p class="text-white/70 mb-4">${escapeHtml(message)}</p>
                <button onclick="fetchEmails()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700">
                    <i class="fas fa-redo mr-2"></i>Try Again
                </button>
            </div>
        `;
    }

    async function viewEmailDetail(emailId) {
        const email = emailState.emails.find(e => e.id === emailId);
        if (!email) return;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-slate-900 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-slate-900 border-b border-white/10 p-6 flex items-center justify-between z-10">
                    <h3 class="text-xl font-bold text-white">Email Details</h3>
                    <button onclick="this.closest('div.fixed').remove()" class="text-white/70 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-4 pb-4 border-b border-white/10">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="text-white/50 text-sm mb-1">From:</div>
                                <div class="text-white font-semibold">${escapeHtml(email.from_email || 'Unknown')}</div>
                            </div>
                            <div class="text-white/50 text-sm">
                                ${new Date(email.received_at || email.created_at).toLocaleString()}
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="text-white/50 text-sm mb-1">Subject:</div>
                            <div class="text-white font-semibold text-lg">${escapeHtml(email.subject || '(No Subject)')}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="createLeadFromEmail('${email.id}'); this.closest('div.fixed').remove();" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-user-plus mr-2"></i>Create Lead from Email
                            </button>
                        </div>
                    </div>
                    <div class="bg-white/5 p-6 rounded-xl">
                        <div class="text-white/90 leading-relaxed">
                            ${email.body || '<p class="text-white/50">No content</p>'}
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function syncGmailEmails() {
        try {
            const response = await fetch('api/email/gmail/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': localStorage.getItem('apiKey') || ''
                },
                body: JSON.stringify({ maxResults: 50 })
            });

            const data = await response.json();
            
            if (data.success) {
                alert(`Successfully synced ${data.ingested || 0} new emails!`);
                await fetchEmails();
            } else {
                alert('Error syncing emails: ' + (data.error || 'Unknown error'));
            }
        } catch (err) {
            console.error('[EMAILS] Sync error:', err);
            alert('Error syncing emails: ' + err.message);
        }
    }

    async function createLeadFromEmail(emailId) {
        const email = emailState.emails.find(e => e.id === emailId);
        if (!email) {
            alert('Email not found');
            return;
        }

        const confirmed = confirm(
            `Create lead from email?\n\nFrom: ${email.from_email || 'Unknown'}\nSubject: ${email.subject || '(No Subject)'}\n\nThis will create a lead inside Salesmate and run smart assignment.`
        );
        if (!confirmed) return;

        const apiKey = localStorage.getItem('apiKey') || '';

        try {
            const response = await fetch(`api/email/${encodeURIComponent(emailId)}/create-lead`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey
                }
            });

            const data = await response.json().catch(() => ({}));
            if (!response.ok || !data.success) {
                throw new Error(data.error || `Failed to create lead (${response.status})`);
            }

            const assignedName = data.assignedSalesman?.name || data.assignment?.salesman?.name || null;
            const conversationId = data.conversation?.id || null;

            let msg = data.created ? '✅ Lead created from email.' : '✅ Lead already existed for this email.';
            if (assignedName) msg += `\n\nAssigned to: ${assignedName}`;
            if (conversationId) msg += `\nConversation ID: ${conversationId}`;

            alert(msg);

            // Refresh list to show the email as processed/read + lead linkage
            await fetchEmails();

            // Optional: refresh leads if user is on the Leads tab
            try {
                if (typeof loadLeads === 'function') {
                    await loadLeads();
                }
            } catch (_) {}
        } catch (err) {
            console.error('[EMAILS] Create lead error:', err);
            alert('Error creating lead: ' + (err?.message || String(err)));
        }
    }

    async function loadConversations() {
        try {
            console.log('[DASHBOARD] Loading conversations...');
            const data = await api.fetchData('conversations');
            console.log('[DASHBOARD] Conversations data received:', data);
            
            const conversations = (data.conversations || []).map(c => {
                c.lastMessage = c.last_message || c.lastMessage || '';
                return c;
            });
            console.log('[DASHBOARD] Processed conversations:', conversations.length);
            
            state.data.conversations = conversations;
            
            // Get filter values
            const heatFilter = document.getElementById('heatFilter')?.value || '';
            
            const filtered = conversations.filter(conv => {
                // Search filter
                const matchesSearch = !state.searchQuery ||
                    (conv.end_user_phone || '').includes(state.searchQuery) ||
                    (conv.lastMessage || '').toLowerCase().includes(state.searchQuery.toLowerCase());
                
                // Heat filter
                const matchesHeat = !heatFilter || conv.heat === heatFilter;
                
                return matchesSearch && matchesHeat;
            });
            console.log('[DASHBOARD] Filtered conversations:', filtered.length);
            
            document.getElementById('tabContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-white text-2xl font-bold"><i class="fas fa-comments mr-3"></i>Recent Conversations</h2>
                    <div class="flex space-x-3">
                        <select id="heatFilter" class="search-input px-4 py-2 rounded-xl text-sm" onchange="loadConversations()">
                            <option value="">All Heat Levels</option>
                            <option value="ON_FIRE">🔥 On Fire</option>
                            <option value="VERY_HOT">🔴 Very Hot</option>
                            <option value="HOT">🟠 Hot</option>
                            <option value="WARM">🟡 Warm</option>
                            <option value="COLD">🔵 Cold</option>
                        </select>
                        <input type="text" id="conversationSearch" placeholder="Search conversations..." class="search-input px-4 py-2 rounded-xl text-sm" oninput="handleSearch(event)">
                        <button class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors"><i class="fas fa-filter mr-2"></i>More Filters</button>
                    </div>
                </div>
                <div class="space-y-4">
                    ${filtered.length ? filtered.map(conv => components.conversationCard(conv)).join('') : '<div class="glass-effect p-12 rounded-2xl text-center"><i class="fas fa-comments text-white/50 text-4xl mb-4"></i><p class="text-white/70 text-lg">No conversations found</p></div>'}
                </div>
            `;
        } catch (error) {
            console.error('[DASHBOARD] Error loading conversations:', error);
            document.getElementById('tabContent').innerHTML = `
                <div class="glass-effect p-12 rounded-2xl text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <p class="text-white/70 text-lg">Error loading conversations</p>
                    <p class="text-white/50 text-sm mt-2">${escapeHtml(error.message)}</p>
                </div>
            `;
        }
    }

    async function loadOrders() {
    // Collect filter values
    const customer = document.getElementById('orderCustomerInput')?.value.trim();
    const product = document.getElementById('orderProductInput')?.value.trim();
    const status = document.getElementById('orderStatusInput')?.value.trim();
    const minDate = document.getElementById('orderMinDate')?.value.trim();
    const maxDate = document.getElementById('orderMaxDate')?.value.trim();
    const minAmount = document.getElementById('orderMinAmount')?.value.trim();
    const maxAmount = document.getElementById('orderMaxAmount')?.value.trim();

    // Build query string
    const params = new URLSearchParams();
    if (customer) params.append('customer', customer);
    if (product) params.append('product', product);
    if (status) params.append('status', status);
    if (minDate) params.append('minDate', minDate);
    if (maxDate) params.append('maxDate', maxDate);
    if (minAmount) params.append('minAmount', minAmount);
    if (maxAmount) params.append('maxAmount', maxAmount);

        const url = `/api/dashboard/orders/${state.session.tenantId}${params.toString() ? '?' + params.toString() : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        state.data.orders = data.orders || [];
        document.getElementById('tabContent').innerHTML = `
            <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-6 gap-4">
                <div class="flex-1">
                    <h2 class="text-white text-2xl font-bold mb-2 md:mb-0"><i class="fas fa-shopping-cart mr-3"></i>Recent Orders</h2>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <input type="text" id="orderCustomerInput" placeholder="Customer name/phone" class="search-input px-4 py-2 rounded-xl text-sm w-40" value="${customer || ''}" />
                        <input type="text" id="orderProductInput" placeholder="Product name, SKU, or model" class="search-input px-4 py-2 rounded-xl text-sm w-48" />
                        <select id="orderStatusInput" class="search-input px-4 py-2 rounded-xl text-sm w-32">
                            <option value="">All Statuses</option>
                            <option value="pending"${status==='pending'?' selected':''}>Pending</option>
                            <option value="processing"${status==='processing'?' selected':''}>Processing</option>
                            <option value="completed"${status==='completed'?' selected':''}>Completed</option>
                            <option value="cancelled"${status==='cancelled'?' selected':''}>Cancelled</option>
                        </select>
                        <input type="date" id="orderMinDate" class="search-input px-4 py-2 rounded-xl text-sm w-36" value="${minDate || ''}" />
                        <input type="date" id="orderMaxDate" class="search-input px-4 py-2 rounded-xl text-sm w-36" value="${maxDate || ''}" />
                        <input type="number" id="orderMinAmount" placeholder="Min Amount" class="search-input px-4 py-2 rounded-xl text-sm w-28" value="${minAmount || ''}" />
                        <input type="number" id="orderMaxAmount" placeholder="Max Amount" class="search-input px-4 py-2 rounded-xl text-sm w-28" value="${maxAmount || ''}" />
                        <button id="orderSearchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700">Search</button>
                    </div>
                </div>
                <div class="flex space-x-3 mt-4 md:mt-0">
                    <button class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors"><i class="fas fa-download mr-2"></i>Export</button>
                </div>
            </div>
            <div class="space-y-4">
                ${state.data.orders.length ? state.data.orders.map(o => components.orderCard(o)).join('') : '<div class="glass-effect p-12 rounded-2xl text-center"><i class="fas fa-shopping-cart text-white/50 text-4xl mb-4"></i><p class="text-white/70 text-lg">No orders found</p></div>'}
            </div>
        `;

        // Add event listeners for search
        document.getElementById('orderSearchBtn')?.addEventListener('click', loadOrders);
        ['orderCustomerInput','orderProductInput','orderStatusInput','orderMinDate','orderMaxDate','orderMinAmount','orderMaxAmount'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') loadOrders(); });
        });
    }

    async function loadProducts() {
        // Get search value if present
        const searchValue = document.getElementById('productSearchInput')?.value?.trim() || '';
        // Send search param to backend if present
        let url = `products/performance`;
        if (searchValue) {
            url += `?search=${encodeURIComponent(searchValue)}`;
        }
        const data = await api.fetchData(url);
        state.data.products = data.products || [];

        // Fetch categories for mapping
        let categoryMap = {};
        try {
            const catRes = await fetch(`/api/categories?tenantId=${state.session.tenantId}`);
            const catData = await catRes.json();
            if (catData.success && Array.isArray(catData.categories)) {
                catData.categories.forEach(cat => {
                    categoryMap[cat.id] = cat.name;
                });
            }
        } catch (err) {
            console.warn('Failed to load categories for product cards:', err);
        }

        document.getElementById('tabContent').innerHTML = `
            <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-6 gap-4">
                <div class="flex-1">
                    <h2 class="text-white text-2xl font-bold mb-2 md:mb-0"><i class="fas fa-box mr-3"></i>Product Performance</h2>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <input type="text" id="productSearchInput" placeholder="Search by name, SKU, model..." class="search-input px-4 py-2 rounded-xl text-sm w-64" value="${searchValue}" />
                        <button id="productSearchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700">Search</button>
                    </div>
                </div>
                <div class="flex space-x-3 mt-4 md:mt-0">
                    <button id="addProductBtn" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors"><i class="fas fa-plus mr-2"></i>Add Product</button>
                    <button class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-green-600/20 transition-colors" id="bulkAddProductsBtn"><i class="fas fa-file-upload mr-2"></i>Bulk Add Products</button>
                    <button class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-purple-600/20 transition-colors" id="manageCategoriesBtn"><i class="fas fa-folder mr-2"></i>Manage Categories</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${state.data.products.length ? state.data.products.map(product => {
                    let categoryName = 'N/A';
                    if (product.category && categoryMap[product.category]) {
                        categoryName = categoryMap[product.category];
                    }
                    return `
                    <div class="conversation-card p-6 rounded-2xl">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-900 mb-2">${escapeHtml(product.name || '')}</h4>
                                <p class="text-3xl font-bold text-green-600 mb-1">₹${Number(product.revenue || 0).toFixed(2)}</p>
                                <p class="text-sm text-gray-500">Revenue Generated</p>
                                <p class="text-xs text-blue-600 mt-1">Category: ${escapeHtml(categoryName)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick='editProduct(${JSON.stringify(product).replace(/</g,"&lt;")})' class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm"><i class="fas fa-edit mr-2"></i>Edit</button>
                                <button onclick="deleteProduct('${product.id}')" class="delete-btn w-8 h-8 rounded-full bg-red-100 hover:bg-red-500 text-red-600 hover:text-white flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center p-3 bg-blue-50 rounded-xl"><div class="text-xl font-bold text-blue-600">${product.totalQuantity || 0}</div><div class="text-blue-500 text-sm">Sold</div></div>
                            <div class="text-center p-3 bg-green-50 rounded-xl"><div class="text-xl font-bold text-green-600">${product.totalOrders || 0}</div><div class="text-green-500 text-sm">Orders</div></div>
                        </div>
                        <div class="text-center"><span class="px-3 py-1 bg-gray-100 text-gray-800 text-sm rounded-full">₹${Number(product.price || 0).toFixed(2)} per unit</span></div>
                    </div>
                    `;
                }).join('') : '<div class="col-span-full glass-effect p-12 rounded-2xl text-center"><i class="fas fa-box text-white/50 text-4xl mb-4"></i><p class="text-white/70 text-lg">No products found</p></div>'}
    <!-- Bulk Add Products Modal -->
    <div id="bulkAddProductsModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40" onclick="document.getElementById('bulkAddProductsModal').classList.add('hidden')"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg p-6 overflow-auto max-h-[80vh]">
            <header class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Bulk Add Products</h2>
                <button onclick="document.getElementById('bulkAddProductsModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="space-y-3">
                <input type="file" id="bulkProductsFile" accept=".csv,.xlsx" class="w-full px-3 py-2 border rounded" />
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="document.getElementById('bulkAddProductsModal').classList.add('hidden')" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancel</button>
                    <button id="uploadBulkProductsBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">Upload & Add</button>
                </div>
                <div class="text-xs text-gray-500 mt-2">Accepted formats: CSV, Excel. Columns: name, sku, price, stock, brand, category, packaging_unit, units_per_carton, image_url</div>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="manageCategoriesModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40" onclick="document.getElementById('manageCategoriesModal').classList.add('hidden')"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg overflow-auto max-h-[80vh]">
            <header class="flex justify-between items-center p-6 border-b">
                <div>
                    <h2 class="text-xl font-bold"><i class="fas fa-folder mr-2"></i>Manage Categories</h2>
                    <p class="text-sm text-gray-500 mt-1">Organize your products by category</p>
                </div>
                <button onclick="document.getElementById('manageCategoriesModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="p-6">
                <div class="flex justify-end mb-4">
                    <button onclick="showAddCategoryModal()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add Category</button>
                </div>
                <div id="categoriesListContainer" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading categories...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
            </div>
        `;
        // Add event listeners for search
        document.getElementById('productSearchBtn')?.addEventListener('click', loadProducts);
        document.getElementById('productSearchInput')?.addEventListener('keydown', e => { if (e.key === 'Enter') loadProducts(); });
        
        // Re-initialize handlers after DOM update
        document.getElementById('addProductBtn')?.addEventListener('click', () => editProduct({}));
        initBulkUploadHandlers();
        initManageCategoriesHandler();
    }

    // ---------- Categories Management ----------
    async function loadCategories() {
        const container = document.getElementById('categoriesListContainer');
        if (!container) return;
        
        try {
            const response = await fetch(`/api/categories?tenantId=${state.session.tenantId}`);
            const data = await response.json();
            const categories = data.success ? data.categories || [] : [];
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-folder text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500 text-lg">No categories yet</p>
                        <p class="text-gray-400 text-sm mt-2">Click "Add Category" to create your first category</p>
                    </div>
                `;
            } else {
                container.innerHTML = categories.map(cat => `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${escapeHtml(cat.name)}</h4>
                            <p class="text-sm text-gray-500">${escapeHtml(cat.description || 'No description')}</p>
                        </div>
                        <button onclick="deleteCategory('${cat.id}')" class="ml-4 px-3 py-2 bg-red-100 hover:bg-red-500 text-red-600 hover:text-white rounded-lg transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error('Error loading categories:', err);
            container.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Failed to load categories</p>
                </div>
            `;
            showNotification('Failed to load categories: ' + err.message, 'error');
        }
    }

    function showAddCategoryModal() {
        const modalHtml = `
            <div id="addCategoryModal" class="modal fixed inset-0 z-50 flex items-center justify-center">
                <div class="modal-backdrop absolute inset-0 bg-black opacity-40" onclick="document.getElementById('addCategoryModal').remove()"></div>
                <div class="modal-content relative w-11/12 md:w-1/2 lg:w-1/3 bg-white rounded-lg shadow-lg p-6">
                    <header class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Add New Category</h2>
                        <button onclick="document.getElementById('addCategoryModal').remove()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
                    </header>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category Name *</label>
                            <input id="newCategoryName" type="text" class="w-full px-3 py-2 border rounded" placeholder="e.g., NFF, Electronics" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="newCategoryDesc" class="w-full px-3 py-2 border rounded" rows="3" placeholder="Optional description"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button onclick="document.getElementById('addCategoryModal').remove()" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancel</button>
                            <button onclick="saveNewCategory()" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Save Category</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    async function saveNewCategory() {
        const name = document.getElementById('newCategoryName')?.value.trim();
        const description = document.getElementById('newCategoryDesc')?.value.trim();
        
        if (!name) {
            showNotification('Category name is required', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/categories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tenantId: state.session.tenantId,
                    name,
                    description
                })
            });
            
            const result = await response.json();
            if (result.success) {
                showNotification('Category added successfully!', 'success');
                document.getElementById('addCategoryModal')?.remove();
                loadCategories(); // Reload categories
            } else {
                showNotification(result.error || 'Failed to add category', 'error');
            }
        } catch (err) {
            console.error('Error adding category:', err);
            showNotification('Failed to add category: ' + err.message, 'error');
        }
    }

    async function deleteCategory(categoryId) {
        if (!confirm('Are you sure you want to delete this category? This will unlink it from all products.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/categories/${categoryId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tenantId: state.session.tenantId })
            });
            
            const result = await response.json();
            if (result.success) {
                showNotification('Category deleted successfully!', 'success');
                loadCategories(); // Reload categories
            } else {
                showNotification(result.error || 'Failed to delete category', 'error');
            }
        } catch (err) {
            console.error('Error deleting category:', err);
            showNotification('Failed to delete category: ' + err.message, 'error');
        }
    }

    // FIXED: Customer loading function
    async function loadCustomers() {
        try {
            const tbody = document.getElementById('customerListBody');
            if (!tbody) {
                console.error('customerListBody not found');
                return;
            }
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Loading customers...</td></tr>';

            // Collect filter values
            const phone = document.getElementById('customerSearchInput')?.value.trim();
            const minSpent = document.getElementById('customerMinSpent')?.value.trim();
            const maxSpent = document.getElementById('customerMaxSpent')?.value.trim();
            const minOrderDate = document.getElementById('customerMinOrderDate')?.value.trim();
            const maxOrderDate = document.getElementById('customerMaxOrderDate')?.value.trim();

            // Build query string
            const params = new URLSearchParams();
            if (phone) params.append('phone', phone);
            if (minSpent) params.append('minSpent', minSpent);
            if (maxSpent) params.append('maxSpent', maxSpent);
            if (minOrderDate) params.append('minOrderDate', minOrderDate);
            if (maxOrderDate) params.append('maxOrderDate', maxOrderDate);

            const url = `/api/customers/list/${state.session.tenantId}${params.toString() ? '?' + params.toString() : ''}`;
            const response = await fetch(url);
            const data = await response.json();

            if (!data.success) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-red-500">Error: ${escapeHtml(data.error || 'Failed to load')}</td></tr>`;
                return;
            }

            const customers = data.customers || [];
            state.data.customers = customers;

            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customers.map(customer => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${escapeHtml(customer.name || 'N/A')}</td>
                    <td class="px-4 py-3">${escapeHtml(customer.phone)}</td>
                    <td class="px-4 py-3">${customer.last_order_date ? new Date(customer.last_order_date).toLocaleDateString() : 'Never'}</td>
                    <td class="px-4 py-3">${fmtINR(customer.total_spent || 0)}</td>
                    <td class="px-4 py-3">
                        <button onclick="editCustomer('${customer.id}')" class="text-blue-600 hover:underline text-sm">Edit</button>
                    </td>
                </tr>
            `).join('');

        } catch (error) {
            console.error('Error loading customers:', error);
            const tbody = document.getElementById('customerListBody');
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-red-500">Error: ${escapeHtml(error.message)}</td></tr>`;
            }
            showNotification('Failed to load customers', 'error');
        }
    }

    async function openCustomerModal(initial = {}) {
        const tenantId = state.session?.tenantId;
        if (!tenantId) {
            showNotification('Missing tenant session', 'error');
            return;
        }

        const existingModal = document.getElementById('customerEditModal');
        if (existingModal) existingModal.remove();

        const customer = initial.customer || null;
        const phone = (initial.phone || customer?.phone || customer?.phone_number || '').toString();
        const name = (initial.name || customer?.name || '').toString();

        const modal = document.createElement('div');
        modal.id = 'customerEditModal';
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">${customer?.id ? 'Edit Customer' : 'Add Customer'}</h3>
                    <button type="button" onclick="document.getElementById('customerEditModal')?.remove()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                </div>
                <form id="customerEditForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                        <input id="custPhone" type="text" class="w-full px-4 py-2 border rounded-xl" value="${escapeHtml(phone)}" ${customer?.id ? 'readonly' : ''} />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input id="custName" type="text" class="w-full px-4 py-2 border rounded-xl" value="${escapeHtml(name)}" placeholder="Customer name" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input id="custEmail" type="email" class="w-full px-4 py-2 border rounded-xl" value="${escapeHtml(customer?.email || '')}" placeholder="Email" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Type</label>
                        <select id="custType" class="w-full px-4 py-2 border rounded-xl">
                            <option value="retail" ${(customer?.customer_type || 'retail') === 'retail' ? 'selected' : ''}>Retail</option>
                            <option value="wholesale" ${(customer?.customer_type || '') === 'wholesale' ? 'selected' : ''}>Wholesale</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <input id="custAddress" type="text" class="w-full px-4 py-2 border rounded-xl" value="${escapeHtml(customer?.address || '')}" placeholder="Address" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                        <input id="custCity" type="text" class="w-full px-4 py-2 border rounded-xl" value="${escapeHtml(customer?.city || '')}" placeholder="City" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <input id="custState" type="text" class="w-full px-4 py-2 border rounded-xl" value="${escapeHtml(customer?.state || '')}" placeholder="State" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
                        <input id="custPincode" type="text" class="w-full px-4 py-2 border rounded-xl" value="${escapeHtml(customer?.pincode || '')}" placeholder="Pincode" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GST Number</label>
                        <input id="custGst" type="text" class="w-full px-4 py-2 border rounded-xl" value="${escapeHtml(customer?.gst_number || '')}" placeholder="GST" />
                    </div>
                    <div class="md:col-span-2 flex justify-end gap-3 mt-2">
                        <button type="button" onclick="document.getElementById('customerEditModal')?.remove()" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Save</button>
                    </div>
                </form>
            </div>
        `;

        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });

        document.getElementById('customerEditForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const phoneVal = document.getElementById('custPhone')?.value?.trim();
                if (!phoneVal) {
                    showNotification('Phone is required', 'warning');
                    return;
                }

                const payload = {
                    phone: phoneVal,
                    name: document.getElementById('custName')?.value?.trim() || null,
                    email: document.getElementById('custEmail')?.value?.trim() || null,
                    customer_type: document.getElementById('custType')?.value || 'retail',
                    address: document.getElementById('custAddress')?.value?.trim() || null,
                    city: document.getElementById('custCity')?.value?.trim() || null,
                    state: document.getElementById('custState')?.value?.trim() || null,
                    pincode: document.getElementById('custPincode')?.value?.trim() || null,
                    gst_number: document.getElementById('custGst')?.value?.trim() || null
                };

                const resp = await fetch(`/api/customers/upsert/${tenantId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await resp.json();
                if (!result.success) throw new Error(result.error || 'Failed to save customer');

                showNotification('Customer saved', 'success');
                document.getElementById('customerEditModal')?.remove();
                await loadCustomers();
            } catch (err) {
                console.error('[Customer Save] error', err);
                showNotification(err.message || 'Failed to save customer', 'error');
            }
        });
    }

    function editCustomer(customerId) {
        const customer = (state.data.customers || []).find(c => String(c.id) === String(customerId)) || null;
        if (!customer) {
            showNotification('Customer not found', 'warning');
            return;
        }
        openCustomerModal({ customer });
    }
    async function loadSettings() {
        const data = await api.fetchData('settings');
        const s = data.settings || {};
        state.data.settings = s;
        document.getElementById('tabContent').innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="config-card p-6 rounded-2xl">
                    <h3 class="text-gray-900 text-xl font-semibold mb-6"><i class="fas fa-shipping-fast mr-2 text-blue-600"></i>Shipping Configuration</h3>
                    <form id="shippingForm" class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Free Shipping Threshold</label>
                            <div class="relative"><span class="absolute left-3 top-3 text-gray-500">₹</span>
                            <input type="number" id="freeShippingThreshold" value="${s.free_shipping_threshold || 10000}" class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl"></div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Standard Rate (per carton)</label>
                                <div class="relative"><span class="absolute left-3 top-3 text-gray-500">₹</span>
                                <input type="number" id="standardShippingRate" value="${s.standard_shipping_rate || 20}" class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl"></div></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">High Volume Rate (15+ cartons)</label>
                                <div class="relative"><span class="absolute left-3 top-3 text-gray-500">₹</span>
                                <input type="number" id="bulkShippingRate" value="${s.bulk_shipping_rate || 15}" class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl"></div></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Bulk Threshold (cartons)</label>
                            <input type="number" id="bulkThreshold" value="${s.bulk_threshold || 15}" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></div>
                        <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl hover:from-blue-600 hover:to-blue-700">Save Shipping Settings</button>
                    </form>
                </div>

                <div class="config-card p-6 rounded-2xl">
                    <h3 class="text-gray-900 text-xl font-semibold mb-6"><i class="fas fa-percentage mr-2 text-purple-600"></i>GST Configuration</h3>
                    <form id="gstForm" class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">GST Rate (%)</label>
                            <input type="number" id="gstRate" step="0.01" value="${s.gst_rate || 18}" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Business State</label>
                            <select id="businessState" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                <option value="maharashtra" ${s.business_state==='maharashtra'?'selected':''}>Maharashtra</option>
                                <option value="gujarat" ${s.business_state==='gujarat'?'selected':''}>Gujarat</option>
                                <option value="karnataka" ${s.business_state==='karnataka'?'selected':''}>Karnataka</option>
                                <option value="tamil_nadu" ${s.business_state==='tamil_nadu'?'selected':''}>Tamil Nadu</option>
                                <option value="delhi" ${s.business_state==='delhi'?'selected':''}>Delhi</option>
                                <option value="other" ${s.business_state==='other'?'selected':''}>Other</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white py-3 rounded-xl hover:from-purple-600 hover:to-purple-700">Save GST Settings</button>
                    </form>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <div class="config-card p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-gray-900 text-xl font-semibold"><i class="fas fa-robot mr-2 text-indigo-600"></i>AI Keys</h3>
                        <span class="text-xs px-3 py-1 rounded-full ${s.openai_api_key_set || s.anthropic_api_key_set || s.gemini_api_key_set ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                            ${s.openai_api_key_set || s.anthropic_api_key_set || s.gemini_api_key_set ? 'Configured' : 'Not configured'}
                        </span>
                    </div>
                    <form id="aiKeysForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key</label>
                            <input type="password" id="openaiApiKey" autocomplete="new-password" placeholder="${s.openai_api_key_set ? '•••••••• (saved)' : 'sk-...'}" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                            <p class="text-xs text-gray-500 mt-1">Leave blank to keep the currently saved key.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">OpenAI Project (optional)</label>
                                <input type="text" id="openaiProject" value="${escapeHtml(s.openai_project || '')}" placeholder="proj_..." class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">OpenAI Model (optional)</label>
                                <input type="text" id="openaiModel" value="${escapeHtml(s.openai_model || '')}" placeholder="grok-code-fast-1" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Anthropic API Key (optional)</label>
                            <input type="password" id="anthropicApiKey" autocomplete="new-password" placeholder="${s.anthropic_api_key_set ? '•••••••• (saved)' : 'sk-ant-...'}" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key (optional)</label>
                            <input type="password" id="geminiApiKey" autocomplete="new-password" placeholder="${s.gemini_api_key_set ? '•••••••• (saved)' : 'AIza...'}" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-indigo-500 to-indigo-600 text-white py-3 rounded-xl hover:from-indigo-600 hover:to-indigo-700">Save AI Settings</button>
                    </form>
                </div>

                <div class="config-card p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-gray-900 text-xl font-semibold"><i class="fas fa-comment-dots mr-2 text-green-600"></i>Maytapi Configuration</h3>
                        <span class="text-xs px-3 py-1 rounded-full ${s.maytapi_api_key_set ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                            ${s.maytapi_api_key_set ? 'Configured' : 'Not configured'}
                        </span>
                    </div>
                    <form id="maytapiForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maytapi Product ID</label>
                            <input type="text" id="maytapiProductId" value="${escapeHtml(s.maytapi_product_id || '')}" placeholder="product_id" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maytapi Phone ID</label>
                            <input type="text" id="maytapiPhoneId" value="${escapeHtml(s.maytapi_phone_id || '')}" placeholder="phone_id" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maytapi API Key</label>
                            <input type="password" id="maytapiApiKey" autocomplete="new-password" placeholder="${s.maytapi_api_key_set ? '•••••••• (saved)' : 'api_key'}" class="w-full px-4 py-3 border border-gray-300 rounded-xl" />
                            <p class="text-xs text-gray-500 mt-1">Leave blank to keep the currently saved key.</p>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-xl hover:from-green-600 hover:to-green-700">Save Maytapi Settings</button>
                    </form>
                </div>
            </div>

            <div class="config-card p-6 rounded-2xl mt-8">
                <h3 class="text-gray-900 text-xl font-semibold mb-6"><i class="fas fa-building mr-2 text-green-600"></i>Business Information</h3>
                <form id="businessForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Business Name</label><input type="text" id="businessName" value="${s.business_name || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">GSTIN</label><input type="text" id="gstin" value="${s.gstin || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Business Address</label><textarea id="businessAddress" rows="3" class="w-full px-4 py-3 border rounded-xl">${s.business_address || ''}</textarea></div>
                    <div class="md:col-span-2"><button type="submit" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl hover:from-green-600 hover:to-green-700">Save Business Information</button></div>
                </form>
            </div>

            <div class="config-card p-6 rounded-2xl mt-8">
                <h3 class="text-gray-900 text-xl font-semibold mb-6"><i class="fas fa-sync mr-2 text-orange-600"></i>Zoho Integration</h3>
                <div class="space-y-4">
                    <p class="text-gray-600 text-sm mb-4">Manually sync data from Zoho Books to update products, customers, and orders.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="syncProductsBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all flex items-center justify-center">
                            <i class="fas fa-box mr-2"></i> Sync Products
                        </button>
                        <button id="syncCustomersBtn" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-4 rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all flex items-center justify-center">
                            <i class="fas fa-users mr-2"></i> Sync Customers
                        </button>
                        <button id="syncOrdersBtn" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4 rounded-xl hover:from-green-600 hover:to-green-700 transition-all flex items-center justify-center">
                            <i class="fas fa-shopping-cart mr-2"></i> Sync Orders
                        </button>
                    </div>
                    <div id="syncStatus" class="mt-4 p-4 rounded-xl hidden">
                        <p class="text-sm"></p>
                    </div>
                </div>
            </div>
        `;
        attachSettingsHandlers();
    }

    async function loadAnalytics() {
        const data = await api.fetchData('analytics');
        const analytics = data.analytics || {};
        const perf = Array.isArray(analytics.salesmenPerformance) ? analytics.salesmenPerformance : [];
        document.getElementById('tabContent').innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="config-card p-6 rounded-2xl"><h3 class="text-gray-900 text-xl font-semibold mb-6">Revenue Breakdown</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-xl"><div><span class="text-gray-700 font-medium">Product Revenue</span><p class="text-sm text-gray-500">Base product sales</p></div><span class="text-blue-600 text-xl font-bold">₹${analytics.productRevenue || 0}</span></div>
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-xl"><div><span class="text-gray-700 font-medium">Shipping Revenue</span><p class="text-sm text-gray-500">Collected shipping charges</p></div><span class="text-green-600 text-xl font-bold">₹${analytics.shippingRevenue || 0}</span></div>
                        <div class="flex justify-between items-center p-4 bg-purple-50 rounded-xl"><div><span class="text-gray-700 font-medium">GST Collected</span><p class="text-sm text-gray-500">Total tax collected</p></div><span class="text-purple-600 text-xl font-bold">₹${analytics.gstCollected || 0}</span></div>
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl border-2 border-gray-200"><div><span class="text-gray-900 font-bold">Total Revenue</span><p class="text-sm text-gray-500">All sources combined</p></div><span class="text-gray-900 text-2xl font-bold">₹${analytics.totalRevenue || 0}</span></div>
                    </div>
                </div>
                <div class="config-card p-6 rounded-2xl"><h3 class="text-gray-900 text-xl font-semibold mb-6">Performance Metrics</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-xl"><div><div class="text-gray-900 font-semibold">Average Order Value</div><div class="text-gray-600 text-sm">Per transaction</div></div><div class="text-2xl font-bold text-yellow-600">₹${analytics.avgOrderValue || 0}</div></div>
                        <div class="flex items-center justify-between p-4 bg-blue-50 rounded-xl"><div><div class="text-gray-900 font-semibold">Conversion Rate</div><div class="text-gray-600 text-sm">Conversations to orders</div></div><div class="text-2xl font-bold text-blue-600">${analytics.conversionRate || 0}%</div></div>
                        <div class="flex items-center justify-between p-4 bg-green-50 rounded-xl"><div><div class="text-gray-900 font-semibold">Response Rate</div><div class="text-gray-600 text-sm">Customer engagement</div></div><div class="text-2xl font-bold text-green-600">${analytics.responseRate || 0}%</div></div>
                        <div class="flex items-center justify-between p-4 bg-purple-50 rounded-xl"><div><div class="text-gray-900 font-semibold">Avg. Cart Size</div><div class="text-gray-600 text-sm">Items per order</div></div><div class="text-2xl font-bold text-purple-600">${analytics.avgCartSize || 0}</div></div>
                    </div>
                </div>
            </div>

            <div class="config-card p-6 rounded-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-900 text-xl font-semibold">Sales Team Performance (All Salesmen)</h3>
                    <div class="text-sm text-gray-500">Last ${analytics.period || 30} days</div>
                </div>

                ${perf.length ? `
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr class="text-left text-gray-600">
                                    <th class="py-2 pr-4">Salesman</th>
                                    <th class="py-2 pr-4">Leads</th>
                                    <th class="py-2 pr-4">Open</th>
                                    <th class="py-2 pr-4">Orders</th>
                                    <th class="py-2 pr-4">Revenue</th>
                                    <th class="py-2 pr-4">Conv%</th>
                                    <th class="py-2 pr-4">Heat (🔥/VH/H/W/C)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${perf.map(s => {
                                    const heat = s.heat || {};
                                    const heatText = `${Number(heat.ON_FIRE||0)}/${Number(heat.VERY_HOT||0)}/${Number(heat.HOT||0)}/${Number(heat.WARM||0)}/${Number(heat.COLD||0)}`;
                                    return `
                                        <tr class="border-t border-gray-200">
                                            <td class="py-3 pr-4">
                                                <div class="font-semibold text-gray-900">${escapeHtml(String(s.name || 'Salesman'))}</div>
                                                ${s.phone ? `<div class="text-xs text-gray-500">${escapeHtml(String(s.phone))}</div>` : ''}
                                            </td>
                                            <td class="py-3 pr-4 text-gray-900 font-medium">${Number(s.leads)||0}</td>
                                            <td class="py-3 pr-4 text-gray-900">${Number(s.openLeads)||0}</td>
                                            <td class="py-3 pr-4 text-gray-900">${Number(s.orders)||0}</td>
                                            <td class="py-3 pr-4 text-gray-900 font-semibold">${fmtINR(s.revenue||0)}</td>
                                            <td class="py-3 pr-4 text-gray-900">${Number(s.conversionRate)||0}%</td>
                                            <td class="py-3 pr-4 text-gray-700 font-mono">${heatText}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : `
                    <div class="p-6 rounded-xl bg-gray-50 border border-gray-200 text-gray-600">
                        No salesmen performance data available yet. Add salesmen and ensure leads are assigned.
                    </div>
                `}
            </div>
        `;
    }

    async function loadReports() {
        const data = await api.fetchData('reports');
        if (!data.success) throw new Error(data.error || 'Failed to load reports');

        const reports = data.reports || {};
        const triage = reports.triage || {};
        const triageByStatus = triage.byStatus || {};
        const pipeline = reports.leadsPipeline || {};
        const broadcasts = reports.broadcasts || {};
        const today = broadcasts.today || {};
        const audit = reports.audit || {};

        const stageRows = Array.isArray(pipeline.stages) ? pipeline.stages : [];

        const triageCards = [
            { label: 'New', value: triageByStatus.NEW || 0 },
            { label: 'In Progress', value: triageByStatus.IN_PROGRESS || 0 },
            { label: 'Closed', value: triageByStatus.CLOSED || 0 },
            { label: 'Total', value: triage.total || 0 }
        ];

        document.getElementById('tabContent').innerHTML = `
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-white text-2xl font-bold"><i class="fas fa-clipboard-check mr-3"></i>Reports</h2>
                <div class="text-white/70 text-sm">Snapshot</div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="config-card p-6 rounded-2xl">
                    <h3 class="text-gray-900 text-xl font-semibold mb-6">Triage</h3>
                    <div class="grid grid-cols-2 gap-4">
                        ${triageCards.map(c => `
                            <div class="p-4 rounded-xl bg-gray-50 border border-gray-200">
                                <div class="text-gray-600 text-sm">${escapeHtml(c.label)}</div>
                                <div class="text-gray-900 text-2xl font-bold">${Number(c.value) || 0}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="config-card p-6 rounded-2xl">
                    <h3 class="text-gray-900 text-xl font-semibold mb-6">Broadcasts (Today)</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 rounded-xl bg-green-50 border border-green-200">
                            <div class="text-green-800 text-sm">Sent</div>
                            <div class="text-green-900 text-2xl font-bold">${Number(today.sent) || 0}</div>
                        </div>
                        <div class="p-4 rounded-xl bg-red-50 border border-red-200">
                            <div class="text-red-800 text-sm">Failed</div>
                            <div class="text-red-900 text-2xl font-bold">${Number(today.failed) || 0}</div>
                        </div>
                        <div class="p-4 rounded-xl bg-yellow-50 border border-yellow-200">
                            <div class="text-yellow-800 text-sm">Pending</div>
                            <div class="text-yellow-900 text-2xl font-bold">${Number(today.pending) || 0}</div>
                        </div>
                        <div class="p-4 rounded-xl bg-gray-50 border border-gray-200">
                            <div class="text-gray-600 text-sm">Total</div>
                            <div class="text-gray-900 text-2xl font-bold">${Number(today.total) || 0}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="config-card p-6 rounded-2xl">
                    <h3 class="text-gray-900 text-xl font-semibold mb-6">Leads Pipeline</h3>
                    <div class="space-y-3">
                        ${stageRows.length ? stageRows.map(s => `
                            <div class="flex items-center justify-between p-4 rounded-xl bg-gray-50 border border-gray-200">
                                <div class="text-gray-900 font-medium">${escapeHtml(String(s.name || 'Stage'))}</div>
                                <div class="text-gray-900 font-bold">${Number(s.count) || 0}</div>
                            </div>
                        `).join('') : `
                            <div class="p-6 rounded-xl bg-gray-50 border border-gray-200 text-gray-600">No pipeline stages found</div>
                        `}
                        <div class="flex items-center justify-between p-4 rounded-xl bg-white border border-gray-200">
                            <div class="text-gray-900 font-semibold">Total Leads</div>
                            <div class="text-gray-900 text-lg font-bold">${Number(pipeline.total) || 0}</div>
                        </div>
                    </div>
                </div>

                <div class="config-card p-6 rounded-2xl">
                    <h3 class="text-gray-900 text-xl font-semibold mb-6">Audit Activity</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 rounded-xl bg-blue-50 border border-blue-200">
                            <div class="text-blue-800 text-sm">Last 24h</div>
                            <div class="text-blue-900 text-2xl font-bold">${Number(audit.last24h) || 0}</div>
                        </div>
                        <div class="p-4 rounded-xl bg-gray-50 border border-gray-200">
                            <div class="text-gray-600 text-sm">Loaded (recent)</div>
                            <div class="text-gray-900 text-2xl font-bold">${Number(audit.total) || 0}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function loadAuditLogs() {
        const data = await api.fetchData('audit-logs');
        if (!data.success) throw new Error(data.error || 'Failed to load audit logs');

        const logs = Array.isArray(data.logs) ? data.logs : [];

        document.getElementById('tabContent').innerHTML = `
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-white text-2xl font-bold"><i class="fas fa-clipboard-list mr-3"></i>Audit Logs</h2>
                <div class="text-white/70 text-sm">Showing ${logs.length} recent events</div>
            </div>

            <div class="glass-effect rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-white/10">
                                <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Time</th>
                                <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Action</th>
                                <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Entity</th>
                                <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Summary</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logs.length ? logs.map((l) => {
                                const when = l.created_at ? new Date(l.created_at).toLocaleString() : '';
                                const action = escapeHtml(String(l.action || ''));
                                const entity = escapeHtml([l.entity_type, l.entity_id].filter(Boolean).join(': '));
                                const summary = escapeHtml(String(l.summary || ''));
                                return `
                                    <tr class="border-t border-white/10 hover:bg-white/5">
                                        <td class="px-6 py-4 text-white/70 text-sm whitespace-nowrap">${when}</td>
                                        <td class="px-6 py-4 text-white text-sm font-medium">${action}</td>
                                        <td class="px-6 py-4 text-white/70 text-sm">${entity || '-'}</td>
                                        <td class="px-6 py-4 text-white/70 text-sm">${summary || '-'}</td>
                                    </tr>
                                `;
                            }).join('') : `
                                <tr>
                                    <td colspan="4" class="px-6 py-10 text-center text-white/70">No audit events yet</td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function getActivityIcon(action) {
        const a = String(action || '').toLowerCase();
        if (a.includes('create')) return 'fas fa-plus-circle';
        if (a.includes('update') || a.includes('edit')) return 'fas fa-pen-to-square';
        if (a.includes('assign')) return 'fas fa-user-check';
        if (a.includes('close') || a.includes('resolve')) return 'fas fa-check-circle';
        if (a.includes('reopen')) return 'fas fa-rotate-left';
        if (a.includes('delete')) return 'fas fa-trash';
        if (a.includes('pipeline')) return 'fas fa-diagram-project';
        if (a.includes('triage')) return 'fas fa-life-ring';
        return 'fas fa-bolt';
    }

    async function loadActivityFeed() {
        const data = await api.fetchData('audit-logs');
        if (!data.success) throw new Error(data.error || 'Failed to load activity feed');

        const logs = Array.isArray(data.logs) ? data.logs : [];

        document.getElementById('tabContent').innerHTML = `
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-white text-2xl font-bold"><i class="fas fa-stream mr-3"></i>Activity Feed</h2>
                <div class="text-white/70 text-sm">Showing ${logs.length} recent events</div>
            </div>

            <div class="space-y-4">
                ${logs.length ? logs.map((l) => {
                    const when = l.created_at ? new Date(l.created_at).toLocaleString() : '';
                    const action = escapeHtml(String(l.action || ''));
                    const summary = escapeHtml(String(l.summary || ''));
                    const entity = escapeHtml([l.entity_type, l.entity_id].filter(Boolean).join(': '));
                    const actor = escapeHtml(String(l.actor_name || l.actor_type || ''));
                    const icon = getActivityIcon(l.action);
                    return `
                        <div class="glass-effect rounded-2xl p-5">
                            <div class="flex items-start gap-4">
                                <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center flex-shrink-0">
                                    <i class="${icon} text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between gap-4">
                                        <div class="text-white font-semibold">${summary || action || 'Event'}</div>
                                        <div class="text-white/60 text-xs whitespace-nowrap">${when}</div>
                                    </div>
                                    <div class="mt-1 text-white/70 text-sm">
                                        ${action ? `<span class="font-medium text-white/80">${action}</span>` : ''}
                                        ${entity ? `<span class="ml-2">• ${entity}</span>` : ''}
                                        ${actor ? `<span class="ml-2">• ${actor}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : `
                    <div class="glass-effect p-10 rounded-2xl text-center text-white/70">No activity yet</div>
                `}
            </div>
        `;
    }

    // -------- Message Templates --------
    window._templateEditor = window._templateEditor || { editingId: null };

    function getTemplateFormValues() {
        const name = (document.getElementById('tmplName')?.value || '').trim();
        const category = (document.getElementById('tmplCategory')?.value || '').trim();
        const text = (document.getElementById('tmplText')?.value || '').trim();
        const variablesRaw = (document.getElementById('tmplVars')?.value || '').trim();
        const isActive = !!document.getElementById('tmplActive')?.checked;

        let variables = variablesRaw || '[]';
        // Keep it permissive: accept JSON arrays/objects or comma-separated strings.
        try {
            const parsed = JSON.parse(variables);
            variables = parsed;
        } catch {
            const parts = variablesRaw
                .split(',')
                .map(s => s.trim())
                .filter(Boolean);
            variables = parts.length ? parts : [];
        }

        return { name, category: category || null, templateText: text, variables, isActive };
    }

    function fillTemplateForm(t) {
        const name = t?.name || '';
        const category = t?.category || '';
        const text = t?.template_text || '';
        const vars = t?.variables || '[]';
        const active = (t?.is_active == null) ? true : !!Number(t.is_active);

        const elName = document.getElementById('tmplName');
        const elCat = document.getElementById('tmplCategory');
        const elText = document.getElementById('tmplText');
        const elVars = document.getElementById('tmplVars');
        const elActive = document.getElementById('tmplActive');

        if (elName) elName.value = name;
        if (elCat) elCat.value = category;
        if (elText) elText.value = text;
        if (elVars) elVars.value = (typeof vars === 'string') ? vars : JSON.stringify(vars);
        if (elActive) elActive.checked = active;
    }

    function clearTemplateForm() {
        window._templateEditor.editingId = null;
        fillTemplateForm({ name: '', category: '', template_text: '', variables: '[]', is_active: 1 });
        const title = document.getElementById('tmplFormTitle');
        if (title) title.textContent = 'New Template';
        const cancelBtn = document.getElementById('tmplCancelBtn');
        if (cancelBtn) cancelBtn.classList.add('hidden');
    }

    async function fetchTemplates() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) throw new Error('No tenant session');
        const res = await fetch(`/api/broadcast/templates/${tenantId}`, { headers: { ...api.authHeaders() } });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed to load templates');
        return Array.isArray(data.templates) ? data.templates : [];
    }

    async function saveTemplate() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) throw new Error('No tenant session');

        const v = getTemplateFormValues();
        if (!v.name || !v.templateText) {
            showNotification('Template name and text are required', 'warning');
            return;
        }

        const payload = {
            tenantId,
            // back-compat keys supported by API
            templateName: v.name,
            messageText: v.templateText,
            // explicit keys
            name: v.name,
            templateText: v.templateText,
            category: v.category,
            variables: v.variables,
            isActive: v.isActive
        };

        if (window._templateEditor.editingId) {
            const id = window._templateEditor.editingId;
            const r = await api.putJSON(`/api/broadcast/templates/${id}`, payload);
            if (!r.success) throw new Error(r.error || 'Failed to update template');
            showNotification('Template updated', 'success');
        } else {
            const r = await api.postJSON('/api/broadcast/templates', payload);
            if (!r.success) throw new Error(r.error || 'Failed to create template');
            showNotification('Template created', 'success');
        }

        await loadMessageTemplates();
        clearTemplateForm();
    }

    async function deleteTemplate(templateId) {
        if (!templateId) return;
        if (!confirm('Delete this template?')) return;
        const res = await fetch(`/api/broadcast/templates/${templateId}`, {
            method: 'DELETE',
            headers: { ...api.authHeaders() }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed to delete template');
        showNotification('Template deleted', 'success');
        await loadMessageTemplates();
        if (window._templateEditor.editingId === templateId) clearTemplateForm();
    }

    function editTemplate(t) {
        window._templateEditor.editingId = t?.id || null;
        fillTemplateForm(t);
        const title = document.getElementById('tmplFormTitle');
        if (title) title.textContent = 'Edit Template';
        const cancelBtn = document.getElementById('tmplCancelBtn');
        if (cancelBtn) cancelBtn.classList.remove('hidden');
    }

    async function loadMessageTemplates() {
        const templates = await fetchTemplates();

        document.getElementById('tabContent').innerHTML = `
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-white text-2xl font-bold"><i class="fas fa-message mr-3"></i>Message Templates</h2>
                <div class="text-white/70 text-sm">${templates.length} templates</div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="config-card p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <h3 id="tmplFormTitle" class="text-gray-900 text-xl font-semibold">New Template</h3>
                        <button id="tmplCancelBtn" class="hidden text-sm px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300" onclick="clearTemplateForm()">Cancel</button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Template Name</label>
                            <input id="tmplName" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g. Payment Follow-up" />
                        </div>

                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Category (optional)</label>
                            <input id="tmplCategory" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g. followup" />
                        </div>

                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Message Text</label>
                            <textarea id="tmplText" rows="5" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Write the template message..."></textarea>
                        </div>

                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Variables (JSON or comma-separated)</label>
                            <input id="tmplVars" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder='e.g. ["name","order_id"]' value="[]" />
                        </div>

                        <label class="flex items-center gap-2 text-sm text-gray-800">
                            <input id="tmplActive" type="checkbox" class="rounded" checked />
                            Active
                        </label>

                        <button class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-4 rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all" onclick="saveTemplate()">
                            <i class="fas fa-save mr-2"></i>Save Template
                        </button>
                    </div>
                </div>

                <div class="glass-effect p-0 rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-white/10">
                                    <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Name</th>
                                    <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Category</th>
                                    <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Active</th>
                                    <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${templates.length ? templates.map((t) => {
                                    const name = escapeHtml(String(t.name || ''));
                                    const category = escapeHtml(String(t.category || ''));
                                    const active = (t.is_active == null) ? 'Yes' : (Number(t.is_active) ? 'Yes' : 'No');
                                    return `
                                        <tr class="border-t border-white/10 hover:bg-white/5">
                                            <td class="px-6 py-4 text-white text-sm font-medium">${name || '-'}</td>
                                            <td class="px-6 py-4 text-white/70 text-sm">${category || '-'}</td>
                                            <td class="px-6 py-4 text-white/70 text-sm">${active}</td>
                                            <td class="px-6 py-4 text-white/70 text-sm whitespace-nowrap">
                                                <button class="px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 mr-2" onclick='editTemplate(${JSON.stringify({
                                                    id: t.id,
                                                    name: t.name,
                                                    category: t.category,
                                                    template_text: t.template_text,
                                                    variables: t.variables,
                                                    is_active: t.is_active
                                                }).replace(/'/g, "\\'")})'>Edit</button>
                                                <button class="px-3 py-1 rounded-lg bg-red-500/30 hover:bg-red-500/40" onclick="deleteTemplate('${t.id}')">Delete</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') : `
                                    <tr>
                                        <td colspan="4" class="px-6 py-10 text-center text-white/70">No templates yet</td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        // Ensure form is reset on first load
        clearTemplateForm();
    }

    // -------- Unsubscribed (Opt-out list) --------
    async function fetchUnsubscribed() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) throw new Error('No tenant session');
        const res = await fetch(`/api/broadcast/unsubscribed/${tenantId}`, { headers: { ...api.authHeaders() } });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed to load unsubscribed list');
        return Array.isArray(data.items) ? data.items : [];
    }

    async function addUnsubscribed() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) throw new Error('No tenant session');
        const raw = (document.getElementById('unsubPhone')?.value || '').trim();
        const phone = raw.replace(/\D/g, '');
        if (!phone) {
            showNotification('Enter a phone number', 'warning');
            return;
        }

        const res = await api.postJSON(`/api/broadcast/unsubscribed/${tenantId}`, { phone_number: phone });
        if (!res.success) throw new Error(res.error || 'Failed to add number');
        showNotification('Added to unsubscribed list', 'success');
        const el = document.getElementById('unsubPhone');
        if (el) el.value = '';
        await loadUnsubscribed();
    }

    async function removeUnsubscribed(phoneNumber) {
        const tenantId = state.session?.tenantId;
        if (!tenantId) throw new Error('No tenant session');
        const p = String(phoneNumber || '').replace(/\D/g, '');
        if (!p) return;
        if (!confirm(`Remove ${p} from unsubscribed list?`)) return;

        const res = await fetch(`/api/broadcast/unsubscribed/${tenantId}/${p}`, {
            method: 'DELETE',
            headers: { ...api.authHeaders() }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed to remove number');
        showNotification('Removed', 'success');
        await loadUnsubscribed();
    }

    async function loadUnsubscribed() {
        const items = await fetchUnsubscribed();

        document.getElementById('tabContent').innerHTML = `
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-white text-2xl font-bold"><i class="fas fa-user-slash mr-3"></i>Unsubscribed</h2>
                <div class="text-white/70 text-sm">${items.length} numbers</div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="config-card p-6 rounded-2xl">
                    <h3 class="text-gray-900 text-xl font-semibold mb-4">Add Number</h3>
                    <div class="flex gap-3">
                        <input id="unsubPhone" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Phone number (digits only is ok)" />
                        <button class="px-5 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-semibold" onclick="addUnsubscribed()">
                            <i class="fas fa-plus mr-2"></i>Add
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-3">Numbers here are skipped by broadcasts and follow-ups.</div>
                </div>

                <div class="glass-effect rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-white/10">
                                    <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Phone</th>
                                    <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Added</th>
                                    <th class="text-left px-6 py-4 text-white/80 text-sm font-semibold">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.length ? items.map((it) => {
                                    const phone = escapeHtml(String(it.phone_number || ''));
                                    const when = it.created_at ? new Date(it.created_at).toLocaleString() : '';
                                    return `
                                        <tr class="border-t border-white/10 hover:bg-white/5">
                                            <td class="px-6 py-4 text-white text-sm font-medium">${phone}</td>
                                            <td class="px-6 py-4 text-white/70 text-sm">${escapeHtml(when)}</td>
                                            <td class="px-6 py-4 text-white/70 text-sm">
                                                <button class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20" onclick="removeUnsubscribed('${phone}')">Remove</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') : `
                                    <tr>
                                        <td colspan="3" class="px-6 py-10 text-center text-white/70">No unsubscribed numbers</td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    // Check WhatsApp Web connection status for broadcast tab
    async function checkWhatsAppWebStatus() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) {
            return {
                connected: false,
                html: `<div class="bg-gray-100 border border-gray-300 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-gray-500 mr-3"></i>
                        <span class="text-gray-700">No tenant ID found</span>
                    </div>
                </div>`
            };
        }

        try {
            // PRIORITY 1: Check if desktop agent is running (on user's PC, not cloud)
            // We'll use a simple fetch with try/catch - CORS will cause error if agent offline
            let desktopAgentOnline = false;
            
            console.log('[DASHBOARD] Checking desktop agent at localhost:3001...');
            
            try {
                // Attempt to reach the desktop agent on user's local machine
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                
                const desktopAgentResponse = await fetch('http://localhost:3001/health', { 
                    method: 'GET',
                    mode: 'cors', // Allow CORS
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('[DASHBOARD] Desktop agent response status:', desktopAgentResponse.status);
                
                if (desktopAgentResponse.ok) {
                    const desktopAgentData = await desktopAgentResponse.json();
                    console.log('[DASHBOARD] Desktop agent data:', desktopAgentData);
                    
                    if (desktopAgentData && desktopAgentData.status === 'running') {
                        desktopAgentOnline = true;
                        console.log('[DASHBOARD] ✅ Desktop agent is ONLINE!');
                    }
                }
            } catch (error) {
                // Agent not running on user's PC (connection refused, timeout, or CORS error)
                console.log('[DASHBOARD] ⚠️ Desktop agent check failed:', error.message);
                console.log('[DASHBOARD] Error type:', error.name);
            }
            
            if (desktopAgentOnline) {
                console.log('[DASHBOARD] Showing GREEN banner for desktop agent');
                return {
                    connected: true,
                    method: 'desktop_agent',
                    html: `<div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300 rounded-lg p-4 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-desktop text-green-600 mr-3 text-2xl"></i>
                                    <div>
                                        <p class="font-bold text-green-900 flex items-center">
                                            <span class="relative flex h-3 w-3 mr-2">
                                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                            </span>
                                            Desktop Agent Online
                                        </p>
                                        <p class="text-xs text-gray-700 mt-1">
                                            <i class="fab fa-whatsapp text-green-600 mr-1"></i>Using your local WhatsApp Web
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold text-white bg-gradient-to-r from-green-500 to-green-600 px-4 py-2 rounded-full shadow-md">
                                        ✅ FREE MODE
                                    </span>
                                    <p class="text-xs text-green-700 mt-1 font-semibold">$0.00 per message!</p>
                                </div>
                            </div>
                            <div class="mt-3 bg-white/80 rounded p-2 text-xs text-gray-700">
                                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                                All broadcasts will be sent through your PC's WhatsApp - NO API COSTS!
                            </div>
                        </div>`
                };
            }
            
            // PRIORITY 2: Check cloud-based WhatsApp Web connection
            const response = await fetch(`/api/whatsapp-web/status/${tenantId}`, { cache: 'no-store' });
            const result = await response.json();
            
            if (result.success && result.status === 'ready' && result.hasClient) {
                return {
                    connected: true,
                    method: 'whatsapp_web',
                    html: `<div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-semibold text-green-800">WhatsApp Web Connected (Cloud)</p>
                                    <p class="text-sm text-green-700">Phone: ${result.connection?.phone_number || 'N/A'}</p>
                                </div>
                            </div>
                            <span class="text-xs text-green-600 bg-green-100 px-3 py-1 rounded-full">
                                <i class="fas fa-circle animate-pulse"></i> Active
                            </span>
                        </div>
                        <p class="text-xs text-green-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>Broadcasts will be sent via Cloud WhatsApp Web (Free)
                        </p>
                    </div>`
                };
            } else {
                return {
                    connected: false,
                    method: 'none',
                    html: `<div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-orange-300 rounded-lg p-4 shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-orange-500 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-bold text-orange-900">No Free WhatsApp Connection</p>
                                    <div class="text-xs text-orange-700 mt-1 space-y-0.5">
                                        <p>• Desktop Agent: <span class="font-bold">Offline ❌</span></p>
                                        <p>• Cloud WhatsApp: <span class="font-bold">${result.status || 'Disconnected'} ❌</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold text-white bg-gradient-to-r from-orange-500 to-red-500 px-3 py-2 rounded-full">
                                    💰 PAID MODE
                                </span>
                                <p class="text-xs text-gray-700 mt-1">Using Maytapi API</p>
                            </div>
                        </div>
                        <div class="mt-3 bg-white rounded-lg p-3 border-2 border-blue-200">
                            <p class="text-xs font-bold text-blue-900 mb-2">
                                <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>💡 Switch to FREE broadcasts!
                            </p>
                            <ol class="text-xs text-gray-700 space-y-1 ml-4 list-decimal">
                                <li>Go to Settings → Download Desktop Agent</li>
                                <li>Run START-AGENT.bat on your PC</li>
                                <li>Scan QR code with WhatsApp</li>
                                <li>Enjoy FREE unlimited broadcasts! 🎉</li>
                            </ol>
                        </div>
                    </div>`
                };
            }
        } catch (error) {
            console.error('Error checking connection status:', error);
            return {
                connected: false,
                method: 'error',
                html: `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-times-circle text-red-500 mr-3"></i>
                        <span class="text-red-700">Error checking connection status</span>
                    </div>
                </div>`
            };
        }
    }

    // Update daily message limit
    async function updateDailyLimit() {
        const tenantId = state.session?.tenantId;
        const limitInput = document.getElementById('dailyLimitInput');
        const newLimit = parseInt(limitInput.value);
        
        if (!newLimit || newLimit < 100 || newLimit > 10000) {
            showNotification('Daily limit must be between 100 and 10,000', 'warning');
            return;
        }
        
        try {
            const data = await api.putJSON(`/api/broadcast/daily-limit/${tenantId}`, { dailyLimit: newLimit });
            
            if (data.success) {
                showNotification(`✅ Daily limit updated to ${newLimit} messages/day`, 'success');
                // Reload to show updated banner
                setTimeout(() => loadBroadcast(), 1000);
            } else {
                showNotification(data.error || 'Failed to update daily limit', 'error');
            }
        } catch (error) {
            console.error('Error updating daily limit:', error);
            showNotification('Failed to update daily limit', 'error');
        }
    }

    async function loadBroadcast() {
        // Check WhatsApp Web connection status
        const waWebStatus = await checkWhatsAppWebStatus();
        
        // Check daily message limit
        const tenantId = state.session?.tenantId;
        let dailyLimitHtml = '';
        let stats = null; // Initialize stats variable
        let currentDailyLimit = 1000; // Default value
        
        try {
            const statsResponse = await fetch(`/api/broadcast/daily-stats/${tenantId}`, { headers: { ...api.authHeaders() } });
            if (statsResponse.ok) {
                const statsData = await statsResponse.json();
                stats = statsData.stats; // Assign to outer scope variable
                currentDailyLimit = stats.daily_limit || 1000;
                
                let bannerColor = 'bg-green-50 border-green-200 text-green-800';
                let icon = 'fa-check-circle text-green-500';
                
                if (stats.status === 'limit_reached') {
                    bannerColor = 'bg-red-50 border-red-300 text-red-800';
                    icon = 'fa-exclamation-triangle text-red-500';
                } else if (stats.status === 'warning') {
                    bannerColor = 'bg-yellow-50 border-yellow-300 text-yellow-800';
                    icon = 'fa-exclamation-circle text-yellow-500';
                }
                
                dailyLimitHtml = `
                    <div class="${bannerColor} border-2 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas ${icon} text-2xl mr-3"></i>
                                <div>
                                    <p class="font-bold">Daily Message Usage</p>
                                    <p class="text-sm">${stats.sent_today} / ${stats.daily_limit} messages sent today (${stats.percentage_used}%)</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-lg">${stats.remaining}</p>
                                <p class="text-xs">remaining</p>
                            </div>
                        </div>
                        ${stats.status === 'warning' || stats.status === 'limit_reached' ? `
                            <p class="text-xs mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                ${stats.status === 'limit_reached' ? 
                                    'Daily limit reached! Limit resets tomorrow.' : 
                                    'Approaching daily limit. Use wisely to avoid hitting the cap.'}
                            </p>
                        ` : ''}
                    </div>
                `;
            }
        } catch (err) {
            console.log('Could not load daily stats:', err);
        }
        
        document.getElementById('tabContent').innerHTML = `
            <div class="max-w-4xl mx-auto">
                <!-- WhatsApp Web Connection Status Banner -->
                <div id="waWebStatusBanner" class="mb-4">
                    ${waWebStatus.html}
                </div>
                
                <!-- Daily Limit Banner -->
                ${dailyLimitHtml}
                
                <!-- Daily Limit Settings -->
                <div class="config-card p-6 rounded-xl mb-6 bg-gradient-to-r from-indigo-50 to-purple-50">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center">
                            <i class="fas fa-cog text-indigo-600 text-2xl mr-3"></i>
                            <div>
                                <p class="font-bold text-gray-900">Daily Message Limit</p>
                                <p class="text-sm text-gray-600">Set your daily sending limit (100-10,000)</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="number" id="dailyLimitInput" min="100" max="10000" step="100"
                                value="${currentDailyLimit}"
                                class="w-32 px-4 py-2 border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center font-bold">
                            <button id="saveDailyLimitBtn"
                                class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold shadow-md">
                                <i class="fas fa-save mr-2"></i>Save
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-gray-600 bg-white/50 rounded-lg p-3">
                        <i class="fas fa-info-circle text-indigo-500 mr-1"></i>
                        <strong>Auto-Scheduling:</strong> If you upload more contacts than your daily limit, the system will automatically split them across multiple days. For example, uploading 2000 contacts with a 500/day limit will schedule over 4 days.
                    </div>
                </div>
                
                <div class="config-card p-8 rounded-2xl mb-6">
                    <h2 class="text-gray-900 text-2xl font-bold mb-6">
                        <i class="fas fa-bullhorn mr-3 text-indigo-600"></i>Send Broadcast
                    </h2>
                    
                    <!-- Bot Delivery Method Indicator -->
                    <div id="botDeliveryIndicator" class="mb-6 p-4 rounded-lg border-2">
                        <!-- Will be populated by JavaScript -->
                    </div>

                    <!-- Send Via (Provider Selector) -->
                    <div class="mb-6 bg-slate-50 border border-slate-200 rounded-lg p-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Send Via
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                            <div class="md:col-span-2">
                                <select id="broadcastSendVia"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <option value="auto" selected>Auto (Recommended)</option>
                                    <option value="whatsapp_web">WhatsApp Web (Free)</option>
                                    <option value="maytapi">Maytapi (Paid API)</option>
                                    <option value="desktop_agent">Desktop Agent (Free)</option>
                                </select>
                                <div class="mt-2 text-xs text-gray-600">
                                    <div><strong>Auto</strong> uses your configured mode and can fallback if needed.</div>
                                    <div><strong>WhatsApp Web</strong> requires a connected session.</div>
                                    <div><strong>Maytapi</strong> requires Maytapi credentials for this tenant.</div>
                                </div>
                            </div>
                            <div class="md:col-span-1">
                                <div class="text-xs text-gray-500 bg-white rounded-lg border border-gray-200 p-3">
                                    <i class="fas fa-info-circle mr-1 text-indigo-500"></i>
                                    Paying clients can choose the sending source per broadcast.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <form id="broadcastForm" class="space-y-6">
                        <!-- Campaign Name -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Campaign Name
                            </label>
                            <input type="text" id="campaignName" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="e.g., Holiday Sale 2025">
                        </div>

                        <!-- Recipients Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Recipients
                            </label>
                            
                            <!-- Tab selector - Mobile Optimized -->
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <button type="button" onclick="switchRecipientMode('paste')" id="recipientModePaste"
                                    class="px-2 py-3 rounded-lg border-2 border-indigo-500 bg-indigo-50 text-indigo-700 font-semibold text-xs md:text-sm hover:shadow-md transition">
                                    <i class="fab fa-whatsapp block md:inline text-lg md:text-base mb-1 md:mb-0 md:mr-1"></i>
                                    <span class="block md:inline">Paste</span>
                                </button>
                                <button type="button" onclick="switchRecipientMode('upload')" id="recipientModeUpload"
                                    class="px-2 py-3 rounded-lg border-2 border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-xs md:text-sm hover:shadow-md transition">
                                    <i class="fas fa-upload block md:inline text-lg md:text-base mb-1 md:mb-0 md:mr-1"></i>
                                    <span class="block md:inline">Upload</span>
                                </button>
                                <button type="button" onclick="switchRecipientMode('groups')" id="recipientModeGroups"
                                    class="px-2 py-3 rounded-lg border-2 border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-xs md:text-sm hover:shadow-md transition">
                                    <i class="fas fa-users block md:inline text-lg md:text-base mb-1 md:mb-0 md:mr-1"></i>
                                    <span class="block md:inline">Groups</span>
                                </button>
                            </div>

                            <!-- Upload Mode (Excel/CSV) -->
                            <div id="uploadMode" class="hidden">
                                <!-- Google Contacts Instructions -->
                                <div class="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                                    <div class="flex items-start">
                                        <i class="fab fa-google text-blue-600 text-2xl mr-3 mt-1"></i>
                                        <div class="flex-1">
                                            <p class="font-bold text-gray-800 mb-2">
                                                <i class="fas fa-star text-yellow-500 mr-1"></i>Import from Google Contacts (Easiest!)
                                            </p>
                                            <ol class="list-decimal list-inside space-y-1 text-xs text-gray-700 mb-3">
                                                <li>Open <a href="https://contacts.google.com" target="_blank" class="text-blue-600 hover:underline font-semibold">contacts.google.com</a></li>
                                                <li>Click "Export" on the left sidebar</li>
                                                <li>Select "Google CSV" format</li>
                                                <li>Click "Export" button → Downloads a CSV file</li>
                                                <li>Upload that CSV file below 👇</li>
                                            </ol>
                                            <div class="bg-white/50 rounded px-3 py-2 text-xs text-gray-600">
                                                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                                                <strong>Also works with:</strong> Excel files, iPhone exports, or any CSV with phone numbers
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-500 transition">
                                    <input type="file" id="recipientsFile" accept=".xlsx,.xls,.csv" 
                                        class="hidden" onchange="handleFileUpload(event)">
                                    <label for="recipientsFile" class="cursor-pointer">
                                        <i class="fas fa-file-upload text-4xl text-indigo-500 mb-2"></i>
                                        <p class="text-sm font-semibold text-gray-700">Click to Upload CSV/Excel File</p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>Google CSV
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>Excel (.xlsx, .xls)
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>Any CSV
                                        </p>
                                    </label>
                                    <div id="fileInfo" class="mt-3 text-sm text-green-600 hidden"></div>
                                </div>
                                
                                <!-- Recipients List -->
                                <div id="recipientsList" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Loaded Numbers:</span>
                                        <div class="flex gap-2">
                                            <button type="button" onclick="showSaveGroupDialog()" class="text-xs text-indigo-600 hover:text-indigo-700 font-semibold">
                                                <i class="fas fa-save"></i> Save as Group
                                            </button>
                                            <button type="button" onclick="clearRecipients()" class="text-xs text-red-600 hover:text-red-700">
                                                <i class="fas fa-times-circle"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                    <div id="recipientsNumbers" class="text-xs text-gray-600 space-y-1"></div>
                                </div>
                            </div>

                            <!-- iPhone Paste Mode (NOW FIRST) -->
                            <div id="pasteMode" class="hidden">
                                <div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300 rounded-xl p-6 mb-4">
                                    <div class="flex items-start">
                                        <div class="bg-white rounded-full p-3 mr-4">
                                            <i class="fab fa-whatsapp text-green-500 text-3xl"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-bold text-lg text-gray-800 mb-2">📱 Super Simple - Just Copy & Paste!</h3>
                                            <p class="text-sm text-gray-700 mb-3">Your customer can copy numbers from anywhere:</p>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-600">
                                                <div class="flex items-center">
                                                    <i class="fab fa-whatsapp text-green-500 mr-2"></i>
                                                    <span>WhatsApp chat or group</span>
                                                </div>
                                                <div class="flex items-center">
                                                    <i class="fas fa-sms text-blue-500 mr-2"></i>
                                                    <span>iPhone Messages</span>
                                                </div>
                                                <div class="flex items-center">
                                                    <i class="fas fa-address-book text-purple-500 mr-2"></i>
                                                    <span>Contact list (any app)</span>
                                                </div>
                                                <div class="flex items-center">
                                                    <i class="fas fa-file-alt text-orange-500 mr-2"></i>
                                                    <span>Notes, Email, anywhere!</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Simple Text Paste Area -->
                                <div class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-6 hover:border-indigo-400 transition">
                                    <label class="block text-center mb-4">
                                        <div class="text-2xl mb-2">📋</div>
                                        <p class="font-bold text-gray-800 text-lg mb-1">Step 1: Copy your contacts</p>
                                        <p class="text-sm text-gray-600">From WhatsApp, Messages, or anywhere on your phone</p>
                                    </label>
                                    <textarea id="pasteContacts" rows="10" 
                                        placeholder="Step 2: Paste here! We'll find all phone numbers automatically 🎯&#10;&#10;Examples of what you can paste:&#10;&#10;+1 234-567-8900&#10;John: 2345678900&#10;Call me at (234) 567-8900&#10;WhatsApp: +12345678900&#10;&#10;Just paste ANYTHING with phone numbers - we'll extract them!"
                                        class="w-full px-4 py-4 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base"
                                        onpaste="setTimeout(handleContactPaste, 100)"></textarea>
                                    
                                    <div class="flex gap-2 mt-4">
                                        <button type="button" onclick="handleContactPaste()" 
                                            class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 font-semibold text-lg shadow-lg">
                                            <i class="fas fa-magic mr-2"></i>Extract Phone Numbers
                                        </button>
                                        <button type="button" onclick="clearPastedRecipients()" 
                                            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                            <i class="fas fa-eraser mr-2"></i>Clear
                                        </button>
                                    </div>
                                </div>

                                <!-- Extracted Numbers -->
                                <div id="pasteRecipientsList" class="hidden mt-4 bg-green-50 border-2 border-green-200 rounded-xl p-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <div class="flex items-center">
                                            <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                                            <div>
                                                <p class="font-bold text-green-800">Found Phone Numbers!</p>
                                                <span id="pasteCountBadge" class="text-sm text-green-700"></span>
                                            </div>
                                        </div>
                                        <button type="button" onclick="showSaveGroupDialog()" 
                                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold text-sm">
                                            <i class="fas fa-save mr-2"></i>Save as Group
                                        </button>
                                    </div>
                                    <div id="pasteRecipientsNumbers" class="max-h-64 overflow-y-auto bg-white rounded-lg p-3 text-sm space-y-1"></div>
                                </div>
                            </div>

                            <!-- Groups Mode -->
                            <div id="groupsMode" class="hidden">
                                <div id="contactGroupsList" class="space-y-2">
                                    <p class="text-sm text-gray-500 text-center py-8">Loading groups...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Message Type -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Message Type
                            </label>
                            <div class="flex gap-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="messageType" value="text" checked 
                                        onchange="toggleMessageType()"
                                        class="w-4 h-4 text-indigo-600">
                                    <span class="ml-2 text-gray-700"><i class="fas fa-comment mr-1"></i> Text Only</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="messageType" value="image" 
                                        onchange="toggleMessageType()"
                                        class="w-4 h-4 text-indigo-600">
                                    <span class="ml-2 text-gray-700"><i class="fas fa-image mr-1"></i> Image + Text</span>
                                </label>
                            </div>
                        </div>

                        <!-- Image Upload (hidden by default) -->
                        <div id="imageUploadSection" class="hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-image mr-2"></i>Upload Images
                            </label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-500 transition">
                                <input type="file" id="broadcastImage" accept="image/*" capture="environment" multiple
                                    class="hidden" onchange="handleImageUpload(event)">
                                <label for="broadcastImage" class="cursor-pointer">
                                    <div class="flex flex-col md:flex-row items-center justify-center gap-3">
                                        <div class="text-center">
                                            <i class="fas fa-camera text-4xl text-indigo-500 mb-2"></i>
                                            <p class="text-sm font-semibold text-gray-700">Take Photo</p>
                                        </div>
                                        <span class="hidden md:inline text-2xl text-gray-300">or</span>
                                        <div class="text-center">
                                            <i class="fas fa-image text-4xl text-purple-500 mb-2"></i>
                                            <p class="text-sm font-semibold text-gray-700">Choose from Gallery</p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-3">
                                        <i class="fas fa-mobile-alt mr-1"></i>On mobile: Camera opens automatically
                                    </p>
                                </label>
                                <div id="imagePreview" class="mt-4 hidden">
                                    <img id="previewImg" class="max-h-64 w-auto mx-auto rounded-lg shadow-lg border-2 border-green-200" alt="Preview">
                                    <p id="imageCountLabel" class="mt-2 text-sm text-gray-600"></p>
                                    <button type="button" onclick="removeImage()" 
                                        class="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                                        <i class="fas fa-trash mr-2"></i>Remove Image
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Message Text -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-semibold text-gray-700">
                                    Message <span id="messageLabel">Text</span>
                                </label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="openBroadcastTemplatePicker()" 
                                        class="text-xs text-indigo-600 hover:text-indigo-700 font-semibold">
                                        <i class="fas fa-file-alt"></i> Load Template
                                    </button>
                                    <button type="button" onclick="saveAsTemplate()" 
                                        class="text-xs text-green-600 hover:text-green-700 font-semibold">
                                        <i class="fas fa-save"></i> Save as Template
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Personalization Guide -->
                            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                                <div class="flex items-start">
                                    <i class="fas fa-user-tag text-purple-600 text-xl mr-3 mt-1"></i>
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-800 mb-2 flex items-center">
                                            <i class="fas fa-magic text-yellow-500 mr-2"></i>Personalize Your Messages
                                        </p>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                            <div class="bg-white/70 rounded px-3 py-2">
                                                <code class="text-purple-700 font-bold">{name}</code>
                                                <p class="text-gray-600 mt-1">Contact's name</p>
                                            </div>
                                            <div class="bg-white/70 rounded px-3 py-2">
                                                <code class="text-purple-700 font-bold">{phone}</code>
                                                <p class="text-gray-600 mt-1">Phone number</p>
                                            </div>
                                            <div class="bg-white/70 rounded px-3 py-2">
                                                <code class="text-purple-700 font-bold">{business}</code>
                                                <p class="text-gray-600 mt-1">Your business</p>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-xs text-gray-700 bg-white/50 rounded px-3 py-2">
                                            <strong>Example:</strong> "Hi {name}! Special offer from {business} just for you! 🎉"
                                            <br>→ Becomes: "Hi John! Special offer from SAK Store just for you! 🎉"
                                        </div>
                                        <div class="mt-3 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2">
                                            <div class="flex items-start">
                                                <i class="fas fa-shield-check text-green-600 mr-2 mt-0.5"></i>
                                                <div>
                                                    <strong class="flex items-center gap-1">
                                                        <i class="fas fa-robot"></i> Anti-Bot Detection Active
                                                    </strong>
                                                    <p class="mt-1">Messages are automatically humanized with:</p>
                                                    <ul class="mt-1 ml-3 space-y-1">
                                                        <li>• 20 random greeting templates</li>
                                                        <li>• Natural delays (10-18s between messages)</li>
                                                        <li>• Random emoji variations</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <textarea id="broadcastMessage" required rows="5"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="Hi {name}! 👋&#10;&#10;We have exciting news from {business}...&#10;&#10;Contact us at {phone} for more details!"></textarea>
                        </div>

                        <!-- Schedule Options -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Send Time
                            </label>
                            <div class="flex gap-4 mb-3">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="scheduleType" value="now" checked 
                                        onchange="toggleSchedule()"
                                        class="w-4 h-4 text-indigo-600">
                                    <span class="ml-2 text-gray-700"><i class="fas fa-bolt mr-1"></i> Send Now</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="scheduleType" value="later" 
                                        onchange="toggleSchedule()"
                                        class="w-4 h-4 text-indigo-600">
                                    <span class="ml-2 text-gray-700"><i class="fas fa-clock mr-1"></i> Schedule</span>
                                </label>
                            </div>
                            <input type="datetime-local" id="scheduleTime" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent hidden">
                        </div>

                        <!-- Batch Settings -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-cogs mr-2 text-indigo-600"></i>
                                Batch & Rate Limiting Settings
                            </h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        Messages per Batch
                                    </label>
                                    <input type="number" id="batchSize" value="10" min="1" max="100"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <p class="text-xs text-gray-500 mt-1">Default: 10</p>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        Delay Between Messages (ms)
                                    </label>
                                    <input type="number" id="messageDelay" value="500" min="100" max="5000" step="100"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <p class="text-xs text-gray-500 mt-1">Default: 500ms</p>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        Delay Between Batches (ms)
                                    </label>
                                    <input type="number" id="batchDelay" value="2000" min="1000" max="30000" step="1000"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <p class="text-xs text-gray-500 mt-1">Default: 2000ms</p>
                                </div>
                            </div>
                            
                            <div class="mt-3 bg-blue-50 border border-blue-200 rounded p-2">
                                <p class="text-xs text-blue-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <strong>Tip:</strong> Increase delays if you're hitting WhatsApp rate limits. 
                                    Smaller batches with longer delays = more reliable delivery.
                                </p>
                            </div>
                        </div>

                        <!-- Submit Button - Mobile Optimized -->
                        <div class="sticky bottom-0 left-0 right-0 bg-white/95 backdrop-blur -mx-8 px-8 py-4 border-t-2 border-gray-200 md:static md:bg-transparent md:backdrop-blur-none md:mx-0 md:px-0 md:py-0 md:border-0">
                            <button type="submit" 
                                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 px-6 rounded-xl font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-2xl active:scale-95 transform">
                                <i class="fas fa-paper-plane mr-2 text-xl"></i>
                                <span id="submitButtonText">Send Broadcast Now</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Recent Broadcasts -->
                <div class="config-card p-8 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-gray-900 text-xl font-bold">
                            <i class="fas fa-history mr-2 text-gray-600"></i>Recent Broadcasts
                        </h3>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                            <input type="text" id="campaignSearch" placeholder="Search by campaign name..."
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm"
                                onkeyup="filterBroadcasts()">
                            <select id="statusFilter" onchange="filterBroadcasts()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
                                <option value="">All Statuses</option>
                                <option value="completed">Completed</option>
                                <option value="processing">Processing</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                            <input type="date" id="dateFromFilter" onchange="filterBroadcasts()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm" />
                            <input type="date" id="dateToFilter" onchange="filterBroadcasts()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm" />
                            <button type="button" onclick="clearFilters()"
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-semibold">
                                <i class="fas fa-times mr-1"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                    
                    <div id="broadcastHistory" class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                        <p>No broadcasts sent yet</p>
                    </div>
                </div>
            </div>
        `;

        // Attach form submit handler
        document.getElementById('broadcastForm').addEventListener('submit', handleBroadcastSubmit);
        
        // Attach daily limit save button handler
        const saveDailyLimitBtn = document.getElementById('saveDailyLimitBtn');
        if (saveDailyLimitBtn) {
            saveDailyLimitBtn.addEventListener('click', updateDailyLimit);
        }
        
        // Update bot delivery method indicator
        const savedFeatures = JSON.parse(localStorage.getItem(`tenant_features_${state.session?.tenantId}`)) || {};
        const botDeliveryMethod = savedFeatures.bot_delivery_method || 'desktop';
        const indicator = document.getElementById('botDeliveryIndicator');
        
        if (botDeliveryMethod === 'cloud') {
            indicator.className = 'mb-6 p-4 rounded-lg border-2 bg-blue-50 border-blue-300';
            indicator.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-cloud text-blue-600 text-2xl"></i>
                    <div class="flex-1">
                        <p class="font-bold text-blue-900">24/7 Cloud Bot Active (Waha)</p>
                        <p class="text-sm text-blue-700">Broadcasts will be sent through the always-online cloud bot</p>
                    </div>
                    <button type="button" onclick="window.location.href='/clients.html'" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">
                        <i class="fas fa-cog mr-1"></i> Change
                    </button>
                </div>
            `;
        } else {
            indicator.className = 'mb-6 p-4 rounded-lg border-2 bg-gray-50 border-gray-300';
            indicator.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-desktop text-gray-600 text-2xl"></i>
                    <div class="flex-1">
                        <p class="font-bold text-gray-900">Desktop Agent Mode</p>
                        <p class="text-sm text-gray-700">Broadcasts require your PC to be online with WhatsApp Web connected</p>
                    </div>
                    <button type="button" onclick="window.location.href='/clients.html'" 
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm font-semibold">
                        <i class="fas fa-cog mr-1"></i> Switch to Cloud Bot
                    </button>
                </div>
            `;
        }
        
        // Load broadcast history
        loadBroadcastHistory();
        
        // Auto-refresh broadcast history every 5 seconds to show progress
        if (window.broadcastHistoryInterval) {
            clearInterval(window.broadcastHistoryInterval);
        }
        window.broadcastHistoryInterval = setInterval(() => {
            loadBroadcastHistory();
        }, 5000);
    }
    
    // WhatsApp Web Connection Management
    async function loadWhatsAppWeb() {
        const tenantId = state.session?.tenantId;
        
        const content = document.getElementById('tabContent');
        content.innerHTML = `
            <div class="space-y-6">
                <!-- Header -->
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">
                            <i class="fas fa-qrcode mr-3"></i>WhatsApp Web Connection
                        </h2>
                        <p class="text-white/70">Connect your own WhatsApp number via QR code (Standalone System)</p>
                    </div>
                </div>

                <!-- Connection Status Card -->
                <div class="bg-white/95 backdrop-blur rounded-2xl shadow-xl p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        <i class="fas fa-signal mr-2 text-green-500"></i>Connection Status
                    </h3>

                    <!-- Session / Salesman selector (Premium/Enterprise multi-WhatsApp) -->
                    <div class="mb-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Session</label>
                            <select id="waWebSessionSelect" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500">
                                <option value="default">Default (Admin)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Choose which WhatsApp number to connect.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Salesman Mapping (optional)</label>
                            <input id="waWebSalesmanId" type="text" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Salesman ID (auto-filled when selected)" />
                            <p class="text-xs text-gray-500 mt-1">Used to route replies from assigned salesman.</p>
                        </div>
                    </div>
                    
                    <div id="waWebStatus" class="mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-3 h-3 rounded-full bg-gray-400 animate-pulse"></div>
                            <span class="text-gray-600">Checking status...</span>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4">
                        <button onclick="connectWhatsAppWeb()" id="btnConnect" 
                                class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-colors flex items-center">
                            <i class="fas fa-plug mr-2"></i>Connect
                        </button>
                        <button onclick="disconnectWhatsAppWeb()" id="btnDisconnect" 
                                class="bg-red-600 text-white px-6 py-3 rounded-xl hover:bg-red-700 transition-colors flex items-center">
                            <i class="fas fa-unlink mr-2"></i>Disconnect
                        </button>
                        <button onclick="refreshWhatsAppStatus()" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Status
                        </button>
                    </div>
                </div>

                <!-- QR Code Display -->
                <div id="qrCodeSection" class="bg-white/95 backdrop-blur rounded-2xl shadow-xl p-6 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        <i class="fas fa-mobile-alt mr-2 text-blue-500"></i>Scan QR Code
                    </h3>
                    <p class="text-gray-600 mb-6">Open WhatsApp on your phone → Settings → Linked Devices → Link a Device</p>
                    
                    <div class="flex justify-center items-center bg-gray-50 p-8 rounded-xl">
                        <div id="qrCodeDisplay" class="text-center">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-500">Loading QR code...</p>
                        </div>
                    </div>
                </div>

                <!-- Info Card -->
                <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 backdrop-blur rounded-2xl p-6 border border-white/20">
                    <h3 class="text-white font-semibold mb-3">
                        <i class="fas fa-info-circle mr-2"></i>About WhatsApp Web Connection
                    </h3>
                    <ul class="text-white/80 space-y-2 text-sm">
                        <li><i class="fas fa-check-circle text-green-400 mr-2"></i>Standalone system - works independently from Maytapi</li>
                        <li><i class="fas fa-check-circle text-green-400 mr-2"></i>Free to use with your own WhatsApp number</li>
                        <li><i class="fas fa-check-circle text-green-400 mr-2"></i>QR code connection - scan once and stay connected</li>
                        <li><i class="fas fa-check-circle text-green-400 mr-2"></i>Sessions persist across server restarts</li>
                        <li><i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>Your phone must stay online and connected</li>
                    </ul>
                </div>

                <!-- Connection Details -->
                <div id="connectionDetails" class="bg-white/95 backdrop-blur rounded-2xl shadow-xl p-6 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        <i class="fas fa-info mr-2 text-purple-500"></i>Connection Details
                    </h3>
                    <div id="connectionInfo" class="space-y-2 text-gray-700">
                        <!-- Details will be populated here -->
                    </div>
                </div>
            </div>
        `;

        // Populate sessions from salesmen list (best-effort)
        try {
            const tenantId = state.session?.tenantId;
            if (tenantId) {
                const res = await fetch(`/api/salesmen/${tenantId}`);
                const data = await res.json();
                const team = Array.isArray(data?.salesmen) ? data.salesmen : [];
                const sel = document.getElementById('waWebSessionSelect');
                if (sel && team.length) {
                    for (const s of team) {
                        if (!s || !s.id) continue;
                        const opt = document.createElement('option');
                        opt.value = `salesman_${String(s.id)}`;
                        opt.textContent = `${s.name || 'Salesman'} (#${s.id})`;
                        opt.dataset.salesmanId = String(s.id);
                        sel.appendChild(opt);
                    }
                    sel.addEventListener('change', () => {
                        const selected = sel.options[sel.selectedIndex];
                        const sid = selected?.dataset?.salesmanId || '';
                        const input = document.getElementById('waWebSalesmanId');
                        if (input) input.value = sid;
                        refreshWhatsAppStatus();
                    });
                }
            }
        } catch (e) {
            // best-effort
        }

        // Load current status
        await refreshWhatsAppStatus();
        
        // Auto-refresh status every 10 seconds
        if (window.waWebStatusInterval) {
            clearInterval(window.waWebStatusInterval);
        }
        window.waWebStatusInterval = setInterval(() => {
            refreshWhatsAppStatus();
        }, 10000);
    }

    async function connectWhatsAppWeb() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) {
            alert('No tenant ID found');
            return;
        }

        const sessionName = document.getElementById('waWebSessionSelect')?.value || 'default';
        const salesmanId = document.getElementById('waWebSalesmanId')?.value?.trim() || null;

        try {
            document.getElementById('btnConnect').disabled = true;
            document.getElementById('btnConnect').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';

            const response = await fetch('/api/whatsapp-web/connect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tenantId, sessionName, salesmanId })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const result = await response.json();
            if (!result.success) {
                showNotification('Connection failed: ' + (result.error || 'Unknown error'), 'error');
                return;
            }

            if (result.status === 'ready') {
                showNotification('WhatsApp Web is already connected ✓', 'success');
                document.getElementById('qrCodeSection')?.classList.add('hidden');
            } else {
                showNotification('Initializing WhatsApp Web… QR will appear shortly', 'success');
                document.getElementById('qrCodeSection')?.classList.remove('hidden');
                setTimeout(() => pollForQRCode(tenantId, sessionName), 1500);
            }

            await refreshWhatsAppStatus();
        } catch (error) {
            console.error('Connect error:', error);
            const errorMessage = error.name === 'AbortError' 
                ? 'Connection timeout - Server is taking too long to respond. Please try again.' 
                : 'Error connecting: ' + error.message;
            showNotification(errorMessage, 'error');
        } finally {
            document.getElementById('btnConnect').disabled = false;
            document.getElementById('btnConnect').innerHTML = '<i class="fas fa-plug mr-2"></i>Connect';
        }
    }

    async function disconnectWhatsAppWeb() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        const sessionName = document.getElementById('waWebSessionSelect')?.value || 'default';

        if (!confirm('Are you sure you want to disconnect WhatsApp Web?')) return;

        try {
            document.getElementById('btnDisconnect').disabled = true;
            document.getElementById('btnDisconnect').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Disconnecting...';

            const response = await fetch('/api/whatsapp-web/disconnect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tenantId, sessionName })
            });

            const result = await response.json();
            if (result.success) {
                showNotification('WhatsApp Web disconnected', 'success');
                document.getElementById('qrCodeSection')?.classList.add('hidden');
                document.getElementById('connectionDetails')?.classList.add('hidden');
                await refreshWhatsAppStatus();
            } else {
                showNotification('Disconnect failed: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Disconnect error:', error);
            showNotification('Error disconnecting: ' + error.message, 'error');
        } finally {
            document.getElementById('btnDisconnect').disabled = false;
            document.getElementById('btnDisconnect').innerHTML = '<i class="fas fa-unlink mr-2"></i>Disconnect';
        }
    }

    async function refreshWhatsAppStatus() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        const sessionName = document.getElementById('waWebSessionSelect')?.value || 'default';

        try {
            const response = await fetch(`/api/whatsapp-web/status/${tenantId}?sessionName=${encodeURIComponent(sessionName)}`, { cache: 'no-store' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();

            const statusDiv = document.getElementById('waWebStatus');
            if (!statusDiv) return;

            const waStatus = result.status || 'disconnected';

            let statusColor = 'gray';
            let statusText = 'Disconnected';
            let statusIcon = 'fa-circle';

            switch (waStatus) {
                case 'ready':
                    statusColor = 'green';
                    statusText = 'Connected & Ready ✓';
                    statusIcon = 'fa-check-circle';
                    document.getElementById('qrCodeSection')?.classList.add('hidden');
                    document.getElementById('connectionDetails')?.classList.remove('hidden');
                    break;
                case 'qr_ready':
                    statusColor = 'yellow';
                    statusText = 'Scan QR Code to Connect';
                    statusIcon = 'fa-qrcode';
                    document.getElementById('qrCodeSection')?.classList.remove('hidden');
                    pollForQRCode(tenantId, sessionName);
                    break;
                case 'initializing':
                    statusColor = 'blue';
                    statusText = 'Starting WhatsApp Web…';
                    statusIcon = 'fa-spinner fa-spin';
                    break;
                case 'error':
                    statusColor = 'red';
                    statusText = 'Connection Failed';
                    statusIcon = 'fa-exclamation-circle';
                    break;
                default:
                    statusColor = 'gray';
                    statusText = 'Not Connected';
                    statusIcon = 'fa-circle';
                    document.getElementById('qrCodeSection')?.classList.add('hidden');
                    document.getElementById('connectionDetails')?.classList.add('hidden');
            }

            statusDiv.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-3 h-3 rounded-full bg-${statusColor}-500 ${waStatus === 'initializing' ? 'animate-pulse' : ''}"></div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <i class="fas ${statusIcon} text-${statusColor}-500"></i>
                            <span class="font-semibold text-gray-800">${statusText}</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">WhatsApp Web (Standalone) — Tenant: ${tenantId} — Session: ${sessionName}</p>
                    </div>
                </div>
            `;

            // Show connection details if connected
            if (waStatus === 'ready') {
                const detailsDiv = document.getElementById('connectionInfo');
                if (detailsDiv) {
                    const phoneNumber = result.connection?.phone_number || 'Unknown';
                    detailsDiv.innerHTML = `
                        <p><strong>Tenant ID:</strong> ${tenantId}</p>
                        <p><strong>Status:</strong> ${waStatus}</p>
                        <p><strong>Provider:</strong> WhatsApp Web (Standalone)</p>
                        <p><strong>Phone:</strong> ${phoneNumber}</p>
                        <p><strong>Connection:</strong> Active and Ready</p>
                    `;
                }
            }

        } catch (error) {
            console.error('Status refresh error:', error);
            
            // Show user-friendly error message
            const statusDiv = document.getElementById('waWebStatus');
            if (statusDiv) {
                const errorMessage = error.name === 'AbortError' 
                    ? 'Connection timeout - Server may be busy' 
                    : 'Unable to check status - Server may be down';
                    
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-4 bg-red-50 p-3 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                        <span class="text-red-700">${errorMessage}</span>
                        <button onclick="refreshWhatsAppStatus()" class="ml-auto px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
    }

    async function pollForQRCode(tenantId, sessionName = 'default') {
        if (!tenantId) return;

        try {
            const qrDisplay = document.getElementById('qrCodeDisplay');
            if (!qrDisplay) return;

            qrDisplay.innerHTML = '<div class="loading-spinner mx-auto mb-4"></div><p class="text-gray-500">Loading QR code...</p>';

            const response = await fetch(`/api/whatsapp-web/qr/${tenantId}?sessionName=${encodeURIComponent(sessionName)}`, { cache: 'no-store' });
            const result = await response.json();

            if (result.success && result.qrCode) {
                qrDisplay.innerHTML = `
                    <img src="${result.qrCode}" alt="QR Code" class="mx-auto border-4 border-gray-200 rounded-lg" style="max-width: 300px;" />
                    <p class="text-gray-600 mt-4 font-semibold">📱 Scan with WhatsApp</p>
                    <p class="text-sm text-gray-500 mt-2">WhatsApp → Settings → Linked Devices → Link a Device</p>
                    <p class="text-xs text-gray-400 mt-3">QR code refreshes automatically</p>
                `;
                setTimeout(() => pollForQRCode(tenantId, sessionName), 30000);
            } else {
                qrDisplay.innerHTML = `<p class="text-gray-500">${result.message || 'Waiting for QR code…'}</p>`;
                setTimeout(() => pollForQRCode(tenantId, sessionName), 3000);
            }
        } catch (error) {
            console.error('QR poll error:', error);
            const qrDisplay = document.getElementById('qrCodeDisplay');
            if (qrDisplay) {
                qrDisplay.innerHTML = '<p class="text-red-500">Error loading QR code. Retrying...</p>';
                setTimeout(() => pollForQRCode(tenantId, sessionName), 5000);
            }
        }
    }

    async function loadBroadcastHistory() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;
        
        try {
            const response = await fetch(`/api/broadcast/history/${tenantId}`, { headers: { ...api.authHeaders() } });
            const result = await response.json();
            
            if (result.success && result.broadcasts && result.broadcasts.length > 0) {
                window.allBroadcasts = result.broadcasts; // Store for filtering
                renderBroadcastList(result.broadcasts);
            } else {
                window.allBroadcasts = [];
                document.getElementById('broadcastHistory').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                        <p>No broadcasts sent yet</p>
                    </div>
                `;
            }
        } catch (err) {
            console.error('Error loading broadcast history:', err);
            window.allBroadcasts = [];
            document.getElementById('broadcastHistory').innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                    <p>Failed to load broadcast history</p>
                </div>
            `;
        }
    }

    // NEW PHASE 2 FEATURES

    // Filter broadcasts
    window.allBroadcasts = []; // Store all broadcasts for filtering
    
    async function filterBroadcasts() {
        const searchTerm = document.getElementById('campaignSearch')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('statusFilter')?.value || '';
        const dateFromRaw = document.getElementById('dateFromFilter')?.value || '';
        const dateToRaw = document.getElementById('dateToFilter')?.value || '';
        
        let filtered = window.allBroadcasts;
        
        if (searchTerm) {
            filtered = filtered.filter(b => 
                b.campaign_name.toLowerCase().includes(searchTerm)
            );
        }
        
        if (statusFilter) {
            filtered = filtered.filter(b => b.status === statusFilter);
        }

        if (dateFromRaw) {
            const from = new Date(dateFromRaw);
            from.setHours(0, 0, 0, 0);
            filtered = filtered.filter((b) => {
                const d = new Date(b.sent_at || b.created_at || b.scheduled_at || 0);
                return d >= from;
            });
        }

        if (dateToRaw) {
            const to = new Date(dateToRaw);
            to.setHours(23, 59, 59, 999);
            filtered = filtered.filter((b) => {
                const d = new Date(b.sent_at || b.created_at || b.scheduled_at || 0);
                return d <= to;
            });
        }
        
        // Render filtered results (reuse the rendering logic from loadBroadcastHistory)
        if (filtered.length === 0) {
            document.getElementById('broadcastHistory').innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-search text-4xl mb-3 opacity-50"></i>
                    <p>No broadcasts match your filters</p>
                </div>
            `;
            return;
        }
        
        // Reuse rendering logic from loadBroadcastHistory
        renderBroadcastList(filtered);
    }
    
    function clearFilters() {
        document.getElementById('campaignSearch').value = '';
        document.getElementById('statusFilter').value = '';
        const df = document.getElementById('dateFromFilter');
        const dt = document.getElementById('dateToFilter');
        if (df) df.value = '';
        if (dt) dt.value = '';
        renderBroadcastList(window.allBroadcasts);
    }
    
    function renderBroadcastList(broadcasts) {
        const historyHtml = broadcasts.map(broadcast => {
            const sentAt = new Date(broadcast.sent_at || broadcast.created_at).toLocaleString();
            const isProcessing = broadcast.status === 'processing';
            const successRate = broadcast.recipient_count > 0 
                ? ((broadcast.success_count / broadcast.recipient_count) * 100).toFixed(0)
                : 0;
            
            let progressBar = '';
            if (isProcessing && broadcast.recipient_count > 0) {
                const progress = ((broadcast.success_count + broadcast.fail_count) / broadcast.recipient_count * 100).toFixed(0);
                progressBar = `
                    <div class="mt-3 mb-2">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Processing...</span>
                            <span>${broadcast.success_count + broadcast.fail_count}/${broadcast.recipient_count}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300 animate-pulse" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-gray-900">${escapeHtml(broadcast.campaign_name)}</h4>
                            <p class="text-xs text-gray-500 mt-1">${sentAt}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${
                            broadcast.status === 'completed' ? 'bg-green-100 text-green-800' :
                            broadcast.status === 'processing' ? 'bg-blue-100 text-blue-800 animate-pulse' :
                            broadcast.status === 'scheduled' ? 'bg-purple-100 text-purple-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${isProcessing ? '⏳ Processing' : broadcast.status}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3 line-clamp-2">${escapeHtml(broadcast.message_content)}</p>
                    ${progressBar}
                    <div class="flex gap-4 text-sm">
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-paper-plane mr-1 text-xs"></i>
                            <span>${broadcast.success_count || 0} sent</span>
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-users mr-1 text-xs"></i>
                            <span>${broadcast.recipient_count || 0} total</span>
                        </div>
                        ${!isProcessing ? `
                        <div class="flex items-center ${
                            successRate >= 90 ? 'text-green-600' :
                            successRate >= 70 ? 'text-yellow-600' :
                            'text-red-600'
                        }">
                            <i class="fas fa-chart-pie mr-1 text-xs"></i>
                            <span>${successRate}% success</span>
                        </div>
                        ` : ''}
                    </div>
                    ${broadcast.campaign_id ? `
                    <div class="flex gap-2 mt-3">
                        <button onclick="viewCampaignReport('${broadcast.campaign_id}')" 
                            class="flex-1 px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-xs font-semibold">
                            <i class="fas fa-chart-bar mr-1"></i> View Details
                        </button>
                        <button onclick="exportCampaignReport('${broadcast.campaign_id}', '${escapeHtml(broadcast.campaign_name)}')" 
                            class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-xs font-semibold">
                            <i class="fas fa-download mr-1"></i> Export CSV
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        }).join('');
        
        document.getElementById('broadcastHistory').innerHTML = historyHtml;
    }
    
    // View campaign report (per-contact delivery details)
    async function viewCampaignReport(campaignId) {
        try {
            const response = await fetch(`/api/broadcast/campaign-report/${campaignId}`, {
                headers: { ...api.authHeaders() }
            });
            const result = await response.json();
            
            if (!result.success) {
                showNotification('Failed to load campaign report', 'error');
                return;
            }
            
            const { campaign, recipients, stats, click_stats } = result;
            const linksTracked = click_stats?.links_tracked || 0;
            const clicksTotal = click_stats?.clicks_total || 0;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">${escapeHtml(campaign.name)}</h2>
                                <p class="text-sm opacity-90">Campaign Delivery Report</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white/20 rounded-lg p-2">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-6 gap-4 mt-4">
                            <div class="bg-white/10 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.total}</p>
                                <p class="text-xs opacity-90">Total</p>
                            </div>
                            <div class="bg-green-500/30 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.sent}</p>
                                <p class="text-xs opacity-90">Sent</p>
                            </div>
                            <div class="bg-red-500/30 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.failed}</p>
                                <p class="text-xs opacity-90">Failed</p>
                            </div>
                            <div class="bg-gray-500/30 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.skipped || 0}</p>
                                <p class="text-xs opacity-90">Skipped</p>
                            </div>
                            <div class="bg-blue-500/30 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.replied || 0}</p>
                                <p class="text-xs opacity-90">Replied</p>
                            </div>
                            <div class="bg-yellow-500/30 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.pending}</p>
                                <p class="text-xs opacity-90">Pending</p>
                            </div>
                        </div>
                        <div class="mt-3 text-sm opacity-90">
                            <span class="font-semibold">Links Tracked:</span> ${linksTracked} &nbsp;|&nbsp; <span class="font-semibold">Clicks:</span> ${clicksTotal}
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 250px);">
                        <table class="w-full">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Phone Number</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Replied</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Replied At</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Sent At</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Error</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${recipients.map(r => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 text-sm font-mono">${r.phone}</td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                r.status === 'sent' ? 'bg-green-100 text-green-800' :
                                                r.status === 'failed' ? 'bg-red-100 text-red-800' :
                                                r.status === 'skipped' ? 'bg-gray-100 text-gray-800' :
                                                'bg-yellow-100 text-yellow-800'
                                            }">
                                                ${r.status}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                r.replied ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'
                                            }">
                                                ${r.replied ? 'Yes' : 'No'}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-xs text-gray-600">
                                            ${r.replied_at ? new Date(r.replied_at).toLocaleString() : '-'}
                                        </td>
                                        <td class="px-4 py-3 text-xs text-gray-600">
                                            ${r.sent_at ? new Date(r.sent_at).toLocaleString() : '-'}
                                        </td>
                                        <td class="px-4 py-3 text-xs text-red-600">
                                            ${r.error_message || '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } catch (err) {
            console.error('Error viewing campaign report:', err);
            showNotification('Failed to load report', 'error');
        }
    }
    
    // Export campaign report as CSV
    async function exportCampaignReport(campaignId, campaignName) {
        try {
            const url = `/api/broadcast/campaign-report/${campaignId}/export`;
            const response = await fetch(url, { headers: { ...api.authHeaders() } });
            if (!response.ok) throw new Error('Download failed');

            const blob = await response.blob();
            const a = document.createElement('a');
            const safeName = String(campaignName || 'campaign').replace(/[^a-z0-9\-_ ]/gi, '_').slice(0, 80);
            a.href = URL.createObjectURL(blob);
            a.download = `${safeName}-${campaignId}.csv`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();

            showNotification('Downloading report...', 'success');
        } catch (e) {
            console.error('Export campaign report error:', e);
            showNotification('Failed to download report', 'error');
        }
    }
    
    // Load message templates into the Broadcast composer (modal picker)
    async function openBroadcastTemplatePicker() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;
        
        try {
            const response = await fetch(`/api/broadcast/templates/${tenantId}`, {
                headers: { ...api.authHeaders() }
            });
            const result = await response.json();
            
            if (!result.success || !result.templates || result.templates.length === 0) {
                showNotification('No templates saved yet', 'info');
                return;
            }
            
            // Show template selector modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold">Load Message Template</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white/20 rounded-lg p-2">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto" style="max-height: calc(80vh - 100px);">
                        <div class="space-y-3">
                            ${result.templates.map(template => `
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition"
                                     onclick='useTemplate(${JSON.stringify(template.id)}, ${JSON.stringify(template.template_text || template.message_text || '')}, ${JSON.stringify(template.image_url || '')}, ${JSON.stringify(template.message_type || template.category || 'text')})'>
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="font-semibold text-gray-900">${escapeHtml(template.name || template.template_name || 'Template')}</h3>
                                        <span class="text-xs text-gray-500">Used ${template.usage_count || 0}x</span>
                                    </div>
                                    <p class="text-sm text-gray-600 line-clamp-3">${escapeHtml(template.template_text || template.message_text || '')}</p>
                                    ${template.image_url ? `
                                        <div class="mt-2">
                                            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">
                                                <i class="fas fa-image mr-1"></i> Has Image
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } catch (err) {
            console.error('Error loading templates:', err);
            showNotification('Failed to load templates', 'error');
        }
    }
    
    // Use template
    async function useTemplate(templateId, messageText, imageUrl, messageType) {
        document.getElementById('broadcastMessage').value = messageText;
        
        if ((String(messageType || '').toLowerCase() === 'image' || !!imageUrl) && imageUrl) {
            document.querySelector('input[name="messageType"][value="image"]').checked = true;
            toggleMessageType();
            // If the template stored a data URL/base64 (or a URL), show it as the selected image.
            uploadedImageBase64 = imageUrl;
            uploadedImagesBase64 = imageUrl ? [imageUrl] : [];
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('previewImg');
            if (img) img.src = imageUrl;
            const countLabel = document.getElementById('imageCountLabel');
            if (countLabel) countLabel.textContent = uploadedImagesBase64.length ? '1 image selected' : '';
            if (preview) preview.classList.remove('hidden');
        }
        
        // Increment usage count
        await fetch(`/api/broadcast/templates/${templateId}/use`, { method: 'PUT', headers: { ...api.authHeaders() } });
        
        // Close modal
        document.querySelector('.fixed.inset-0').remove();
        showNotification('Template loaded!', 'success');
    }
    
    // Save as template
    async function saveAsTemplate() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;
        
        const messageText = document.getElementById('broadcastMessage').value.trim();
        if (!messageText) {
            showNotification('Please enter a message first', 'error');
            return;
        }
        
        const templateName = prompt('Enter a name for this template:');
        if (!templateName) return;
        
        const messageType = document.querySelector('input[name="messageType"]:checked').value;
        
        try {
            const result = await api.postJSON('/api/broadcast/templates', {
                tenantId,
                templateName,
                messageText,
                messageType,
                imageUrl: (uploadedImagesBase64 && uploadedImagesBase64.length) ? uploadedImagesBase64[0] : uploadedImageBase64,
                // Explicit fields used by the Templates tab editor too
                name: templateName,
                templateText: messageText,
                category: messageType,
                message_type: messageType,
                isActive: true
            });
            
            if (result.success) {
                showNotification('Template saved successfully!', 'success');
            } else {
                showNotification(result.error || 'Failed to save template', 'error');
            }
        } catch (err) {
            console.error('Error saving template:', err);
            showNotification('Failed to save template', 'error');
        }
    }

    // Broadcast helper functions
    let uploadedRecipients = [];
    let uploadedImageBase64 = null;
    let uploadedImagesBase64 = [];

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                // Extract phone numbers from multiple possible columns
                // Google Contacts format: "Phone 1 - Value", "Phone 2 - Value", etc.
                // Also supports: phone, number, mobile, whatsapp, cell, telephone
                const phoneColumns = [
                    'phone', 'number', 'mobile', 'whatsapp', 'cell', 'telephone',
                    'Phone', 'Number', 'Mobile', 'WhatsApp', 'Cell', 'Telephone',
                    'Phone 1 - Value', 'Phone 2 - Value', 'Phone 3 - Value',
                    'phone 1 - value', 'phone 2 - value', 'phone 3 - value'
                ];
                
                const phones = [];
                jsonData.forEach(row => {
                    // Try all possible column names
                    for (const col of phoneColumns) {
                        if (row[col]) {
                            const cleaned = String(row[col]).replace(/\D/g, '');
                            if (cleaned && cleaned.length >= 10) {
                                phones.push(cleaned);
                            }
                        }
                    }
                    
                    // Also check all columns that contain "phone" or "mobile" in the name
                    Object.keys(row).forEach(key => {
                        if ((key.toLowerCase().includes('phone') || key.toLowerCase().includes('mobile')) && row[key]) {
                            const cleaned = String(row[key]).replace(/\D/g, '');
                            if (cleaned && cleaned.length >= 10 && !phones.includes(cleaned)) {
                                phones.push(cleaned);
                            }
                        }
                    });
                });
                
                // Remove duplicates
                uploadedRecipients = [...new Set(phones)];

                if (uploadedRecipients.length === 0) {
                    showNotification('❌ No valid phone numbers found. Make sure the file has phone numbers in any column.', 'error');

                    return;
                }

                // Show summary
                document.getElementById('fileInfo').textContent = `✓ ${uploadedRecipients.length} recipients loaded`;
                document.getElementById('fileInfo').classList.remove('hidden');
                
                // Show numbers list
                const recipientsList = document.getElementById('recipientsList');
                const recipientsNumbers = document.getElementById('recipientsNumbers');
                recipientsNumbers.innerHTML = uploadedRecipients.map((phone, idx) => 
                    `<div class="flex items-center gap-2">
                        <span class="text-gray-400">${idx + 1}.</span>
                        <span class="font-mono">+${phone}</span>
                    </div>`
                ).join('');
                recipientsList.classList.remove('hidden');
                
                showNotification(`✅ Successfully loaded ${uploadedRecipients.length} phone numbers!`, 'success');
            } catch (err) {
                console.error('File read error:', err);
                showNotification('❌ Error reading file. Supported formats: CSV, Excel (.xlsx, .xls)', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function clearRecipients() {
        uploadedRecipients = [];
        document.getElementById('recipientsFile').value = '';
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('recipientsList').classList.add('hidden');
        showNotification('Recipients cleared', 'info');
    }

    // Contact Groups Functions
    let contactGroups = [];

    function switchRecipientMode(mode) {
        const uploadBtn = document.getElementById('recipientModeUpload');
        const pasteBtn = document.getElementById('recipientModePaste');
        const groupsBtn = document.getElementById('recipientModeGroups');
        const uploadMode = document.getElementById('uploadMode');
        const pasteMode = document.getElementById('pasteMode');
        const groupsMode = document.getElementById('groupsMode');

        // Reset all buttons with mobile-responsive classes
        const inactiveClass = 'px-2 py-3 rounded-lg border-2 border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-xs md:text-sm hover:shadow-md transition';
        const activeClass = 'px-2 py-3 rounded-lg border-2 border-indigo-500 bg-indigo-50 text-indigo-700 font-semibold text-xs md:text-sm hover:shadow-md transition';

        uploadBtn.className = inactiveClass;
        pasteBtn.className = inactiveClass;
        groupsBtn.className = inactiveClass;

        uploadMode.classList.add('hidden');
        pasteMode.classList.add('hidden');
        groupsMode.classList.add('hidden');

        if (mode === 'upload') {
            uploadBtn.className = activeClass;
            uploadMode.classList.remove('hidden');
        } else if (mode === 'paste') {
            pasteBtn.className = activeClass;
            pasteMode.classList.remove('hidden');
        } else {
            groupsBtn.className = activeClass;
            groupsMode.classList.remove('hidden');
            loadContactGroups();
        }
    }

    // iPhone Contact Paste Functions
    function handleContactPaste() {
        const textarea = document.getElementById('pasteContacts');
        const text = textarea.value;

        if (!text.trim()) {
            return; // Silently return if empty
        }

        // Extract phone numbers using multiple patterns
        // Matches international numbers like +1234567890, (123) 456-7890, 123-456-7890, etc.
        const phoneRegex = /[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,5}[-\s\.]?[0-9]{1,5}/g;
        const matches = text.match(phoneRegex) || [];
        
        // Clean and deduplicate
        const phones = [...new Set(matches.map(phone => 
            phone.replace(/[\s\-\(\)\.]/g, '').replace(/^[+]/, '')
        ))].filter(phone => phone.length >= 10 && phone.length <= 15);

        if (phones.length === 0) {
            showNotification('No valid phone numbers found. Try pasting from WhatsApp or your contact list.', 'error');
            return;
        }

        // Replace uploadedRecipients instead of appending
        uploadedRecipients = phones;

        // Display extracted numbers with better formatting
        const list = document.getElementById('pasteRecipientsList');
        const numbersDiv = document.getElementById('pasteRecipientsNumbers');
        const countBadge = document.getElementById('pasteCountBadge');
        
        countBadge.textContent = `${phones.length} contact${phones.length > 1 ? 's' : ''} ready to broadcast`;
        
        numbersDiv.innerHTML = uploadedRecipients.map((phone, idx) => 
            `<div class="flex items-center gap-2 py-1 hover:bg-gray-50 px-2 rounded">
                <span class="text-green-500"><i class="fas fa-check-circle"></i></span>
                <span class="text-gray-400 text-xs">${idx + 1}.</span>
                <span class="font-mono text-gray-800">+${phone}</span>
            </div>`
        ).join('');
        
        list.classList.remove('hidden');
        showNotification(`✅ Found ${phones.length} phone number${phones.length > 1 ? 's' : ''}!`, 'success');
    }

    function clearPastedRecipients() {
        uploadedRecipients = [];
        document.getElementById('pasteContacts').value = '';
        document.getElementById('pasteRecipientsList').classList.add('hidden');
        showNotification('Cleared all contacts', 'info');
    }

    async function loadContactGroups() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        try {
            const response = await fetch(`/api/broadcast/groups/${tenantId}`);
            const result = await response.json();

            if (result.success) {
                contactGroups = result.groups || [];
                renderContactGroups();
            }
        } catch (error) {
            console.error('Error loading contact groups:', error);
            showNotification('Error loading contact groups', 'error');
        }
    }

    function renderContactGroups() {
        const container = document.getElementById('contactGroupsList');
        
        if (contactGroups.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-users text-gray-300 text-4xl mb-3"></i>
                    <p class="text-gray-500">No saved groups yet</p>
                    <p class="text-xs text-gray-400 mt-2">Upload contacts and save them as a group for quick reuse</p>
                </div>
            `;
            return;
        }

        container.innerHTML = contactGroups.map(group => `
            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                <div class="flex items-center justify-between">
                    <label class="flex items-center cursor-pointer flex-1">
                        <input type="checkbox" onchange="toggleGroupSelection('${group.id}')" 
                            class="w-5 h-5 text-indigo-600 rounded mr-3">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${escapeHtml(group.group_name)}</p>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-users mr-1"></i>${group.contact_count} contacts
                                <span class="mx-2">•</span>
                                <i class="fas fa-clock mr-1"></i>${new Date(group.created_at).toLocaleDateString()}
                            </p>
                        </div>
                    </label>
                    <button type="button" onclick="deleteGroup('${group.id}')" 
                        class="ml-2 text-red-500 hover:text-red-700 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function toggleGroupSelection(groupId) {
        const group = contactGroups.find(g => g.id === groupId);
        if (!group) return;

        const checkbox = event.target;
        
        if (checkbox.checked) {
            // Add contacts from this group
            const newContacts = group.contacts.filter(c => !uploadedRecipients.includes(c));
            uploadedRecipients.push(...newContacts);
            showNotification(`Added ${group.contact_count} contacts from ${group.group_name}`, 'success');
        } else {
            // Remove contacts from this group
            uploadedRecipients = uploadedRecipients.filter(c => !group.contacts.includes(c));
            showNotification(`Removed ${group.group_name} contacts`, 'info');
        }
    }

    function showSaveGroupDialog() {
        if (uploadedRecipients.length === 0) {
            showNotification('No recipients loaded to save', 'error');
            return;
        }

        const groupName = prompt(`Save ${uploadedRecipients.length} contacts as a group\n\nEnter group name (e.g., "iPhone Contacts", "Sales Team"):`);
        if (!groupName || !groupName.trim()) return;

        saveContactGroup(groupName.trim());
    }

    async function saveContactGroup(groupName) {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        try {
            const response = await fetch('/api/broadcast/groups/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tenantId,
                    groupName,
                    contacts: uploadedRecipients
                })
            });

            const result = await response.json();
            
            if (result.success) {
                showNotification(`✅ Group "${groupName}" saved with ${uploadedRecipients.length} contacts`, 'success');
                loadContactGroups(); // Refresh the list
            } else {
                showNotification(result.error || 'Failed to save group', 'error');
            }
        } catch (error) {
            console.error('Error saving group:', error);
            showNotification('Error saving contact group', 'error');
        }
    }

    async function deleteGroup(groupId) {
        if (!confirm('Are you sure you want to delete this contact group?')) return;

        try {
            const response = await fetch(`/api/broadcast/groups/${groupId}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            
            if (result.success) {
                showNotification('Group deleted successfully', 'success');
                loadContactGroups(); // Refresh the list
            } else {
                showNotification('Failed to delete group', 'error');
            }
        } catch (error) {
            console.error('Error deleting group:', error);
            showNotification('Error deleting group', 'error');
        }
    }

    function handleImageUpload(event) {
        const files = Array.from(event.target.files || []).filter(Boolean);
        if (!files.length) return;

        // Check file size (max 5MB each)
        for (const f of files) {
            if (f.size > 5 * 1024 * 1024) {
                showNotification('❌ Image too large! Please use images under 5MB', 'error');
                return;
            }
        }

        uploadedImagesBase64 = [];
        uploadedImageBase64 = null;

        const readAsDataUrl = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        Promise.all(files.map(readAsDataUrl))
            .then((results) => {
                uploadedImagesBase64 = results.filter(Boolean);
                uploadedImageBase64 = uploadedImagesBase64[0] || null;

                if (!uploadedImageBase64) {
                    showNotification('❌ Failed to read image(s)', 'error');
                    return;
                }

                document.getElementById('previewImg').src = uploadedImageBase64;
                document.getElementById('imageCountLabel').textContent = `${uploadedImagesBase64.length} image${uploadedImagesBase64.length > 1 ? 's' : ''} selected`;
                document.getElementById('imagePreview').classList.remove('hidden');
                showNotification('✅ Image(s) uploaded successfully!', 'success');
            })
            .catch((err) => {
                console.error('Image read error:', err);
                showNotification('❌ Error reading image(s)', 'error');
            });
    }

    function removeImage() {
        uploadedImageBase64 = null;
        uploadedImagesBase64 = [];
        document.getElementById('broadcastImage').value = '';
        document.getElementById('imagePreview').classList.add('hidden');
        showNotification('Image removed', 'info');
    }

    function toggleMessageType() {
        const messageType = document.querySelector('input[name="messageType"]:checked').value;
        const imageSection = document.getElementById('imageUploadSection');
        const messageLabel = document.getElementById('messageLabel');
        
        if (messageType === 'image') {
            imageSection.classList.remove('hidden');
            messageLabel.textContent = 'Caption';
        } else {
            imageSection.classList.add('hidden');
            messageLabel.textContent = 'Text';
            uploadedImageBase64 = null;
            uploadedImagesBase64 = [];
        }
    }

    function toggleSchedule() {
        const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
        const scheduleTimeInput = document.getElementById('scheduleTime');
        const submitButtonText = document.getElementById('submitButtonText');
        
        if (scheduleType === 'later') {
            scheduleTimeInput.classList.remove('hidden');
            submitButtonText.textContent = 'Schedule Broadcast';
        } else {
            scheduleTimeInput.classList.add('hidden');
            submitButtonText.textContent = 'Send Broadcast Now';
        }
    }

    async function handleBroadcastSubmit(e) {
        e.preventDefault();
        
        const tenantId = state.session?.tenantId;
        if (!tenantId) {
            showNotification('Session expired. Please refresh.', 'error');
            return;
        }

        if (uploadedRecipients.length === 0) {
            showNotification('Please upload a recipients Excel file', 'error');
            return;
        }

        const sendVia = (document.getElementById('broadcastSendVia')?.value || 'auto');

        // Get bot delivery method from saved features (used to decide if WhatsApp Web checks are needed)
        const savedFeatures = JSON.parse(localStorage.getItem(`tenant_features_${tenantId}`)) || {};
        const botDeliveryMethod = savedFeatures.bot_delivery_method || 'desktop';

        // Check WhatsApp Web status before sending (only when relevant)
        const needsWaWeb = (sendVia === 'whatsapp_web') || (sendVia === 'auto' && botDeliveryMethod === 'cloud');
        if (needsWaWeb) {
            const waWebStatus = await checkWhatsAppWebStatus();
            if (sendVia === 'whatsapp_web') {
                if (!waWebStatus.connected) {
                    showNotification('WhatsApp Web is disconnected. Please connect WhatsApp Web or choose Maytapi.', 'error');
                    return;
                }
            } else if (sendVia === 'auto') {
                if (!waWebStatus.connected) {
                    const proceed = confirm('⚠️ WhatsApp Web is disconnected. Broadcasts may fallback to Maytapi (Paid) if configured.\n\nDo you want to continue?');
                    if (!proceed) {
                        return;
                    }
                }
            }
        }

        const campaignName = document.getElementById('campaignName').value;
        const message = document.getElementById('broadcastMessage').value;
        const messageType = document.querySelector('input[name="messageType"]:checked').value;
        const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
        const scheduleTime = document.getElementById('scheduleTime').value;
        
        // Get batch settings
        const batchSize = parseInt(document.getElementById('batchSize').value) || 10;
        const messageDelay = parseInt(document.getElementById('messageDelay').value) || 500;
        const batchDelay = parseInt(document.getElementById('batchDelay').value) || 2000;

        if (messageType === 'image' && !(uploadedImagesBase64 && uploadedImagesBase64.length)) {
            showNotification('Please upload an image', 'error');
            return;
        }

        // Provider forcing for broadcast (paid clients can choose per broadcast)
        let forceMethod = null;
        let botDeliveryMethodToUse = botDeliveryMethod;
        if (sendVia === 'maytapi') {
            forceMethod = 'maytapi';
        } else if (sendVia === 'whatsapp_web') {
            // Force the WhatsApp Web/WAHA path and skip desktop agent
            forceMethod = 'waha';
            botDeliveryMethodToUse = 'cloud';
        } else if (sendVia === 'desktop_agent') {
            forceMethod = 'desktop_agent';
            botDeliveryMethodToUse = 'desktop';
        }

        const payload = {
            tenantId,
            campaignName,
            message,
            recipients: uploadedRecipients,
            messageType,
            scheduleType,
            scheduleTime: scheduleType === 'later' ? scheduleTime : null,
            imageBase64: messageType === 'image' ? (uploadedImagesBase64[0] || uploadedImageBase64) : null,
            imageBase64List: messageType === 'image' ? (uploadedImagesBase64 || []) : null,
            batchSize,
            messageDelay,
            batchDelay,
            botDeliveryMethod: botDeliveryMethodToUse
        };

        if (forceMethod) {
            payload.forceMethod = forceMethod;
        }

        // Show loading state
        const submitButton = document.querySelector('#broadcastForm button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

        try {
            let response, result;
            
            // ALWAYS use server API - it will intelligently route to desktop agent or fallback
            // This ensures broadcast history is properly saved in database
            console.log('[BROADCAST] Sending via server API (will route to desktop agent if available)');
            
            response = await fetch('/api/broadcast/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            result = await response.json();
            
            if (result.success) {
                if (scheduleType === 'later') {
                    showNotification(`Broadcast scheduled successfully!`, 'success');
                } else {
                    // Show success message for background processing
                    showNotification(`✅ Broadcast started! Processing ${result.details.total} recipients in background.`, 'success');
                }
                
                // Reset form
                document.getElementById('broadcastForm').reset();
                clearRecipients();
                uploadedImageBase64 = null;
                uploadedImagesBase64 = [];
                document.getElementById('imagePreview').classList.add('hidden');
                
                // Reload history immediately and set up auto-refresh
                loadBroadcastHistory();
                
                // Auto-refresh history every 5 seconds for next 2 minutes to show progress
                let refreshCount = 0;
                const maxRefreshes = 24; // 2 minutes
                const refreshInterval = setInterval(() => {
                    refreshCount++;
                    loadBroadcastHistory();
                    if (refreshCount >= maxRefreshes) {
                        clearInterval(refreshInterval);
                    }
                }, 5000);
            } else {
                showNotification(result.error || 'Failed to send broadcast', 'error');
            }
        } catch (err) {
            console.error('Broadcast error:', err);
            showNotification('Error sending broadcast', 'error');
        } finally {
            // Restore button
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    }

    function showBroadcastReport(details) {
        const successRate = details.total > 0 ? ((details.success / details.total) * 100).toFixed(1) : 0;
        
        let errorHtml = '';
        if (details.errors && details.errors.length > 0) {
            errorHtml = `
                <div class="mt-4 p-4 bg-red-50 rounded-lg border border-red-200">
                    <h4 class="font-semibold text-red-900 mb-2">Failed Numbers:</h4>
                    <div class="space-y-1 text-sm text-red-700 max-h-40 overflow-y-auto">
                        ${details.errors.map(err => `
                            <div class="flex justify-between">
                                <span class="font-mono">+${err.recipient}</span>
                                <span class="text-xs">${err.error}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-8">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                            <i class="fas fa-check-circle text-3xl text-green-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Broadcast Complete!</h2>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-600">${details.total}</div>
                            <div class="text-sm text-gray-600 mt-1">Total</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-600">${details.success}</div>
                            <div class="text-sm text-gray-600 mt-1">Sent</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-red-600">${details.failed}</div>
                            <div class="text-sm text-gray-600 mt-1">Failed</div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Success Rate</span>
                            <span class="font-semibold">${successRate}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-500" 
                                style="width: ${successRate}%"></div>
                        </div>
                    </div>

                    ${errorHtml}

                    <div class="mt-6 flex gap-3">
                        <button onclick="this.closest('.fixed').remove()" 
                            class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition">
                            Done
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close on outside click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function showBroadcastHelp() {
        showNotification('Send broadcast commands directly to your WhatsApp bot number. The bot will process them automatically!', 'info');
    }

    // ---------- Follow-ups Functions ----------
    async function loadFollowUps() {
        const statusFilter = document.getElementById('followupStatusFilter')?.value || '';
        const customerFilter = document.getElementById('followupCustomerFilter')?.value || '';
        const leadTypeFilter = document.getElementById('leadTypeFilter')?.value || '';

        try {
            // Fetch follow-ups
            const params = new URLSearchParams();
            if (statusFilter) params.append('status', statusFilter);
            if (customerFilter) params.append('customer_phone', customerFilter);
            params.append('limit', '200');

            const url = `/api/followups/${state.session.tenantId}?${params.toString()}`;
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const data = await response.json();

            if (!data.success) throw new Error(data.error || 'Failed to load follow-ups');

            const followups = data.followups || [];
            state.data.followups = followups;
            
            // Fetch stats
            const statsResponse = await fetch(`/api/followups/${state.session.tenantId}/stats`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const statsData = await statsResponse.json();
            const stats = statsData.stats || {};

            // Fetch AI suggestions
            const suggestionsResponse = await fetch(`/api/followups/${state.session.tenantId}/suggestions`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const suggestionsData = await suggestionsResponse.json();
            const suggestions = suggestionsData.suggestions || [];

            // Fetch active chat leads
            const leadParams = new URLSearchParams();
            if (leadTypeFilter) leadParams.append('lead_type', leadTypeFilter);
            leadParams.append('limit', '500');
            const leadsResponse = await fetch(`/api/followups/${state.session.tenantId}/leads?${leadParams.toString()}`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const leadsData = await leadsResponse.json();
            const leads = leadsData.leads || [];

            document.getElementById('tabContent').innerHTML = `
                <div class="mb-6">
                    <h2 class="text-white text-2xl font-bold mb-4"><i class="fas fa-clock mr-3"></i>Follow-ups Management</h2>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-gray-600 text-sm mb-1">Total</div>
                            <div class="text-3xl font-bold text-gray-900">${stats.total || 0}</div>
                        </div>
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-blue-700 text-sm mb-1">Scheduled</div>
                            <div class="text-3xl font-bold text-blue-700">${stats.scheduled || 0}</div>
                        </div>
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-green-700 text-sm mb-1">Completed</div>
                            <div class="text-3xl font-bold text-green-700">${stats.completed || 0}</div>
                        </div>
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-red-700 text-sm mb-1">Failed</div>
                            <div class="text-3xl font-bold text-red-700">${stats.failed || 0}</div>
                        </div>
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-yellow-700 text-sm mb-1">Next 24h</div>
                            <div class="text-3xl font-bold text-yellow-700">${stats.upcoming24h || 0}</div>
                        </div>
                    </div>

                    <!-- Create Follow-up Button -->
                    <div class="mb-6 flex gap-3">
                        <button onclick="showCreateFollowupModal()" class="glass-effect px-6 py-3 rounded-xl text-white hover:bg-white/20 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create Follow-up
                        </button>
                        <button onclick="triggerIntelligentFollowUps()" class="glass-effect px-6 py-3 rounded-xl text-blue-300 hover:bg-blue-500/20 transition-colors">
                            <i class="fas fa-magic mr-2"></i>Analyze & Create Smart Follow-ups
                        </button>
                    </div>

                    <!-- AI Suggestions -->
                    ${suggestions.length > 0 ? `
                        <div class="config-card p-6 rounded-xl mb-6">
                            <h3 class="text-gray-900 text-lg font-bold mb-4">
                                <i class="fas fa-lightbulb mr-2 text-yellow-600"></i>AI Suggestions
                            </h3>
                            <div class="space-y-3">
                                ${suggestions.map(s => `
                                    <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-gray-900 font-medium">${s.customer_name || s.customer_phone}</span>
                                                <span class="px-2 py-1 rounded text-xs ${
                                                    s.priority === 'high' ? 'bg-red-100 text-red-700' :
                                                    s.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                                                    'bg-blue-100 text-blue-700'
                                                }">${s.priority.toUpperCase()}</span>
                                                <span class="text-gray-500 text-sm">${s.type.replace('_', ' ')}</span>
                                            </div>
                                            <div class="text-gray-700 text-sm">${s.reason}</div>
                                            <div class="text-gray-500 text-xs mt-1">${new Date(s.suggested_time).toLocaleString()}</div>
                                        </div>
                                        <button onclick='createFollowupFromSuggestion(${JSON.stringify(s)})' class="px-4 py-2 rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 text-sm">
                                            <i class="fas fa-plus mr-1"></i>Create
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Filters -->
                    <div class="config-card p-4 rounded-xl mb-6">
                        <div class="flex flex-wrap gap-4">
                            <select id="followupStatusFilter" class="search-input px-4 py-2 rounded-xl text-sm" onchange="loadFollowUps()">
                                <option value="">All Statuses</option>
                                <option value="scheduled" ${statusFilter==='scheduled'?'selected':''}>Scheduled</option>
                                <option value="completed" ${statusFilter==='completed'?'selected':''}>Completed</option>
                                <option value="failed" ${statusFilter==='failed'?'selected':''}>Failed</option>
                                <option value="cancelled" ${statusFilter==='cancelled'?'selected':''}>Cancelled</option>
                            </select>
                            <select id="leadTypeFilter" class="search-input px-4 py-2 rounded-xl text-sm" onchange="loadFollowUps()">
                                <option value="" ${leadTypeFilter===''?'selected':''}>All Lead Types</option>
                                <option value="hot" ${leadTypeFilter==='hot'?'selected':''}>Hot Lead</option>
                                <option value="warm" ${leadTypeFilter==='warm'?'selected':''}>Warm Lead</option>
                                <option value="new" ${leadTypeFilter==='new'?'selected':''}>New Lead</option>
                                <option value="cold" ${leadTypeFilter==='cold'?'selected':''}>Cold Lead</option>
                            </select>
                            <input type="text" id="followupCustomerFilter" placeholder="Search by customer phone" 
                                class="search-input px-4 py-2 rounded-xl text-sm flex-1" value="${customerFilter}"
                                onkeyup="if(event.key==='Enter') loadFollowUps()">
                            <button onclick="loadFollowUps()" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Active Chats (Lead List) -->
                    <div class="config-card p-6 rounded-xl mb-6">
                        <h3 class="text-gray-900 text-lg font-bold mb-4">
                            <i class="fas fa-users mr-2 text-blue-600"></i>Active Chats
                        </h3>
                        ${leads.length === 0 ? `
                            <div class="text-center py-10">
                                <div class="text-gray-600">No active chats found</div>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${leads.map(l => {
                                    const lastAt = l.last_message_at ? new Date(l.last_message_at) : null;
                                    const badge = l.lead_type === 'hot'
                                        ? 'bg-red-100 text-red-700'
                                        : l.lead_type === 'warm'
                                            ? 'bg-yellow-100 text-yellow-700'
                                            : l.lead_type === 'new'
                                                ? 'bg-blue-100 text-blue-700'
                                                : 'bg-gray-100 text-gray-700';

                                    const label = l.lead_type === 'hot'
                                        ? 'HOT'
                                        : l.lead_type === 'warm'
                                            ? 'WARM'
                                            : l.lead_type === 'new'
                                                ? 'NEW'
                                                : 'COLD';

                                    return `
                                        <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-between">
                                            <div>
                                                <div class="flex items-center gap-3 mb-1">
                                                    <button class="text-gray-900 font-medium hover:underline" onclick='openChatFromPhone(${JSON.stringify(l.phone || '')})'>${l.phone || ''}</button>
                                                    <span class="px-2 py-1 rounded text-xs ${badge}">${label} LEAD</span>
                                                </div>
                                                <div class="text-gray-500 text-xs">
                                                    ${lastAt ? `Last message: ${lastAt.toLocaleString()}` : 'Last message: -'}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Follow-ups List -->
                    <div class="space-y-4">
                        ${followups.length === 0 ? `
                            <div class="config-card p-12 rounded-xl text-center">
                                <i class="fas fa-clock text-gray-300 text-5xl mb-4"></i>
                                <p class="text-gray-800 text-lg">No follow-ups found</p>
                                <p class="text-gray-500 text-sm mt-2">Create your first follow-up or let customers request them</p>
                            </div>
                        ` : followups.map(f => {
                            const scheduledTime = new Date(f.scheduled_time);
                            const isPast = scheduledTime < new Date();
                            const isUpcoming = !isPast && (scheduledTime - new Date()) < 24 * 60 * 60 * 1000;
                            
                            return `
                                <div class="config-card p-6 rounded-xl">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <span class="px-3 py-1 rounded-lg text-sm font-medium ${
                                                    f.status === 'scheduled' ? 'bg-blue-100 text-blue-700' :
                                                    f.status === 'completed' ? 'bg-green-100 text-green-700' :
                                                    f.status === 'failed' ? 'bg-red-100 text-red-700' :
                                                    'bg-gray-100 text-gray-700'
                                                }">${f.status.toUpperCase()}</span>
                                                ${isUpcoming && f.status === 'scheduled' ? '<span class="px-3 py-1 rounded-lg text-sm font-medium bg-yellow-100 text-yellow-700">UPCOMING</span>' : ''}
                                            </div>
                                            <div class="text-gray-900 font-medium text-lg mb-2">
                                                ${f.customer?.business_name || f.customer?.name || f.end_user_phone}
                                            </div>
                                            <div class="text-gray-700 mb-2">${f.description}</div>
                                            <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                                                <div>
                                                    <i class="fas fa-phone mr-1"></i>
                                                    <button class="text-blue-700 hover:underline" onclick='openChatFromPhone(${JSON.stringify(f.end_user_phone || '')})'>${f.end_user_phone}</button>
                                                </div>
                                                <div><i class="fas fa-calendar mr-1"></i>${scheduledTime.toLocaleDateString()}</div>
                                                <div><i class="fas fa-clock mr-1"></i>${scheduledTime.toLocaleTimeString()}</div>
                                                <div><i class="fas fa-info-circle mr-1"></i>${f.original_request || 'Manual'}</div>
                                            </div>
                                            ${f.conversation_context?.note ? `
                                                <div class="mt-3 p-3 bg-gray-50 rounded-lg text-gray-700 text-sm">
                                                    <i class="fas fa-sticky-note mr-2"></i>${f.conversation_context.note}
                                                </div>
                                            ` : ''}
                                            ${f.error_message ? `
                                                <div class="mt-3 p-3 bg-red-50 rounded-lg text-red-700 text-sm">
                                                    <i class="fas fa-exclamation-circle mr-2"></i>${f.error_message}
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="flex gap-2 ml-4">
                                            <button onclick="addFollowupToCustomers('${f.id}')" class="p-3 rounded-lg bg-blue-50 hover:bg-blue-100 text-blue-700" title="Add to Customers">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                            ${f.status === 'scheduled' ? `
                                                <button onclick="sendFollowupNow('${f.id}')" class="p-3 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700" title="Send now">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                                <button onclick="editFollowup('${f.id}')" class="p-3 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            ` : ''}
                                            <button onclick="deleteFollowup('${f.id}')" class="p-3 rounded-lg bg-red-50 hover:bg-red-100 text-red-600" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

        } catch (error) {
            console.error('[loadFollowUps] Error:', error);
            document.getElementById('tabContent').innerHTML = `
                <div class="config-card p-12 rounded-xl text-center">
                    <i class="fas fa-exclamation-circle text-red-400 text-5xl mb-4"></i>
                    <p class="text-gray-900 text-lg mb-2">Failed to load follow-ups</p>
                    <p class="text-gray-600 text-sm">${error.message}</p>
                    <button onclick="loadFollowUps()" class="px-6 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 mt-4">
                        <i class="fas fa-redo mr-2"></i>Retry
                    </button>
                </div>
            `;
        }
    }

    // ---------- Leads Functions ----------
    async function loadLeads() {
        if (!state.session?.tenantId) throw new Error('No tenant session');

        const params = new URLSearchParams();
        if (state.searchQuery) params.append('q', state.searchQuery);

        // Load pipeline board (includes enriched leads)
        const url = `/api/leads-pipeline/${state.session.tenantId}/board${params.toString() ? `?${params.toString()}` : ''}`;
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${state.session.token}` }
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'Failed to load leads pipeline');

        const leads = data.leads || [];
        state.data.leads = leads;
        state.data.leadsPipeline = { readonly: data.readonly === true, stages: data.stages || [], columns: data.columns || [] };

        const scoreLabel = (s) => String(s || '').toUpperCase();
        const badgeForScore = (s) => {
            const v = scoreLabel(s);
            if (v === 'HOT') return 'bg-red-100 text-red-800';
            if (v === 'WARM') return 'bg-yellow-100 text-yellow-800';
            if (v === 'COLD') return 'bg-blue-100 text-blue-800';
            return 'bg-gray-100 text-gray-700';
        };

        const count = (v) => leads.filter(l => scoreLabel(l.lead_score) === v).length;
        const hot = count('HOT');
        const warm = count('WARM');
        const cold = count('COLD');

        const pipelineReadonly = state.data.leadsPipeline?.readonly === true;
        const pipelineStages = state.data.leadsPipeline?.stages || [];
        const pipelineColumns = state.data.leadsPipeline?.columns || [];

        const stageBadge = (name) => {
            const n = String(name || '').toLowerCase();
            if (n.includes('won')) return 'bg-emerald-100 text-emerald-800';
            if (n.includes('lost')) return 'bg-red-100 text-red-800';
            if (n.includes('qual')) return 'bg-blue-100 text-blue-800';
            return 'bg-gray-100 text-gray-700';
        };

        document.getElementById('tabContent').innerHTML = `
            <div class="mb-6">
                <h2 class="text-white text-2xl font-bold mb-4"><i class="fas fa-user-tag mr-3"></i>Leads</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="config-card p-6 rounded-xl">
                        <div class="text-gray-600 text-sm mb-1">Hot</div>
                        <div class="text-3xl font-bold text-red-700">${hot}</div>
                    </div>
                    <div class="config-card p-6 rounded-xl">
                        <div class="text-gray-600 text-sm mb-1">Warm</div>
                        <div class="text-3xl font-bold text-yellow-700">${warm}</div>
                    </div>
                    <div class="config-card p-6 rounded-xl">
                        <div class="text-gray-600 text-sm mb-1">Cold</div>
                        <div class="text-3xl font-bold text-blue-700">${cold}</div>
                    </div>
                </div>

                <div class="config-card p-4 rounded-xl mb-6">
                    <div class="flex items-center justify-between flex-wrap gap-3">
                        <div>
                            <div class="text-gray-900 font-semibold flex items-center gap-2">
                                <span>Pipeline</span>
                                ${pipelineReadonly ? `<span class="px-2 py-1 rounded-lg text-xs font-medium bg-gray-100 text-gray-700">Read-only</span>` : ''}
                            </div>
                            <div class="text-xs text-gray-500">${pipelineReadonly ? 'Pipeline is read-only in this environment.' : 'Move leads across stages (New → Qualified → Won/Lost).'}</div>
                        </div>
                        <button onclick="loadLeads()" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20">
                            <i class="fas fa-rotate mr-2"></i>Refresh
                        </button>
                    </div>
                </div>

                ${pipelineStages.length === 0 ? `
                    <div class="config-card p-10 rounded-xl text-center mb-6">
                        <div class="text-gray-700 font-semibold">Pipeline not available</div>
                        <div class="text-gray-500 text-sm mt-1">Pipeline stages are created automatically in local mode.</div>
                    </div>
                ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        ${pipelineColumns.map(col => {
                            const st = col.stage || {};
                            const stName = st.name || '';
                            const stId = st.id || '';
                            const colLeads = col.leads || [];
                            return `
                                <div class="config-card p-4 rounded-xl">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-2 min-w-0">
                                            <span class="px-2 py-1 rounded-lg text-xs font-medium ${stageBadge(stName)}">${escapeHtml(stName)}</span>
                                            <span class="text-xs text-gray-500">${colLeads.length}</span>
                                        </div>
                                    </div>
                                    <div class="space-y-3">
                                        ${colLeads.length === 0 ? `<div class="text-xs text-gray-500">No leads</div>` : colLeads.map(l => {
                                            const phone = l.end_user_phone || '';
                                            const preview = l.last_message || l.lastMessage || '';
                                            const updated = l.updated_at ? new Date(l.updated_at).toLocaleString() : '';
                                            const needsHuman = (l.requires_human_attention === true || l.requires_human_attention === 1);
                                            const score = scoreLabel(l.lead_score);
                                            const currentStageId = l.pipeline_stage_id || stId;
                                            return `
                                                <div class="bg-white/80 rounded-xl p-4 hover:shadow-md transition cursor-pointer" onclick="openConversation('${state.session.tenantId}','${l.id}')">
                                                    <div class="flex items-start justify-between gap-3">
                                                        <div class="min-w-0">
                                                            <div class="flex items-center gap-2 flex-wrap">
                                                                <div class="text-sm font-semibold text-gray-900 truncate">${escapeHtml(phone || 'Unknown')}</div>
                                                                <span class="px-2 py-1 rounded-lg text-xs font-medium ${badgeForScore(score)}">${escapeHtml(score || 'LEAD')}</span>
                                                                ${needsHuman ? `<span class="px-2 py-1 rounded-lg text-xs font-medium bg-purple-100 text-purple-800"><i class='fas fa-user-shield mr-1'></i>Attention</span>` : ''}
                                                            </div>
                                                            ${preview ? `<div class="mt-2 text-xs text-gray-700 bg-gray-50 rounded-lg p-2">${escapeHtml(preview)}</div>` : ''}
                                                            <div class="mt-2 text-[11px] text-gray-500">Updated: ${escapeHtml(updated)}</div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3" onclick="event.stopPropagation()">
                                                        <select class="search-input px-3 py-2 rounded-xl text-xs w-full" ${pipelineReadonly ? 'disabled title="Read-only"' : ''} onchange="moveLeadStage('${l.id}', this.value)">
                                                            ${pipelineStages.map(s => {
                                                                const sid = String(s.id);
                                                                const selected = String(currentStageId) === sid ? 'selected' : '';
                                                                return `<option value="${escapeHtml(sid)}" ${selected}>Move to: ${escapeHtml(String(s.name || ''))}</option>`;
                                                            }).join('')}
                                                        </select>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}

                ${leads.length === 0 ? `
                    <div class="config-card p-10 rounded-xl text-center">
                        <div class="text-gray-700 font-semibold">No leads found</div>
                        <div class="text-gray-500 text-sm mt-1">Leads appear when conversations are scored or flagged for attention.</div>
                    </div>
                ` : `
                    <div class="space-y-3">
                        ${leads.map(l => {
                            const phone = l.end_user_phone || '';
                            const preview = l.last_message || l.lastMessage || '';
                            const updated = l.updated_at ? new Date(l.updated_at).toLocaleString() : '';
                            const needsHuman = (l.requires_human_attention === true || l.requires_human_attention === 1);
                            const score = scoreLabel(l.lead_score);
                            const stageName = l.pipeline_stage_name || '';
                            return `
                                <div class="config-card p-5 rounded-xl hover:shadow-lg transition-all cursor-pointer" onclick="openConversation('${state.session.tenantId}','${l.id}')">
                                    <div class="flex items-start justify-between gap-4">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <div class="text-gray-900 font-semibold">${escapeHtml(phone || 'Unknown')}</div>
                                                <span class="px-2 py-1 rounded-lg text-xs font-medium ${badgeForScore(score)}">${escapeHtml(score || 'LEAD')}</span>
                                                ${stageName ? `<span class="px-2 py-1 rounded-lg text-xs font-medium ${stageBadge(stageName)}">${escapeHtml(stageName)}</span>` : ''}
                                                ${needsHuman ? `<span class="px-2 py-1 rounded-lg text-xs font-medium bg-purple-100 text-purple-800"><i class='fas fa-user-shield mr-1'></i>Needs Attention</span>` : ''}
                                            </div>
                                            ${preview ? `<div class="mt-2 text-sm text-gray-700 bg-gray-50 rounded-lg p-3">${escapeHtml(preview)}</div>` : ''}
                                            <div class="mt-2 text-xs text-gray-500">Updated: ${escapeHtml(updated)}</div>
                                        </div>
                                        <div class="flex items-center text-gray-400">
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>
        `;
    }

    async function moveLeadStage(conversationId, stageId) {
        try {
            if (!state.session?.tenantId) throw new Error('No tenant session');
            if (state.data?.leadsPipeline?.readonly === true) {
                showNotification('Pipeline is read-only in this environment', 'warning');
                return;
            }
            const path = `/api/leads-pipeline/${state.session.tenantId}/leads/${conversationId}/stage`;
            const resp = await api.putJSON(path, { stage_id: stageId });
            if (!resp.success) throw new Error(resp.error || 'Failed to move lead');
            showNotification('Lead moved', 'success');
            await loadLeads();
        } catch (err) {
            showNotification(err.message || String(err), 'error');
        }
    }

    // ---------- Triage Functions ----------
    async function loadTriage() {
        if (!state.session?.tenantId) throw new Error('No tenant session');

        // Load sales team assignees (best-effort; triage should still render if unavailable)
        try {
            const teamRes = await fetch(`/api/sales-team/${state.session.tenantId}`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const teamData = await teamRes.json();
            state.data.salesTeam = teamData?.success ? (teamData.users || []) : [];
        } catch (_) {
            state.data.salesTeam = [];
        }

        // Load smart-assign status (best-effort)
        try {
            const asRes = await fetch(`/api/triage-assignment/${state.session.tenantId}/status`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const asData = await asRes.json();
            state.data.triageAssignStatus = asData?.success ? asData : null;
        } catch (_) {
            state.data.triageAssignStatus = null;
        }

        // Load smart-assign config (best-effort; may be readonly in hosted env)
        try {
            const cfgRes = await fetch(`/api/triage-assignment/${state.session.tenantId}/config`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const cfgData = await cfgRes.json();
            state.data.triageAssignConfig = cfgData?.success ? (cfgData.config || null) : null;
            state.data.triageAssignConfigReadonly = cfgData?.readonly === true;
        } catch (_) {
            state.data.triageAssignConfig = null;
            state.data.triageAssignConfigReadonly = true;
        }

        // Load SLA config (best-effort)
        try {
            const slaRes = await fetch(`/api/triage/${state.session.tenantId}/sla-config`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const slaData = await slaRes.json();
            state.data.triageSlaConfig = slaData?.success ? (slaData.config || null) : null;
        } catch (_) {
            state.data.triageSlaConfig = null;
        }

        const statusFilter = document.getElementById('triageStatusFilter')?.value || '';
        const assigneeFilter = document.getElementById('triageAssigneeFilter')?.value || '';
        const params = new URLSearchParams();
        if (statusFilter) params.append('status', statusFilter);
        if (assigneeFilter === '__UNASSIGNED__') {
            params.append('unassigned', '1');
        } else if (assigneeFilter) {
            params.append('assigned_to', assigneeFilter);
        }

        const url = `/api/triage/${state.session.tenantId}${params.toString() ? `?${params.toString()}` : ''}`;
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${state.session.token}` }
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'Failed to load triage');

        const items = data.items || [];
        state.data.triage = items;

        const countBy = (s) => items.filter(i => String(i.status || '').toUpperCase() === s).length;
        const countNew = countBy('NEW');
        const countInProgress = countBy('IN_PROGRESS');
        const countClosed = countBy('CLOSED');

        const badgeFor = (status) => {
            const s = String(status || '').toUpperCase();
            if (s === 'NEW') return 'bg-yellow-100 text-yellow-800';
            if (s === 'IN_PROGRESS') return 'bg-blue-100 text-blue-800';
            if (s === 'CLOSED') return 'bg-green-100 text-green-800';
            return 'bg-gray-100 text-gray-700';
        };

        document.getElementById('tabContent').innerHTML = `
            <div class="mb-6">
                ${(() => {
                    const team = Array.isArray(state.data.salesTeam) ? state.data.salesTeam : [];
                    const statusObj = state.data.triageAssignStatus;
                    const enabled = statusObj?.enabled === true ? true : (team.length > 0);
                    const pillClass = enabled ? 'bg-emerald-100 text-emerald-800' : 'bg-gray-100 text-gray-700';
                    const pillText = enabled ? 'Smart Assign: ON' : 'Smart Assign: OFF';
                    return `
                        <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
                            <h2 class="text-white text-2xl font-bold"><i class="fas fa-life-ring mr-3"></i>Triage</h2>
                            <span class="px-3 py-1 rounded-xl text-xs font-semibold ${pillClass}">${pillText}</span>
                        </div>
                    `;
                })()}

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="config-card p-6 rounded-xl">
                        <div class="text-gray-600 text-sm mb-1">New</div>
                        <div class="text-3xl font-bold text-yellow-700">${countNew}</div>
                    </div>
                    <div class="config-card p-6 rounded-xl">
                        <div class="text-gray-600 text-sm mb-1">In Progress</div>
                        <div class="text-3xl font-bold text-blue-700">${countInProgress}</div>
                    </div>
                    <div class="config-card p-6 rounded-xl">
                        <div class="text-gray-600 text-sm mb-1">Closed</div>
                        <div class="text-3xl font-bold text-green-700">${countClosed}</div>
                    </div>
                </div>

                <div class="config-card p-4 rounded-xl mb-6">
                    ${(() => {
                        const team = Array.isArray(state.data.salesTeam) ? state.data.salesTeam : [];
                        const assignee = assigneeFilter || '';
                        const unassignedActive = assignee === '__UNASSIGNED__';
                        return `
                            <div class="flex flex-wrap gap-4 items-center">
                                <select id="triageStatusFilter" class="search-input px-4 py-2 rounded-xl text-sm" onchange="loadTriage()">
                                    <option value="" ${statusFilter===''?'selected':''}>All Statuses</option>
                                    <option value="NEW" ${statusFilter==='NEW'?'selected':''}>New</option>
                                    <option value="IN_PROGRESS" ${statusFilter==='IN_PROGRESS'?'selected':''}>In Progress</option>
                                    <option value="CLOSED" ${statusFilter==='CLOSED'?'selected':''}>Closed</option>
                                </select>

                                <select id="triageAssigneeFilter" class="search-input px-4 py-2 rounded-xl text-sm" onchange="loadTriage()">
                                    <option value="" ${assignee===''?'selected':''}>All Assignees</option>
                                    <option value="__UNASSIGNED__" ${unassignedActive?'selected':''}>Unassigned</option>
                                    ${team.map(u => {
                                        const label = `${u.name || 'Assignee'}${u.phone ? ` (${u.phone})` : ''}`;
                                        const selected = String(u.id) === String(assignee) ? 'selected' : '';
                                        return `<option value="${escapeHtml(String(u.id))}" ${selected}>${escapeHtml(label)}</option>`;
                                    }).join('')}
                                </select>

                                <button onclick="setTriageAssigneeFilter('__UNASSIGNED__')" class="px-4 py-2 rounded-xl text-sm ${unassignedActive ? 'bg-white/25 text-white' : 'glass-effect text-white hover:bg-white/20'}">
                                    <i class="fas fa-user-slash mr-2"></i>Unassigned
                                </button>

                                <button onclick="loadTriage()" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20">
                                    <i class="fas fa-rotate mr-2"></i>Refresh
                                </button>
                            </div>
                        `;
                    })()}
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    ${(() => {
                        const cfg = state.data.triageAssignConfig || { strategy: 'LEAST_ACTIVE', auto_assign: 1 };
                        const readonly = state.data.triageAssignConfigReadonly === true;
                        const autoAssignChecked = (cfg.auto_assign === 1 || cfg.auto_assign === true) ? 'checked' : '';
                        const strategy = String(cfg.strategy || 'LEAST_ACTIVE').toUpperCase();
                        const slaCfg = state.data.triageSlaConfig || { enabled: true, minutes: 60 };
                        const slaEnabled = slaCfg?.enabled === false ? false : true;
                        const slaEnabledChecked = slaEnabled ? 'checked' : '';
                        const slaMinutes = Number.isFinite(Number(slaCfg?.minutes)) ? Number(slaCfg?.minutes) : 60;
                        return `
                            <div class="config-card p-6 rounded-xl">
                                <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                                    <div>
                                        <div class="text-gray-900 font-semibold">Smart Assign Settings</div>
                                        <div class="text-xs text-gray-500">Controls how new triage items are auto-assigned.</div>
                                    </div>
                                    <button onclick="saveTriageAssignmentConfig()" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold" ${readonly ? 'disabled style=\'opacity:0.6;cursor:not-allowed\'' : ''}>
                                        <i class="fas fa-save mr-2"></i>Save
                                    </button>
                                </div>

                                <div class="space-y-4">
                                    <label class="flex items-center gap-3">
                                        <input id="triageAutoAssignToggle" type="checkbox" class="h-4 w-4" ${autoAssignChecked} ${readonly ? 'disabled' : ''} />
                                        <span class="text-sm text-gray-800">Enable auto-assign</span>
                                    </label>
                                    <div>
                                        <div class="text-xs text-gray-600 mb-1">Strategy</div>
                                        <select id="triageAssignStrategy" class="search-input px-4 py-2 rounded-xl text-sm w-full" ${readonly ? 'disabled' : ''}>
                                            <option value="LEAST_ACTIVE" ${strategy==='LEAST_ACTIVE'?'selected':''}>Least Active</option>
                                            <option value="ROUND_ROBIN" ${strategy==='ROUND_ROBIN'?'selected':''}>Round Robin</option>
                                        </select>
                                    </div>

                                    <div class="pt-4 border-t">
                                        <div class="flex items-center justify-between mb-2">
                                            <div>
                                                <div class="text-gray-900 font-semibold">SLA Timer</div>
                                                <div class="text-xs text-gray-500">Shows overdue/remaining time on triage items.</div>
                                            </div>
                                            <button onclick="saveTriageSlaConfig()" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold">
                                                <i class="fas fa-save mr-2"></i>Save SLA
                                            </button>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <label class="flex items-center gap-3">
                                                <input id="triageSlaEnabled" type="checkbox" class="h-4 w-4" ${slaEnabledChecked} />
                                                <span class="text-sm text-gray-800">Enable SLA</span>
                                            </label>
                                            <div>
                                                <div class="text-xs text-gray-600 mb-1">SLA Minutes</div>
                                                <input id="triageSlaMinutes" type="number" min="1" max="10080" class="search-input px-4 py-2 rounded-xl text-sm w-full" value="${escapeHtml(String(slaMinutes))}" />
                                            </div>
                                        </div>
                                    </div>
                                    ${readonly ? `<div class="text-xs text-gray-500">This environment is read-only for smart-assign settings.</div>` : ''}
                                </div>
                            </div>
                        `;
                    })()}

                    ${(() => {
                        const team = Array.isArray(state.data.salesTeam) ? state.data.salesTeam : [];
                        return `
                            <div class="config-card p-6 rounded-xl">
                                <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                                    <div>
                                        <div class="text-gray-900 font-semibold">Sales Team</div>
                                        <div class="text-xs text-gray-500">Manage triage assignees for this tenant.</div>
                                    </div>
                                    <button onclick="showSalesUserModal('create')" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold">
                                        <i class="fas fa-user-plus mr-2"></i>Add
                                    </button>
                                </div>

                                ${team.length === 0 ? `
                                    <div class="text-sm text-gray-600">No sales users yet.</div>
                                ` : `
                                    <div class="space-y-2">
                                        ${team.map(u => {
                                            const label = `${u.name || 'Assignee'}${u.phone ? ` (${u.phone})` : ''}`;
                                            const role = u.role ? String(u.role) : '';
                                            return `
                                                <div class="flex items-center justify-between gap-3 bg-white/80 rounded-xl px-4 py-3">
                                                    <div class="min-w-0">
                                                        <div class="text-sm font-semibold text-gray-900 truncate">${escapeHtml(label)}</div>
                                                        <div class="text-xs text-gray-500 truncate">${escapeHtml(role)}</div>
                                                    </div>
                                                    <div class="flex gap-2">
                                                        <button onclick="showSalesUserModal('edit','${escapeHtml(String(u.id))}')" class="px-3 py-2 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 text-xs font-semibold">Edit</button>
                                                        <button onclick="deleteSalesUser('${escapeHtml(String(u.id))}')" class="px-3 py-2 rounded-lg bg-red-50 text-red-700 hover:bg-red-100 text-xs font-semibold">Delete</button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                            </div>
                        `;
                    })()}
                </div>

                ${items.length === 0 ? `
                    <div class="config-card p-10 rounded-xl text-center">
                        <div class="text-gray-700 font-semibold">No triage items</div>
                        <div class="text-gray-500 text-sm mt-1">Items will appear when the system flags a conversation for human attention.</div>
                    </div>
                ` : `
                    <div class="space-y-3">
                        ${items.map(item => {
                            const phone = item.end_user_phone || item.phone_number || item.phone || '';
                            const preview = item.message_preview || '';
                            const created = item.created_at ? new Date(item.created_at).toLocaleString() : '';
                            const assignedTo = item.assigned_to || '';
                            const team = Array.isArray(state.data.salesTeam) ? state.data.salesTeam : [];
                            const assignee = assignedTo
                                ? (team.find(u => String(u.id) === String(assignedTo)) || null)
                                : null;
                            const assignedLabel = assignee
                                ? `${assignee.name || 'Assignee'}${assignee.phone ? ` (${assignee.phone})` : ''}`
                                : assignedTo;

                            const slaEnabled = item.sla_enabled === true;
                            const slaStatus = String(item.sla_status || '');
                            const slaPill = (() => {
                                if (!slaEnabled) return '';
                                if (slaStatus === 'closed') return '';
                                if (slaStatus === 'overdue') {
                                    const mins = Math.max(1, Math.ceil((Number(item.sla_overdue_seconds) || 0) / 60));
                                    return `<span class="px-2 py-1 rounded-lg text-xs font-semibold bg-red-100 text-red-800">SLA: OVERDUE ${mins}m</span>`;
                                }
                                const minsLeft = Math.max(1, Math.ceil((Number(item.sla_remaining_seconds) || 0) / 60));
                                return `<span class="px-2 py-1 rounded-lg text-xs font-semibold bg-emerald-100 text-emerald-800">SLA: ${minsLeft}m left</span>`;
                            })();

                            const actions = String(item.status || '').toUpperCase() === 'CLOSED'
                                ? `<button onclick="reopenTriage('${item.id}')" class="px-4 py-2 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 text-sm"><i class='fas fa-rotate-left mr-2'></i>Reopen</button>`
                                : `<button onclick="showAssignTriageModal('${item.id}')" class="px-4 py-2 rounded-lg bg-purple-50 text-purple-700 hover:bg-purple-100 text-sm"><i class='fas fa-user-plus mr-2'></i>Assign</button>
                                   <button onclick="showCloseTriageModal('${item.id}')" class="px-4 py-2 rounded-lg bg-green-50 text-green-700 hover:bg-green-100 text-sm"><i class='fas fa-check mr-2'></i>Close</button>`;

                            return `
                                <div class="config-card p-5 rounded-xl">
                                    <div class="flex items-start justify-between gap-4">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <div class="text-gray-900 font-semibold">${escapeHtml(phone || 'Unknown')}</div>
                                                <span class="px-2 py-1 rounded-lg text-xs font-medium ${badgeFor(item.status)}">${escapeHtml(String(item.status || ''))}</span>
                                                ${slaPill}
                                                <span class="text-xs text-gray-500">${escapeHtml(String(item.type || 'HUMAN_ATTENTION'))}</span>
                                            </div>
                                            ${preview ? `<div class="mt-2 text-sm text-gray-700 bg-gray-50 rounded-lg p-3">${escapeHtml(preview)}</div>` : ''}
                                            <div class="mt-2 text-xs text-gray-500">Created: ${escapeHtml(created)}${assignedTo ? ` • Assigned: ${escapeHtml(assignedLabel)}` : ''}</div>
                                        </div>
                                        <div class="flex gap-2 flex-wrap justify-end">${actions}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>
        `;
    }

    async function assignTriage(itemId, assignedTo) {
        const path = `/api/triage/${state.session.tenantId}/${itemId}/assign`;
        const res = await api.postJSON(path, { assigned_to: assignedTo });
        if (!res.success) throw new Error(res.error || 'Assign failed');
        showNotification('Triage item assigned', 'success');
        await loadTriage();
    }

    async function closeTriage(itemId, reason) {
        const path = `/api/triage/${state.session.tenantId}/${itemId}/close`;
        const res = await api.postJSON(path, { reason: reason || null });
        if (!res.success) throw new Error(res.error || 'Close failed');
        showNotification('Triage item closed', 'success');
        await loadTriage();
    }

    async function reopenTriage(itemId) {
        const path = `/api/triage/${state.session.tenantId}/${itemId}/reopen`;
        const res = await api.postJSON(path, {});
        if (!res.success) throw new Error(res.error || 'Reopen failed');
        showNotification('Triage item reopened', 'success');
        await loadTriage();
    }

    function setTriageAssigneeFilter(value) {
        const el = document.getElementById('triageAssigneeFilter');
        if (el) el.value = value;
        loadTriage();
    }

    async function saveTriageAssignmentConfig() {
        try {
            if (!state.session?.tenantId) throw new Error('No tenant session');
            if (state.data.triageAssignConfigReadonly === true) {
                showNotification('Smart assign settings are read-only here', 'warning');
                return;
            }

            const autoAssign = document.getElementById('triageAutoAssignToggle')?.checked === true;
            const strategy = document.getElementById('triageAssignStrategy')?.value || 'LEAST_ACTIVE';
            const path = `/api/triage-assignment/${state.session.tenantId}/config`;
            const resp = await api.putJSON(path, { auto_assign: autoAssign, strategy });
            if (!resp.success) throw new Error(resp.error || 'Failed to save');
            showNotification('Smart assign settings saved', 'success');
            await loadTriage();
        } catch (err) {
            showNotification(err.message || String(err), 'error');
        }
    }

    async function saveTriageSlaConfig() {
        try {
            if (!state.session?.tenantId) throw new Error('No tenant session');
            const enabled = document.getElementById('triageSlaEnabled')?.checked === true;
            const minutes = Number.parseInt(String(document.getElementById('triageSlaMinutes')?.value || ''), 10);
            const path = `/api/triage/${state.session.tenantId}/sla-config`;
            const resp = await api.putJSON(path, { enabled, minutes });
            if (!resp.success) throw new Error(resp.error || 'Failed to save SLA');
            showNotification('SLA settings saved', 'success');
            await loadTriage();
        } catch (err) {
            showNotification(err.message || String(err), 'error');
        }
    }

    function showSalesUserModal(mode, userId) {
        const tenantId = state.session?.tenantId;
        const team = Array.isArray(state.data.salesTeam) ? state.data.salesTeam : [];
        const existing = mode === 'edit' ? (team.find(u => String(u.id) === String(userId)) || null) : null;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-users mr-2 text-emerald-600"></i>
                        ${mode === 'edit' ? 'Edit Sales User' : 'Add Sales User'}
                    </h3>
                    <p class="text-sm text-gray-500 mt-1">Used for triage assignment.</p>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <div class="text-xs text-gray-600 mb-1">Name</div>
                        <input id="salesUserName" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent" value="${escapeHtml(String(existing?.name || ''))}" placeholder="Sales 1" />
                    </div>
                    <div>
                        <div class="text-xs text-gray-600 mb-1">Phone (optional)</div>
                        <input id="salesUserPhone" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent" value="${escapeHtml(String(existing?.phone || ''))}" placeholder="+9715..." />
                    </div>
                    <div>
                        <div class="text-xs text-gray-600 mb-1">Role (optional)</div>
                        <input id="salesUserRole" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent" value="${escapeHtml(String(existing?.role || 'sales'))}" placeholder="sales" />
                    </div>
                    <label class="flex items-center gap-3">
                        <input id="salesUserActive" type="checkbox" class="h-4 w-4" ${(existing?.is_active === undefined || existing?.is_active === 1 || existing?.is_active === true) ? 'checked' : ''} />
                        <span class="text-sm text-gray-800">Active</span>
                    </label>

                    <div class="flex gap-3">
                        <button id="salesUserCancel" class="flex-1 px-4 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium">Cancel</button>
                        <button id="salesUserSave" class="flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold">Save</button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        modal.querySelector('#salesUserCancel').addEventListener('click', () => modal.remove());
        modal.querySelector('#salesUserSave').addEventListener('click', async () => {
            const name = String(modal.querySelector('#salesUserName').value || '').trim();
            const phone = String(modal.querySelector('#salesUserPhone').value || '').trim();
            const role = String(modal.querySelector('#salesUserRole').value || '').trim();
            const is_active = modal.querySelector('#salesUserActive').checked;
            if (!name) {
                showNotification('Name is required', 'error');
                return;
            }
            try {
                if (mode === 'edit' && existing?.id) {
                    const resp = await api.putJSON(`/api/sales-team/${tenantId}/${existing.id}`, { name, phone: phone || null, role: role || null, is_active });
                    if (!resp.success) throw new Error(resp.error || 'Update failed');
                    showNotification('Sales user updated', 'success');
                } else {
                    const resp = await api.postJSON(`/api/sales-team/${tenantId}`, { name, phone: phone || null, role: role || null });
                    if (!resp.success) throw new Error(resp.error || 'Create failed');
                    showNotification('Sales user added', 'success');
                }
                modal.remove();
                await loadTriage();
            } catch (err) {
                showNotification(err.message || String(err), 'error');
            }
        });
    }

    async function deleteSalesUser(userId) {
        try {
            if (!confirm('Delete this sales user?')) return;
            const tenantId = state.session?.tenantId;
            const resp = await fetch(`/api/sales-team/${tenantId}/${userId}`, {
                method: 'DELETE',
                headers: { 'Authorization': state.session?.token ? `Bearer ${state.session.token}` : '' }
            });
            const data = await resp.json();
            if (!data.success) throw new Error(data.error || 'Delete failed');
            showNotification('Sales user deleted', 'success');
            await loadTriage();
        } catch (err) {
            showNotification(err.message || String(err), 'error');
        }
    }

    function showAssignTriageModal(itemId) {
        const team = Array.isArray(state.data.salesTeam) ? state.data.salesTeam : [];
        const optionsHtml = team.length
            ? `<select id="triageAssignTo" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="">Select assignee</option>
                    ${team.map(u => {
                        const label = `${u.name || 'Assignee'}${u.phone ? ` (${u.phone})` : ''}`;
                        return `<option value="${escapeHtml(String(u.id))}">${escapeHtml(label)}</option>`;
                    }).join('')}
               </select>
               <div class="text-xs text-gray-500">Tip: Manage assignees via the Sales Team API.</div>`
            : `<input id="triageAssignTo" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Assigned to (e.g. agent name/phone)" />
               <div class="text-xs text-gray-500">No sales team users found yet. Create one via the Sales Team API.</div>`;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold text-gray-900"><i class="fas fa-user-plus mr-2 text-purple-600"></i>Assign Triage</h3>
                    <p class="text-sm text-gray-500 mt-1">Assign to a sales team member.</p>
                </div>
                <div class="p-6 space-y-4">
                    ${optionsHtml}
                    <div class="flex gap-3">
                        <button id="triageAssignCancel" class="flex-1 px-4 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium">Cancel</button>
                        <button id="triageAssignSave" class="flex-1 px-4 py-3 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-semibold">Assign</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        modal.querySelector('#triageAssignCancel').addEventListener('click', () => modal.remove());
        modal.querySelector('#triageAssignSave').addEventListener('click', async () => {
            const v = modal.querySelector('#triageAssignTo').value;
            if (!v) {
                showNotification(team.length ? 'Please select an assignee' : 'Please enter an assignee', 'error');
                return;
            }
            try {
                await assignTriage(itemId, v);
                modal.remove();
            } catch (err) {
                showNotification(err.message || String(err), 'error');
            }
        });
    }

    function showCloseTriageModal(itemId) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold text-gray-900"><i class="fas fa-check mr-2 text-green-600"></i>Close Triage</h3>
                    <p class="text-sm text-gray-500 mt-1">Optionally record a closing reason.</p>
                </div>
                <div class="p-6 space-y-4">
                    <input id="triageCloseReason" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Reason (optional)" />
                    <div class="flex gap-3">
                        <button id="triageCloseCancel" class="flex-1 px-4 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium">Cancel</button>
                        <button id="triageCloseSave" class="flex-1 px-4 py-3 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        modal.querySelector('#triageCloseCancel').addEventListener('click', () => modal.remove());
        modal.querySelector('#triageCloseSave').addEventListener('click', async () => {
            const v = modal.querySelector('#triageCloseReason').value;
            try {
                await closeTriage(itemId, v);
                modal.remove();
            } catch (err) {
                showNotification(err.message || String(err), 'error');
            }
        });
    }

    async function addFollowupToCustomers(followupId) {
        try {
            const followup = (state.data.followups || []).find(x => String(x.id) === String(followupId));
            if (!followup) {
                showNotification('Follow-up not found', 'warning');
                return;
            }

            const phone = followup.end_user_phone || '';
            const name = (followup.customer?.business_name || followup.customer?.name || '').toString();
            if (!phone) {
                showNotification('Follow-up has no phone', 'warning');
                return;
            }

            await switchTab('customers');

            const tenantId = state.session?.tenantId;
            const lookupResp = await fetch(`/api/customers/lookup/${tenantId}?phone=${encodeURIComponent(phone)}`);
            const lookup = await lookupResp.json();
            const existing = lookup?.success ? (lookup.customer || null) : null;

            await openCustomerModal({ phone, name, customer: existing || null });
        } catch (err) {
            console.error('[addFollowupToCustomers] error', err);
            showNotification(err.message || 'Failed to add customer', 'error');
        }
    }

    function showCreateFollowupModal() {
        const modal = document.createElement('div');
        modal.id = 'createFollowupModal';
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full p-8">
                <h3 class="text-2xl font-bold text-white mb-6">Create Follow-up</h3>
                <form id="createFollowupForm" onsubmit="handleCreateFollowup(event)" class="space-y-4">
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Customer Phone</label>
                        <input type="text" id="newFollowupPhone" required 
                            class="w-full px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none"
                            placeholder="+919876543210">
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Scheduled Time</label>
                        <input type="datetime-local" id="newFollowupTime" required 
                            class="w-full px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Description</label>
                        <input type="text" id="newFollowupDescription" 
                            class="w-full px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none"
                            placeholder="Follow up on pending order">
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Note (optional)</label>
                        <textarea id="newFollowupNote" rows="3" 
                            class="w-full px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none"
                            placeholder="Additional notes..."></textarea>
                    </div>
                    <div class="flex gap-3 justify-end pt-4">
                        <button type="button" onclick="document.getElementById('createFollowupModal').remove()" 
                            class="px-6 py-3 rounded-xl bg-white/10 text-white hover:bg-white/20 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                            class="px-6 py-3 rounded-xl bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create Follow-up
                        </button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Set default time to 2 hours from now
        const defaultTime = new Date(Date.now() + 2 * 60 * 60 * 1000);
        document.getElementById('newFollowupTime').value = defaultTime.toISOString().slice(0, 16);
    }

    async function handleCreateFollowup(event) {
        event.preventDefault();
        
        const phone = document.getElementById('newFollowupPhone').value.trim();
        const time = document.getElementById('newFollowupTime').value;
        const description = document.getElementById('newFollowupDescription').value.trim();
        const note = document.getElementById('newFollowupNote').value.trim();

        try {
            const response = await fetch(`/api/followups/${state.session.tenantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({
                    customer_phone: phone,
                    scheduled_time: new Date(time).toISOString(),
                    description: description || 'Manual follow-up',
                    note: note,
                    created_by: 'admin'
                })
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            showNotification('Follow-up created successfully', 'success');
            document.getElementById('createFollowupModal').remove();
            loadFollowUps();

        } catch (error) {
            console.error('[handleCreateFollowup] Error:', error);
            showNotification('Failed to create follow-up: ' + error.message, 'error');
        }
    }

    function createFollowupFromSuggestion(suggestion) {
        showCreateFollowupModal();
        setTimeout(() => {
            document.getElementById('newFollowupPhone').value = suggestion.customer_phone;
            document.getElementById('newFollowupTime').value = new Date(suggestion.suggested_time).toISOString().slice(0, 16);
            document.getElementById('newFollowupDescription').value = suggestion.reason;
            document.getElementById('newFollowupNote').value = `AI Suggested (${suggestion.type}): ${suggestion.message_template || ''}`;
        }, 100);
    }

    async function sendFollowupNow(followupId) {
        if (!confirm('Send this follow-up immediately?')) return;
        
        try {
            const response = await fetch(`/api/followups/${state.session.tenantId}/${followupId}/send-now`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            showNotification('Follow-up sent successfully', 'success');
            loadFollowUps();

        } catch (error) {
            console.error('[sendFollowupNow] Error:', error);
            showNotification('Failed to send follow-up: ' + error.message, 'error');
        }
    }

    async function editFollowup(followupId) {
        // TODO: Implement edit modal
        showNotification('Edit feature coming soon', 'info');
    }

    async function deleteFollowup(followupId) {
        if (!confirm('Cancel/delete this follow-up?')) return;
        
        try {
            const response = await fetch(`/api/followups/${state.session.tenantId}/${followupId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            showNotification('Follow-up cancelled successfully', 'success');
            loadFollowUps();

        } catch (error) {
            console.error('[deleteFollowup] Error:', error);
            showNotification('Failed to cancel follow-up: ' + error.message, 'error');
        }
    }

    async function triggerIntelligentFollowUps() {
        if (!confirm('This will analyze all conversations and automatically create follow-ups for:\n\n• Abandoned carts\n• Price inquiries without orders\n• Leads based on temperature (Hot/Warm/Cold)\n\nContinue?')) {
            return;
        }

        showNotification('Analyzing conversations... This may take a minute.', 'info');

        try {
            const response = await fetch(`/api/followups/${state.session.tenantId}/trigger-intelligent`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            showNotification('Smart follow-ups created successfully! Refreshing...', 'success');
            setTimeout(() => loadFollowUps(), 2000);

        } catch (error) {
            console.error('[triggerIntelligentFollowUps] Error:', error);
            showNotification('Failed to create smart follow-ups: ' + error.message, 'error');
        }
    }

    // ---------- Modal & Action Functions ----------
    function editProduct(product) {
        try {
            const modal = document.getElementById('editProductModal');
            // Always refresh category dropdown before showing modal
            loadCategoriesDropdown().then(() => {
                const isNew = !product?.id;
                const titleEl = document.getElementById('editProdTitle');
                if (titleEl) titleEl.textContent = isNew ? 'Add Product' : 'Edit Product';
                const saveBtn = document.getElementById('saveEditProdBtn');
                if (saveBtn) saveBtn.textContent = isNew ? 'Create Product' : 'Save Changes';

                document.getElementById('editProdId').value = product.id || '';
                document.getElementById('editProdName').value = product.name || '';
                document.getElementById('editProdSku').value = product.sku || '';
                document.getElementById('editProdDescription').value = product.description || '';
                document.getElementById('editProdPrice').value = product.price || '';
                document.getElementById('editProdStock').value = product.stockQuantity || product.stock_quantity || 0;
                document.getElementById('editProdBrand').value = product.brand || '';
                document.getElementById('editProdCategory').value = product.category || '';
                document.getElementById('editProdImageUrl').value = product.imageUrl || product.image_url || '';
                document.getElementById('editProdPackagingUnit').value = product.packagingUnit || product.packaging_unit || '';
                document.getElementById('editProdUnitsPerCarton').value = product.unitsPerCarton || product.units_per_carton || 1;
                modal.classList.remove('hidden');
            });
        } catch (err) {
            console.error('editProduct error', err);
            showNotification('Failed to open edit modal', 'error');
        }
    }

    async function saveProductEdits() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return showNotification('Session expired. Re-login required.', 'error');

        const productId = document.getElementById('editProdId').value;
        const payload = {
            name: document.getElementById('editProdName').value,
            sku: document.getElementById('editProdSku').value || null,
            description: document.getElementById('editProdDescription').value || null,
            price: parseFloat(document.getElementById('editProdPrice').value) || null,
            stock_quantity: parseInt(document.getElementById('editProdStock').value) || 0,
            brand: document.getElementById('editProdBrand').value || null,
            category: document.getElementById('editProdCategory').value || null,
            image_url: document.getElementById('editProdImageUrl').value || null,
            packaging_unit: document.getElementById('editProdPackagingUnit').value || null,
            units_per_carton: parseInt(document.getElementById('editProdUnitsPerCarton').value) || 1
        };

        try {
            let resp;
            if (productId) {
                resp = await api.putJSON(`/api/dashboard/products/${tenantId}/${productId}`, payload);
                if (!resp || !resp.success) throw new Error(resp?.error || 'Failed to update product');
                showNotification('Product updated successfully', 'success');
            } else {
                resp = await api.postJSON(`/api/dashboard/products/${tenantId}`, payload);
                if (!resp || !resp.success) throw new Error(resp?.error || 'Failed to create product');
                showNotification('Product created successfully', 'success');
            }
            document.getElementById('editProductModal').classList.add('hidden');
            if (state.currentTab === 'products') loadProducts();
        } catch (err) {
            console.error('saveProductEdits error', err);
            showNotification('Failed to save product: ' + (err.message || err), 'error');
        }
    }

    async function deleteConversation(id) {
        if (!confirm('Are you sure you want to delete this conversation?')) return;
        try {
            const result = await api.deleteItem('conversations', id);
            if (result.success) {
                showNotification('Conversation deleted successfully', 'success');
                if (state.currentTab === 'conversations') loadConversations();
                await loadStats();
            } else throw new Error(result.error || 'Delete failed');
        } catch (error) {
            console.error('deleteConversation error', error);
            showNotification('Failed to delete conversation: ' + (error.message || error), 'error');
        }
    }

    async function deleteOrder(id) {
        if (!confirm('Are you sure you want to delete this order?')) return;
        try {
            const result = await api.deleteItem('orders', id);
            if (result.success) {
                showNotification('Order deleted successfully', 'success');
                if (state.currentTab === 'orders') loadOrders();
                await loadStats();
            } else throw new Error(result.error || 'Delete failed');
        } catch (error) {
            console.error('deleteOrder error', error);
            showNotification('Failed to delete order: ' + (error.message || error), 'error');
        }
    }

    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;
        try {
            const result = await api.deleteItem('products', id);
            if (result.success) {
                showNotification('Product deleted successfully', 'success');
                if (state.currentTab === 'products') loadProducts();
                await loadStats();
            } else throw new Error(result.error || 'Delete failed');
        } catch (error) {
            console.error('deleteProduct error', error);
            showNotification('Failed to delete product: ' + (error.message || error), 'error');
        }
    }

    function initCharts() {
        const salesCtx = document.getElementById('salesChart');
        if (salesCtx) {
            try {
                new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
                        datasets: [{
                            label: 'Sales (₹)',
                            data: [1200,1900,3000,5000,2000,3000,4500],
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive:true, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true } } }
                });
            } catch(e) { console.warn('sales chart init failed', e); }
        }

        const activityCtx = document.getElementById('activityChart');
        if (activityCtx) {
            try {
                new Chart(activityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Customer Messages','Bot Responses','Orders'],
                        datasets: [{ data:[45,35,20], backgroundColor:['rgba(34,197,94,0.8)','rgba(168,85,247,0.8)','rgba(249,115,22,0.8)'], borderWidth:0 }]
                    },
                    options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
                });
            } catch(e) { console.warn('activity chart init failed', e); }
        }
    }

    function handleSearch(e){
        state.searchQuery = e.target.value.trim().toLowerCase();
        if (state.currentTab === 'conversations') loadConversations();
    }

    function attachSettingsHandlers(){
        const shippingForm = document.getElementById('shippingForm');
        if (shippingForm) {
            shippingForm.onsubmit = async (ev) => {
                ev.preventDefault();
                const payload = {
                    free_shipping_threshold: Number(document.getElementById('freeShippingThreshold').value || 0),
                    standard_shipping_rate: Number(document.getElementById('standardShippingRate').value || 0),
                    bulk_shipping_rate: Number(document.getElementById('bulkShippingRate').value || 0),
                    bulk_threshold: Number(document.getElementById('bulkThreshold').value || 0)
                };
                try {
                    const resp = await api.updateSettings(payload);
                    if (resp.success) showNotification('Shipping settings updated', 'success');
                    else throw new Error(resp.error || 'Failed');
                } catch (err) { console.error(err); showNotification('Failed to update shipping settings', 'error'); }
            };
        }

        const gstForm = document.getElementById('gstForm');
        if (gstForm) {
            gstForm.onsubmit = async (ev) => {
                ev.preventDefault();
                const payload = { gst_rate: Number(document.getElementById('gstRate').value || 0), business_state: document.getElementById('businessState').value || null };
                try {
                    const resp = await api.updateSettings(payload);
                    if (resp.success) showNotification('GST settings updated', 'success');
                    else throw new Error(resp.error || 'Failed');
                } catch (err) { console.error(err); showNotification('Failed to update GST settings', 'error'); }
            };
        }

        const businessForm = document.getElementById('businessForm');
        if (businessForm) {
            businessForm.onsubmit = async (ev) => {
                ev.preventDefault();
                const payload = { business_name: document.getElementById('businessName').value || '', gstin: document.getElementById('gstin').value || '', business_address: document.getElementById('businessAddress').value || '' };
                try {
                    const resp = await api.updateSettings(payload);
                    if (resp.success) showNotification('Business info updated', 'success');
                    else throw new Error(resp.error || 'Failed');
                } catch (err) { console.error(err); showNotification('Failed to update business info', 'error'); }
            };
        }

        const aiKeysForm = document.getElementById('aiKeysForm');
        if (aiKeysForm) {
            aiKeysForm.onsubmit = async (ev) => {
                ev.preventDefault();
                const payload = {
                    openai_project: document.getElementById('openaiProject')?.value || '',
                    openai_model: document.getElementById('openaiModel')?.value || ''
                };

                const openaiApiKey = (document.getElementById('openaiApiKey')?.value || '').trim();
                const anthropicApiKey = (document.getElementById('anthropicApiKey')?.value || '').trim();
                const geminiApiKey = (document.getElementById('geminiApiKey')?.value || '').trim();

                if (openaiApiKey) payload.openai_api_key = openaiApiKey;
                if (anthropicApiKey) payload.anthropic_api_key = anthropicApiKey;
                if (geminiApiKey) payload.gemini_api_key = geminiApiKey;

                try {
                    const resp = await api.updateSettings(payload);
                    if (resp.success) {
                        showNotification('AI settings updated', 'success');
                        await loadSettings();
                    } else {
                        throw new Error(resp.error || 'Failed');
                    }
                } catch (err) {
                    console.error(err);
                    showNotification('Failed to update AI settings', 'error');
                }
            };
        }

        const maytapiForm = document.getElementById('maytapiForm');
        if (maytapiForm) {
            maytapiForm.onsubmit = async (ev) => {
                ev.preventDefault();
                const payload = {
                    maytapi_product_id: document.getElementById('maytapiProductId')?.value || '',
                    maytapi_phone_id: document.getElementById('maytapiPhoneId')?.value || ''
                };
                const maytapiApiKey = (document.getElementById('maytapiApiKey')?.value || '').trim();
                if (maytapiApiKey) payload.maytapi_api_key = maytapiApiKey;

                try {
                    const resp = await api.updateSettings(payload);
                    if (resp.success) {
                        showNotification('Maytapi settings updated', 'success');
                        await loadSettings();
                    } else {
                        throw new Error(resp.error || 'Failed');
                    }
                } catch (err) {
                    console.error(err);
                    showNotification('Failed to update Maytapi settings', 'error');
                }
            };
        }

        // Zoho Sync Handlers
        const syncProductsBtn = document.getElementById('syncProductsBtn');
        if (syncProductsBtn) {
            syncProductsBtn.onclick = async () => {
                const statusDiv = document.getElementById('syncStatus');
                const btn = syncProductsBtn;
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Syncing...';
                statusDiv.classList.remove('hidden', 'bg-green-50', 'bg-red-50');
                statusDiv.classList.add('bg-blue-50');
                statusDiv.querySelector('p').textContent = 'Syncing products from Zoho Books...';
                
                try {
                    const response = await fetch(`/api/dashboard/sync-products/${state.session.tenantId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        statusDiv.classList.remove('bg-blue-50');
                        statusDiv.classList.add('bg-green-50');
                        statusDiv.querySelector('p').textContent = '✓ Products synced successfully!';
                        statusDiv.querySelector('p').className = 'text-sm text-green-800';
                        showNotification('Products synced from Zoho', 'success');
                        if (state.currentTab === 'products') loadProducts();
                    } else {
                        throw new Error(result.error || 'Sync failed');
                    }
                } catch (err) {
                    console.error(err);
                    statusDiv.classList.remove('bg-blue-50');
                    statusDiv.classList.add('bg-red-50');
                    statusDiv.querySelector('p').textContent = '✗ Sync failed: ' + err.message;
                    statusDiv.querySelector('p').className = 'text-sm text-red-800';
                    showNotification('Failed to sync products', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-box mr-2"></i> Sync Products';
                }
            };
        }

        const syncCustomersBtn = document.getElementById('syncCustomersBtn');
        if (syncCustomersBtn) {
            syncCustomersBtn.onclick = async () => {
                const statusDiv = document.getElementById('syncStatus');
                const btn = syncCustomersBtn;
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Syncing...';
                statusDiv.classList.remove('hidden', 'bg-green-50', 'bg-red-50');
                statusDiv.classList.add('bg-blue-50');
                statusDiv.querySelector('p').textContent = 'Syncing customers from Zoho Books...';
                
                try {
                    const response = await fetch(`/api/dashboard/sync-customers/${state.session.tenantId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        statusDiv.classList.remove('bg-blue-50');
                        statusDiv.classList.add('bg-green-50');
                        statusDiv.querySelector('p').textContent = '✓ Customers synced successfully!';
                        statusDiv.querySelector('p').className = 'text-sm text-green-800';
                        showNotification('Customers synced from Zoho', 'success');
                        if (state.currentTab === 'customers') loadCustomers();
                    } else {
                        throw new Error(result.error || 'Sync failed');
                    }
                } catch (err) {
                    console.error(err);
                    statusDiv.classList.remove('bg-blue-50');
                    statusDiv.classList.add('bg-red-50');
                    statusDiv.querySelector('p').textContent = '✗ Sync failed: ' + err.message;
                    statusDiv.querySelector('p').className = 'text-sm text-red-800';
                    showNotification('Failed to sync customers', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-users mr-2"></i> Sync Customers';
                }
            };
        }

        const syncOrdersBtn = document.getElementById('syncOrdersBtn');
        if (syncOrdersBtn) {
            syncOrdersBtn.onclick = async () => {
                const statusDiv = document.getElementById('syncStatus');
                const btn = syncOrdersBtn;
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Syncing...';
                statusDiv.classList.remove('hidden', 'bg-green-50', 'bg-red-50');
                statusDiv.classList.add('bg-blue-50');
                statusDiv.querySelector('p').textContent = 'Syncing orders from Zoho Books...';
                
                try {
                    const response = await fetch(`/api/dashboard/sync-orders/${state.session.tenantId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        statusDiv.classList.remove('bg-blue-50');
                        statusDiv.classList.add('bg-green-50');
                        statusDiv.querySelector('p').textContent = '✓ Orders synced successfully!';
                        statusDiv.querySelector('p').className = 'text-sm text-green-800';
                        showNotification('Orders synced from Zoho', 'success');
                        if (state.currentTab === 'orders') loadOrders();
                    } else {
                        throw new Error(result.error || 'Sync failed');
                    }
                } catch (err) {
                    console.error(err);
                    statusDiv.classList.remove('bg-blue-50');
                    statusDiv.classList.add('bg-red-50');
                    statusDiv.querySelector('p').textContent = '✗ Sync failed: ' + err.message;
                    statusDiv.querySelector('p').className = 'text-sm text-red-800';
                    showNotification('Failed to sync orders', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-shopping-cart mr-2"></i> Sync Orders';
                }
            };
        }
    }

    // ---------- Notifications ----------
    let notifications = [];
    
    function toggleNotifications() {
        const panel = document.getElementById('notificationsPanel');
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden')) {
            loadNotifications();
        }
    }

    async function loadNotifications() {
        try {
            const tenantId = state.session.tenantId;
            if (!tenantId) return;

            // Get recent orders and conversations for notifications
            const [ordersData, convsData] = await Promise.all([
                api.fetchData(`orders`),
                api.fetchData(`conversations`)
            ]);

            notifications = [];

            // Add new orders as notifications
            if (ordersData.success && ordersData.orders) {
                const recentOrders = ordersData.orders.slice(0, 5);
                recentOrders.forEach(order => {
                    notifications.push({
                        id: order.id,
                        type: 'order',
                        icon: 'fa-shopping-cart',
                        color: 'text-green-400',
                        title: 'New Order',
                        message: `Order #${order.id.substring(0, 8)} - ${fmtINR(order.total_amount || order.total)}`,
                        time: new Date(order.created_at).toLocaleTimeString(),
                        date: new Date(order.created_at)
                    });
                });
            }

            // Add recent conversations as notifications
            if (convsData.success && convsData.conversations) {
                const recentConvs = convsData.conversations.slice(0, 5);
                recentConvs.forEach(conv => {
                    notifications.push({
                        id: conv.id,
                        type: 'conversation',
                        icon: 'fa-comments',
                        color: 'text-blue-400',
                        title: 'New Message',
                        message: `From ${conv.customer_name || conv.phone_number || 'Unknown'}`,
                        time: new Date(conv.updated_at).toLocaleTimeString(),
                        date: new Date(conv.updated_at)
                    });
                });
            }

            // Sort by date (newest first)
            notifications.sort((a, b) => b.date - a.date);
            
            // Update badge
            document.getElementById('notifBadge').textContent = Math.min(notifications.length, 99);
            
            // Render notifications
            renderNotifications();
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    function renderNotifications() {
        const list = document.getElementById('notificationsList');
        
        if (notifications.length === 0) {
            list.innerHTML = `
                <div class="p-8 text-center">
                    <i class="fas fa-bell-slash text-white/30 text-4xl mb-3"></i>
                    <p class="text-white/50">No notifications yet</p>
                </div>
            `;
            return;
        }

        list.innerHTML = notifications.map(notif => `
            <div class="p-4 border-b border-white/10 hover:bg-white/5 transition-colors cursor-pointer" onclick="handleNotificationClick('${notif.id}', '${notif.type}')">
                <div class="flex items-start space-x-3">
                    <div class="${notif.color}">
                        <i class="fas ${notif.icon} text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-white font-semibold text-sm">${escapeHtml(notif.title)}</h4>
                        <p class="text-white/70 text-sm mt-1">${escapeHtml(notif.message)}</p>
                        <span class="text-white/40 text-xs mt-1 block">${escapeHtml(notif.time)}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function handleNotificationClick(id, type) {
        // Close notifications panel
        document.getElementById('notificationsPanel').classList.add('hidden');
        
        // Switch to relevant tab and show details
        if (type === 'order') {
            switchTab('orders');
            setTimeout(() => viewOrderDetails(id), 500);
        } else if (type === 'conversation') {
            switchTab('conversations');
            setTimeout(() => viewConversationDetails(id), 500);
        }
    }

    function clearAllNotifications() {
        notifications = [];
        document.getElementById('notifBadge').textContent = '0';
        renderNotifications();
    }

    // Close notifications panel when clicking outside
    document.addEventListener('click', function(event) {
        const panel = document.getElementById('notificationsPanel');
        const bellButton = event.target.closest('button[onclick="toggleNotifications()"]');
        
        if (!panel?.contains(event.target) && !bellButton) {
            panel?.classList.add('hidden');
        }
    });

    async function handleLogout(){
        localStorage.removeItem('dashboardToken');
        localStorage.removeItem('dashboardSession');
        showNotification('Logged out successfully', 'success');
        setTimeout(() => {
            location.href = '/login.html';
        }, 500);
    }

    // ========== SALESMATE INTELLIGENCE: TEAM MANAGEMENT ==========
    async function loadTeam() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        try {
            const res = await fetch(`/api/salesmen/${tenantId}`);
            const data = await res.json();
            const team = data.salesmen || [];

            document.getElementById('tabContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-white text-2xl font-bold"><i class="fas fa-user-friends mr-3"></i>Sales Team</h2>
                        <p class="text-white/70 text-sm mt-1">Manage your sales team and workload distribution</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="showBroadcastSalesmenModal()" class="glass-effect px-6 py-3 rounded-xl text-white hover:bg-white/20 transition-colors">
                            <i class="fas fa-bullhorn mr-2"></i>Message All
                        </button>
                        <button onclick="showAddSalesmanModal()" class="glass-effect px-6 py-3 rounded-xl text-white hover:bg-white/20 transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>Add Salesman
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    ${team.length ? team.map(s => `
                        <div class="config-card p-6 rounded-xl">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-900">${escapeHtml(s.name)}</h4>
                                        ${s.email ? `<p class="text-sm text-gray-500">${escapeHtml(s.email)}</p>` : ''}
                                        ${s.phone ? `<p class="text-sm text-gray-500">${escapeHtml(s.phone)}</p>` : ''}
                                    </div>
                                </div>
                                <span class="px-3 py-1 ${s.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} text-xs rounded-full font-medium">
                                    ${s.active ? 'Active' : 'Inactive'}
                                </span>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <p class="text-xs text-blue-600 mb-1">Active Leads</p>
                                    <p class="text-2xl font-bold text-blue-900">${s.active_leads || 0}</p>
                                </div>
                                <div class="bg-purple-50 p-3 rounded-lg">
                                    <p class="text-xs text-purple-600 mb-1">Monthly Cap</p>
                                    <p class="text-2xl font-bold text-purple-900">${s.max_leads_per_month || '∞'}</p>
                                </div>
                            </div>

                            ${s.product_skills || s.language_skills || s.geographic_zone ? `
                                <div class="bg-gray-50 p-3 rounded-lg mb-4 text-sm">
                                    ${s.product_skills ? `<p class="text-gray-700"><i class="fas fa-box mr-2 text-blue-500"></i>${escapeHtml(s.product_skills)}</p>` : ''}
                                    ${s.language_skills ? `<p class="text-gray-700"><i class="fas fa-language mr-2 text-green-500"></i>${escapeHtml(s.language_skills)}</p>` : ''}
                                    ${s.geographic_zone ? `<p class="text-gray-700"><i class="fas fa-map-marker-alt mr-2 text-red-500"></i>${escapeHtml(s.geographic_zone)}</p>` : ''}
                                </div>
                            ` : ''}

                            <div class="flex gap-2">
                                <button onclick="editSalesman('${s.id}')" class="flex-1 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 text-sm font-medium">
                                    <i class="fas fa-edit mr-2"></i>Edit
                                </button>
                                <button onclick="deleteSalesman('${s.id}')" class="flex-1 px-4 py-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 text-sm font-medium">
                                    <i class="fas fa-trash mr-2"></i>Remove
                                </button>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="col-span-2 config-card p-12 rounded-xl text-center">
                            <i class="fas fa-user-friends text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-700 text-lg font-semibold">No sales team members yet</p>
                            <p class="text-gray-500 text-sm mt-2">Add your first salesman to start using smart assignment</p>
                        </div>
                    `}
                </div>
            `;
        } catch (error) {
            console.error('Error loading team:', error);
            showNotification('Error loading team: ' + error.message, 'error');
        }
    }

    // ========== SALESMATE INTELLIGENCE: TASKS MANAGEMENT ==========
    async function loadTasks() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        try {
            const res = await fetch(`/api/tasks/${tenantId}`);
            const data = await res.json();
            const tasks = data.tasks || [];
            const now = new Date();

            const overdue = tasks.filter(t => t.status !== 'COMPLETED' && t.due_date && new Date(t.due_date) < now);
            const upcoming = tasks.filter(t => t.status !== 'COMPLETED' && t.due_date && new Date(t.due_date) >= now);
            const completed = tasks.filter(t => t.status === 'COMPLETED');

            document.getElementById('tabContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-white text-2xl font-bold"><i class="fas fa-tasks mr-3"></i>Tasks</h2>
                        <p class="text-white/70 text-sm mt-1">Manage follow-ups and action items</p>
                    </div>
                    <button onclick="showAddTaskModal()" class="glass-effect px-6 py-3 rounded-xl text-white hover:bg-white/20 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Task
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="stat-card p-6 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-white"></i>
                            </div>
                            <div>
                                <p class="text-white/70 text-sm">Overdue</p>
                                <p class="text-white text-3xl font-bold">${overdue.length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-6 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clock text-white"></i>
                            </div>
                            <div>
                                <p class="text-white/70 text-sm">Upcoming</p>
                                <p class="text-white text-3xl font-bold">${upcoming.length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-6 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check text-white"></i>
                            </div>
                            <div>
                                <p class="text-white/70 text-sm">Completed</p>
                                <p class="text-white text-3xl font-bold">${completed.length}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    ${overdue.length > 0 ? `
                        <div>
                            <h3 class="text-white text-lg font-semibold mb-3"><i class="fas fa-exclamation-circle mr-2 text-red-400"></i>Overdue Tasks</h3>
                            <div class="space-y-3">
                                ${overdue.map(t => renderTaskCard(t, 'overdue')).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${upcoming.length > 0 ? `
                        <div>
                            <h3 class="text-white text-lg font-semibold mb-3"><i class="fas fa-calendar mr-2 text-blue-400"></i>Upcoming Tasks</h3>
                            <div class="space-y-3">
                                ${upcoming.map(t => renderTaskCard(t, 'upcoming')).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${overdue.length === 0 && upcoming.length === 0 ? `
                        <div class="config-card p-12 rounded-xl text-center">
                            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
                            <p class="text-gray-700 text-lg font-semibold">All caught up!</p>
                            <p class="text-gray-500 text-sm mt-2">No pending tasks</p>
                        </div>
                    ` : ''}
                </div>
            `;
        } catch (error) {
            console.error('Error loading tasks:', error);
            showNotification('Error loading tasks: ' + error.message, 'error');
        }
    }

    function renderTaskCard(task, type) {
        const priorityColors = { 
            'LOW': 'bg-gray-100 text-gray-800', 
            'MEDIUM': 'bg-blue-100 text-blue-800', 
            'HIGH': 'bg-orange-100 text-orange-800', 
            'URGENT': 'bg-red-100 text-red-800' 
        };
        const borderColor = type === 'overdue' ? 'border-l-4 border-red-500' : 'border-l-4 border-blue-500';
        
        return `
            <div class="config-card p-5 rounded-xl ${borderColor}">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-semibold text-gray-900">${escapeHtml(task.title)}</h4>
                            <span class="px-2 py-1 ${priorityColors[task.priority || 'MEDIUM']} text-xs rounded-full font-medium">
                                ${task.priority || 'MEDIUM'}
                            </span>
                        </div>
                        ${task.description ? `<p class="text-sm text-gray-600 mb-2">${escapeHtml(task.description)}</p>` : ''}
                        <div class="flex items-center gap-4 text-xs text-gray-500">
                            ${task.due_date ? `<span><i class="far fa-clock mr-1"></i>${new Date(task.due_date).toLocaleString()}</span>` : ''}
                            ${task.assigned_to ? `<span><i class="fas fa-user mr-1"></i>Assigned to: ${task.assigned_to}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-2 ml-4">
                        <button onclick="completeTask('${task.id}')" class="px-3 py-1 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 text-sm">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="deleteTask('${task.id}')" class="px-3 py-1 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // ========== SALESMATE INTELLIGENCE: CALLS MANAGEMENT ==========
    async function loadCalls() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        try {
            const res = await fetch(`/api/calls/${tenantId}`);
            const data = await res.json();
            const calls = data.calls || [];

            const inbound = calls.filter(c => c.direction === 'INBOUND').length;
            const outbound = calls.filter(c => c.direction === 'OUTBOUND').length;
            const totalDuration = calls.reduce((sum, c) => sum + (c.duration_seconds || 0), 0);

            document.getElementById('tabContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-white text-2xl font-bold"><i class="fas fa-phone mr-3"></i>Call Logs</h2>
                        <p class="text-white/70 text-sm mt-1">Track all customer phone interactions</p>
                    </div>
                    <button onclick="showLogCallModal()" class="glass-effect px-6 py-3 rounded-xl text-white hover:bg-white/20 transition-colors">
                        <i class="fas fa-phone-alt mr-2"></i>Log Call
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="stat-card p-6 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-phone-volume text-white"></i>
                            </div>
                            <div>
                                <p class="text-white/70 text-sm">Inbound</p>
                                <p class="text-white text-3xl font-bold">${inbound}</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-6 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-phone text-white"></i>
                            </div>
                            <div>
                                <p class="text-white/70 text-sm">Outbound</p>
                                <p class="text-white text-3xl font-bold">${outbound}</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card p-6 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clock text-white"></i>
                            </div>
                            <div>
                                <p class="text-white/70 text-sm">Total Duration</p>
                                <p class="text-white text-2xl font-bold">${Math.floor(totalDuration / 60)}m</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-card rounded-xl overflow-hidden">
                    ${calls.length ? `
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Direction</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Outcome</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duration</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${calls.map(c => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHtml(c.phone_number || 'N/A')}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 py-1 ${c.direction === 'INBOUND' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'} text-xs rounded-full">
                                                    ${c.direction === 'INBOUND' ? '📥' : '📤'} ${c.direction}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHtml(c.outcome || '-')}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${c.duration_seconds ? Math.floor(c.duration_seconds / 60) + 'm ' + (c.duration_seconds % 60) + 's' : '-'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.created_at ? new Date(c.created_at).toLocaleString() : '-'}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${escapeHtml(c.notes || '-')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="p-12 text-center">
                            <i class="fas fa-phone-slash text-gray-400 text-5xl mb-4"></i>
                            <p class="text-gray-700 text-lg font-semibold">No calls logged yet</p>
                            <p class="text-gray-500 text-sm mt-2">Start logging calls to track customer interactions</p>
                        </div>
                    `}
                </div>
            `;
        } catch (error) {
            console.error('Error loading calls:', error);
            showNotification('Error loading calls: ' + error.message, 'error');
        }
    }

    async function init() {
        // Check if we already have a valid session
        const existingSession = localStorage.getItem('dashboardSession');
        if (existingSession) {
            try {
                state.session = JSON.parse(existingSession);
                console.log('Restored session from localStorage:', state.session);
                
                // Validate session has required fields
                const tenantId = state.session.tenantId || state.session.tenant_id;
                if (!tenantId) {
                    throw new Error('Invalid session data');
                }
                state.session.tenantId = tenantId;

                // Normalize optional fields to avoid redirect loops if tenant metadata is incomplete
                state.session.businessName =
                    state.session.businessName ||
                    state.session.business_name ||
                    state.session.business ||
                    state.session.name ||
                    state.session.phoneNumber ||
                    state.session.phone_number ||
                    'Sales Dashboard';

                // Persist normalized session so subsequent reloads are stable
                try {
                    localStorage.setItem('dashboardSession', JSON.stringify(state.session));
                } catch (_) {}
                
                // Load and apply feature settings
                applyFeatureSettings(state.session.tenantId);
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                await loadStats();
                switchTab('overview');
                loadNotifications();
                showNotification('Welcome back, ' + state.session.businessName + '!', 'success');
                return;
            } catch (err) {
                console.log('Failed to restore session, redirecting to login:', err);
                localStorage.removeItem('dashboardSession');
                localStorage.removeItem('dashboardToken');
                window.location.href = '/login.html';
                return;
            }
        }

        // No session found - redirect to login
        console.log('No session found, redirecting to login');
        window.location.href = '/login.html';
    }

    // Apply feature settings to show/hide tabs
    function applyFeatureSettings(tenantId) {
        // Load saved feature settings from localStorage (set by admin in clients.html)
        const savedFeatures = JSON.parse(localStorage.getItem(`tenant_features_${tenantId}`)) || {};
        console.log('Loading feature settings for tenant:', tenantId, savedFeatures);
        
        // Map features to tab data attributes
        const featureTabMap = {
            'tab_products': 'products',
            'tab_customers': 'customers',
            'tab_orders': 'orders',
            'tab_discounts': 'discounts',
            'tab_broadcast': 'broadcast',
            'tab_whatsapp_web': 'whatsapp-web',
            'tab_analytics': 'analytics'
        };
        
        // Show/hide tabs based on feature settings
        Object.keys(featureTabMap).forEach(feature => {
            const tabName = featureTabMap[feature];
            const isEnabled = savedFeatures.hasOwnProperty(feature) ? savedFeatures[feature] : true; // Default to enabled
            
            // Find all sidebar items with this tab
            const tabElements = document.querySelectorAll(`[data-tab="${tabName}"]`);
            tabElements.forEach(el => {
                if (isEnabled) {
                    el.style.display = ''; // Show
                    console.log(`✅ Enabled tab: ${tabName}`);
                } else {
                    el.style.display = 'none'; // Hide
                    console.log(`❌ Disabled tab: ${tabName}`);
                }
            });
        });
    }

    // ---------- Event listeners ----------
    document.addEventListener('DOMContentLoaded', function(){
        initSidebarUI();

        // Keep sidebar state sane when switching between mobile/desktop.
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;

            if (window.innerWidth <= 768) {
                sidebar.classList.remove('mobile-open');
                setSidebarCollapsed(false);
            } else {
                try {
                    const saved = localStorage.getItem(SIDEBAR_STORAGE_KEY);
                    setSidebarCollapsed(saved === '1');
                } catch (_) {
                    setSidebarCollapsed(false);
                }
            }
        });

        // Initialize bulk upload handlers
        initBulkUploadHandlers();
        // Initialize manage categories handler
        initManageCategoriesHandler();
        
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('view-order-btn') || event.target.closest('.view-order-btn')) {
                const button = event.target.closest('.view-order-btn') || event.target;
                const orderId = button.getAttribute('data-order-id');
                const tenantId = button.getAttribute('data-tenant-id') || state.session?.tenantId;
                if (orderId && tenantId) {
                    loadOrderAndShowModal(orderId, tenantId);
                }
            }
        });

        document.getElementById('globalSearch')?.addEventListener('input', function(e){
            state.searchQuery = e.target.value.trim().toLowerCase();
            if (state.currentTab === 'conversations') loadConversations();
            else if (state.currentTab === 'orders') loadOrders();
            else if (state.currentTab === 'leads') loadLeads();
        });
        // Customer search filter listeners
        document.getElementById('customerSearchBtn')?.addEventListener('click', loadCustomers);
        ['customerSearchInput','customerMinSpent','customerMaxSpent','customerMinOrderDate','customerMaxOrderDate'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') loadCustomers(); });
        });

        document.getElementById('closeConvBtn')?.addEventListener('click', () => {
            hideReplyComposer();
            document.getElementById('conversationModal').classList.add('hidden');
        });

        document.getElementById('exportConvBtn')?.addEventListener('click', exportCurrentConversation);
        document.getElementById('replyBtn')?.addEventListener('click', sendReplyFromConversation);
        document.getElementById('replyCancelBtn')?.addEventListener('click', hideReplyComposer);
        document.getElementById('replySendBtn')?.addEventListener('click', submitReplyFromComposer);
        document.getElementById('replyText')?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                submitReplyFromComposer();
            }
        });
        document.getElementById('loadMoreBtn')?.addEventListener('click', () => {
            const el = document.getElementById('convMessages');
            if (el) el.scrollTop = 0;
            showNotification('All loaded (scrolling up)', 'info');
        });
        document.getElementById('closeOrderModal')?.addEventListener('click', () => {
            const modal = document.getElementById('orderModal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        });
        document.getElementById('closeEditProdBtn')?.addEventListener('click', () => document.getElementById('editProductModal').classList.add('hidden'));
        document.getElementById('cancelEditProd')?.addEventListener('click', () => document.getElementById('editProductModal').classList.add('hidden'));
        document.getElementById('saveEditProdBtn')?.addEventListener('click', saveProductEdits);
        document.getElementById('closeCustomerModalBtn')?.addEventListener('click', () => document.getElementById('customerModal').classList.add('hidden'));

        document.addEventListener('click', function(e){
            const btn = e.target.closest('.view-details-btn');
            if (!btn) return;
            const tenantId = btn.dataset.tenantId;
            const convId = btn.dataset.convId;
            openConversation(tenantId, convId);
        });

        document.getElementById('saveOrderStatusBtn')?.addEventListener('click', async () => {
            const orderId = window.currentOrderId;
            if (!orderId) return alert('Order id missing');

            const statusSelect = document.getElementById('orderStatusSelect');
            const saveBtn = document.getElementById('saveOrderStatusBtn');
            const newStatus = statusSelect.value;
            
            saveBtn.disabled = true;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';

            try {
                const resp = await fetch(`/api/orders/${encodeURIComponent(orderId)}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const json = await resp.json();
                if (!resp.ok) {
                    console.error('Status update failed', json);
                    alert('Failed to update status: ' + (json.error || JSON.stringify(json)));
                    return;
                }

                const statusLabel = document.getElementById('orderStatusLabel');
                if (statusLabel) statusLabel.textContent = newStatus;

                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                if (orderCard) {
                    const badge = orderCard.querySelector('.order-status-badge');
                    if (badge) badge.textContent = newStatus;
                }

                showNotification('Order status updated successfully', 'success');
            } catch (err) {
                console.error('Error updating order status', err);
                alert('Error updating order status');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        });
    });

    // ========== Website Content Functions ==========
    
    async function loadWebsiteContent() {
        try {
            // Load stats
            const statsRes = await fetch(`/api/dashboard/website-content/stats/${state.session.tenantId}`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const statsData = await statsRes.json();
            
            if (statsData.success) {
                document.getElementById('websiteUrlCount').textContent = statsData.stats.totalUrls || 0;
                document.getElementById('websiteChunkCount').textContent = statsData.stats.totalChunks || 0;
            }

            // Load crawled URLs list
            await refreshWebsiteList();
        } catch (error) {
            console.error('Error loading website content:', error);
            showNotification('Failed to load website content', 'error');
        }
    }

    // ---------- Documents Tab ----------
    async function loadDocuments() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        document.getElementById('tabContent').innerHTML = `
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
                <div>
                    <h2 class="text-white text-2xl font-bold"><i class="fas fa-file-alt mr-3"></i>Documents</h2>
                    <p class="text-white/70 text-sm mt-1">Upload documents to improve AI responses.</p>
                </div>
            </div>

            <div class="config-card p-6 rounded-xl shadow-lg mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3"><i class="fas fa-upload text-blue-500 mr-2"></i>Upload Document</h3>
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="file" id="docUploadFile" accept=".pdf,.txt,.csv,.xlsx,.xls" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-white" />
                    <button id="docUploadBtn" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-medium">
                        <i class="fas fa-cloud-upload-alt mr-2"></i>Upload
                    </button>
                </div>
                <div class="text-xs text-gray-500 mt-2">Accepted: PDF, TXT, CSV, Excel. Text will be extracted and stored.</div>
            </div>

            <div class="config-card p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800"><i class="fas fa-list text-green-600 mr-2"></i>Uploaded Documents</h3>
                    <button id="refreshDocsBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">Refresh</button>
                </div>
                <div id="documentsList" class="space-y-3">
                    <div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>
                </div>
            </div>
        `;

        document.getElementById('docUploadBtn')?.addEventListener('click', uploadDocumentFromTab);
        document.getElementById('refreshDocsBtn')?.addEventListener('click', loadDocumentsList);

        await loadDocumentsList();
    }

    async function loadDocumentsList() {
        const tenantId = state.session?.tenantId;
        const container = document.getElementById('documentsList');
        if (!tenantId || !container) return;

        try {
            const res = await fetch(`/api/dashboard/documents/${tenantId}`);
            const data = await res.json();
            const docs = data.documents || [];

            if (!data.success) throw new Error(data.error || 'Failed to load documents');

            if (!docs.length) {
                container.innerHTML = `<div class="text-center py-10 text-gray-500"><i class="fas fa-file-alt text-3xl mb-3"></i><p>No documents uploaded yet.</p></div>`;
                return;
            }

            container.innerHTML = docs.map(d => `
                <div class="flex items-center justify-between p-4 bg-white rounded-xl border">
                    <div class="min-w-0">
                        <div class="font-semibold text-gray-900 truncate">${escapeHtml(d.original_name || d.filename || 'document')}</div>
                        <div class="text-xs text-gray-500 mt-1">${escapeHtml(d.mime_type || '')} • ${d.size_bytes ? Math.round(d.size_bytes / 1024) + ' KB' : ''}</div>
                    </div>
                    <button onclick="deleteDocument('${d.id}')" class="ml-4 px-3 py-2 bg-red-100 hover:bg-red-500 text-red-600 hover:text-white rounded-lg transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        } catch (err) {
            console.error('Load documents error:', err);
            container.innerHTML = `<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>${escapeHtml(err.message || String(err))}</p></div>`;
        }
    }

    async function uploadDocumentFromTab() {
        const tenantId = state.session?.tenantId;
        const input = document.getElementById('docUploadFile');
        if (!tenantId) return showNotification('Session expired. Re-login required.', 'error');
        if (!input || !input.files || !input.files.length) return showNotification('Please select a file.', 'warning');

        const formData = new FormData();
        formData.append('file', input.files[0]);

        try {
            showNotification('Uploading document...', 'info');
            const res = await fetch(`/api/dashboard/documents/${tenantId}/upload`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Upload failed');
            showNotification('Document uploaded!', 'success');
            input.value = '';
            await loadDocumentsList();
        } catch (err) {
            console.error('Upload document error:', err);
            showNotification('Upload failed: ' + (err.message || String(err)), 'error');
        }
    }

    async function deleteDocument(documentId) {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;
        if (!confirm('Delete this document?')) return;

        try {
            const res = await fetch(`/api/dashboard/documents/${tenantId}/${documentId}`, { method: 'DELETE' });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Delete failed');
            showNotification('Document deleted.', 'success');
            await loadDocumentsList();
        } catch (err) {
            console.error('Delete document error:', err);
            showNotification('Delete failed: ' + (err.message || String(err)), 'error');
        }
    }

    async function crawlWebsiteUrl() {
        const urlInput = document.getElementById('websiteUrlInput');
        const url = urlInput.value.trim();
        
        if (!url) {
            showNotification('Please enter a URL', 'error');
            return;
        }

        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            showNotification('URL must start with http:// or https://', 'error');
            return;
        }

        try {
            showNotification('Crawling website... This may take a moment', 'info');
            
            const res = await fetch(`/api/dashboard/website-content/crawl/${state.session.tenantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({ url })
            });

            const data = await res.json();
            
            if (data.success) {
                showNotification(`Successfully crawled: ${data.pageTitle || url} (${data.chunksCreated} chunks)`, 'success');
                urlInput.value = '';
                await refreshWebsiteList();
                await loadWebsiteContent();
            } else {
                showNotification(`Failed to crawl: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Error crawling website:', error);
            showNotification('Failed to crawl website', 'error');
        }
    }

    async function crawlEntireWebsite() {
        const urlInput = document.getElementById('websiteFullUrlInput');
        const url = urlInput.value.trim();
        
        if (!url) {
            showNotification('Please enter a website URL', 'error');
            return;
        }

        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            showNotification('URL must start with http:// or https://', 'error');
            return;
        }

        const maxPages = parseInt(document.getElementById('maxPages').value) || 100;
        const maxDepth = parseInt(document.getElementById('maxDepth').value) || 3;
        const useSitemap = document.getElementById('useSitemap').checked;

        // Show progress indicator
        const progressDiv = document.getElementById('crawlProgress');
        const progressBar = document.getElementById('crawlProgressBar');
        const progressCount = document.getElementById('crawlProgressCount');
        progressDiv.classList.remove('hidden');
        progressBar.style.width = '10%';
        progressCount.textContent = 'Starting...';

        try {
            showNotification('Starting full website crawl... This may take several minutes', 'info');
            
            const res = await fetch(`/api/dashboard/website-content/crawl-all/${state.session.tenantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({ 
                    url,
                    options: {
                        maxPages,
                        maxDepth,
                        useSitemap,
                        delayBetweenRequests: 1000
                    }
                })
            });

            const data = await res.json();
            
            progressDiv.classList.add('hidden');
            
            if (data.success) {
                showNotification(
                    `✅ Successfully crawled entire website!\n` +
                    `📄 Pages: ${data.pagesCrawled}\n` +
                    `📦 Chunks: ${data.totalChunks}`, 
                    'success'
                );
                urlInput.value = '';
                await refreshWebsiteList();
                await loadWebsiteContent();
            } else {
                showNotification(`Failed to crawl website: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Error crawling entire website:', error);
            progressDiv.classList.add('hidden');
            showNotification('Failed to crawl entire website', 'error');
        }
    }

    async function refreshWebsiteList() {
        try {
            const res = await fetch(`/api/dashboard/website-content/list/${state.session.tenantId}`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const data = await res.json();
            
            const tbody = document.getElementById('websiteUrlsList');
            
            if (!data.success || !data.urls || data.urls.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-globe text-4xl mb-3 block"></i>
                            <p>No websites crawled yet. Add a URL above to get started!</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.urls.map(item => `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="px-4 py-3">${escapeHtml(item.pageTitle || 'Untitled')}</td>
                    <td class="px-4 py-3">
                        <a href="${escapeHtml(item.url)}" target="_blank" class="text-blue-600 hover:underline text-xs">
                            ${escapeHtml(item.url.substring(0, 50))}${item.url.length > 50 ? '...' : ''}
                        </a>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${escapeHtml(item.contentType || 'general')}</span>
                    </td>
                    <td class="px-4 py-3">${item.chunkCount || 0}</td>
                    <td class="px-4 py-3 text-xs text-gray-600">${item.crawlDate ? new Date(item.crawlDate).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-4 py-3">
                        <button 
                            onclick="deleteWebsiteContent('${escapeHtml(item.url)}')" 
                            class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error refreshing website list:', error);
            document.getElementById('websiteUrlsList').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-8 text-red-500">
                        Failed to load: ${escapeHtml(error.message)}
                    </td>
                </tr>
            `;
        }
    }

    async function searchWebsiteContent() {
        const query = document.getElementById('websiteSearchQuery').value.trim();
        
        if (!query) {
            showNotification('Please enter a search query', 'error');
            return;
        }

        try {
            const res = await fetch(`/api/dashboard/website-content/search/${state.session.tenantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({ query, limit: 5, minSimilarity: 0.7 })
            });

            const data = await res.json();
            
            const resultsDiv = document.getElementById('websiteSearchResults');
            const resultsList = document.getElementById('websiteSearchResultsList');
            
            if (!data.success || !data.results || data.results.length === 0) {
                resultsDiv.classList.remove('hidden');
                resultsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-search text-3xl mb-3"></i>
                        <p>No results found for "${escapeHtml(query)}"</p>
                        <p class="text-sm mt-2">Try different keywords or crawl more content</p>
                    </div>
                `;
                return;
            }

            resultsDiv.classList.remove('hidden');
            resultsList.innerHTML = data.results.map(result => `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-2">
                        <h5 class="font-semibold text-gray-800">${escapeHtml(result.pageTitle || 'Untitled')}</h5>
                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">${result.relevanceScore}% match</span>
                    </div>
                    <a href="${escapeHtml(result.url)}" target="_blank" class="text-xs text-blue-600 hover:underline mb-2 block">
                        ${escapeHtml(result.url)}
                    </a>
                    <p class="text-sm text-gray-600 mb-2">${escapeHtml(result.content.substring(0, 200))}${result.content.length > 200 ? '...' : ''}</p>
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                        <span class="px-2 py-1 bg-gray-100 rounded">${escapeHtml(result.contentType)}</span>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error searching website content:', error);
            showNotification('Failed to search content', 'error');
        }
    }

    async function deleteWebsiteContent(url) {
        if (!confirm(`Are you sure you want to delete all content from:\n${url}`)) {
            return;
        }

        try {
            const res = await fetch(`/api/dashboard/website-content/${state.session.tenantId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({ url })
            });

            const data = await res.json();
            
            if (data.success) {
                showNotification(`Deleted ${data.deletedCount} chunks`, 'success');
                await refreshWebsiteList();
                await loadWebsiteContent();
            } else {
                showNotification('Failed to delete content', 'error');
            }
        } catch (error) {
            console.error('Error deleting website content:', error);
            showNotification('Failed to delete content', 'error');
        }
    }

    // ========== SALESMATE INTELLIGENCE: HELPER FUNCTIONS ==========
    
    function showAddSalesmanModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b sticky top-0 bg-white">
                    <h3 class="text-xl font-bold text-gray-900"><i class="fas fa-user-plus mr-2 text-purple-600"></i>Add Salesman</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input id="salesmanName" type="text" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="John Doe" required />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input id="salesmanEmail" type="email" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="john@company.com" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                            <input id="salesmanPhone" type="text" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="+919876543210" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Leads Per Month</label>
                        <input id="salesmanMaxLeads" type="number" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="100" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Skills (comma separated)</label>
                        <input id="salesmanProductSkills" type="text" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="Electronics, Furniture, Appliances" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Language Skills (comma separated)</label>
                        <input id="salesmanLanguageSkills" type="text" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="English, Hindi, Tamil" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Geographic Zone</label>
                        <input id="salesmanGeographicZone" type="text" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="North India, Mumbai, Delhi NCR" />
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium">Cancel</button>
                        <button onclick="saveSalesman()" class="flex-1 px-4 py-3 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-semibold">Add Salesman</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function showBroadcastSalesmenModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b sticky top-0 bg-white">
                    <h3 class="text-xl font-bold text-gray-900"><i class="fas fa-bullhorn mr-2 text-purple-600"></i>Message All Salesmen</h3>
                    <p class="text-sm text-gray-500 mt-1">Sends a WhatsApp message to every active salesman phone number.</p>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">From WhatsApp session</label>
                        <select id="broadcastFromSession" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500">
                            <option value="default" selected>Default (Admin)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Make sure this session is connected in the WhatsApp Web tab.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Message *</label>
                        <textarea id="broadcastSalesmenText" rows="5" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="Team, please check your assigned leads…" required></textarea>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium">Cancel</button>
                        <button onclick="sendBroadcastToSalesmen()" class="flex-1 px-4 py-3 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-semibold">Send</button>
                    </div>
                    <div id="broadcastSalesmenResult" class="hidden"></div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function sendBroadcastToSalesmen() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return showNotification('No tenant selected', 'error');

        const text = document.getElementById('broadcastSalesmenText')?.value?.trim() || '';
        const fromSessionName = document.getElementById('broadcastFromSession')?.value || 'default';
        if (!text) return showNotification('Message is required', 'error');

        const resultDiv = document.getElementById('broadcastSalesmenResult');
        if (resultDiv) {
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `<div class="bg-blue-50 text-blue-800 p-3 rounded-lg text-sm"><i class="fas fa-spinner fa-spin mr-2"></i>Sending…</div>`;
        }

        try {
            const res = await fetch(`/api/salesmen/${tenantId}/broadcast`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, fromSessionName })
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Broadcast failed');

            const sent = data.sent || 0;
            const failed = data.failed || 0;
            showNotification(`Broadcast complete: ${sent} sent, ${failed} failed`, failed ? 'warning' : 'success');

            if (resultDiv) {
                resultDiv.innerHTML = `
                    <div class="${failed ? 'bg-yellow-50 text-yellow-800' : 'bg-green-50 text-green-800'} p-3 rounded-lg text-sm">
                        <i class="fas ${failed ? 'fa-exclamation-triangle' : 'fa-check-circle'} mr-2"></i>
                        Sent: <b>${sent}</b> • Failed: <b>${failed}</b>
                    </div>
                `;
            }
        } catch (e) {
            showNotification('Broadcast error: ' + (e?.message || e), 'error');
            if (resultDiv) {
                resultDiv.innerHTML = `<div class="bg-red-50 text-red-800 p-3 rounded-lg text-sm"><i class="fas fa-times-circle mr-2"></i>${escapeHtml(e?.message || String(e))}</div>`;
            }
        }
    }

    async function saveSalesman() {
        const name = document.getElementById('salesmanName').value.trim();
        if (!name) return showNotification('Name is required', 'error');

        const data = {
            name,
            email: document.getElementById('salesmanEmail').value.trim() || null,
            phone: document.getElementById('salesmanPhone').value.trim() || null,
            max_leads_per_month: parseInt(document.getElementById('salesmanMaxLeads').value) || null,
            product_skills: document.getElementById('salesmanProductSkills').value.trim() || null,
            language_skills: document.getElementById('salesmanLanguageSkills').value.trim() || null,
            geographic_zone: document.getElementById('salesmanGeographicZone').value.trim() || null
        };

        try {
            const res = await fetch(`/api/salesmen/${state.session.tenantId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (!result.success) throw new Error(result.error || 'Failed to add salesman');
            
            showNotification('Salesman added successfully!', 'success');
            document.querySelector('.fixed.inset-0').remove();
            await loadTeam();
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    async function deleteSalesman(salesmanId) {
        if (!confirm('Remove this salesman? They will be deactivated but data will be preserved.')) return;

        try {
            const res = await fetch(`/api/salesmen/${state.session.tenantId}/${salesmanId}`, {
                method: 'DELETE'
            });
            const result = await res.json();
            if (!result.success) throw new Error(result.error || 'Failed to remove salesman');
            
            showNotification('Salesman removed', 'success');
            await loadTeam();
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    function showAddTaskModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b sticky top-0 bg-white">
                    <h3 class="text-xl font-bold text-gray-900"><i class="fas fa-plus mr-2 text-blue-600"></i>Add Task</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title *</label>
                        <input id="taskTitle" type="text" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Follow up with customer" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="taskDescription" rows="3" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Additional details..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                            <select id="taskPriority" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500">
                                <option value="LOW">Low</option>
                                <option value="MEDIUM" selected>Medium</option>
                                <option value="HIGH">High</option>
                                <option value="URGENT">Urgent</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                            <input id="taskDueDate" type="datetime-local" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500" />
                        </div>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium">Cancel</button>
                        <button onclick="saveTask()" class="flex-1 px-4 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold">Add Task</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function saveTask() {
        const title = document.getElementById('taskTitle').value.trim();
        if (!title) return showNotification('Title is required', 'error');

        const data = {
            title,
            description: document.getElementById('taskDescription').value.trim() || null,
            priority: document.getElementById('taskPriority').value,
            due_date: document.getElementById('taskDueDate').value || null
        };

        try {
            const res = await fetch(`/api/tasks/${state.session.tenantId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (!result.success) throw new Error(result.error || 'Failed to add task');
            
            showNotification('Task added successfully!', 'success');
            document.querySelector('.fixed.inset-0').remove();
            await loadTasks();
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    async function completeTask(taskId) {
        try {
            const res = await fetch(`/api/tasks/${state.session.tenantId}/${taskId}/complete`, {
                method: 'POST'
            });
            const result = await res.json();
            if (!result.success) throw new Error(result.error || 'Failed to complete task');
            
            showNotification('Task completed!', 'success');
            await loadTasks();
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    async function deleteTask(taskId) {
        if (!confirm('Delete this task?')) return;

        try {
            const res = await fetch(`/api/tasks/${state.session.tenantId}/${taskId}`, {
                method: 'DELETE'
            });
            const result = await res.json();
            if (!result.success) throw new Error(result.error || 'Failed to delete task');
            
            showNotification('Task deleted', 'success');
            await loadTasks();
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    function showLogCallModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b sticky top-0 bg-white">
                    <h3 class="text-xl font-bold text-gray-900"><i class="fas fa-phone mr-2 text-green-600"></i>Log Call</h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                            <input id="callPhone" type="text" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500" placeholder="+919876543210" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Direction *</label>
                            <select id="callDirection" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500">
                                <option value="INBOUND">Inbound (Received)</option>
                                <option value="OUTBOUND">Outbound (Made)</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Outcome</label>
                            <select id="callOutcome" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500">
                                <option value="">Select outcome...</option>
                                <option value="ANSWERED">Answered</option>
                                <option value="NO_ANSWER">No Answer</option>
                                <option value="BUSY">Busy</option>
                                <option value="VOICEMAIL">Voicemail</option>
                                <option value="CALLBACK_SCHEDULED">Callback Scheduled</option>
                                <option value="INTERESTED">Interested</option>
                                <option value="NOT_INTERESTED">Not Interested</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Duration (seconds)</label>
                            <input id="callDuration" type="number" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500" placeholder="120" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="callNotes" rows="3" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500" placeholder="Call summary, next steps..."></textarea>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium">Cancel</button>
                        <button onclick="saveCall()" class="flex-1 px-4 py-3 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold">Log Call</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function saveCall() {
        const phone_number = document.getElementById('callPhone').value.trim();
        const direction = document.getElementById('callDirection').value;
        
        if (!phone_number) return showNotification('Phone number is required', 'error');

        const data = {
            phone_number,
            direction,
            outcome: document.getElementById('callOutcome').value || null,
            duration_seconds: parseInt(document.getElementById('callDuration').value) || null,
            notes: document.getElementById('callNotes').value.trim() || null
        };

        try {
            const res = await fetch(`/api/calls/${state.session.tenantId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (!result.success) throw new Error(result.error || 'Failed to log call');
            
            showNotification('Call logged successfully!', 'success');
            document.querySelector('.fixed.inset-0').remove();
            await loadCalls();
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    }

    init();
    </script>
</body>
</html>