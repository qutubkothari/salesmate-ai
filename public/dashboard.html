<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WhatsApp AI Sales Dashboard</title>
    <!-- Updated: Follow-ups tab added - v20251112 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; border: 1px solid rgba(255,255,255,0.1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); border-color: rgba(255,255,255,0.2); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); }
        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        .animate-pulse-soft { animation: pulseSoft 2s infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulseSoft { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .search-input { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.03) 100%); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.06); }
        .tab-active { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.2); }
        .delete-btn { transition: all 0.2s ease; }
        .delete-btn:hover { transform: scale(1.05); }
        .loading-spinner { border: 3px solid rgba(255,255,255,0.25); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .conversation-card { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); }
        .config-card { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); }
        .success-alert { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .error-alert { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        /* Hide scrollbar while maintaining scroll functionality */
        .overflow-x-auto::-webkit-scrollbar { display: none; }
        .overflow-x-auto { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Sidebar Styles */
        .sidebar { 
            width: 280px; 
            transition: width 0.3s ease, transform 0.3s ease; 
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 50;
            overflow-y: auto;
        }
        .sidebar.collapsed { width: 80px; }
        .sidebar-item {
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 12px 20px;
            border-radius: 12px;
            margin: 4px 12px;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.8);
        }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .sidebar-item.active { 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        .sidebar-item i { width: 24px; min-width: 24px; text-align: center; font-size: 18px; }
        .sidebar-item span { 
            margin-left: 16px; 
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .sidebar.collapsed .sidebar-item span { opacity: 0; width: 0; overflow: hidden; }
        .main-content { 
            margin-left: 280px; 
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .main-content.expanded { margin-left: 80px; }
        .sidebar-toggle {
            position: fixed;
            top: 24px;
            left: 250px;
            z-index: 51;
            transition: left 0.3s ease;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .sidebar-toggle.collapsed { left: 50px; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .sidebar-toggle { left: 20px; }
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
            <div class="text-center glass-effect p-8 rounded-2xl">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h2 class="text-white text-xl font-semibold mb-2">Loading Dashboard</h2>
                <p class="text-white/70">Please wait while we fetch your data...</p>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Sidebar Navigation -->
            <aside id="sidebar" class="sidebar glass-effect">
                <div class="p-6 border-b border-white/20">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <i class="fab fa-whatsapp text-white text-xl"></i>
                        </div>
                        <div class="sidebar-text">
                            <h2 class="text-white font-bold text-lg">Sales AI</h2>
                            <p class="text-white/60 text-xs">Dashboard</p>
                        </div>
                    </div>
                </div>
                
                <nav class="py-4">
                    <!-- Hidden tabs - will be activated based on subscription modules -->
                    <div class="sidebar-item active" onclick="switchTab('overview')" data-tab="overview" style="display: none;">
                        <i class="fas fa-chart-line"></i>
                        <span>Overview</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('conversations')" data-tab="conversations" style="display: none;">
                        <i class="fas fa-comments"></i>
                        <span>Conversations</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('orders')" data-tab="orders" style="display: none;">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Orders</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('followups')" data-tab="followups" style="display: none;">
                        <i class="fas fa-clock"></i>
                        <span>Follow-ups</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('products')" data-tab="products" style="display: none;">
                        <i class="fas fa-box"></i>
                        <span>Products</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('customers')" data-tab="customers" style="display: none;">
                        <i class="fas fa-users"></i>
                        <span>Customers</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('settings')" data-tab="settings" style="display: none;">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('analytics')" data-tab="analytics" style="display: none;">
                        <i class="fas fa-chart-bar"></i>
                        <span>Analytics</span>
                    </div>
                    
                    <!-- Active tabs - Based on subscription modules -->
                    <div class="sidebar-item" onclick="switchTab('broadcast')" data-tab="broadcast">
                        <i class="fas fa-bullhorn"></i>
                        <span>Broadcast</span>
                    </div>
                    <!-- Hidden for now - focusing on broadcast functionality -->
                    <div class="sidebar-item active" onclick="switchTab('whatsapp-web')" data-tab="whatsapp-web" style="display: none;">
                        <i class="fas fa-qrcode"></i>
                        <span>WhatsApp Web</span>
                    </div>
                    
                    <!-- Hidden tabs -->
                    <div class="sidebar-item" onclick="window.location.href='/discounts.html'" style="display: none;">
                        <i class="fas fa-tags"></i>
                        <span>Discounts</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('website')" data-tab="website" style="display: none;">
                        <i class="fas fa-globe"></i>
                        <span>Website Content</span>
                    </div>
                </nav>
            </aside>

            <!-- Sidebar Toggle Button -->
            <button id="sidebarToggle" onclick="toggleSidebar()" class="sidebar-toggle p-3 rounded-xl text-white hover:bg-white/30 transition-all">
                <i class="fas fa-bars"></i>
            </button>

            <!-- Main Content Area -->
            <div id="mainContent" class="main-content">
                <!-- Header -->
                <header class="glass-effect border-b border-white/20 sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div>
                                    <h1 class="text-2xl font-bold text-white" id="businessName">Sales Dashboard</h1>
                                    <p class="text-white/70 text-sm">WhatsApp AI Assistant</p>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <input type="text" id="globalSearch" placeholder="Search conversations, orders..." class="search-input pl-10 pr-4 py-2 rounded-xl border-0 w-64 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>

                                <button onclick="toggleNotifications()" class="glass-effect p-3 rounded-xl text-white hover:bg-white/20 transition-colors relative">
                                    <i class="fas fa-bell"></i>
                                    <span id="notifBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-xs flex items-center justify-center">0</span>
                                </button>

                                <button onclick="handleLogout()" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Notifications Panel -->
                <div id="notificationsPanel" class="hidden fixed top-20 right-6 w-96 max-h-[600px] glass-effect rounded-2xl shadow-2xl z-40 overflow-hidden">
                    <div class="p-4 border-b border-white/10 flex items-center justify-between">
                        <h3 class="text-white font-semibold text-lg"><i class="fas fa-bell mr-2"></i>Notifications</h3>
                        <button onclick="clearAllNotifications()" class="text-white/70 hover:text-white text-sm">Clear All</button>
                    </div>
                    <div id="notificationsList" class="overflow-y-auto max-h-[500px]">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>

                <!-- Stats Overview -->
                <section class="max-w-7xl mx-auto px-6 py-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8" id="statsGrid">
                        <!-- Stats will be dynamically loaded -->
                    </div>
                </section>

                <!-- Tab Content -->
                <main class="max-w-7xl mx-auto px-6 pb-8">
                    <!-- Main dynamic content area -->
                    <div id="tabContent" class="animate-fade-in">
                        <!-- Content loaded dynamically by JavaScript -->
                    </div>

                <!-- FIXED: Customers Tab (separate from tabContent) -->
                <div id="customersTab" class="hidden">
                    <div class="mb-4 flex flex-col md:flex-row md:items-end gap-4">
                        <input id="customerSearchInput" type="text" placeholder="Search by phone, name..." class="search-input px-4 py-2 rounded-xl border w-full md:w-64" />
                        <input id="customerMinSpent" type="number" placeholder="Min Spent" class="search-input px-4 py-2 rounded-xl border w-full md:w-32" />
                        <input id="customerMaxSpent" type="number" placeholder="Max Spent" class="search-input px-4 py-2 rounded-xl border w-full md:w-32" />
                        <input id="customerMinOrderDate" type="date" class="search-input px-4 py-2 rounded-xl border w-full md:w-40" />
                        <input id="customerMaxOrderDate" type="date" class="search-input px-4 py-2 rounded-xl border w-full md:w-40" />
                        <button id="customerSearchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700">Search</button>
                    </div>
                    <div class="overflow-x-auto rounded-xl bg-white/80 shadow-lg">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 font-semibold">Name</th>
                                    <th class="px-4 py-2 font-semibold">Phone</th>
                                    <th class="px-4 py-2 font-semibold">Last Order</th>
                                    <th class="px-4 py-2 font-semibold">Total Spent</th>
                                    <th class="px-4 py-2 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customerListBody">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading customers...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Website Content Tab -->
                <div id="websiteTab" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Stats Cards -->
                        <div class="stat-card p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-white/80 text-sm">Crawled URLs</h3>
                                <i class="fas fa-link text-blue-400"></i>
                            </div>
                            <p id="websiteUrlCount" class="text-3xl font-bold text-white">0</p>
                        </div>
                        <div class="stat-card p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-white/80 text-sm">Content Chunks</h3>
                                <i class="fas fa-cube text-purple-400"></i>
                            </div>
                            <p id="websiteChunkCount" class="text-3xl font-bold text-white">0</p>
                        </div>
                        <div class="stat-card p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-white/80 text-sm">Last Crawl</h3>
                                <i class="fas fa-clock text-green-400"></i>
                            </div>
                            <p id="websiteLastCrawl" class="text-lg font-medium text-white">Never</p>
                        </div>
                    </div>

                    <!-- Add URL Section -->
                    <div class="config-card p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-plus-circle text-blue-500 mr-2"></i>Crawl Website
                        </h3>
                        
                        <!-- Single Page Crawl -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Single Page</label>
                            <div class="flex gap-3">
                                <input 
                                    type="url" 
                                    id="websiteUrlInput" 
                                    placeholder="https://example.com/products/product-page" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                />
                                <button 
                                    onclick="crawlWebsiteUrl()" 
                                    class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-medium">
                                    <i class="fas fa-spider mr-2"></i>Crawl Page
                                </button>
                            </div>
                        </div>

                        <!-- Full Website Crawl -->
                        <div class="border-t pt-4 mt-4">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Entire Website (All Pages & Subpages)</label>
                            <div class="flex gap-3 mb-3">
                                <input 
                                    type="url" 
                                    id="websiteFullUrlInput" 
                                    placeholder="https://example.com" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                                />
                                <button 
                                    onclick="crawlEntireWebsite()" 
                                    class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all font-medium whitespace-nowrap">
                                    <i class="fas fa-globe mr-2"></i>Crawl All
                                </button>
                            </div>
                            
                            <!-- Advanced Options -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-gray-600 mb-1 block">Max Pages</label>
                                    <input 
                                        type="number" 
                                        id="maxPages" 
                                        value="100" 
                                        min="1" 
                                        max="500" 
                                        class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 mb-1 block">Max Depth</label>
                                    <input 
                                        type="number" 
                                        id="maxDepth" 
                                        value="3" 
                                        min="1" 
                                        max="5" 
                                        class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>
                            </div>
                            
                            <div class="mt-2 flex items-start gap-2">
                                <input type="checkbox" id="useSitemap" checked class="mt-1">
                                <label for="useSitemap" class="text-xs text-gray-600">
                                    <i class="fas fa-sitemap mr-1"></i>Use sitemap.xml if available (faster)
                                </label>
                            </div>
                        </div>

                        <p class="text-sm text-gray-600 mt-3">
                            <i class="fas fa-info-circle mr-1"></i>
                            Crawl entire website to index all product pages, specs, and pricing automatically
                        </p>
                        
                        <!-- Progress Indicator -->
                        <div id="crawlProgress" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-900">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Crawling website...
                                </span>
                                <span id="crawlProgressCount" class="text-xs text-blue-700">0 pages</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div id="crawlProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Website Content Section -->
                    <div class="config-card p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-search text-purple-500 mr-2"></i>Test Search
                        </h3>
                        <div class="flex gap-3 mb-4">
                            <input 
                                type="text" 
                                id="websiteSearchQuery" 
                                placeholder="Search for product info, specs, pricing..." 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                            />
                            <button 
                                onclick="searchWebsiteContent()" 
                                class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
                                <i class="fas fa-search mr-2"></i>Search
                            </button>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="websiteSearchResults" class="hidden mt-4">
                            <h4 class="font-semibold text-gray-700 mb-3">Search Results:</h4>
                            <div id="websiteSearchResultsList" class="space-y-3">
                                <!-- Results will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Crawled URLs List -->
                    <div class="config-card p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-list text-green-500 mr-2"></i>Crawled Content
                            </h3>
                            <button 
                                onclick="refreshWebsiteList()" 
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold">Page Title</th>
                                        <th class="px-4 py-3 text-left font-semibold">URL</th>
                                        <th class="px-4 py-3 text-left font-semibold">Type</th>
                                        <th class="px-4 py-3 text-left font-semibold">Chunks</th>
                                        <th class="px-4 py-3 text-left font-semibold">Crawled</th>
                                        <th class="px-4 py-3 text-left font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="websiteUrlsList">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40" onclick="document.getElementById('customerModal').classList.add('hidden')"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg p-6 overflow-hidden">
            <header class="flex justify-between items-center mb-4">
                <div>
                    <h2 id="customerModalName" class="text-lg font-semibold">Customer</h2>
                    <div id="customerModalPhone" class="text-xs text-gray-500"></div>
                </div>
                <button id="closeCustomerModalBtn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="mb-4">
                <div class="mb-2"><strong>Last Order:</strong> <span id="customerModalLastOrder">N/A</span></div>
                <div class="mb-2"><strong>Total Spent:</strong> <span id="customerModalTotalSpent">₹0.00</span></div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">Notes</h3>
                <ul id="customerNotesList" class="mb-2 space-y-2 max-h-40 overflow-y-auto">
                    <!-- Notes loaded dynamically -->
                </ul>
                <form id="addNoteForm" class="flex gap-2">
                    <input id="newNoteText" type="text" placeholder="Add a note..." class="flex-1 border rounded px-3 py-2" required />
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Add</button>
                </form>
            </div>
        </div>
    </div>
    <!-- Conversation Modal -->
    <!-- Conversation Details Modal -->
    <div id="conversationModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="modal-content relative w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
            <!-- Modal Header -->
            <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <h2 id="convTitle" class="text-2xl font-bold">Conversation Details</h2>
                                <div id="convMeta" class="text-white/80 text-sm mt-1"></div>
                            </div>
                        </div>
                        <div id="convStats" class="flex gap-4 mt-4 text-sm">
                            <!-- Stats will be added dynamically -->
                        </div>
                    </div>
                    <button id="closeConvBtn" class="ml-4 w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </header>

            <!-- Messages Area -->
            <div class="p-6">
                <div id="convMessages" class="h-96 overflow-y-auto bg-gray-50 rounded-xl p-4 space-y-3 mb-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading messages...</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 justify-between items-center">
                    <button id="loadMoreBtn" class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                        <i class="fas fa-history mr-2"></i>Load Older Messages
                    </button>
                    <div class="flex gap-3">
                        <button id="exportConvBtn" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors font-medium">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <button id="replyBtn" class="px-6 py-2.5 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all font-medium">
                            <i class="fas fa-reply mr-2"></i>Send Reply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative w-full max-w-4xl bg-white rounded-lg shadow-lg p-6 z-10 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-semibold">Order <span id="orderId">#Loading...</span></h3>
                    <p id="orderPlacedAt" class="text-sm text-gray-500">Placed:</p>
                </div>
                <div class="flex items-center gap-3">
                    <select id="orderStatusSelect" class="rounded border px-3 py-1 text-sm">
                        <!-- options inserted by JS -->
                    </select>
                    <button id="saveOrderStatusBtn" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Save</button>
                    <button id="closeOrderModal" class="bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">Close</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                <div>
                    <div class="mb-2"><strong>Status:</strong> <span id="orderStatusLabel" class="text-sm">Loading...</span></div>
                    <div class="mb-2"><strong>Mobile Number:</strong> <span id="orderCustomerPhone" class="text-sm text-gray-700">Loading...</span></div>
                    <div class="mb-2"><strong>Customer Name:</strong> <span id="orderCustomerName" class="text-sm text-gray-700">Loading...</span></div>
                    <div class="mb-2"><strong>Zoho Invoice No.:</strong> <span id="orderZohoInvoiceNo" class="text-sm text-gray-700">Loading...</span></div>
                    <div class="mb-2"><strong>Shipping Address:</strong> <div id="orderShippingAddress" class="text-sm text-gray-600">Loading...</div></div>
                </div>

                <div class="md:col-span-2">
                    <div class="flex justify-end">
                        <div class="text-right space-y-1">
                            <div class="flex justify-between gap-4"><span>Subtotal:</span><span id="orderSubtotal">₹0.00</span></div>
                            <div class="flex justify-between gap-4"><span>Shipping:</span><span id="orderShipping">₹0.00</span></div>
                            <div class="flex justify-between gap-4"><span>GST:</span><span id="orderGST">₹0.00</span></div>
                            <div class="border-t pt-2 flex justify-between gap-4 font-semibold"><span>Total:</span><span id="orderTotal">₹0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products table -->
            <div>
                <h4 class="font-medium mb-2">Products</h4>
                <div class="overflow-auto max-h-48">
                    <table class="w-full text-sm" id="orderItemsTable">
                        <thead class="text-left text-xs text-gray-600">
                            <tr>
                                <th class="pb-2">Product</th>
                                <th class="pb-2">SKU</th>
                                <th class="pb-2 text-right">Qty</th>
                                <th class="pb-2 text-right">Unit Price</th>
                                <th class="pb-2 text-right">Line Total</th>
                            </tr>
                        </thead>
                        <tbody id="orderItemsTableBody">
                            <!-- JS inserts rows here -->
                        </tbody>
                    </table>
                </div>
                <div id="noItemsNotice" class="text-sm text-gray-500 mt-2 hidden">Product details not available.</div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg p-6 overflow-auto max-h-[80vh]">
            <header class="flex justify-between items-center mb-4">
                <h2 id="editProdTitle" class="text-lg font-semibold">Edit Product</h2>
                <button id="closeEditProdBtn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="space-y-3">
                <input type="hidden" id="editProdId" />
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input id="editProdName" class="w-full px-3 py-2 border rounded" />
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                        <input id="editProdPrice" type="number" step="0.01" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity</label>
                        <input id="editProdStock" type="number" class="w-full px-3 py-2 border rounded" />
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
                        <input id="editProdBrand" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="editProdCategory" class="w-full px-3 py-2 border rounded"></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Packaging Unit</label>
                        <input id="editProdPackagingUnit" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Units per Carton</label>
                        <input id="editProdUnitsPerCarton" type="number" class="w-full px-3 py-2 border rounded" />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                    <input id="editProdImageUrl" class="w-full px-3 py-2 border rounded" />
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="cancelEditProd" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancel</button>
                    <button id="saveEditProdBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ---------- Category Loader ----------
    async function loadCategoriesDropdown() {
        try {
            const tenantId = state.session?.tenantId;
            const response = await fetch(`/api/categories?tenantId=${tenantId}`);
            const data = await response.json();
            const dropdown = document.getElementById('editProdCategory');
            if (!dropdown) return;
            dropdown.innerHTML = '';
            if (data.success && Array.isArray(data.categories) && data.categories.length > 0) {
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    dropdown.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No categories found';
                dropdown.appendChild(option);
            }
        } catch (err) {
            console.error('Failed to load categories:', err);
        }
    }

    document.getElementById('editProductModal')?.addEventListener('show', loadCategoriesDropdown);

    // ---------- Bulk Add Products ----------
    // These will be initialized after DOM is fully loaded
    function initBulkUploadHandlers() {
        const bulkAddBtn = document.getElementById('bulkAddProductsBtn');
        const uploadBtn = document.getElementById('uploadBulkProductsBtn');
        const modal = document.getElementById('bulkAddProductsModal');
        
        if (bulkAddBtn) {
            bulkAddBtn.addEventListener('click', function() {
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            });
        }

        if (uploadBtn) {
            uploadBtn.addEventListener('click', async function() {
                const fileInput = document.getElementById('bulkProductsFile');
                if (!fileInput || !fileInput.files.length) {
                    showNotification('Please select a file to upload.', 'warning');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('tenantId', state.session?.tenantId);
                
                try {
                    showNotification('Uploading products...', 'info');
                    const response = await fetch('/api/products/bulk-upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification(`Successfully uploaded ${result.count || 0} products!`, 'success');
                        if (modal) {
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                        }
                        fileInput.value = ''; // Clear file input
                        loadProducts(); // Reload products
                    } else {
                        showNotification(result.error || 'Upload failed.', 'error');
                    }
                } catch (err) {
                    console.error('Upload error:', err);
                    showNotification('Upload failed: ' + err.message, 'error');
                }
            });
        }
    }

    // ---------- Manage Categories Modal ----------
    function initManageCategoriesHandler() {
        const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
        const modal = document.getElementById('manageCategoriesModal');
        
        if (manageCategoriesBtn) {
            manageCategoriesBtn.addEventListener('click', function() {
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    loadCategories(); // Load categories when modal opens
                }
            });
        }
    }
    
    // ---------- Application State ----------
    const state = {
        session: null,
        currentTab: 'overview',
        data: { stats: null, conversations: [], orders: [], products: [], settings: {} },
        searchQuery: '',
        isLoading: false
    };
    // ---------- API Helpers ----------
    const api = {
        async verifyToken(token) {
            const response = await fetch('/api/verify-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token })
            });
            return await response.json();
        },

        async fetchData(endpoint) {
            if (!state.session?.tenantId) throw new Error('No tenant session');
            const response = await fetch(`/api/dashboard/${endpoint}/${state.session.tenantId}`);
            if (!response.ok) throw new Error(`Failed to fetch ${endpoint}`);
            return await response.json();
        },

        async updateSettings(settingsData) {
            const response = await fetch(`/api/dashboard/settings/${state.session.tenantId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settingsData)
            });
            return await response.json();
        },

        async deleteItem(type, id) {
            const response = await fetch(`/api/dashboard/${type}/${state.session.tenantId}/${id}`, {
                method: 'DELETE'
            });
            return await response.json();
        },

        async putJSON(path, payload) {
            const response = await fetch(path, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            return await response.json();
        },

        async postJSON(path, payload) {
            const response = await fetch(path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            return await response.json();
        }
    };

    // ---------- Utilities ----------
    function showNotification(message, type = 'info') {
        const colors = {
            success: 'success-alert',
            error: 'error-alert',
            info: 'bg-blue-500 text-white',
            warning: 'bg-orange-500 text-white'
        };
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[type]} px-6 py-3 rounded-xl shadow-lg z-50 animate-slide-up`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3500);
    }

    function escapeHtml(str) {
        if (typeof str !== 'string') return str;
        return str.replace(/[&<>"']/g, function (c) {
            return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c];
        });
    }

    function fmtINR(value) {
        try {
            const num = Number(value || 0);
            if (isNaN(num)) return '₹0.00';
            return '₹' + num.toLocaleString('en-IN', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        } catch (error) {
            console.warn('Error formatting currency:', error);
            return '₹0.00';
        }
    }

    // ---------- Order Modal Functions ----------
    async function loadOrderAndShowModal(orderId, tenantId) {
        try {
            console.log('Loading order modal for:', orderId);
            const modal = document.getElementById('orderModal');
            if (!modal) {
                console.error('Order modal not found in DOM');
                showNotification('Error: Order modal not available', 'error');
                return;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            const orderIdElement = document.getElementById('orderId');
            if (orderIdElement) {
                orderIdElement.textContent = 'Loading...';
            }
            
            const response = await fetch(`/api/dashboard/orders/${encodeURIComponent(tenantId)}?limit=100&offset=0`);
            if (!response.ok) {
                throw new Error(`Failed to fetch orders: ${response.status}`);
            }
            
            const data = await response.json();
            if (!data.success || !data.orders) {
                throw new Error('Invalid response format');
            }
            
            let order = data.orders.find(o => String(o.id) === String(orderId));
            if (!order) {
                throw new Error('Order not found');
            }
            
            if (order.conversation_id && (!order.customerName || order.customerName === order.conversation?.end_user_phone)) {
                try {
                    const convResponse = await fetch(`/api/dashboard/conversation/${tenantId}/${order.conversation_id}`);
                    if (convResponse.ok) {
                        const convData = await convResponse.json();
                        if (convData.success && convData.conversation) {
                            const messages = convData.conversation.messages || [];
                            const customerMessages = messages.filter(m => m.sender === 'user' || m.sender === 'customer');
                            for (const msg of customerMessages.slice(0, 5)) {
                                const text = msg.message_body || '';
                                const nameMatch = text.match(/(?:my name is|i am|i'm)\s+([a-zA-Z\s]{2,20})/i);
                                if (nameMatch && nameMatch[1].trim().length > 1) {
                                    order.customerName = nameMatch[1].trim();
                                    break;
                                }
                            }
                        }
                    }
                } catch (convError) {
                    console.warn('Could not enhance customer name:', convError);
                }
            }
            
            renderOrderDetails(order);
            
        } catch (error) {
            console.error('Error loading order modal:', error);
            showNotification(`Failed to load order: ${error.message}`, 'error');
            
            const modal = document.getElementById('orderModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
    }

    function renderOrderDetails(order) {
        console.log('Rendering order details:', order);
        
        function safeSetText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.warn(`Element not found: ${elementId}`);
            }
        }

        safeSetText('orderId', '#' + (order.id || '').substring(0, 8));
        safeSetText('orderPlacedAt', order.created_at ? 
            'Placed: ' + new Date(order.created_at).toLocaleString() : '');
        safeSetText('orderStatusLabel', order.order_status || 'N/A');
        
        let customerPhone = order.conversation?.end_user_phone || order.customer_phone || 'N/A';
        if (typeof customerPhone === 'string' && customerPhone.endsWith('@c.us')) {
            customerPhone = customerPhone.replace(/@c\.us$/, '');
        }
        // Always show the cleaned phone number under Mobile Number
        safeSetText('orderCustomerPhone', customerPhone);

        // Customer Name fallback to N/A if not present or same as phone
        const customerName = order.customerName && order.customerName !== customerPhone ? order.customerName : 'N/A';
        safeSetText('orderCustomerName', customerName);

        // Show Zoho Invoice No. if present, else N/A
        let zohoInvoiceNo = order.zoho_invoice_id || order.zoho_invoice_no || 'N/A';
        if (zohoInvoiceNo === null || zohoInvoiceNo === undefined || zohoInvoiceNo === '') zohoInvoiceNo = 'N/A';
        safeSetText('orderZohoInvoiceNo', zohoInvoiceNo);

        // Show shipping address if present, else N/A
        let shippingAddress = order.shippingAddress || order.shipping_address || '';
        if (!shippingAddress || shippingAddress.trim() === '') shippingAddress = 'N/A';
        safeSetText('orderShippingAddress', shippingAddress);
        
        const subtotal = Number(order.subtotal_amount || order.subtotal || 0);
        const shipping = Number(order.shipping_charges || order.shipping || 0);
        const gst = Number(order.gst_amount || order.gst || 0);
        const total = Number(order.total_amount || order.total || 0);
        
        safeSetText('orderSubtotal', fmtINR(subtotal));
        safeSetText('orderShipping', fmtINR(shipping));
        safeSetText('orderGST', fmtINR(gst));
        safeSetText('orderTotal', fmtINR(total));
        
        const tbody = document.getElementById('orderItemsTableBody');
        const noItemsNotice = document.getElementById('noItemsNotice');
        
        if (tbody) {
            tbody.innerHTML = '';
            const items = order.items || [];
            
            if (items.length === 0) {
                if (noItemsNotice) noItemsNotice.classList.remove('hidden');
            } else {
                if (noItemsNotice) noItemsNotice.classList.add('hidden');
                
                let totalCartons = 0;
                let totalPieces = 0;
                
                items.forEach(item => {
                    const quantity = Number(item.quantity || 0);
                    const unitsPerCarton = Number(item.unitsPerCarton || item.units_per_carton || 1000);
                    const pieces = quantity * unitsPerCarton;
                    totalCartons += quantity;
                    totalPieces += pieces;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="py-2">
                            <div class="font-medium">${escapeHtml(item.productName || item.product_name || 'Unknown Product')}</div>
                            <div class="text-xs text-gray-500">${pieces.toLocaleString()} pieces total</div>
                        </td>
                        <td class="py-2">${escapeHtml(item.sku || 'N/A')}</td>
                        <td class="py-2 text-right">
                            <div class="font-medium">${quantity} cartons</div>
                            <div class="text-xs text-gray-500">${unitsPerCarton.toLocaleString()}/carton</div>
                        </td>
                        <td class="py-2 text-right">${fmtINR(item.unitPrice || item.unit_price || item.price_at_time_of_purchase || 0)}</td>
                        <td class="py-2 text-right">${fmtINR(item.lineTotal || item.line_total || (quantity * (item.unitPrice || item.unit_price || 0)))}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'border-t-2 border-gray-300 bg-gray-50 font-semibold';
                summaryRow.innerHTML = `
                    <td class="py-3 font-bold">ORDER TOTALS</td>
                    <td class="py-3"></td>
                    <td class="py-3 text-right">
                        <div class="font-bold text-blue-600">${totalCartons} cartons</div>
                        <div class="text-sm text-blue-500">${totalPieces.toLocaleString()} pieces</div>
                    </td>
                    <td class="py-3"></td>
                    <td class="py-3 text-right font-bold text-lg">${fmtINR(total)}</td>
                `;
                tbody.appendChild(summaryRow);
            }
        }
        
        populateStatusDropdown(order.order_status || 'new');
        window.currentOrderId = order.id;
    }

    function populateStatusDropdown(currentStatus) {
        const statusSelect = document.getElementById('orderStatusSelect');
        if (!statusSelect) return;
        const statuses = [
            'new', 'pending_payment', 'pending', 'confirmed', 
            'shipped', 'delivered', 'cancelled', 'refunded'
        ];
        statusSelect.innerHTML = '';
        statuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            if (status === currentStatus) option.selected = true;
            statusSelect.appendChild(option);
        });
    }

    async function openConversation(tenantId, conversationId) {
        const modal = document.getElementById('conversationModal');
        const title = document.getElementById('convTitle');
        const meta = document.getElementById('convMeta');
        const stats = document.getElementById('convStats');
        const messagesEl = document.getElementById('convMessages');

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Show loading state
        messagesEl.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading conversation...</p>
            </div>
        `;
        title.textContent = 'Loading...';
        meta.textContent = '';
        stats.innerHTML = '';

        try {
            const resp = await fetch(`/api/dashboard/conversation/${tenantId}/${conversationId}`);
            const payload = await resp.json();
            
            if (!payload.success) {
                messagesEl.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
                        <p class="text-red-600 font-medium">Error loading conversation</p>
                        <p class="text-gray-500 text-sm mt-2">${escapeHtml(payload.error || 'Unknown error')}</p>
                    </div>
                `;
                return;
            }
            
            const { conversation } = payload;
            const messages = conversation.messages || [];
            
            // Update header info
            const phone = conversation.end_user_phone || 'Unknown';
            title.textContent = phone;
            meta.textContent = `ID: ${conversationId.substring(0, 8)}... • Updated: ${conversation.updated_at ? new Date(conversation.updated_at).toLocaleString() : 'Unknown'}`;
            
            // Show stats
            stats.innerHTML = `
                <div class="flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-full">
                    <i class="fas fa-comments"></i>
                    <span>${messages.length} messages</span>
                </div>
                <div class="flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-full">
                    <i class="fas fa-info-circle"></i>
                    <span>State: ${escapeHtml(conversation.state || 'active')}</span>
                </div>
                ${conversation.last_product_discussed ? `
                    <div class="flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-full">
                        <i class="fas fa-box"></i>
                        <span>${escapeHtml(conversation.last_product_discussed)}</span>
                    </div>
                ` : ''}
            `;

            // Render messages
            if (messages.length === 0) {
                messagesEl.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">No messages in this conversation yet</p>
                    </div>
                `;
            } else {
                messagesEl.innerHTML = '';
                messages.forEach((m, index) => {
                    const isCustomer = /@c\.us$/.test(m.sender) || /^\+?\d+$/.test(m.sender);
                    const prevMessage = messages[index - 1];
                    const showDate = !prevMessage || 
                        new Date(m.created_at).toDateString() !== new Date(prevMessage.created_at).toDateString();
                    
                    // Date separator
                    if (showDate) {
                        const dateDiv = document.createElement('div');
                        dateDiv.className = 'text-center my-4';
                        dateDiv.innerHTML = `
                            <span class="bg-gray-200 text-gray-600 text-xs px-3 py-1 rounded-full">
                                ${new Date(m.created_at).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}
                            </span>
                        `;
                        messagesEl.appendChild(dateDiv);
                    }
                    
                    // Message bubble
                    const bubble = document.createElement('div');
                    bubble.className = `flex ${isCustomer ? 'justify-start' : 'justify-end'}`;
                    
                    const time = new Date(m.created_at).toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit', 
                        hour12: true 
                    });
                    
                    bubble.innerHTML = `
                        <div class="max-w-[75%] ${isCustomer ? 'bg-white' : 'bg-gradient-to-r from-blue-500 to-purple-600'} rounded-2xl shadow-sm">
                            <div class="px-4 py-3">
                                ${!isCustomer ? '' : `<div class="text-xs font-semibold text-blue-600 mb-1">Customer</div>`}
                                <div class="text-sm ${isCustomer ? 'text-gray-800' : 'text-white'} break-words whitespace-pre-wrap">${escapeHtml(m.message_body || '')}</div>
                                <div class="text-xs ${isCustomer ? 'text-gray-400' : 'text-white/70'} mt-1 flex items-center justify-end space-x-1">
                                    <span>${time}</span>
                                    ${!isCustomer ? '<i class="fas fa-check-double text-blue-200"></i>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    messagesEl.appendChild(bubble);
                });

                // Scroll to bottom
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }
        } catch (error) {
            console.error('openConversation error', error);
            messagesEl.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-orange-500 text-3xl mb-3"></i>
                    <p class="text-gray-700 font-medium">Failed to load conversation</p>
                    <p class="text-gray-500 text-sm mt-2">${escapeHtml(error.message || String(error))}</p>
                </div>
            `;
        }
    }
    // ---------- UI Components ----------
    const components = {
        statsCard(icon, title, value, change, color) {
            return `
                <div class="stat-card card-hover p-6 rounded-2xl animate-slide-up">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r ${color} rounded-xl flex items-center justify-center">
                            <i class="${icon} text-white text-xl"></i>
                        </div>
                        ${change ? `<span class="text-green-400 text-sm font-medium">+${change}%</span>` : ''}
                    </div>
                    <h3 class="text-white/70 text-sm font-medium mb-1">${title}</h3>
                    <p class="text-white text-3xl font-bold">${value}</p>
                </div>
            `;
        },

        conversationCard(conv) {
            const lastMessage = conv.lastMessage || 'No messages yet';
            const messagePreview = lastMessage.length > 80 ? lastMessage.substring(0, 80) + '...' : lastMessage;
            return `
                <div class="conversation-card p-6 rounded-2xl mb-4 border border-white/20">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">${escapeHtml(conv.end_user_phone || 'Unknown')}</h4>
                                <p class="text-sm text-gray-500">State: ${escapeHtml(conv.state || 'Active')}</p>
                                ${conv.last_product_discussed ? `<p class="text-xs text-blue-600">Product: ${escapeHtml(conv.last_product_discussed)}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">${conv.updated_at ? new Date(conv.updated_at).toLocaleDateString() : ''}</span>
                            <button onclick="deleteConversation('${conv.id}')" class="delete-btn w-8 h-8 rounded-full bg-red-100 hover:bg-red-500 text-red-600 hover:text-white flex items-center justify-center">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl mb-4">
                        <p class="text-gray-700 text-sm">${escapeHtml(messagePreview)}</p>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-2">
                            <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full">${conv.messageCount || 0} messages</span>
                            ${conv.state === 'waiting' ? '<span class="px-3 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Needs follow-up</span>' : ''}
                        </div>
                        <button class="view-details-btn px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-sm rounded-xl" 
                                data-tenant-id="${state.session?.tenantId || ''}" data-conv-id="${conv.id}">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        },

        orderCard(order) {
            return `
                <div class="order-card conversation-card p-6 rounded-2xl mb-4 border border-white/20" data-order-id="${escapeHtml(order.id)}">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-teal-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-shopping-bag text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Order #${escapeHtml(String(order.id).substring(0, 8))}...</h4>
                                <p class="text-sm text-gray-500">${escapeHtml(order.customerName || order.conversation?.end_user_phone || 'N/A')}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-900">₹${Number(order.total || 0).toFixed(2)}</p>
                            <p class="text-sm text-gray-500">${order.created_at ? new Date(order.created_at).toLocaleDateString() : ''}</p>
                        </div>
                    </div>

                    ${order.discount > 0 ? `
                        <div class="bg-green-50 p-3 rounded-xl mb-4">
                            <p class="text-green-800 text-sm"><i class="fas fa-tag mr-2"></i>Discount Applied: ₹${Number(order.discount).toFixed(2)} saved!</p>
                        </div>
                    ` : ''}

                    ${order.shipping ? `
                        <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
                            <div class="bg-blue-50 p-2 rounded"><span class="text-blue-600">Shipping: ₹${Number(order.shipping).toFixed(2)}</span></div>
                            <div class="bg-purple-50 p-2 rounded"><span class="text-purple-600">GST: ₹${Number(order.gst || 0).toFixed(2)}</span></div>
                        </div>
                    ` : ''}

                    <div class="flex items-center justify-between space-x-3">
                        <span class="px-4 py-2 bg-green-100 text-green-800 text-sm rounded-xl font-medium">${escapeHtml(order.order_status || 'Confirmed')}</span>
                        <div class="flex space-x-2">
                            <button 
                              class="view-order-btn bg-blue-500 text-white px-3 py-1 rounded" 
                              data-order-id="${escapeHtml(order.id)}" 
                              data-tenant-id="${escapeHtml(state.session?.tenantId || '')}">
                              View Details
                            </button>
                            <button onclick="deleteOrder('${order.id}')" class="delete-btn w-10 h-10 rounded-xl bg-red-100 hover:bg-red-500 text-red-600 hover:text-white flex items-center justify-center">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    };

    // ---------- Tab & Load Management ----------
    function switchTab(tabName) {
        state.currentTab = tabName;
        
        // Update sidebar items
        document.querySelectorAll('.sidebar-item').forEach(item => {
            if (item.dataset.tab === tabName) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
        
        // Close sidebar on mobile after selection
        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('mobile-open');
        }
        
        loadTabContent(tabName);
    }
    
    // Toggle sidebar collapse/expand
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleBtn = document.getElementById('sidebarToggle');
        
        // On mobile, toggle sidebar visibility
        if (window.innerWidth <= 768) {
            sidebar.classList.toggle('mobile-open');
        } else {
            // On desktop, toggle collapse
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            toggleBtn.classList.toggle('collapsed');
        }
    }

    async function loadTabContent(tabName) {
        const content = document.getElementById('tabContent');
        const customersTab = document.getElementById('customersTab');
        const websiteTab = document.getElementById('websiteTab');
        
        // Clear any auto-refresh intervals when switching tabs
        if (window.broadcastHistoryInterval && tabName !== 'broadcast') {
            clearInterval(window.broadcastHistoryInterval);
            window.broadcastHistoryInterval = null;
        }
        if (window.waWebStatusInterval && tabName !== 'whatsapp-web') {
            clearInterval(window.waWebStatusInterval);
            window.waWebStatusInterval = null;
        }
        
        // Hide all tab content first
        content.classList.remove('hidden');
        if (customersTab) customersTab.classList.add('hidden');
        if (websiteTab) websiteTab.classList.add('hidden');
        
        content.innerHTML = '<div class="flex justify-center py-20"><div class="loading-spinner"></div></div>';
        
        try {
            switch (tabName) {
                case 'overview': await loadOverview(); break;
                case 'conversations': await loadConversations(); break;
                case 'orders': await loadOrders(); break;
                case 'products': await loadProducts(); break;
                case 'settings': await loadSettings(); break;
                case 'analytics': await loadAnalytics(); break;
                case 'broadcast': await loadBroadcast(); break;
                case 'whatsapp-web': await loadWhatsAppWeb(); break;
                case 'followups': await loadFollowUps(); break;
                case 'customers': 
                    content.classList.add('hidden');
                    if (customersTab) {
                        customersTab.classList.remove('hidden');
                        await loadCustomers();
                    } else {
                        content.classList.remove('hidden');
                        content.innerHTML = '<div class="p-8 text-red-500">Customers tab element not found.</div>';
                    }
                    break;
                case 'website':
                    content.classList.add('hidden');
                    if (websiteTab) {
                        websiteTab.classList.remove('hidden');
                        await loadWebsiteContent();
                    } else {
                        content.classList.remove('hidden');
                        content.innerHTML = '<div class="p-8 text-red-500">Website tab element not found.</div>';
                    }
                    break;
                default: 
                    content.innerHTML = '<div class="p-8">Unknown tab</div>';
            }
        } catch (err) {
            console.error('Error loading tab', tabName, err);
            content.innerHTML = `<div class="glass-effect p-8 rounded-2xl text-center"><i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i><h3 class="text-white text-xl font-semibold mb-2">Error Loading Data</h3><p class="text-white/70 mb-4">${escapeHtml(err.message || String(err))}</p><button onclick="loadTabContent('${tabName}')" class="px-6 py-2 bg-blue-600 text-white rounded-xl">Try Again</button></div>`;
        }
    }

    // ---------- Loaders ----------
    async function loadStats() {
        const data = await api.fetchData('stats');
        if (data.success) {
            state.data.stats = data.stats;
            document.getElementById('businessName').textContent = data.stats.businessName || 'Sales Dashboard';
            document.getElementById('statsGrid').innerHTML = [
                components.statsCard('fas fa-shopping-cart', 'Total Orders', data.stats.totalOrders || 0, data.stats.ordersChange || 0, 'from-blue-500 to-blue-600'),
                components.statsCard('fas fa-comments', 'Conversations', data.stats.totalConversations || 0, data.stats.convChange || 0, 'from-green-500 to-green-600'),
                components.statsCard('fas fa-box', 'Products', data.stats.totalProducts || 0, data.stats.productsChange || 0, 'from-purple-500 to-purple-600'),
                components.statsCard('fas fa-rupee-sign', 'Revenue', `₹${(data.stats.totalRevenue || 0)}`, data.stats.revenueChange || 0, 'from-yellow-500 to-yellow-600'),
                components.statsCard('fas fa-envelope', 'Messages', data.stats.totalMessages || 0, data.stats.messagesChange || 0, 'from-orange-500 to-orange-600')
            ].join('');
        }
    }

    async function loadOverview() {
        document.getElementById('tabContent').innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-effect p-6 rounded-2xl">
                    <h3 class="text-white text-xl font-semibold mb-4"><i class="fas fa-chart-line mr-2"></i>Sales Trend</h3>
                    <canvas id="salesChart" width="400" height="200"></canvas>
                </div>
                <div class="glass-effect p-6 rounded-2xl">
                    <h3 class="text-white text-xl font-semibold mb-4"><i class="fas fa-users mr-2"></i>Customer Activity</h3>
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="glass-effect p-6 rounded-2xl mt-8">
                <h3 class="text-white text-xl font-semibold mb-6"><i class="fas fa-tachometer-alt mr-2"></i>System Health</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center p-4 bg-green-500/20 rounded-xl border border-green-500/30">
                        <div class="text-3xl font-bold text-green-400 mb-2">98.7%</div>
                        <div class="text-green-300 text-sm">Uptime</div>
                    </div>
                    <div class="text-center p-4 bg-blue-500/20 rounded-xl border border-blue-500/30">
                        <div class="text-3xl font-bold text-blue-400 mb-2">1.2s</div>
                        <div class="text-blue-300 text-sm">Response Time</div>
                    </div>
                    <div class="text-center p-4 bg-purple-500/20 rounded-xl border border-purple-500/30">
                        <div class="text-3xl font-bold text-purple-400 mb-2">Active</div>
                        <div class="text-purple-300 text-sm">AI Status</div>
                    </div>
                </div>
            </div>
        `;
        setTimeout(initCharts, 80);
    }

    async function loadConversations() {
        try {
            console.log('[DASHBOARD] Loading conversations...');
            const data = await api.fetchData('conversations');
            console.log('[DASHBOARD] Conversations data received:', data);
            
            const conversations = (data.conversations || []).map(c => {
                c.lastMessage = c.last_message || c.lastMessage || '';
                return c;
            });
            console.log('[DASHBOARD] Processed conversations:', conversations.length);
            
            state.data.conversations = conversations;
            const filtered = conversations.filter(conv =>
                !state.searchQuery ||
                (conv.end_user_phone || '').includes(state.searchQuery) ||
                (conv.lastMessage || '').toLowerCase().includes(state.searchQuery.toLowerCase())
            );
            console.log('[DASHBOARD] Filtered conversations:', filtered.length);
            
            document.getElementById('tabContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-white text-2xl font-bold"><i class="fas fa-comments mr-3"></i>Recent Conversations</h2>
                    <div class="flex space-x-3">
                        <input type="text" id="conversationSearch" placeholder="Search conversations..." class="search-input px-4 py-2 rounded-xl text-sm" oninput="handleSearch(event)">
                        <button class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors"><i class="fas fa-filter mr-2"></i>Filter</button>
                    </div>
                </div>
                <div class="space-y-4">
                    ${filtered.length ? filtered.map(conv => components.conversationCard(conv)).join('') : '<div class="glass-effect p-12 rounded-2xl text-center"><i class="fas fa-comments text-white/50 text-4xl mb-4"></i><p class="text-white/70 text-lg">No conversations found</p></div>'}
                </div>
            `;
        } catch (error) {
            console.error('[DASHBOARD] Error loading conversations:', error);
            document.getElementById('tabContent').innerHTML = `
                <div class="glass-effect p-12 rounded-2xl text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <p class="text-white/70 text-lg">Error loading conversations</p>
                    <p class="text-white/50 text-sm mt-2">${escapeHtml(error.message)}</p>
                </div>
            `;
        }
    }

    async function loadOrders() {
    // Collect filter values
    const customer = document.getElementById('orderCustomerInput')?.value.trim();
    const product = document.getElementById('orderProductInput')?.value.trim();
    const status = document.getElementById('orderStatusInput')?.value.trim();
    const minDate = document.getElementById('orderMinDate')?.value.trim();
    const maxDate = document.getElementById('orderMaxDate')?.value.trim();
    const minAmount = document.getElementById('orderMinAmount')?.value.trim();
    const maxAmount = document.getElementById('orderMaxAmount')?.value.trim();

    // Build query string
    const params = new URLSearchParams();
    if (customer) params.append('customer', customer);
    if (product) params.append('product', product);
    if (status) params.append('status', status);
    if (minDate) params.append('minDate', minDate);
    if (maxDate) params.append('maxDate', maxDate);
    if (minAmount) params.append('minAmount', minAmount);
    if (maxAmount) params.append('maxAmount', maxAmount);

        const url = `/api/dashboard/orders/${state.session.tenantId}${params.toString() ? '?' + params.toString() : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        state.data.orders = data.orders || [];
        document.getElementById('tabContent').innerHTML = `
            <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-6 gap-4">
                <div class="flex-1">
                    <h2 class="text-white text-2xl font-bold mb-2 md:mb-0"><i class="fas fa-shopping-cart mr-3"></i>Recent Orders</h2>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <input type="text" id="orderCustomerInput" placeholder="Customer name/phone" class="search-input px-4 py-2 rounded-xl text-sm w-40" value="${customer || ''}" />
                        <input type="text" id="orderProductInput" placeholder="Product name, SKU, or model" class="search-input px-4 py-2 rounded-xl text-sm w-48" />
                        <select id="orderStatusInput" class="search-input px-4 py-2 rounded-xl text-sm w-32">
                            <option value="">All Statuses</option>
                            <option value="pending"${status==='pending'?' selected':''}>Pending</option>
                            <option value="processing"${status==='processing'?' selected':''}>Processing</option>
                            <option value="completed"${status==='completed'?' selected':''}>Completed</option>
                            <option value="cancelled"${status==='cancelled'?' selected':''}>Cancelled</option>
                        </select>
                        <input type="date" id="orderMinDate" class="search-input px-4 py-2 rounded-xl text-sm w-36" value="${minDate || ''}" />
                        <input type="date" id="orderMaxDate" class="search-input px-4 py-2 rounded-xl text-sm w-36" value="${maxDate || ''}" />
                        <input type="number" id="orderMinAmount" placeholder="Min Amount" class="search-input px-4 py-2 rounded-xl text-sm w-28" value="${minAmount || ''}" />
                        <input type="number" id="orderMaxAmount" placeholder="Max Amount" class="search-input px-4 py-2 rounded-xl text-sm w-28" value="${maxAmount || ''}" />
                        <button id="orderSearchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700">Search</button>
                    </div>
                </div>
                <div class="flex space-x-3 mt-4 md:mt-0">
                    <button class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors"><i class="fas fa-download mr-2"></i>Export</button>
                </div>
            </div>
            <div class="space-y-4">
                ${state.data.orders.length ? state.data.orders.map(o => components.orderCard(o)).join('') : '<div class="glass-effect p-12 rounded-2xl text-center"><i class="fas fa-shopping-cart text-white/50 text-4xl mb-4"></i><p class="text-white/70 text-lg">No orders found</p></div>'}
            </div>
        `;

        // Add event listeners for search
        document.getElementById('orderSearchBtn')?.addEventListener('click', loadOrders);
        ['orderCustomerInput','orderProductInput','orderStatusInput','orderMinDate','orderMaxDate','orderMinAmount','orderMaxAmount'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') loadOrders(); });
        });
    }

    async function loadProducts() {
        // Get search value if present
        const searchValue = document.getElementById('productSearchInput')?.value?.trim() || '';
        // Send search param to backend if present
        let url = `products/performance`;
        if (searchValue) {
            url += `?search=${encodeURIComponent(searchValue)}`;
        }
        const data = await api.fetchData(url);
        state.data.products = data.products || [];

        // Fetch categories for mapping
        let categoryMap = {};
        try {
            const catRes = await fetch(`/api/categories?tenantId=${state.session.tenantId}`);
            const catData = await catRes.json();
            if (catData.success && Array.isArray(catData.categories)) {
                catData.categories.forEach(cat => {
                    categoryMap[cat.id] = cat.name;
                });
            }
        } catch (err) {
            console.warn('Failed to load categories for product cards:', err);
        }

        document.getElementById('tabContent').innerHTML = `
            <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-6 gap-4">
                <div class="flex-1">
                    <h2 class="text-white text-2xl font-bold mb-2 md:mb-0"><i class="fas fa-box mr-3"></i>Product Performance</h2>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <input type="text" id="productSearchInput" placeholder="Search by name, SKU, model..." class="search-input px-4 py-2 rounded-xl text-sm w-64" value="${searchValue}" />
                        <button id="productSearchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700">Search</button>
                    </div>
                </div>
                <div class="flex space-x-3 mt-4 md:mt-0">
                    <button class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors"><i class="fas fa-plus mr-2"></i>Add Product</button>
                    <button class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-green-600/20 transition-colors" id="bulkAddProductsBtn"><i class="fas fa-file-upload mr-2"></i>Bulk Add Products</button>
                    <button class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-purple-600/20 transition-colors" id="manageCategoriesBtn"><i class="fas fa-folder mr-2"></i>Manage Categories</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${state.data.products.length ? state.data.products.map(product => {
                    let categoryName = 'N/A';
                    if (product.category && categoryMap[product.category]) {
                        categoryName = categoryMap[product.category];
                    }
                    return `
                    <div class="conversation-card p-6 rounded-2xl">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-900 mb-2">${escapeHtml(product.name || '')}</h4>
                                <p class="text-3xl font-bold text-green-600 mb-1">₹${Number(product.revenue || 0).toFixed(2)}</p>
                                <p class="text-sm text-gray-500">Revenue Generated</p>
                                <p class="text-xs text-blue-600 mt-1">Category: ${escapeHtml(categoryName)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick='editProduct(${JSON.stringify(product).replace(/</g,"&lt;")})' class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm"><i class="fas fa-edit mr-2"></i>Edit</button>
                                <button onclick="deleteProduct('${product.id}')" class="delete-btn w-8 h-8 rounded-full bg-red-100 hover:bg-red-500 text-red-600 hover:text-white flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center p-3 bg-blue-50 rounded-xl"><div class="text-xl font-bold text-blue-600">${product.totalQuantity || 0}</div><div class="text-blue-500 text-sm">Sold</div></div>
                            <div class="text-center p-3 bg-green-50 rounded-xl"><div class="text-xl font-bold text-green-600">${product.totalOrders || 0}</div><div class="text-green-500 text-sm">Orders</div></div>
                        </div>
                        <div class="text-center"><span class="px-3 py-1 bg-gray-100 text-gray-800 text-sm rounded-full">₹${Number(product.price || 0).toFixed(2)} per unit</span></div>
                    </div>
                    `;
                }).join('') : '<div class="col-span-full glass-effect p-12 rounded-2xl text-center"><i class="fas fa-box text-white/50 text-4xl mb-4"></i><p class="text-white/70 text-lg">No products found</p></div>'}
    <!-- Bulk Add Products Modal -->
    <div id="bulkAddProductsModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40" onclick="document.getElementById('bulkAddProductsModal').classList.add('hidden')"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg p-6 overflow-auto max-h-[80vh]">
            <header class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Bulk Add Products</h2>
                <button onclick="document.getElementById('bulkAddProductsModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="space-y-3">
                <input type="file" id="bulkProductsFile" accept=".csv,.xlsx" class="w-full px-3 py-2 border rounded" />
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="document.getElementById('bulkAddProductsModal').classList.add('hidden')" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancel</button>
                    <button id="uploadBulkProductsBtn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">Upload & Add</button>
                </div>
                <div class="text-xs text-gray-500 mt-2">Accepted formats: CSV, Excel. Columns: name, sku, price, stock, brand, category, packaging_unit, units_per_carton, image_url</div>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="manageCategoriesModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40" onclick="document.getElementById('manageCategoriesModal').classList.add('hidden')"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg overflow-auto max-h-[80vh]">
            <header class="flex justify-between items-center p-6 border-b">
                <div>
                    <h2 class="text-xl font-bold"><i class="fas fa-folder mr-2"></i>Manage Categories</h2>
                    <p class="text-sm text-gray-500 mt-1">Organize your products by category</p>
                </div>
                <button onclick="document.getElementById('manageCategoriesModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="p-6">
                <div class="flex justify-end mb-4">
                    <button onclick="showAddCategoryModal()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Add Category</button>
                </div>
                <div id="categoriesListContainer" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading categories...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
            </div>
        `;
        // Add event listeners for search
        document.getElementById('productSearchBtn')?.addEventListener('click', loadProducts);
        document.getElementById('productSearchInput')?.addEventListener('keydown', e => { if (e.key === 'Enter') loadProducts(); });
        
        // Re-initialize handlers after DOM update
        initBulkUploadHandlers();
        initManageCategoriesHandler();
    }

    // ---------- Categories Management ----------
    async function loadCategories() {
        const container = document.getElementById('categoriesListContainer');
        if (!container) return;
        
        try {
            const response = await fetch(`/api/categories?tenantId=${state.session.tenantId}`);
            const data = await response.json();
            const categories = data.success ? data.categories || [] : [];
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-folder text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500 text-lg">No categories yet</p>
                        <p class="text-gray-400 text-sm mt-2">Click "Add Category" to create your first category</p>
                    </div>
                `;
            } else {
                container.innerHTML = categories.map(cat => `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${escapeHtml(cat.name)}</h4>
                            <p class="text-sm text-gray-500">${escapeHtml(cat.description || 'No description')}</p>
                        </div>
                        <button onclick="deleteCategory('${cat.id}')" class="ml-4 px-3 py-2 bg-red-100 hover:bg-red-500 text-red-600 hover:text-white rounded-lg transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error('Error loading categories:', err);
            container.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Failed to load categories</p>
                </div>
            `;
            showNotification('Failed to load categories: ' + err.message, 'error');
        }
    }

    function showAddCategoryModal() {
        const modalHtml = `
            <div id="addCategoryModal" class="modal fixed inset-0 z-50 flex items-center justify-center">
                <div class="modal-backdrop absolute inset-0 bg-black opacity-40" onclick="document.getElementById('addCategoryModal').remove()"></div>
                <div class="modal-content relative w-11/12 md:w-1/2 lg:w-1/3 bg-white rounded-lg shadow-lg p-6">
                    <header class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Add New Category</h2>
                        <button onclick="document.getElementById('addCategoryModal').remove()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
                    </header>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category Name *</label>
                            <input id="newCategoryName" type="text" class="w-full px-3 py-2 border rounded" placeholder="e.g., NFF, Electronics" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="newCategoryDesc" class="w-full px-3 py-2 border rounded" rows="3" placeholder="Optional description"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button onclick="document.getElementById('addCategoryModal').remove()" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancel</button>
                            <button onclick="saveNewCategory()" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Save Category</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    async function saveNewCategory() {
        const name = document.getElementById('newCategoryName')?.value.trim();
        const description = document.getElementById('newCategoryDesc')?.value.trim();
        
        if (!name) {
            showNotification('Category name is required', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/categories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tenantId: state.session.tenantId,
                    name,
                    description
                })
            });
            
            const result = await response.json();
            if (result.success) {
                showNotification('Category added successfully!', 'success');
                document.getElementById('addCategoryModal')?.remove();
                loadCategories(); // Reload categories
            } else {
                showNotification(result.error || 'Failed to add category', 'error');
            }
        } catch (err) {
            console.error('Error adding category:', err);
            showNotification('Failed to add category: ' + err.message, 'error');
        }
    }

    async function deleteCategory(categoryId) {
        if (!confirm('Are you sure you want to delete this category? This will unlink it from all products.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/categories/${categoryId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tenantId: state.session.tenantId })
            });
            
            const result = await response.json();
            if (result.success) {
                showNotification('Category deleted successfully!', 'success');
                loadCategories(); // Reload categories
            } else {
                showNotification(result.error || 'Failed to delete category', 'error');
            }
        } catch (err) {
            console.error('Error deleting category:', err);
            showNotification('Failed to delete category: ' + err.message, 'error');
        }
    }

    // FIXED: Customer loading function
    async function loadCustomers() {
        try {
            const tbody = document.getElementById('customerListBody');
            if (!tbody) {
                console.error('customerListBody not found');
                return;
            }
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Loading customers...</td></tr>';

            // Collect filter values
            const phone = document.getElementById('customerSearchInput')?.value.trim();
            const minSpent = document.getElementById('customerMinSpent')?.value.trim();
            const maxSpent = document.getElementById('customerMaxSpent')?.value.trim();
            const minOrderDate = document.getElementById('customerMinOrderDate')?.value.trim();
            const maxOrderDate = document.getElementById('customerMaxOrderDate')?.value.trim();

            // Build query string
            const params = new URLSearchParams();
            if (phone) params.append('phone', phone);
            if (minSpent) params.append('minSpent', minSpent);
            if (maxSpent) params.append('maxSpent', maxSpent);
            if (minOrderDate) params.append('minOrderDate', minOrderDate);
            if (maxOrderDate) params.append('maxOrderDate', maxOrderDate);

            const url = `/api/customers/list/${state.session.tenantId}${params.toString() ? '?' + params.toString() : ''}`;
            const response = await fetch(url);
            const data = await response.json();

            if (!data.success) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-red-500">Error: ${escapeHtml(data.error || 'Failed to load')}</td></tr>`;
                return;
            }

            const customers = data.customers || [];

            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customers.map(customer => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${escapeHtml(customer.name || 'N/A')}</td>
                    <td class="px-4 py-3">${escapeHtml(customer.phone)}</td>
                    <td class="px-4 py-3">${customer.last_order_date ? new Date(customer.last_order_date).toLocaleDateString() : 'Never'}</td>
                    <td class="px-4 py-3">${fmtINR(customer.total_spent || 0)}</td>
                    <td class="px-4 py-3">
                        <button onclick="viewCustomer('${customer.id}')" class="text-blue-600 hover:underline text-sm">View</button>
                    </td>
                </tr>
            `).join('');

        } catch (error) {
            console.error('Error loading customers:', error);
            const tbody = document.getElementById('customerListBody');
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-red-500">Error: ${escapeHtml(error.message)}</td></tr>`;
            }
            showNotification('Failed to load customers', 'error');
        }
    }

    function viewCustomer(customerId) {
        showNotification('Customer details feature coming soon', 'info');
    }
    async function loadSettings() {
        const data = await api.fetchData('settings');
        const s = data.settings || {};
        state.data.settings = s;
        document.getElementById('tabContent').innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="config-card p-6 rounded-2xl">
                    <h3 class="text-gray-900 text-xl font-semibold mb-6"><i class="fas fa-shipping-fast mr-2 text-blue-600"></i>Shipping Configuration</h3>
                    <form id="shippingForm" class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Free Shipping Threshold</label>
                            <div class="relative"><span class="absolute left-3 top-3 text-gray-500">₹</span>
                            <input type="number" id="freeShippingThreshold" value="${s.free_shipping_threshold || 10000}" class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl"></div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Standard Rate (per carton)</label>
                                <div class="relative"><span class="absolute left-3 top-3 text-gray-500">₹</span>
                                <input type="number" id="standardShippingRate" value="${s.standard_shipping_rate || 20}" class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl"></div></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">High Volume Rate (15+ cartons)</label>
                                <div class="relative"><span class="absolute left-3 top-3 text-gray-500">₹</span>
                                <input type="number" id="bulkShippingRate" value="${s.bulk_shipping_rate || 15}" class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl"></div></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Bulk Threshold (cartons)</label>
                            <input type="number" id="bulkThreshold" value="${s.bulk_threshold || 15}" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></div>
                        <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl hover:from-blue-600 hover:to-blue-700">Save Shipping Settings</button>
                    </form>
                </div>

                <div class="config-card p-6 rounded-2xl">
                    <h3 class="text-gray-900 text-xl font-semibold mb-6"><i class="fas fa-percentage mr-2 text-purple-600"></i>GST Configuration</h3>
                    <form id="gstForm" class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">GST Rate (%)</label>
                            <input type="number" id="gstRate" step="0.01" value="${s.gst_rate || 18}" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Business State</label>
                            <select id="businessState" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                <option value="maharashtra" ${s.business_state==='maharashtra'?'selected':''}>Maharashtra</option>
                                <option value="gujarat" ${s.business_state==='gujarat'?'selected':''}>Gujarat</option>
                                <option value="karnataka" ${s.business_state==='karnataka'?'selected':''}>Karnataka</option>
                                <option value="tamil_nadu" ${s.business_state==='tamil_nadu'?'selected':''}>Tamil Nadu</option>
                                <option value="delhi" ${s.business_state==='delhi'?'selected':''}>Delhi</option>
                                <option value="other" ${s.business_state==='other'?'selected':''}>Other</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white py-3 rounded-xl hover:from-purple-600 hover:to-purple-700">Save GST Settings</button>
                    </form>
                </div>
            </div>

            <div class="config-card p-6 rounded-2xl mt-8">
                <h3 class="text-gray-900 text-xl font-semibold mb-6"><i class="fas fa-building mr-2 text-green-600"></i>Business Information</h3>
                <form id="businessForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Business Name</label><input type="text" id="businessName" value="${s.business_name || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">GSTIN</label><input type="text" id="gstin" value="${s.gstin || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Business Address</label><textarea id="businessAddress" rows="3" class="w-full px-4 py-3 border rounded-xl">${s.business_address || ''}</textarea></div>
                    <div class="md:col-span-2"><button type="submit" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl hover:from-green-600 hover:to-green-700">Save Business Information</button></div>
                </form>
            </div>

            <div class="config-card p-6 rounded-2xl mt-8">
                <h3 class="text-gray-900 text-xl font-semibold mb-6"><i class="fas fa-sync mr-2 text-orange-600"></i>Zoho Integration</h3>
                <div class="space-y-4">
                    <p class="text-gray-600 text-sm mb-4">Manually sync data from Zoho Books to update products, customers, and orders.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="syncProductsBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all flex items-center justify-center">
                            <i class="fas fa-box mr-2"></i> Sync Products
                        </button>
                        <button id="syncCustomersBtn" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-4 rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all flex items-center justify-center">
                            <i class="fas fa-users mr-2"></i> Sync Customers
                        </button>
                        <button id="syncOrdersBtn" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4 rounded-xl hover:from-green-600 hover:to-green-700 transition-all flex items-center justify-center">
                            <i class="fas fa-shopping-cart mr-2"></i> Sync Orders
                        </button>
                    </div>
                    <div id="syncStatus" class="mt-4 p-4 rounded-xl hidden">
                        <p class="text-sm"></p>
                    </div>
                </div>
            </div>
        `;
        attachSettingsHandlers();
    }

    async function loadAnalytics() {
        const data = await api.fetchData('analytics');
        const analytics = data.analytics || {};
        document.getElementById('tabContent').innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="config-card p-6 rounded-2xl"><h3 class="text-gray-900 text-xl font-semibold mb-6">Revenue Breakdown</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-xl"><div><span class="text-gray-700 font-medium">Product Revenue</span><p class="text-sm text-gray-500">Base product sales</p></div><span class="text-blue-600 text-xl font-bold">₹${analytics.productRevenue || 0}</span></div>
                        <div class="flex justify-between items-center p-4 bg-green-50 rounded-xl"><div><span class="text-gray-700 font-medium">Shipping Revenue</span><p class="text-sm text-gray-500">Collected shipping charges</p></div><span class="text-green-600 text-xl font-bold">₹${analytics.shippingRevenue || 0}</span></div>
                        <div class="flex justify-between items-center p-4 bg-purple-50 rounded-xl"><div><span class="text-gray-700 font-medium">GST Collected</span><p class="text-sm text-gray-500">Total tax collected</p></div><span class="text-purple-600 text-xl font-bold">₹${analytics.gstCollected || 0}</span></div>
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-xl border-2 border-gray-200"><div><span class="text-gray-900 font-bold">Total Revenue</span><p class="text-sm text-gray-500">All sources combined</p></div><span class="text-gray-900 text-2xl font-bold">₹${analytics.totalRevenue || 0}</span></div>
                    </div>
                </div>
                <div class="config-card p-6 rounded-2xl"><h3 class="text-gray-900 text-xl font-semibold mb-6">Performance Metrics</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-xl"><div><div class="text-gray-900 font-semibold">Average Order Value</div><div class="text-gray-600 text-sm">Per transaction</div></div><div class="text-2xl font-bold text-yellow-600">₹${analytics.avgOrderValue || 0}</div></div>
                        <div class="flex items-center justify-between p-4 bg-blue-50 rounded-xl"><div><div class="text-gray-900 font-semibold">Conversion Rate</div><div class="text-gray-600 text-sm">Conversations to orders</div></div><div class="text-2xl font-bold text-blue-600">${analytics.conversionRate || 0}%</div></div>
                        <div class="flex items-center justify-between p-4 bg-green-50 rounded-xl"><div><div class="text-gray-900 font-semibold">Response Rate</div><div class="text-gray-600 text-sm">Customer engagement</div></div><div class="text-2xl font-bold text-green-600">${analytics.responseRate || 0}%</div></div>
                        <div class="flex items-center justify-between p-4 bg-purple-50 rounded-xl"><div><div class="text-gray-900 font-semibold">Avg. Cart Size</div><div class="text-gray-600 text-sm">Items per order</div></div><div class="text-2xl font-bold text-purple-600">${analytics.avgCartSize || 0}</div></div>
                    </div>
                </div>
            </div>
        `;
    }

    // Check WhatsApp Web connection status for broadcast tab
    async function checkWhatsAppWebStatus() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) {
            return {
                connected: false,
                html: `<div class="bg-gray-100 border border-gray-300 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-gray-500 mr-3"></i>
                        <span class="text-gray-700">No tenant ID found</span>
                    </div>
                </div>`
            };
        }

        try {
            // PRIORITY 1: Check if desktop agent is running (on user's PC, not cloud)
            // We'll use a simple fetch with try/catch - CORS will cause error if agent offline
            let desktopAgentOnline = false;
            
            console.log('[DASHBOARD] Checking desktop agent at localhost:3001...');
            
            try {
                // Attempt to reach the desktop agent on user's local machine
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                
                const desktopAgentResponse = await fetch('http://localhost:3001/health', { 
                    method: 'GET',
                    mode: 'cors', // Allow CORS
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('[DASHBOARD] Desktop agent response status:', desktopAgentResponse.status);
                
                if (desktopAgentResponse.ok) {
                    const desktopAgentData = await desktopAgentResponse.json();
                    console.log('[DASHBOARD] Desktop agent data:', desktopAgentData);
                    
                    if (desktopAgentData && desktopAgentData.status === 'running') {
                        desktopAgentOnline = true;
                        console.log('[DASHBOARD] ✅ Desktop agent is ONLINE!');
                    }
                }
            } catch (error) {
                // Agent not running on user's PC (connection refused, timeout, or CORS error)
                console.log('[DASHBOARD] ⚠️ Desktop agent check failed:', error.message);
                console.log('[DASHBOARD] Error type:', error.name);
            }
            
            if (desktopAgentOnline) {
                console.log('[DASHBOARD] Showing GREEN banner for desktop agent');
                return {
                    connected: true,
                    method: 'desktop_agent',
                    html: `<div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300 rounded-lg p-4 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-desktop text-green-600 mr-3 text-2xl"></i>
                                    <div>
                                        <p class="font-bold text-green-900 flex items-center">
                                            <span class="relative flex h-3 w-3 mr-2">
                                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                            </span>
                                            Desktop Agent Online
                                        </p>
                                        <p class="text-xs text-gray-700 mt-1">
                                            <i class="fab fa-whatsapp text-green-600 mr-1"></i>Using your local WhatsApp Web
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold text-white bg-gradient-to-r from-green-500 to-green-600 px-4 py-2 rounded-full shadow-md">
                                        ✅ FREE MODE
                                    </span>
                                    <p class="text-xs text-green-700 mt-1 font-semibold">$0.00 per message!</p>
                                </div>
                            </div>
                            <div class="mt-3 bg-white/80 rounded p-2 text-xs text-gray-700">
                                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                                All broadcasts will be sent through your PC's WhatsApp - NO API COSTS!
                            </div>
                        </div>`
                };
            }
            
            // PRIORITY 2: Check cloud-based WhatsApp Web connection
            const response = await fetch(`/api/whatsapp-web/status/${tenantId}`);
            const result = await response.json();
            
            if (result.success && result.status === 'ready' && result.hasClient) {
                return {
                    connected: true,
                    method: 'whatsapp_web',
                    html: `<div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-semibold text-green-800">WhatsApp Web Connected (Cloud)</p>
                                    <p class="text-sm text-green-700">Phone: ${result.connection?.phone_number || 'N/A'}</p>
                                </div>
                            </div>
                            <span class="text-xs text-green-600 bg-green-100 px-3 py-1 rounded-full">
                                <i class="fas fa-circle animate-pulse"></i> Active
                            </span>
                        </div>
                        <p class="text-xs text-green-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>Broadcasts will be sent via Cloud WhatsApp Web (Free)
                        </p>
                    </div>`
                };
            } else {
                return {
                    connected: false,
                    method: 'none',
                    html: `<div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-orange-300 rounded-lg p-4 shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-orange-500 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-bold text-orange-900">No Free WhatsApp Connection</p>
                                    <div class="text-xs text-orange-700 mt-1 space-y-0.5">
                                        <p>• Desktop Agent: <span class="font-bold">Offline ❌</span></p>
                                        <p>• Cloud WhatsApp: <span class="font-bold">${result.status || 'Disconnected'} ❌</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold text-white bg-gradient-to-r from-orange-500 to-red-500 px-3 py-2 rounded-full">
                                    💰 PAID MODE
                                </span>
                                <p class="text-xs text-gray-700 mt-1">Using Maytapi API</p>
                            </div>
                        </div>
                        <div class="mt-3 bg-white rounded-lg p-3 border-2 border-blue-200">
                            <p class="text-xs font-bold text-blue-900 mb-2">
                                <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>💡 Switch to FREE broadcasts!
                            </p>
                            <ol class="text-xs text-gray-700 space-y-1 ml-4 list-decimal">
                                <li>Go to Settings → Download Desktop Agent</li>
                                <li>Run START-AGENT.bat on your PC</li>
                                <li>Scan QR code with WhatsApp</li>
                                <li>Enjoy FREE unlimited broadcasts! 🎉</li>
                            </ol>
                        </div>
                    </div>`
                };
            }
        } catch (error) {
            console.error('Error checking connection status:', error);
            return {
                connected: false,
                method: 'error',
                html: `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-times-circle text-red-500 mr-3"></i>
                        <span class="text-red-700">Error checking connection status</span>
                    </div>
                </div>`
            };
        }
    }

    // Update daily message limit
    async function updateDailyLimit() {
        const tenantId = state.session?.tenantId;
        const limitInput = document.getElementById('dailyLimitInput');
        const newLimit = parseInt(limitInput.value);
        
        if (!newLimit || newLimit < 100 || newLimit > 10000) {
            showNotification('Daily limit must be between 100 and 10,000', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/api/broadcast/daily-limit/${tenantId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dailyLimit: newLimit })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(`✅ Daily limit updated to ${newLimit} messages/day`, 'success');
                // Reload to show updated banner
                setTimeout(() => loadBroadcast(), 1000);
            } else {
                showNotification(data.error || 'Failed to update daily limit', 'error');
            }
        } catch (error) {
            console.error('Error updating daily limit:', error);
            showNotification('Failed to update daily limit', 'error');
        }
    }

    async function loadBroadcast() {
        // Check WhatsApp Web connection status
        const waWebStatus = await checkWhatsAppWebStatus();
        
        // Check daily message limit
        const tenantId = state.session?.tenantId;
        let dailyLimitHtml = '';
        let stats = null; // Initialize stats variable
        let currentDailyLimit = 1000; // Default value
        
        try {
            const statsResponse = await fetch(`/api/broadcast/daily-stats/${tenantId}`);
            if (statsResponse.ok) {
                const statsData = await statsResponse.json();
                stats = statsData.stats; // Assign to outer scope variable
                currentDailyLimit = stats.daily_limit || 1000;
                
                let bannerColor = 'bg-green-50 border-green-200 text-green-800';
                let icon = 'fa-check-circle text-green-500';
                
                if (stats.status === 'limit_reached') {
                    bannerColor = 'bg-red-50 border-red-300 text-red-800';
                    icon = 'fa-exclamation-triangle text-red-500';
                } else if (stats.status === 'warning') {
                    bannerColor = 'bg-yellow-50 border-yellow-300 text-yellow-800';
                    icon = 'fa-exclamation-circle text-yellow-500';
                }
                
                dailyLimitHtml = `
                    <div class="${bannerColor} border-2 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas ${icon} text-2xl mr-3"></i>
                                <div>
                                    <p class="font-bold">Daily Message Usage</p>
                                    <p class="text-sm">${stats.sent_today} / ${stats.daily_limit} messages sent today (${stats.percentage_used}%)</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-lg">${stats.remaining}</p>
                                <p class="text-xs">remaining</p>
                            </div>
                        </div>
                        ${stats.status === 'warning' || stats.status === 'limit_reached' ? `
                            <p class="text-xs mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                ${stats.status === 'limit_reached' ? 
                                    'Daily limit reached! Limit resets tomorrow.' : 
                                    'Approaching daily limit. Use wisely to avoid hitting the cap.'}
                            </p>
                        ` : ''}
                    </div>
                `;
            }
        } catch (err) {
            console.log('Could not load daily stats:', err);
        }
        
        document.getElementById('tabContent').innerHTML = `
            <div class="max-w-4xl mx-auto">
                <!-- WhatsApp Web Connection Status Banner -->
                <div id="waWebStatusBanner" class="mb-4">
                    ${waWebStatus.html}
                </div>
                
                <!-- Daily Limit Banner -->
                ${dailyLimitHtml}
                
                <!-- Daily Limit Settings -->
                <div class="config-card p-6 rounded-xl mb-6 bg-gradient-to-r from-indigo-50 to-purple-50">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center">
                            <i class="fas fa-cog text-indigo-600 text-2xl mr-3"></i>
                            <div>
                                <p class="font-bold text-gray-900">Daily Message Limit</p>
                                <p class="text-sm text-gray-600">Set your daily sending limit (100-10,000)</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="number" id="dailyLimitInput" min="100" max="10000" step="100"
                                value="${currentDailyLimit}"
                                class="w-32 px-4 py-2 border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-center font-bold">
                            <button id="saveDailyLimitBtn"
                                class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold shadow-md">
                                <i class="fas fa-save mr-2"></i>Save
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-gray-600 bg-white/50 rounded-lg p-3">
                        <i class="fas fa-info-circle text-indigo-500 mr-1"></i>
                        <strong>Auto-Scheduling:</strong> If you upload more contacts than your daily limit, the system will automatically split them across multiple days. For example, uploading 2000 contacts with a 500/day limit will schedule over 4 days.
                    </div>
                </div>
                
                <div class="config-card p-8 rounded-2xl mb-6">
                    <h2 class="text-gray-900 text-2xl font-bold mb-6">
                        <i class="fas fa-bullhorn mr-3 text-indigo-600"></i>Send Broadcast
                    </h2>
                    
                    <!-- Bot Delivery Method Indicator -->
                    <div id="botDeliveryIndicator" class="mb-6 p-4 rounded-lg border-2">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <form id="broadcastForm" class="space-y-6">
                        <!-- Campaign Name -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Campaign Name
                            </label>
                            <input type="text" id="campaignName" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="e.g., Holiday Sale 2025">
                        </div>

                        <!-- Recipients Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Recipients
                            </label>
                            
                            <!-- Tab selector - Mobile Optimized -->
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <button type="button" onclick="switchRecipientMode('paste')" id="recipientModePaste"
                                    class="px-2 py-3 rounded-lg border-2 border-indigo-500 bg-indigo-50 text-indigo-700 font-semibold text-xs md:text-sm hover:shadow-md transition">
                                    <i class="fab fa-whatsapp block md:inline text-lg md:text-base mb-1 md:mb-0 md:mr-1"></i>
                                    <span class="block md:inline">Paste</span>
                                </button>
                                <button type="button" onclick="switchRecipientMode('upload')" id="recipientModeUpload"
                                    class="px-2 py-3 rounded-lg border-2 border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-xs md:text-sm hover:shadow-md transition">
                                    <i class="fas fa-upload block md:inline text-lg md:text-base mb-1 md:mb-0 md:mr-1"></i>
                                    <span class="block md:inline">Upload</span>
                                </button>
                                <button type="button" onclick="switchRecipientMode('groups')" id="recipientModeGroups"
                                    class="px-2 py-3 rounded-lg border-2 border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-xs md:text-sm hover:shadow-md transition">
                                    <i class="fas fa-users block md:inline text-lg md:text-base mb-1 md:mb-0 md:mr-1"></i>
                                    <span class="block md:inline">Groups</span>
                                </button>
                            </div>

                            <!-- Upload Mode (Excel/CSV) -->
                            <div id="uploadMode" class="hidden">
                                <!-- Google Contacts Instructions -->
                                <div class="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                                    <div class="flex items-start">
                                        <i class="fab fa-google text-blue-600 text-2xl mr-3 mt-1"></i>
                                        <div class="flex-1">
                                            <p class="font-bold text-gray-800 mb-2">
                                                <i class="fas fa-star text-yellow-500 mr-1"></i>Import from Google Contacts (Easiest!)
                                            </p>
                                            <ol class="list-decimal list-inside space-y-1 text-xs text-gray-700 mb-3">
                                                <li>Open <a href="https://contacts.google.com" target="_blank" class="text-blue-600 hover:underline font-semibold">contacts.google.com</a></li>
                                                <li>Click "Export" on the left sidebar</li>
                                                <li>Select "Google CSV" format</li>
                                                <li>Click "Export" button → Downloads a CSV file</li>
                                                <li>Upload that CSV file below 👇</li>
                                            </ol>
                                            <div class="bg-white/50 rounded px-3 py-2 text-xs text-gray-600">
                                                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                                                <strong>Also works with:</strong> Excel files, iPhone exports, or any CSV with phone numbers
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-500 transition">
                                    <input type="file" id="recipientsFile" accept=".xlsx,.xls,.csv" 
                                        class="hidden" onchange="handleFileUpload(event)">
                                    <label for="recipientsFile" class="cursor-pointer">
                                        <i class="fas fa-file-upload text-4xl text-indigo-500 mb-2"></i>
                                        <p class="text-sm font-semibold text-gray-700">Click to Upload CSV/Excel File</p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>Google CSV
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>Excel (.xlsx, .xls)
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>Any CSV
                                        </p>
                                    </label>
                                    <div id="fileInfo" class="mt-3 text-sm text-green-600 hidden"></div>
                                </div>
                                
                                <!-- Recipients List -->
                                <div id="recipientsList" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 max-h-48 overflow-y-auto">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-semibold text-gray-700">Loaded Numbers:</span>
                                        <div class="flex gap-2">
                                            <button type="button" onclick="showSaveGroupDialog()" class="text-xs text-indigo-600 hover:text-indigo-700 font-semibold">
                                                <i class="fas fa-save"></i> Save as Group
                                            </button>
                                            <button type="button" onclick="clearRecipients()" class="text-xs text-red-600 hover:text-red-700">
                                                <i class="fas fa-times-circle"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                    <div id="recipientsNumbers" class="text-xs text-gray-600 space-y-1"></div>
                                </div>
                            </div>

                            <!-- iPhone Paste Mode (NOW FIRST) -->
                            <div id="pasteMode" class="hidden">
                                <div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300 rounded-xl p-6 mb-4">
                                    <div class="flex items-start">
                                        <div class="bg-white rounded-full p-3 mr-4">
                                            <i class="fab fa-whatsapp text-green-500 text-3xl"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-bold text-lg text-gray-800 mb-2">📱 Super Simple - Just Copy & Paste!</h3>
                                            <p class="text-sm text-gray-700 mb-3">Your customer can copy numbers from anywhere:</p>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-600">
                                                <div class="flex items-center">
                                                    <i class="fab fa-whatsapp text-green-500 mr-2"></i>
                                                    <span>WhatsApp chat or group</span>
                                                </div>
                                                <div class="flex items-center">
                                                    <i class="fas fa-sms text-blue-500 mr-2"></i>
                                                    <span>iPhone Messages</span>
                                                </div>
                                                <div class="flex items-center">
                                                    <i class="fas fa-address-book text-purple-500 mr-2"></i>
                                                    <span>Contact list (any app)</span>
                                                </div>
                                                <div class="flex items-center">
                                                    <i class="fas fa-file-alt text-orange-500 mr-2"></i>
                                                    <span>Notes, Email, anywhere!</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Simple Text Paste Area -->
                                <div class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-6 hover:border-indigo-400 transition">
                                    <label class="block text-center mb-4">
                                        <div class="text-2xl mb-2">📋</div>
                                        <p class="font-bold text-gray-800 text-lg mb-1">Step 1: Copy your contacts</p>
                                        <p class="text-sm text-gray-600">From WhatsApp, Messages, or anywhere on your phone</p>
                                    </label>
                                    <textarea id="pasteContacts" rows="10" 
                                        placeholder="Step 2: Paste here! We'll find all phone numbers automatically 🎯&#10;&#10;Examples of what you can paste:&#10;&#10;+1 234-567-8900&#10;John: 2345678900&#10;Call me at (234) 567-8900&#10;WhatsApp: +12345678900&#10;&#10;Just paste ANYTHING with phone numbers - we'll extract them!"
                                        class="w-full px-4 py-4 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base"
                                        onpaste="setTimeout(handleContactPaste, 100)"></textarea>
                                    
                                    <div class="flex gap-2 mt-4">
                                        <button type="button" onclick="handleContactPaste()" 
                                            class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 font-semibold text-lg shadow-lg">
                                            <i class="fas fa-magic mr-2"></i>Extract Phone Numbers
                                        </button>
                                        <button type="button" onclick="clearPastedRecipients()" 
                                            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                            <i class="fas fa-eraser mr-2"></i>Clear
                                        </button>
                                    </div>
                                </div>

                                <!-- Extracted Numbers -->
                                <div id="pasteRecipientsList" class="hidden mt-4 bg-green-50 border-2 border-green-200 rounded-xl p-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <div class="flex items-center">
                                            <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                                            <div>
                                                <p class="font-bold text-green-800">Found Phone Numbers!</p>
                                                <span id="pasteCountBadge" class="text-sm text-green-700"></span>
                                            </div>
                                        </div>
                                        <button type="button" onclick="showSaveGroupDialog()" 
                                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold text-sm">
                                            <i class="fas fa-save mr-2"></i>Save as Group
                                        </button>
                                    </div>
                                    <div id="pasteRecipientsNumbers" class="max-h-64 overflow-y-auto bg-white rounded-lg p-3 text-sm space-y-1"></div>
                                </div>
                            </div>

                            <!-- Groups Mode -->
                            <div id="groupsMode" class="hidden">
                                <div id="contactGroupsList" class="space-y-2">
                                    <p class="text-sm text-gray-500 text-center py-8">Loading groups...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Message Type -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Message Type
                            </label>
                            <div class="flex gap-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="messageType" value="text" checked 
                                        onchange="toggleMessageType()"
                                        class="w-4 h-4 text-indigo-600">
                                    <span class="ml-2 text-gray-700"><i class="fas fa-comment mr-1"></i> Text Only</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="messageType" value="image" 
                                        onchange="toggleMessageType()"
                                        class="w-4 h-4 text-indigo-600">
                                    <span class="ml-2 text-gray-700"><i class="fas fa-image mr-1"></i> Image + Text</span>
                                </label>
                            </div>
                        </div>

                        <!-- Image Upload (hidden by default) -->
                        <div id="imageUploadSection" class="hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-image mr-2"></i>Upload Image
                            </label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-500 transition">
                                <input type="file" id="broadcastImage" accept="image/*" capture="environment"
                                    class="hidden" onchange="handleImageUpload(event)">
                                <label for="broadcastImage" class="cursor-pointer">
                                    <div class="flex flex-col md:flex-row items-center justify-center gap-3">
                                        <div class="text-center">
                                            <i class="fas fa-camera text-4xl text-indigo-500 mb-2"></i>
                                            <p class="text-sm font-semibold text-gray-700">Take Photo</p>
                                        </div>
                                        <span class="hidden md:inline text-2xl text-gray-300">or</span>
                                        <div class="text-center">
                                            <i class="fas fa-image text-4xl text-purple-500 mb-2"></i>
                                            <p class="text-sm font-semibold text-gray-700">Choose from Gallery</p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-3">
                                        <i class="fas fa-mobile-alt mr-1"></i>On mobile: Camera opens automatically
                                    </p>
                                </label>
                                <div id="imagePreview" class="mt-4 hidden">
                                    <img id="previewImg" class="max-h-64 w-auto mx-auto rounded-lg shadow-lg border-2 border-green-200" alt="Preview">
                                    <button type="button" onclick="removeImage()" 
                                        class="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                                        <i class="fas fa-trash mr-2"></i>Remove Image
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Message Text -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-semibold text-gray-700">
                                    Message <span id="messageLabel">Text</span>
                                </label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="loadMessageTemplates()" 
                                        class="text-xs text-indigo-600 hover:text-indigo-700 font-semibold">
                                        <i class="fas fa-file-alt"></i> Load Template
                                    </button>
                                    <button type="button" onclick="saveAsTemplate()" 
                                        class="text-xs text-green-600 hover:text-green-700 font-semibold">
                                        <i class="fas fa-save"></i> Save as Template
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Personalization Guide -->
                            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                                <div class="flex items-start">
                                    <i class="fas fa-user-tag text-purple-600 text-xl mr-3 mt-1"></i>
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-800 mb-2 flex items-center">
                                            <i class="fas fa-magic text-yellow-500 mr-2"></i>Personalize Your Messages
                                        </p>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                            <div class="bg-white/70 rounded px-3 py-2">
                                                <code class="text-purple-700 font-bold">{name}</code>
                                                <p class="text-gray-600 mt-1">Contact's name</p>
                                            </div>
                                            <div class="bg-white/70 rounded px-3 py-2">
                                                <code class="text-purple-700 font-bold">{phone}</code>
                                                <p class="text-gray-600 mt-1">Phone number</p>
                                            </div>
                                            <div class="bg-white/70 rounded px-3 py-2">
                                                <code class="text-purple-700 font-bold">{business}</code>
                                                <p class="text-gray-600 mt-1">Your business</p>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-xs text-gray-700 bg-white/50 rounded px-3 py-2">
                                            <strong>Example:</strong> "Hi {name}! Special offer from {business} just for you! 🎉"
                                            <br>→ Becomes: "Hi John! Special offer from SAK Store just for you! 🎉"
                                        </div>
                                        <div class="mt-3 text-xs text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2">
                                            <div class="flex items-start">
                                                <i class="fas fa-shield-check text-green-600 mr-2 mt-0.5"></i>
                                                <div>
                                                    <strong class="flex items-center gap-1">
                                                        <i class="fas fa-robot"></i> Anti-Bot Detection Active
                                                    </strong>
                                                    <p class="mt-1">Messages are automatically humanized with:</p>
                                                    <ul class="mt-1 ml-3 space-y-1">
                                                        <li>• 20 random greeting templates</li>
                                                        <li>• Natural delays (10-18s between messages)</li>
                                                        <li>• Random emoji variations</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <textarea id="broadcastMessage" required rows="5"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="Hi {name}! 👋&#10;&#10;We have exciting news from {business}...&#10;&#10;Contact us at {phone} for more details!"></textarea>
                        </div>

                        <!-- Schedule Options -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Send Time
                            </label>
                            <div class="flex gap-4 mb-3">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="scheduleType" value="now" checked 
                                        onchange="toggleSchedule()"
                                        class="w-4 h-4 text-indigo-600">
                                    <span class="ml-2 text-gray-700"><i class="fas fa-bolt mr-1"></i> Send Now</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="scheduleType" value="later" 
                                        onchange="toggleSchedule()"
                                        class="w-4 h-4 text-indigo-600">
                                    <span class="ml-2 text-gray-700"><i class="fas fa-clock mr-1"></i> Schedule</span>
                                </label>
                            </div>
                            <input type="datetime-local" id="scheduleTime" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent hidden">
                        </div>

                        <!-- Batch Settings -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-cogs mr-2 text-indigo-600"></i>
                                Batch & Rate Limiting Settings
                            </h4>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        Messages per Batch
                                    </label>
                                    <input type="number" id="batchSize" value="10" min="1" max="100"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <p class="text-xs text-gray-500 mt-1">Default: 10</p>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        Delay Between Messages (ms)
                                    </label>
                                    <input type="number" id="messageDelay" value="500" min="100" max="5000" step="100"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <p class="text-xs text-gray-500 mt-1">Default: 500ms</p>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        Delay Between Batches (ms)
                                    </label>
                                    <input type="number" id="batchDelay" value="2000" min="1000" max="30000" step="1000"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <p class="text-xs text-gray-500 mt-1">Default: 2000ms</p>
                                </div>
                            </div>
                            
                            <div class="mt-3 bg-blue-50 border border-blue-200 rounded p-2">
                                <p class="text-xs text-blue-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <strong>Tip:</strong> Increase delays if you're hitting WhatsApp rate limits. 
                                    Smaller batches with longer delays = more reliable delivery.
                                </p>
                            </div>
                        </div>

                        <!-- Submit Button - Mobile Optimized -->
                        <div class="sticky bottom-0 left-0 right-0 bg-white/95 backdrop-blur -mx-8 px-8 py-4 border-t-2 border-gray-200 md:static md:bg-transparent md:backdrop-blur-none md:mx-0 md:px-0 md:py-0 md:border-0">
                            <button type="submit" 
                                class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 px-6 rounded-xl font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-2xl active:scale-95 transform">
                                <i class="fas fa-paper-plane mr-2 text-xl"></i>
                                <span id="submitButtonText">Send Broadcast Now</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Recent Broadcasts -->
                <div class="config-card p-8 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-gray-900 text-xl font-bold">
                            <i class="fas fa-history mr-2 text-gray-600"></i>Recent Broadcasts
                        </h3>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input type="text" id="campaignSearch" placeholder="Search by campaign name..."
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm"
                                onkeyup="filterBroadcasts()">
                            <select id="statusFilter" onchange="filterBroadcasts()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
                                <option value="">All Statuses</option>
                                <option value="completed">Completed</option>
                                <option value="processing">Processing</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                            <button type="button" onclick="clearFilters()"
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-semibold">
                                <i class="fas fa-times mr-1"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                    
                    <div id="broadcastHistory" class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                        <p>No broadcasts sent yet</p>
                    </div>
                </div>
            </div>
        `;

        // Attach form submit handler
        document.getElementById('broadcastForm').addEventListener('submit', handleBroadcastSubmit);
        
        // Attach daily limit save button handler
        const saveDailyLimitBtn = document.getElementById('saveDailyLimitBtn');
        if (saveDailyLimitBtn) {
            saveDailyLimitBtn.addEventListener('click', updateDailyLimit);
        }
        
        // Update bot delivery method indicator
        const savedFeatures = JSON.parse(localStorage.getItem(`tenant_features_${state.session?.tenantId}`)) || {};
        const botDeliveryMethod = savedFeatures.bot_delivery_method || 'desktop';
        const indicator = document.getElementById('botDeliveryIndicator');
        
        if (botDeliveryMethod === 'cloud') {
            indicator.className = 'mb-6 p-4 rounded-lg border-2 bg-blue-50 border-blue-300';
            indicator.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-cloud text-blue-600 text-2xl"></i>
                    <div class="flex-1">
                        <p class="font-bold text-blue-900">24/7 Cloud Bot Active (Waha)</p>
                        <p class="text-sm text-blue-700">Broadcasts will be sent through the always-online cloud bot</p>
                    </div>
                    <button type="button" onclick="window.location.href='/clients.html'" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">
                        <i class="fas fa-cog mr-1"></i> Change
                    </button>
                </div>
            `;
        } else {
            indicator.className = 'mb-6 p-4 rounded-lg border-2 bg-gray-50 border-gray-300';
            indicator.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-desktop text-gray-600 text-2xl"></i>
                    <div class="flex-1">
                        <p class="font-bold text-gray-900">Desktop Agent Mode</p>
                        <p class="text-sm text-gray-700">Broadcasts require your PC to be online with WhatsApp Web connected</p>
                    </div>
                    <button type="button" onclick="window.location.href='/clients.html'" 
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm font-semibold">
                        <i class="fas fa-cog mr-1"></i> Switch to Cloud Bot
                    </button>
                </div>
            `;
        }
        
        // Load broadcast history
        loadBroadcastHistory();
        
        // Auto-refresh broadcast history every 5 seconds to show progress
        if (window.broadcastHistoryInterval) {
            clearInterval(window.broadcastHistoryInterval);
        }
        window.broadcastHistoryInterval = setInterval(() => {
            loadBroadcastHistory();
        }, 5000);
    }
    
    // WhatsApp Web Connection Management
    async function loadWhatsAppWeb() {
        const tenantId = state.session?.tenantId;
        
        const content = document.getElementById('tabContent');
        content.innerHTML = `
            <div class="space-y-6">
                <!-- Header -->
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-2">
                            <i class="fas fa-qrcode mr-3"></i>WhatsApp Web Connection
                        </h2>
                        <p class="text-white/70">Connect your own WhatsApp number via QR code (Standalone System)</p>
                    </div>
                </div>

                <!-- Connection Status Card -->
                <div class="bg-white/95 backdrop-blur rounded-2xl shadow-xl p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        <i class="fas fa-signal mr-2 text-green-500"></i>Connection Status
                    </h3>
                    
                    <div id="waWebStatus" class="mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-3 h-3 rounded-full bg-gray-400 animate-pulse"></div>
                            <span class="text-gray-600">Checking status...</span>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4">
                        <button onclick="connectWhatsAppWeb()" id="btnConnect" 
                                class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-colors flex items-center">
                            <i class="fas fa-plug mr-2"></i>Connect
                        </button>
                        <button onclick="disconnectWhatsAppWeb()" id="btnDisconnect" 
                                class="bg-red-600 text-white px-6 py-3 rounded-xl hover:bg-red-700 transition-colors flex items-center">
                            <i class="fas fa-unlink mr-2"></i>Disconnect
                        </button>
                        <button onclick="refreshWhatsAppStatus()" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Status
                        </button>
                    </div>
                </div>

                <!-- QR Code Display -->
                <div id="qrCodeSection" class="bg-white/95 backdrop-blur rounded-2xl shadow-xl p-6 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        <i class="fas fa-mobile-alt mr-2 text-blue-500"></i>Scan QR Code
                    </h3>
                    <p class="text-gray-600 mb-6">Open WhatsApp on your phone → Settings → Linked Devices → Link a Device</p>
                    
                    <div class="flex justify-center items-center bg-gray-50 p-8 rounded-xl">
                        <div id="qrCodeDisplay" class="text-center">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-gray-500">Loading QR code...</p>
                        </div>
                    </div>
                </div>

                <!-- Info Card -->
                <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 backdrop-blur rounded-2xl p-6 border border-white/20">
                    <h3 class="text-white font-semibold mb-3">
                        <i class="fas fa-info-circle mr-2"></i>About WhatsApp Web Connection
                    </h3>
                    <ul class="text-white/80 space-y-2 text-sm">
                        <li><i class="fas fa-check-circle text-green-400 mr-2"></i>Standalone system - works independently from Maytapi</li>
                        <li><i class="fas fa-check-circle text-green-400 mr-2"></i>Free to use with your own WhatsApp number</li>
                        <li><i class="fas fa-check-circle text-green-400 mr-2"></i>QR code connection - scan once and stay connected</li>
                        <li><i class="fas fa-check-circle text-green-400 mr-2"></i>Sessions persist across server restarts</li>
                        <li><i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>Your phone must stay online and connected</li>
                    </ul>
                </div>

                <!-- Connection Details -->
                <div id="connectionDetails" class="bg-white/95 backdrop-blur rounded-2xl shadow-xl p-6 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        <i class="fas fa-info mr-2 text-purple-500"></i>Connection Details
                    </h3>
                    <div id="connectionInfo" class="space-y-2 text-gray-700">
                        <!-- Details will be populated here -->
                    </div>
                </div>
            </div>
        `;

        // Load current status
        await refreshWhatsAppStatus();
        
        // Auto-refresh status every 10 seconds
        if (window.waWebStatusInterval) {
            clearInterval(window.waWebStatusInterval);
        }
        window.waWebStatusInterval = setInterval(() => {
            refreshWhatsAppStatus();
        }, 10000);
    }

    async function connectWhatsAppWeb() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) {
            alert('No tenant ID found');
            return;
        }

        try {
            document.getElementById('btnConnect').disabled = true;
            document.getElementById('btnConnect').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';

            // Waha Core only supports 'default' session
            const sessionName = 'default';
            
            const response = await fetch('/api/waha/session/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    tenantId: tenantId,
                    session: sessionName 
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.ok) {
                const statusMsg = result.status === 'WORKING' 
                    ? 'Already connected! Session is working.' 
                    : result.message || 'Waha session started!';
                showNotification(statusMsg, 'success');
                
                // If already working, hide QR and show as connected
                if (result.status === 'WORKING') {
                    document.getElementById('qrCodeSection').classList.add('hidden');
                    await refreshWhatsAppStatus();
                } else {
                    // Show QR section and start polling for QR code
                    document.getElementById('qrCodeSection').classList.remove('hidden');
                    setTimeout(() => pollForQRCode('default'), 2000);
                }
            } else {
                showNotification('Connection failed: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Connect error:', error);
            const errorMessage = error.name === 'AbortError' 
                ? 'Connection timeout - Server is taking too long to respond. Please try again.' 
                : 'Error connecting: ' + error.message;
            showNotification(errorMessage, 'error');
        } finally {
            document.getElementById('btnConnect').disabled = false;
            document.getElementById('btnConnect').innerHTML = '<i class="fas fa-plug mr-2"></i>Connect';
        }
    }

    async function disconnectWhatsAppWeb() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        if (!confirm('Are you sure you want to disconnect WhatsApp Web?')) return;

        try {
            document.getElementById('btnDisconnect').disabled = true;
            document.getElementById('btnDisconnect').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Disconnecting...';

            // Waha Core only supports 'default' session
            const sessionName = 'default';
            
            const response = await fetch(`/api/waha/session/${sessionName}/stop`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();
            
            if (result.ok) {
                showNotification('Waha session stopped successfully', 'success');
                document.getElementById('qrCodeSection').classList.add('hidden');
                await refreshWhatsAppStatus();
            } else {
                showNotification('Disconnect failed: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Disconnect error:', error);
            showNotification('Error disconnecting: ' + error.message, 'error');
        } finally {
            document.getElementById('btnDisconnect').disabled = false;
            document.getElementById('btnDisconnect').innerHTML = '<i class="fas fa-unlink mr-2"></i>Disconnect';
        }
    }

    async function refreshWhatsAppStatus() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        try {
            // Waha Core only supports 'default' session
            const sessionName = 'default';
            
            const response = await fetch(`/api/waha/session/${sessionName}/status`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            const statusDiv = document.getElementById('waWebStatus');
            if (!statusDiv) return;

            // Waha status mapping: STOPPED, STARTING, SCAN_QR_CODE, WORKING, FAILED
            const wahaStatus = result.status || 'STOPPED';

            let statusColor = 'gray';
            let statusText = 'Disconnected';
            let statusIcon = 'fa-circle';

            switch (wahaStatus) {
                case 'WORKING':
                    statusColor = 'green';
                    statusText = 'Connected & Ready ✓';
                    statusIcon = 'fa-check-circle';
                    document.getElementById('qrCodeSection')?.classList.add('hidden');
                    document.getElementById('connectionDetails')?.classList.remove('hidden');
                    break;
                case 'SCAN_QR_CODE':
                    statusColor = 'yellow';
                    statusText = 'Scan QR Code to Connect';
                    statusIcon = 'fa-qrcode';
                    document.getElementById('qrCodeSection')?.classList.remove('hidden');
                    pollForQRCode(sessionName);
                    break;
                case 'STARTING':
                    statusColor = 'blue';
                    statusText = 'Starting Waha Session...';
                    statusIcon = 'fa-spinner fa-spin';
                    break;
                case 'FAILED':
                    statusColor = 'red';
                    statusText = 'Connection Failed';
                    statusIcon = 'fa-exclamation-circle';
                    break;
                case 'STOPPED':
                default:
                    statusColor = 'gray';
                    statusText = 'Not Connected';
                    statusIcon = 'fa-circle';
                    document.getElementById('qrCodeSection')?.classList.add('hidden');
                    document.getElementById('connectionDetails')?.classList.add('hidden');
            }

            statusDiv.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-3 h-3 rounded-full bg-${statusColor}-500 ${wahaStatus === 'STARTING' ? 'animate-pulse' : ''}"></div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <i class="fas ${statusIcon} text-${statusColor}-500"></i>
                            <span class="font-semibold text-gray-800">${statusText}</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Waha Cloud Bot - Session: default</p>
                    </div>
                </div>
            `;

            // Show connection details if connected
            if (wahaStatus === 'WORKING') {
                const detailsDiv = document.getElementById('connectionInfo');
                if (detailsDiv) {
                    detailsDiv.innerHTML = `
                        <p><strong>Session Name:</strong> default</p>
                        <p><strong>Status:</strong> ${wahaStatus}</p>
                        <p><strong>Provider:</strong> Waha Cloud Bot (24/7)</p>
                        <p><strong>Connection:</strong> Active and Ready</p>
                        <p class="text-sm text-gray-500 mt-2"><em>Note: Waha Core supports one WhatsApp account (shared across all tenants)</em></p>
                    `;
                }
            }

        } catch (error) {
            console.error('Status refresh error:', error);
            
            // Show user-friendly error message
            const statusDiv = document.getElementById('waWebStatus');
            if (statusDiv) {
                const errorMessage = error.name === 'AbortError' 
                    ? 'Connection timeout - Server may be busy' 
                    : 'Unable to check status - Server may be down';
                    
                statusDiv.innerHTML = `
                    <div class="flex items-center space-x-4 bg-red-50 p-3 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-red-500"></i>
                        <span class="text-red-700">${errorMessage}</span>
                        <button onclick="refreshWhatsAppStatus()" class="ml-auto px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                            Retry
                        </button>
                    </div>
                `;
            }
        }
    }

    async function pollForQRCode(sessionName) {
        // Waha Core only supports 'default' session
        if (!sessionName) {
            sessionName = 'default';
        }

        try {
            // Get QR code image from Waha
            const qrDisplay = document.getElementById('qrCodeDisplay');
            if (!qrDisplay) return;

            qrDisplay.innerHTML = '<div class="loading-spinner mx-auto mb-4"></div><p class="text-gray-500">Loading QR code from Waha...</p>';

            const response = await fetch(`/api/waha/session/${sessionName}/qr`);
            
            if (response.ok && response.headers.get('content-type')?.includes('image')) {
                // QR code image received
                const blob = await response.blob();
                const qrUrl = URL.createObjectURL(blob);
                
                qrDisplay.innerHTML = `
                    <img src="${qrUrl}" alt="QR Code" class="mx-auto border-4 border-gray-200 rounded-lg" style="max-width: 300px;" />
                    <p class="text-gray-600 mt-4 font-semibold">📱 Scan with WhatsApp</p>
                    <p class="text-sm text-gray-500 mt-2">WhatsApp → Settings → Linked Devices → Link a Device</p>
                    <p class="text-xs text-gray-400 mt-3">QR code refreshes automatically</p>
                `;
                
                // Auto-refresh QR after 30 seconds
                setTimeout(() => pollForQRCode(sessionName), 30000);
            } else {
                const result = await response.json();
                qrDisplay.innerHTML = `<p class="text-gray-500">${result.error || 'Waiting for QR code...'}</p>`;
                // Retry after 3 seconds
                setTimeout(() => pollForQRCode(sessionName), 3000);
            }
        } catch (error) {
            console.error('QR poll error:', error);
            const qrDisplay = document.getElementById('qrCodeDisplay');
            if (qrDisplay) {
                qrDisplay.innerHTML = '<p class="text-red-500">Error loading QR code. Retrying...</p>';
                setTimeout(() => pollForQRCode(sessionName), 5000);
            }
        }
    }

    async function loadBroadcastHistory() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;
        
        try {
            const response = await fetch(`/api/broadcast/history/${tenantId}`);
            const result = await response.json();
            
            if (result.success && result.broadcasts && result.broadcasts.length > 0) {
                window.allBroadcasts = result.broadcasts; // Store for filtering
                renderBroadcastList(result.broadcasts);
            } else {
                window.allBroadcasts = [];
                document.getElementById('broadcastHistory').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                        <p>No broadcasts sent yet</p>
                    </div>
                `;
            }
        } catch (err) {
            console.error('Error loading broadcast history:', err);
            window.allBroadcasts = [];
            document.getElementById('broadcastHistory').innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                    <p>Failed to load broadcast history</p>
                </div>
            `;
        }
    }

    // NEW PHASE 2 FEATURES

    // Filter broadcasts
    window.allBroadcasts = []; // Store all broadcasts for filtering
    
    async function filterBroadcasts() {
        const searchTerm = document.getElementById('campaignSearch')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('statusFilter')?.value || '';
        
        let filtered = window.allBroadcasts;
        
        if (searchTerm) {
            filtered = filtered.filter(b => 
                b.campaign_name.toLowerCase().includes(searchTerm)
            );
        }
        
        if (statusFilter) {
            filtered = filtered.filter(b => b.status === statusFilter);
        }
        
        // Render filtered results (reuse the rendering logic from loadBroadcastHistory)
        if (filtered.length === 0) {
            document.getElementById('broadcastHistory').innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-search text-4xl mb-3 opacity-50"></i>
                    <p>No broadcasts match your filters</p>
                </div>
            `;
            return;
        }
        
        // Reuse rendering logic from loadBroadcastHistory
        renderBroadcastList(filtered);
    }
    
    function clearFilters() {
        document.getElementById('campaignSearch').value = '';
        document.getElementById('statusFilter').value = '';
        renderBroadcastList(window.allBroadcasts);
    }
    
    function renderBroadcastList(broadcasts) {
        const historyHtml = broadcasts.map(broadcast => {
            const sentAt = new Date(broadcast.sent_at || broadcast.created_at).toLocaleString();
            const isProcessing = broadcast.status === 'processing';
            const successRate = broadcast.recipient_count > 0 
                ? ((broadcast.success_count / broadcast.recipient_count) * 100).toFixed(0)
                : 0;
            
            let progressBar = '';
            if (isProcessing && broadcast.recipient_count > 0) {
                const progress = ((broadcast.success_count + broadcast.fail_count) / broadcast.recipient_count * 100).toFixed(0);
                progressBar = `
                    <div class="mt-3 mb-2">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Processing...</span>
                            <span>${broadcast.success_count + broadcast.fail_count}/${broadcast.recipient_count}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300 animate-pulse" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-gray-900">${escapeHtml(broadcast.campaign_name)}</h4>
                            <p class="text-xs text-gray-500 mt-1">${sentAt}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${
                            broadcast.status === 'completed' ? 'bg-green-100 text-green-800' :
                            broadcast.status === 'processing' ? 'bg-blue-100 text-blue-800 animate-pulse' :
                            broadcast.status === 'scheduled' ? 'bg-purple-100 text-purple-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${isProcessing ? '⏳ Processing' : broadcast.status}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3 line-clamp-2">${escapeHtml(broadcast.message_content)}</p>
                    ${progressBar}
                    <div class="flex gap-4 text-sm">
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-paper-plane mr-1 text-xs"></i>
                            <span>${broadcast.success_count || 0} sent</span>
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-users mr-1 text-xs"></i>
                            <span>${broadcast.recipient_count || 0} total</span>
                        </div>
                        ${!isProcessing ? `
                        <div class="flex items-center ${
                            successRate >= 90 ? 'text-green-600' :
                            successRate >= 70 ? 'text-yellow-600' :
                            'text-red-600'
                        }">
                            <i class="fas fa-chart-pie mr-1 text-xs"></i>
                            <span>${successRate}% success</span>
                        </div>
                        ` : ''}
                    </div>
                    ${broadcast.campaign_id ? `
                    <div class="flex gap-2 mt-3">
                        <button onclick="viewCampaignReport('${broadcast.campaign_id}')" 
                            class="flex-1 px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-xs font-semibold">
                            <i class="fas fa-chart-bar mr-1"></i> View Details
                        </button>
                        <button onclick="exportCampaignReport('${broadcast.campaign_id}', '${escapeHtml(broadcast.campaign_name)}')" 
                            class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-xs font-semibold">
                            <i class="fas fa-download mr-1"></i> Export CSV
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
        }).join('');
        
        document.getElementById('broadcastHistory').innerHTML = historyHtml;
    }
    
    // View campaign report (per-contact delivery details)
    async function viewCampaignReport(campaignId) {
        try {
            const response = await fetch(`/api/broadcast/campaign-report/${campaignId}`);
            const result = await response.json();
            
            if (!result.success) {
                showNotification('Failed to load campaign report', 'error');
                return;
            }
            
            const { campaign, recipients, stats } = result;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">${escapeHtml(campaign.name)}</h2>
                                <p class="text-sm opacity-90">Campaign Delivery Report</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white/20 rounded-lg p-2">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-4 gap-4 mt-4">
                            <div class="bg-white/10 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.total}</p>
                                <p class="text-xs opacity-90">Total</p>
                            </div>
                            <div class="bg-green-500/30 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.sent}</p>
                                <p class="text-xs opacity-90">Sent</p>
                            </div>
                            <div class="bg-red-500/30 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.failed}</p>
                                <p class="text-xs opacity-90">Failed</p>
                            </div>
                            <div class="bg-yellow-500/30 rounded-lg p-3 text-center">
                                <p class="text-2xl font-bold">${stats.pending}</p>
                                <p class="text-xs opacity-90">Pending</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 250px);">
                        <table class="w-full">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Phone Number</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Sent At</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Error</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${recipients.map(r => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 text-sm font-mono">${r.phone}</td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                                r.status === 'sent' ? 'bg-green-100 text-green-800' :
                                                r.status === 'failed' ? 'bg-red-100 text-red-800' :
                                                'bg-yellow-100 text-yellow-800'
                                            }">
                                                ${r.status}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-xs text-gray-600">
                                            ${r.sent_at ? new Date(r.sent_at).toLocaleString() : '-'}
                                        </td>
                                        <td class="px-4 py-3 text-xs text-red-600">
                                            ${r.error_message || '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } catch (err) {
            console.error('Error viewing campaign report:', err);
            showNotification('Failed to load report', 'error');
        }
    }
    
    // Export campaign report as CSV
    function exportCampaignReport(campaignId, campaignName) {
        const url = `/api/broadcast/campaign-report/${campaignId}/export`;
        window.location.href = url;
        showNotification('Downloading report...', 'success');
    }
    
    // Load message templates
    async function loadMessageTemplates() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;
        
        try {
            const response = await fetch(`/api/broadcast/templates/${tenantId}`);
            const result = await response.json();
            
            if (!result.success || !result.templates || result.templates.length === 0) {
                showNotification('No templates saved yet', 'info');
                return;
            }
            
            // Show template selector modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold">Load Message Template</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-white hover:bg-white/20 rounded-lg p-2">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto" style="max-height: calc(80vh - 100px);">
                        <div class="space-y-3">
                            ${result.templates.map(template => `
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition"
                                     onclick="useTemplate('${template.id}', ${JSON.stringify(escapeHtml(template.message_text)).replace(/'/g, "\\'")} , '${template.image_url || ''}', '${template.message_type}')">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="font-semibold text-gray-900">${escapeHtml(template.template_name)}</h3>
                                        <span class="text-xs text-gray-500">Used ${template.usage_count || 0}x</span>
                                    </div>
                                    <p class="text-sm text-gray-600 line-clamp-3">${escapeHtml(template.message_text)}</p>
                                    ${template.image_url ? `
                                        <div class="mt-2">
                                            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">
                                                <i class="fas fa-image mr-1"></i> Has Image
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        } catch (err) {
            console.error('Error loading templates:', err);
            showNotification('Failed to load templates', 'error');
        }
    }
    
    // Use template
    async function useTemplate(templateId, messageText, imageUrl, messageType) {
        document.getElementById('broadcastMessage').value = messageText;
        
        if (messageType === 'image' && imageUrl) {
            document.querySelector('input[name="messageType"][value="image"]').checked = true;
            toggleMessageType();
            // Note: Can't set base64 image from URL easily, user will need to re-upload
        }
        
        // Increment usage count
        await fetch(`/api/broadcast/templates/${templateId}/use`, { method: 'PUT' });
        
        // Close modal
        document.querySelector('.fixed.inset-0').remove();
        showNotification('Template loaded!', 'success');
    }
    
    // Save as template
    async function saveAsTemplate() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;
        
        const messageText = document.getElementById('broadcastMessage').value.trim();
        if (!messageText) {
            showNotification('Please enter a message first', 'error');
            return;
        }
        
        const templateName = prompt('Enter a name for this template:');
        if (!templateName) return;
        
        const messageType = document.querySelector('input[name="messageType"]:checked').value;
        
        try {
            const response = await fetch('/api/broadcast/templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tenantId,
                    templateName,
                    messageText,
                    messageType,
                    imageUrl: uploadedImageBase64
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Template saved successfully!', 'success');
            } else {
                showNotification(result.error || 'Failed to save template', 'error');
            }
        } catch (err) {
            console.error('Error saving template:', err);
            showNotification('Failed to save template', 'error');
        }
    }

    // Broadcast helper functions
    let uploadedRecipients = [];
    let uploadedImageBase64 = null;

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                // Extract phone numbers from multiple possible columns
                // Google Contacts format: "Phone 1 - Value", "Phone 2 - Value", etc.
                // Also supports: phone, number, mobile, whatsapp, cell, telephone
                const phoneColumns = [
                    'phone', 'number', 'mobile', 'whatsapp', 'cell', 'telephone',
                    'Phone', 'Number', 'Mobile', 'WhatsApp', 'Cell', 'Telephone',
                    'Phone 1 - Value', 'Phone 2 - Value', 'Phone 3 - Value',
                    'phone 1 - value', 'phone 2 - value', 'phone 3 - value'
                ];
                
                const phones = [];
                jsonData.forEach(row => {
                    // Try all possible column names
                    for (const col of phoneColumns) {
                        if (row[col]) {
                            const cleaned = String(row[col]).replace(/\D/g, '');
                            if (cleaned && cleaned.length >= 10) {
                                phones.push(cleaned);
                            }
                        }
                    }
                    
                    // Also check all columns that contain "phone" or "mobile" in the name
                    Object.keys(row).forEach(key => {
                        if ((key.toLowerCase().includes('phone') || key.toLowerCase().includes('mobile')) && row[key]) {
                            const cleaned = String(row[key]).replace(/\D/g, '');
                            if (cleaned && cleaned.length >= 10 && !phones.includes(cleaned)) {
                                phones.push(cleaned);
                            }
                        }
                    });
                });
                
                // Remove duplicates
                uploadedRecipients = [...new Set(phones)];

                if (uploadedRecipients.length === 0) {
                    showNotification('❌ No valid phone numbers found. Make sure the file has phone numbers in any column.', 'error');

                    return;
                }

                // Show summary
                document.getElementById('fileInfo').textContent = `✓ ${uploadedRecipients.length} recipients loaded`;
                document.getElementById('fileInfo').classList.remove('hidden');
                
                // Show numbers list
                const recipientsList = document.getElementById('recipientsList');
                const recipientsNumbers = document.getElementById('recipientsNumbers');
                recipientsNumbers.innerHTML = uploadedRecipients.map((phone, idx) => 
                    `<div class="flex items-center gap-2">
                        <span class="text-gray-400">${idx + 1}.</span>
                        <span class="font-mono">+${phone}</span>
                    </div>`
                ).join('');
                recipientsList.classList.remove('hidden');
                
                showNotification(`✅ Successfully loaded ${uploadedRecipients.length} phone numbers!`, 'success');
            } catch (err) {
                console.error('File read error:', err);
                showNotification('❌ Error reading file. Supported formats: CSV, Excel (.xlsx, .xls)', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function clearRecipients() {
        uploadedRecipients = [];
        document.getElementById('recipientsFile').value = '';
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('recipientsList').classList.add('hidden');
        showNotification('Recipients cleared', 'info');
    }

    // Contact Groups Functions
    let contactGroups = [];

    function switchRecipientMode(mode) {
        const uploadBtn = document.getElementById('recipientModeUpload');
        const pasteBtn = document.getElementById('recipientModePaste');
        const groupsBtn = document.getElementById('recipientModeGroups');
        const uploadMode = document.getElementById('uploadMode');
        const pasteMode = document.getElementById('pasteMode');
        const groupsMode = document.getElementById('groupsMode');

        // Reset all buttons with mobile-responsive classes
        const inactiveClass = 'px-2 py-3 rounded-lg border-2 border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-xs md:text-sm hover:shadow-md transition';
        const activeClass = 'px-2 py-3 rounded-lg border-2 border-indigo-500 bg-indigo-50 text-indigo-700 font-semibold text-xs md:text-sm hover:shadow-md transition';

        uploadBtn.className = inactiveClass;
        pasteBtn.className = inactiveClass;
        groupsBtn.className = inactiveClass;

        uploadMode.classList.add('hidden');
        pasteMode.classList.add('hidden');
        groupsMode.classList.add('hidden');

        if (mode === 'upload') {
            uploadBtn.className = activeClass;
            uploadMode.classList.remove('hidden');
        } else if (mode === 'paste') {
            pasteBtn.className = activeClass;
            pasteMode.classList.remove('hidden');
        } else {
            groupsBtn.className = activeClass;
            groupsMode.classList.remove('hidden');
            loadContactGroups();
        }
    }

    // iPhone Contact Paste Functions
    function handleContactPaste() {
        const textarea = document.getElementById('pasteContacts');
        const text = textarea.value;

        if (!text.trim()) {
            return; // Silently return if empty
        }

        // Extract phone numbers using multiple patterns
        // Matches international numbers like +1234567890, (123) 456-7890, 123-456-7890, etc.
        const phoneRegex = /[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,5}[-\s\.]?[0-9]{1,5}/g;
        const matches = text.match(phoneRegex) || [];
        
        // Clean and deduplicate
        const phones = [...new Set(matches.map(phone => 
            phone.replace(/[\s\-\(\)\.]/g, '').replace(/^[+]/, '')
        ))].filter(phone => phone.length >= 10 && phone.length <= 15);

        if (phones.length === 0) {
            showNotification('No valid phone numbers found. Try pasting from WhatsApp or your contact list.', 'error');
            return;
        }

        // Replace uploadedRecipients instead of appending
        uploadedRecipients = phones;

        // Display extracted numbers with better formatting
        const list = document.getElementById('pasteRecipientsList');
        const numbersDiv = document.getElementById('pasteRecipientsNumbers');
        const countBadge = document.getElementById('pasteCountBadge');
        
        countBadge.textContent = `${phones.length} contact${phones.length > 1 ? 's' : ''} ready to broadcast`;
        
        numbersDiv.innerHTML = uploadedRecipients.map((phone, idx) => 
            `<div class="flex items-center gap-2 py-1 hover:bg-gray-50 px-2 rounded">
                <span class="text-green-500"><i class="fas fa-check-circle"></i></span>
                <span class="text-gray-400 text-xs">${idx + 1}.</span>
                <span class="font-mono text-gray-800">+${phone}</span>
            </div>`
        ).join('');
        
        list.classList.remove('hidden');
        showNotification(`✅ Found ${phones.length} phone number${phones.length > 1 ? 's' : ''}!`, 'success');
    }

    function clearPastedRecipients() {
        uploadedRecipients = [];
        document.getElementById('pasteContacts').value = '';
        document.getElementById('pasteRecipientsList').classList.add('hidden');
        showNotification('Cleared all contacts', 'info');
    }

    async function loadContactGroups() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        try {
            const response = await fetch(`/api/broadcast/groups/${tenantId}`);
            const result = await response.json();

            if (result.success) {
                contactGroups = result.groups || [];
                renderContactGroups();
            }
        } catch (error) {
            console.error('Error loading contact groups:', error);
            showNotification('Error loading contact groups', 'error');
        }
    }

    function renderContactGroups() {
        const container = document.getElementById('contactGroupsList');
        
        if (contactGroups.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-users text-gray-300 text-4xl mb-3"></i>
                    <p class="text-gray-500">No saved groups yet</p>
                    <p class="text-xs text-gray-400 mt-2">Upload contacts and save them as a group for quick reuse</p>
                </div>
            `;
            return;
        }

        container.innerHTML = contactGroups.map(group => `
            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                <div class="flex items-center justify-between">
                    <label class="flex items-center cursor-pointer flex-1">
                        <input type="checkbox" onchange="toggleGroupSelection('${group.id}')" 
                            class="w-5 h-5 text-indigo-600 rounded mr-3">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${escapeHtml(group.group_name)}</p>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-users mr-1"></i>${group.contact_count} contacts
                                <span class="mx-2">•</span>
                                <i class="fas fa-clock mr-1"></i>${new Date(group.created_at).toLocaleDateString()}
                            </p>
                        </div>
                    </label>
                    <button type="button" onclick="deleteGroup('${group.id}')" 
                        class="ml-2 text-red-500 hover:text-red-700 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function toggleGroupSelection(groupId) {
        const group = contactGroups.find(g => g.id === groupId);
        if (!group) return;

        const checkbox = event.target;
        
        if (checkbox.checked) {
            // Add contacts from this group
            const newContacts = group.contacts.filter(c => !uploadedRecipients.includes(c));
            uploadedRecipients.push(...newContacts);
            showNotification(`Added ${group.contact_count} contacts from ${group.group_name}`, 'success');
        } else {
            // Remove contacts from this group
            uploadedRecipients = uploadedRecipients.filter(c => !group.contacts.includes(c));
            showNotification(`Removed ${group.group_name} contacts`, 'info');
        }
    }

    function showSaveGroupDialog() {
        if (uploadedRecipients.length === 0) {
            showNotification('No recipients loaded to save', 'error');
            return;
        }

        const groupName = prompt(`Save ${uploadedRecipients.length} contacts as a group\n\nEnter group name (e.g., "iPhone Contacts", "Sales Team"):`);
        if (!groupName || !groupName.trim()) return;

        saveContactGroup(groupName.trim());
    }

    async function saveContactGroup(groupName) {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return;

        try {
            const response = await fetch('/api/broadcast/groups/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tenantId,
                    groupName,
                    contacts: uploadedRecipients
                })
            });

            const result = await response.json();
            
            if (result.success) {
                showNotification(`✅ Group "${groupName}" saved with ${uploadedRecipients.length} contacts`, 'success');
                loadContactGroups(); // Refresh the list
            } else {
                showNotification(result.error || 'Failed to save group', 'error');
            }
        } catch (error) {
            console.error('Error saving group:', error);
            showNotification('Error saving contact group', 'error');
        }
    }

    async function deleteGroup(groupId) {
        if (!confirm('Are you sure you want to delete this contact group?')) return;

        try {
            const response = await fetch(`/api/broadcast/groups/${groupId}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            
            if (result.success) {
                showNotification('Group deleted successfully', 'success');
                loadContactGroups(); // Refresh the list
            } else {
                showNotification('Failed to delete group', 'error');
            }
        } catch (error) {
            console.error('Error deleting group:', error);
            showNotification('Error deleting group', 'error');
        }
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showNotification('❌ Image too large! Please use an image under 5MB', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedImageBase64 = e.target.result;
            document.getElementById('previewImg').src = uploadedImageBase64;
            document.getElementById('imagePreview').classList.remove('hidden');
            showNotification('✅ Image uploaded successfully!', 'success');
        };
        reader.readAsDataURL(file);
    }

    function removeImage() {
        uploadedImageBase64 = null;
        document.getElementById('broadcastImage').value = '';
        document.getElementById('imagePreview').classList.add('hidden');
        showNotification('Image removed', 'info');
    }

    function toggleMessageType() {
        const messageType = document.querySelector('input[name="messageType"]:checked').value;
        const imageSection = document.getElementById('imageUploadSection');
        const messageLabel = document.getElementById('messageLabel');
        
        if (messageType === 'image') {
            imageSection.classList.remove('hidden');
            messageLabel.textContent = 'Caption';
        } else {
            imageSection.classList.add('hidden');
            messageLabel.textContent = 'Text';
            uploadedImageBase64 = null;
        }
    }

    function toggleSchedule() {
        const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
        const scheduleTimeInput = document.getElementById('scheduleTime');
        const submitButtonText = document.getElementById('submitButtonText');
        
        if (scheduleType === 'later') {
            scheduleTimeInput.classList.remove('hidden');
            submitButtonText.textContent = 'Schedule Broadcast';
        } else {
            scheduleTimeInput.classList.add('hidden');
            submitButtonText.textContent = 'Send Broadcast Now';
        }
    }

    async function handleBroadcastSubmit(e) {
        e.preventDefault();
        
        const tenantId = state.session?.tenantId;
        if (!tenantId) {
            showNotification('Session expired. Please refresh.', 'error');
            return;
        }

        if (uploadedRecipients.length === 0) {
            showNotification('Please upload a recipients Excel file', 'error');
            return;
        }

        // Check WhatsApp Web status before sending
        const waWebStatus = await checkWhatsAppWebStatus();
        if (!waWebStatus.connected) {
            const proceed = confirm('⚠️ WhatsApp Web is disconnected. Broadcasts will use Maytapi (Paid) as fallback.\n\nDo you want to continue?');
            if (!proceed) {
                return;
            }
        }

        const campaignName = document.getElementById('campaignName').value;
        const message = document.getElementById('broadcastMessage').value;
        const messageType = document.querySelector('input[name="messageType"]:checked').value;
        const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
        const scheduleTime = document.getElementById('scheduleTime').value;
        
        // Get batch settings
        const batchSize = parseInt(document.getElementById('batchSize').value) || 10;
        const messageDelay = parseInt(document.getElementById('messageDelay').value) || 500;
        const batchDelay = parseInt(document.getElementById('batchDelay').value) || 2000;

        if (messageType === 'image' && !uploadedImageBase64) {
            showNotification('Please upload an image', 'error');
            return;
        }

        // Get bot delivery method from saved features
        const savedFeatures = JSON.parse(localStorage.getItem(`tenant_features_${tenantId}`)) || {};
        const botDeliveryMethod = savedFeatures.bot_delivery_method || 'desktop';

        const payload = {
            tenantId,
            campaignName,
            message,
            recipients: uploadedRecipients,
            messageType,
            scheduleType,
            scheduleTime: scheduleType === 'later' ? scheduleTime : null,
            imageBase64: messageType === 'image' ? uploadedImageBase64 : null,
            batchSize,
            messageDelay,
            batchDelay,
            botDeliveryMethod: botDeliveryMethod
        };

        // Show loading state
        const submitButton = document.querySelector('#broadcastForm button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

        try {
            let response, result;
            
            // PRIORITY 1: If desktop agent is online, send DIRECTLY to it (bypassing server)
            if (waWebStatus.connected && waWebStatus.method === 'desktop_agent') {
                console.log('[BROADCAST] 🚀 Sending via DESKTOP AGENT (FREE!)');
                
                try {
                    response = await fetch('http://localhost:3001/broadcast', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            phoneNumbers: uploadedRecipients,
                            message: message,
                            messageType: messageType,
                            imageBase64: messageType === 'image' ? uploadedImageBase64 : null,
                            batchSize: batchSize,
                            messageDelay: messageDelay,
                            batchDelay: batchDelay
                        })
                    });
                    
                    const agentResult = await response.json();
                    
                    if (agentResult.ok) {
                        result = {
                            success: true,
                            details: {
                                total: agentResult.totalRecipients || uploadedRecipients.length,
                                sent: agentResult.totalSent,
                                failed: agentResult.totalFailed
                            },
                            method: 'desktop_agent'
                        };
                    } else {
                        throw new Error(agentResult.error || 'Desktop agent failed');
                    }
                } catch (agentError) {
                    console.warn('[BROADCAST] Desktop agent failed, falling back to server/Maytapi:', agentError.message);
                    // Fall through to server method below
                    response = await fetch('/api/broadcast/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    result = await response.json();
                }
            } else {
                // PRIORITY 2: Use server (which will use Maytapi)
                console.log('[BROADCAST] Using server/Maytapi (PAID)');
                response = await fetch('/api/broadcast/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                result = await response.json();
            }
            
            if (result.success) {
                if (scheduleType === 'later') {
                    showNotification(`Broadcast scheduled successfully!`, 'success');
                } else {
                    // Show success message for background processing
                    showNotification(`✅ Broadcast started! Processing ${result.details.total} recipients in background.`, 'success');
                }
                
                // Reset form
                document.getElementById('broadcastForm').reset();
                clearRecipients();
                uploadedImageBase64 = null;
                document.getElementById('imagePreview').classList.add('hidden');
                
                // Reload history immediately and set up auto-refresh
                loadBroadcastHistory();
                
                // Auto-refresh history every 5 seconds for next 2 minutes to show progress
                let refreshCount = 0;
                const maxRefreshes = 24; // 2 minutes
                const refreshInterval = setInterval(() => {
                    refreshCount++;
                    loadBroadcastHistory();
                    if (refreshCount >= maxRefreshes) {
                        clearInterval(refreshInterval);
                    }
                }, 5000);
            } else {
                showNotification(result.error || 'Failed to send broadcast', 'error');
            }
        } catch (err) {
            console.error('Broadcast error:', err);
            showNotification('Error sending broadcast', 'error');
        } finally {
            // Restore button
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    }

    function showBroadcastReport(details) {
        const successRate = details.total > 0 ? ((details.success / details.total) * 100).toFixed(1) : 0;
        
        let errorHtml = '';
        if (details.errors && details.errors.length > 0) {
            errorHtml = `
                <div class="mt-4 p-4 bg-red-50 rounded-lg border border-red-200">
                    <h4 class="font-semibold text-red-900 mb-2">Failed Numbers:</h4>
                    <div class="space-y-1 text-sm text-red-700 max-h-40 overflow-y-auto">
                        ${details.errors.map(err => `
                            <div class="flex justify-between">
                                <span class="font-mono">+${err.recipient}</span>
                                <span class="text-xs">${err.error}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-8">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                            <i class="fas fa-check-circle text-3xl text-green-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Broadcast Complete!</h2>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-600">${details.total}</div>
                            <div class="text-sm text-gray-600 mt-1">Total</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-600">${details.success}</div>
                            <div class="text-sm text-gray-600 mt-1">Sent</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-red-600">${details.failed}</div>
                            <div class="text-sm text-gray-600 mt-1">Failed</div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Success Rate</span>
                            <span class="font-semibold">${successRate}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-500" 
                                style="width: ${successRate}%"></div>
                        </div>
                    </div>

                    ${errorHtml}

                    <div class="mt-6 flex gap-3">
                        <button onclick="this.closest('.fixed').remove()" 
                            class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition">
                            Done
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close on outside click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function showBroadcastHelp() {
        showNotification('Send broadcast commands directly to your WhatsApp bot number. The bot will process them automatically!', 'info');
    }

    // ---------- Follow-ups Functions ----------
    async function loadFollowUps() {
        const statusFilter = document.getElementById('followupStatusFilter')?.value || '';
        const customerFilter = document.getElementById('followupCustomerFilter')?.value || '';

        try {
            // Fetch follow-ups
            const params = new URLSearchParams();
            if (statusFilter) params.append('status', statusFilter);
            if (customerFilter) params.append('customer_phone', customerFilter);
            params.append('limit', '200');

            const url = `/api/followups/${state.session.tenantId}?${params.toString()}`;
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const data = await response.json();

            if (!data.success) throw new Error(data.error || 'Failed to load follow-ups');

            const followups = data.followups || [];
            
            // Fetch stats
            const statsResponse = await fetch(`/api/followups/${state.session.tenantId}/stats`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const statsData = await statsResponse.json();
            const stats = statsData.stats || {};

            // Fetch AI suggestions
            const suggestionsResponse = await fetch(`/api/followups/${state.session.tenantId}/suggestions`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const suggestionsData = await suggestionsResponse.json();
            const suggestions = suggestionsData.suggestions || [];

            document.getElementById('tabContent').innerHTML = `
                <div class="mb-6">
                    <h2 class="text-white text-2xl font-bold mb-4"><i class="fas fa-clock mr-3"></i>Follow-ups Management</h2>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-white/60 text-sm mb-1">Total</div>
                            <div class="text-3xl font-bold text-white">${stats.total || 0}</div>
                        </div>
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-blue-300 text-sm mb-1">Scheduled</div>
                            <div class="text-3xl font-bold text-blue-400">${stats.scheduled || 0}</div>
                        </div>
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-green-300 text-sm mb-1">Completed</div>
                            <div class="text-3xl font-bold text-green-400">${stats.completed || 0}</div>
                        </div>
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-red-300 text-sm mb-1">Failed</div>
                            <div class="text-3xl font-bold text-red-400">${stats.failed || 0}</div>
                        </div>
                        <div class="config-card p-6 rounded-xl">
                            <div class="text-yellow-300 text-sm mb-1">Next 24h</div>
                            <div class="text-3xl font-bold text-yellow-400">${stats.upcoming24h || 0}</div>
                        </div>
                    </div>

                    <!-- Create Follow-up Button -->
                    <div class="mb-6 flex gap-3">
                        <button onclick="showCreateFollowupModal()" class="glass-effect px-6 py-3 rounded-xl text-white hover:bg-white/20 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create Follow-up
                        </button>
                        <button onclick="triggerIntelligentFollowUps()" class="glass-effect px-6 py-3 rounded-xl text-blue-300 hover:bg-blue-500/20 transition-colors">
                            <i class="fas fa-magic mr-2"></i>Analyze & Create Smart Follow-ups
                        </button>
                    </div>

                    <!-- AI Suggestions -->
                    ${suggestions.length > 0 ? `
                        <div class="config-card p-6 rounded-xl mb-6">
                            <h3 class="text-white text-lg font-bold mb-4">
                                <i class="fas fa-lightbulb mr-2 text-yellow-400"></i>AI Suggestions
                            </h3>
                            <div class="space-y-3">
                                ${suggestions.map(s => `
                                    <div class="bg-white/5 p-4 rounded-lg flex items-center justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-white font-medium">${s.customer_name || s.customer_phone}</span>
                                                <span class="px-2 py-1 rounded text-xs ${
                                                    s.priority === 'high' ? 'bg-red-500/20 text-red-300' :
                                                    s.priority === 'medium' ? 'bg-yellow-500/20 text-yellow-300' :
                                                    'bg-blue-500/20 text-blue-300'
                                                }">${s.priority.toUpperCase()}</span>
                                                <span class="text-white/50 text-sm">${s.type.replace('_', ' ')}</span>
                                            </div>
                                            <div class="text-white/70 text-sm">${s.reason}</div>
                                            <div class="text-white/50 text-xs mt-1">${new Date(s.suggested_time).toLocaleString()}</div>
                                        </div>
                                        <button onclick='createFollowupFromSuggestion(${JSON.stringify(s)})' class="glass-effect px-4 py-2 rounded-lg text-white text-sm hover:bg-white/20">
                                            <i class="fas fa-plus mr-1"></i>Create
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Filters -->
                    <div class="config-card p-4 rounded-xl mb-6">
                        <div class="flex flex-wrap gap-4">
                            <select id="followupStatusFilter" class="search-input px-4 py-2 rounded-xl text-sm" onchange="loadFollowUps()">
                                <option value="">All Statuses</option>
                                <option value="scheduled" ${statusFilter==='scheduled'?'selected':''}>Scheduled</option>
                                <option value="completed" ${statusFilter==='completed'?'selected':''}>Completed</option>
                                <option value="failed" ${statusFilter==='failed'?'selected':''}>Failed</option>
                                <option value="cancelled" ${statusFilter==='cancelled'?'selected':''}>Cancelled</option>
                            </select>
                            <input type="text" id="followupCustomerFilter" placeholder="Search by customer phone" 
                                class="search-input px-4 py-2 rounded-xl text-sm flex-1" value="${customerFilter}"
                                onkeyup="if(event.key==='Enter') loadFollowUps()">
                            <button onclick="loadFollowUps()" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Follow-ups List -->
                    <div class="space-y-4">
                        ${followups.length === 0 ? `
                            <div class="config-card p-12 rounded-xl text-center">
                                <i class="fas fa-clock text-white/30 text-5xl mb-4"></i>
                                <p class="text-white/70 text-lg">No follow-ups found</p>
                                <p class="text-white/50 text-sm mt-2">Create your first follow-up or let customers request them</p>
                            </div>
                        ` : followups.map(f => {
                            const scheduledTime = new Date(f.scheduled_time);
                            const isPast = scheduledTime < new Date();
                            const isUpcoming = !isPast && (scheduledTime - new Date()) < 24 * 60 * 60 * 1000;
                            
                            return `
                                <div class="config-card p-6 rounded-xl">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <span class="px-3 py-1 rounded-lg text-sm font-medium ${
                                                    f.status === 'scheduled' ? 'bg-blue-500/20 text-blue-300' :
                                                    f.status === 'completed' ? 'bg-green-500/20 text-green-300' :
                                                    f.status === 'failed' ? 'bg-red-500/20 text-red-300' :
                                                    'bg-gray-500/20 text-gray-300'
                                                }">${f.status.toUpperCase()}</span>
                                                ${isUpcoming && f.status === 'scheduled' ? '<span class="px-3 py-1 rounded-lg text-sm font-medium bg-yellow-500/20 text-yellow-300">UPCOMING</span>' : ''}
                                            </div>
                                            <div class="text-white font-medium text-lg mb-2">
                                                ${f.customer?.business_name || f.customer?.name || f.end_user_phone}
                                            </div>
                                            <div class="text-white/70 mb-2">${f.description}</div>
                                            <div class="flex flex-wrap gap-4 text-sm text-white/50">
                                                <div><i class="fas fa-phone mr-1"></i>${f.end_user_phone}</div>
                                                <div><i class="fas fa-calendar mr-1"></i>${scheduledTime.toLocaleDateString()}</div>
                                                <div><i class="fas fa-clock mr-1"></i>${scheduledTime.toLocaleTimeString()}</div>
                                                <div><i class="fas fa-info-circle mr-1"></i>${f.original_request || 'Manual'}</div>
                                            </div>
                                            ${f.conversation_context?.note ? `
                                                <div class="mt-3 p-3 bg-white/5 rounded-lg text-white/70 text-sm">
                                                    <i class="fas fa-sticky-note mr-2"></i>${f.conversation_context.note}
                                                </div>
                                            ` : ''}
                                            ${f.error_message ? `
                                                <div class="mt-3 p-3 bg-red-500/10 rounded-lg text-red-300 text-sm">
                                                    <i class="fas fa-exclamation-circle mr-2"></i>${f.error_message}
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="flex gap-2 ml-4">
                                            ${f.status === 'scheduled' ? `
                                                <button onclick="sendFollowupNow('${f.id}')" class="glass-effect p-3 rounded-lg text-white hover:bg-white/20" title="Send now">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                                <button onclick="editFollowup('${f.id}')" class="glass-effect p-3 rounded-lg text-white hover:bg-white/20" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            ` : ''}
                                            <button onclick="deleteFollowup('${f.id}')" class="glass-effect p-3 rounded-lg text-red-300 hover:bg-red-500/20" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

        } catch (error) {
            console.error('[loadFollowUps] Error:', error);
            document.getElementById('tabContent').innerHTML = `
                <div class="config-card p-12 rounded-xl text-center">
                    <i class="fas fa-exclamation-circle text-red-400 text-5xl mb-4"></i>
                    <p class="text-white text-lg mb-2">Failed to load follow-ups</p>
                    <p class="text-white/50 text-sm">${error.message}</p>
                    <button onclick="loadFollowUps()" class="glass-effect px-6 py-3 rounded-xl text-white hover:bg-white/20 mt-4">
                        <i class="fas fa-redo mr-2"></i>Retry
                    </button>
                </div>
            `;
        }
    }

    function showCreateFollowupModal() {
        const modal = document.createElement('div');
        modal.id = 'createFollowupModal';
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full p-8">
                <h3 class="text-2xl font-bold text-white mb-6">Create Follow-up</h3>
                <form id="createFollowupForm" onsubmit="handleCreateFollowup(event)" class="space-y-4">
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Customer Phone</label>
                        <input type="text" id="newFollowupPhone" required 
                            class="w-full px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none"
                            placeholder="+919876543210">
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Scheduled Time</label>
                        <input type="datetime-local" id="newFollowupTime" required 
                            class="w-full px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Description</label>
                        <input type="text" id="newFollowupDescription" 
                            class="w-full px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none"
                            placeholder="Follow up on pending order">
                    </div>
                    <div>
                        <label class="block text-white/70 text-sm mb-2">Note (optional)</label>
                        <textarea id="newFollowupNote" rows="3" 
                            class="w-full px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 focus:border-blue-400 focus:outline-none"
                            placeholder="Additional notes..."></textarea>
                    </div>
                    <div class="flex gap-3 justify-end pt-4">
                        <button type="button" onclick="document.getElementById('createFollowupModal').remove()" 
                            class="px-6 py-3 rounded-xl bg-white/10 text-white hover:bg-white/20 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                            class="px-6 py-3 rounded-xl bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create Follow-up
                        </button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Set default time to 2 hours from now
        const defaultTime = new Date(Date.now() + 2 * 60 * 60 * 1000);
        document.getElementById('newFollowupTime').value = defaultTime.toISOString().slice(0, 16);
    }

    async function handleCreateFollowup(event) {
        event.preventDefault();
        
        const phone = document.getElementById('newFollowupPhone').value.trim();
        const time = document.getElementById('newFollowupTime').value;
        const description = document.getElementById('newFollowupDescription').value.trim();
        const note = document.getElementById('newFollowupNote').value.trim();

        try {
            const response = await fetch(`/api/followups/${state.session.tenantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({
                    customer_phone: phone,
                    scheduled_time: new Date(time).toISOString(),
                    description: description || 'Manual follow-up',
                    note: note,
                    created_by: 'admin'
                })
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            showNotification('Follow-up created successfully', 'success');
            document.getElementById('createFollowupModal').remove();
            loadFollowUps();

        } catch (error) {
            console.error('[handleCreateFollowup] Error:', error);
            showNotification('Failed to create follow-up: ' + error.message, 'error');
        }
    }

    function createFollowupFromSuggestion(suggestion) {
        showCreateFollowupModal();
        setTimeout(() => {
            document.getElementById('newFollowupPhone').value = suggestion.customer_phone;
            document.getElementById('newFollowupTime').value = new Date(suggestion.suggested_time).toISOString().slice(0, 16);
            document.getElementById('newFollowupDescription').value = suggestion.reason;
            document.getElementById('newFollowupNote').value = `AI Suggested (${suggestion.type}): ${suggestion.message_template || ''}`;
        }, 100);
    }

    async function sendFollowupNow(followupId) {
        if (!confirm('Send this follow-up immediately?')) return;
        
        try {
            const response = await fetch(`/api/followups/${state.session.tenantId}/${followupId}/send-now`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            showNotification('Follow-up sent successfully', 'success');
            loadFollowUps();

        } catch (error) {
            console.error('[sendFollowupNow] Error:', error);
            showNotification('Failed to send follow-up: ' + error.message, 'error');
        }
    }

    async function editFollowup(followupId) {
        // TODO: Implement edit modal
        showNotification('Edit feature coming soon', 'info');
    }

    async function deleteFollowup(followupId) {
        if (!confirm('Cancel/delete this follow-up?')) return;
        
        try {
            const response = await fetch(`/api/followups/${state.session.tenantId}/${followupId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            showNotification('Follow-up cancelled successfully', 'success');
            loadFollowUps();

        } catch (error) {
            console.error('[deleteFollowup] Error:', error);
            showNotification('Failed to cancel follow-up: ' + error.message, 'error');
        }
    }

    async function triggerIntelligentFollowUps() {
        if (!confirm('This will analyze all conversations and automatically create follow-ups for:\n\n• Abandoned carts\n• Price inquiries without orders\n• Leads based on temperature (Hot/Warm/Cold)\n\nContinue?')) {
            return;
        }

        showNotification('Analyzing conversations... This may take a minute.', 'info');

        try {
            const response = await fetch(`/api/followups/${state.session.tenantId}/trigger-intelligent`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            showNotification('Smart follow-ups created successfully! Refreshing...', 'success');
            setTimeout(() => loadFollowUps(), 2000);

        } catch (error) {
            console.error('[triggerIntelligentFollowUps] Error:', error);
            showNotification('Failed to create smart follow-ups: ' + error.message, 'error');
        }
    }

    // ---------- Modal & Action Functions ----------
    function editProduct(product) {
        try {
            const modal = document.getElementById('editProductModal');
            // Always refresh category dropdown before showing modal
            loadCategoriesDropdown().then(() => {
                document.getElementById('editProdId').value = product.id || '';
                document.getElementById('editProdName').value = product.name || '';
                document.getElementById('editProdPrice').value = product.price || '';
                document.getElementById('editProdStock').value = product.stockQuantity || product.stock_quantity || 0;
                document.getElementById('editProdBrand').value = product.brand || '';
                document.getElementById('editProdCategory').value = product.category || '';
                document.getElementById('editProdImageUrl').value = product.imageUrl || product.image_url || '';
                document.getElementById('editProdPackagingUnit').value = product.packagingUnit || product.packaging_unit || '';
                document.getElementById('editProdUnitsPerCarton').value = product.unitsPerCarton || product.units_per_carton || 1;
                modal.classList.remove('hidden');
            });
        } catch (err) {
            console.error('editProduct error', err);
            showNotification('Failed to open edit modal', 'error');
        }
    }

    async function saveProductEdits() {
        const tenantId = state.session?.tenantId;
        if (!tenantId) return showNotification('Session expired. Re-login required.', 'error');

        const productId = document.getElementById('editProdId').value;
        const payload = {
            name: document.getElementById('editProdName').value,
            price: parseFloat(document.getElementById('editProdPrice').value) || null,
            stock_quantity: parseInt(document.getElementById('editProdStock').value) || 0,
            brand: document.getElementById('editProdBrand').value || null,
            category: document.getElementById('editProdCategory').value || null,
            image_url: document.getElementById('editProdImageUrl').value || null,
            packaging_unit: document.getElementById('editProdPackagingUnit').value || null,
            units_per_carton: parseInt(document.getElementById('editProdUnitsPerCarton').value) || 1
        };

        try {
            const resp = await api.putJSON(`/api/dashboard/products/${tenantId}/${productId}`, payload);
            if (!resp || !resp.success) throw new Error(resp?.error || 'Failed to update product');
            showNotification('Product updated successfully', 'success');
            document.getElementById('editProductModal').classList.add('hidden');
            if (state.currentTab === 'products') loadProducts();
        } catch (err) {
            console.error('saveProductEdits error', err);
            showNotification('Failed to save product: ' + (err.message || err), 'error');
        }
    }

    async function deleteConversation(id) {
        if (!confirm('Are you sure you want to delete this conversation?')) return;
        try {
            const result = await api.deleteItem('conversations', id);
            if (result.success) {
                showNotification('Conversation deleted successfully', 'success');
                if (state.currentTab === 'conversations') loadConversations();
                await loadStats();
            } else throw new Error(result.error || 'Delete failed');
        } catch (error) {
            console.error('deleteConversation error', error);
            showNotification('Failed to delete conversation: ' + (error.message || error), 'error');
        }
    }

    async function deleteOrder(id) {
        if (!confirm('Are you sure you want to delete this order?')) return;
        try {
            const result = await api.deleteItem('orders', id);
            if (result.success) {
                showNotification('Order deleted successfully', 'success');
                if (state.currentTab === 'orders') loadOrders();
                await loadStats();
            } else throw new Error(result.error || 'Delete failed');
        } catch (error) {
            console.error('deleteOrder error', error);
            showNotification('Failed to delete order: ' + (error.message || error), 'error');
        }
    }

    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;
        try {
            const result = await api.deleteItem('products', id);
            if (result.success) {
                showNotification('Product deleted successfully', 'success');
                if (state.currentTab === 'products') loadProducts();
                await loadStats();
            } else throw new Error(result.error || 'Delete failed');
        } catch (error) {
            console.error('deleteProduct error', error);
            showNotification('Failed to delete product: ' + (error.message || error), 'error');
        }
    }

    function initCharts() {
        const salesCtx = document.getElementById('salesChart');
        if (salesCtx) {
            try {
                new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
                        datasets: [{
                            label: 'Sales (₹)',
                            data: [1200,1900,3000,5000,2000,3000,4500],
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive:true, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true } } }
                });
            } catch(e) { console.warn('sales chart init failed', e); }
        }

        const activityCtx = document.getElementById('activityChart');
        if (activityCtx) {
            try {
                new Chart(activityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Customer Messages','Bot Responses','Orders'],
                        datasets: [{ data:[45,35,20], backgroundColor:['rgba(34,197,94,0.8)','rgba(168,85,247,0.8)','rgba(249,115,22,0.8)'], borderWidth:0 }]
                    },
                    options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
                });
            } catch(e) { console.warn('activity chart init failed', e); }
        }
    }

    function handleSearch(e){
        state.searchQuery = e.target.value.trim().toLowerCase();
        if (state.currentTab === 'conversations') loadConversations();
    }

    function attachSettingsHandlers(){
        const shippingForm = document.getElementById('shippingForm');
        if (shippingForm) {
            shippingForm.onsubmit = async (ev) => {
                ev.preventDefault();
                const payload = {
                    free_shipping_threshold: Number(document.getElementById('freeShippingThreshold').value || 0),
                    standard_shipping_rate: Number(document.getElementById('standardShippingRate').value || 0),
                    bulk_shipping_rate: Number(document.getElementById('bulkShippingRate').value || 0),
                    bulk_threshold: Number(document.getElementById('bulkThreshold').value || 0)
                };
                try {
                    const resp = await api.updateSettings(payload);
                    if (resp.success) showNotification('Shipping settings updated', 'success');
                    else throw new Error(resp.error || 'Failed');
                } catch (err) { console.error(err); showNotification('Failed to update shipping settings', 'error'); }
            };
        }

        const gstForm = document.getElementById('gstForm');
        if (gstForm) {
            gstForm.onsubmit = async (ev) => {
                ev.preventDefault();
                const payload = { gst_rate: Number(document.getElementById('gstRate').value || 0), business_state: document.getElementById('businessState').value || null };
                try {
                    const resp = await api.updateSettings(payload);
                    if (resp.success) showNotification('GST settings updated', 'success');
                    else throw new Error(resp.error || 'Failed');
                } catch (err) { console.error(err); showNotification('Failed to update GST settings', 'error'); }
            };
        }

        const businessForm = document.getElementById('businessForm');
        if (businessForm) {
            businessForm.onsubmit = async (ev) => {
                ev.preventDefault();
                const payload = { business_name: document.getElementById('businessName').value || '', gstin: document.getElementById('gstin').value || '', business_address: document.getElementById('businessAddress').value || '' };
                try {
                    const resp = await api.updateSettings(payload);
                    if (resp.success) showNotification('Business info updated', 'success');
                    else throw new Error(resp.error || 'Failed');
                } catch (err) { console.error(err); showNotification('Failed to update business info', 'error'); }
            };
        }

        // Zoho Sync Handlers
        const syncProductsBtn = document.getElementById('syncProductsBtn');
        if (syncProductsBtn) {
            syncProductsBtn.onclick = async () => {
                const statusDiv = document.getElementById('syncStatus');
                const btn = syncProductsBtn;
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Syncing...';
                statusDiv.classList.remove('hidden', 'bg-green-50', 'bg-red-50');
                statusDiv.classList.add('bg-blue-50');
                statusDiv.querySelector('p').textContent = 'Syncing products from Zoho Books...';
                
                try {
                    const response = await fetch(`/api/dashboard/sync-products/${state.session.tenantId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        statusDiv.classList.remove('bg-blue-50');
                        statusDiv.classList.add('bg-green-50');
                        statusDiv.querySelector('p').textContent = '✓ Products synced successfully!';
                        statusDiv.querySelector('p').className = 'text-sm text-green-800';
                        showNotification('Products synced from Zoho', 'success');
                        if (state.currentTab === 'products') loadProducts();
                    } else {
                        throw new Error(result.error || 'Sync failed');
                    }
                } catch (err) {
                    console.error(err);
                    statusDiv.classList.remove('bg-blue-50');
                    statusDiv.classList.add('bg-red-50');
                    statusDiv.querySelector('p').textContent = '✗ Sync failed: ' + err.message;
                    statusDiv.querySelector('p').className = 'text-sm text-red-800';
                    showNotification('Failed to sync products', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-box mr-2"></i> Sync Products';
                }
            };
        }

        const syncCustomersBtn = document.getElementById('syncCustomersBtn');
        if (syncCustomersBtn) {
            syncCustomersBtn.onclick = async () => {
                const statusDiv = document.getElementById('syncStatus');
                const btn = syncCustomersBtn;
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Syncing...';
                statusDiv.classList.remove('hidden', 'bg-green-50', 'bg-red-50');
                statusDiv.classList.add('bg-blue-50');
                statusDiv.querySelector('p').textContent = 'Syncing customers from Zoho Books...';
                
                try {
                    const response = await fetch(`/api/dashboard/sync-customers/${state.session.tenantId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        statusDiv.classList.remove('bg-blue-50');
                        statusDiv.classList.add('bg-green-50');
                        statusDiv.querySelector('p').textContent = '✓ Customers synced successfully!';
                        statusDiv.querySelector('p').className = 'text-sm text-green-800';
                        showNotification('Customers synced from Zoho', 'success');
                        if (state.currentTab === 'customers') loadCustomers();
                    } else {
                        throw new Error(result.error || 'Sync failed');
                    }
                } catch (err) {
                    console.error(err);
                    statusDiv.classList.remove('bg-blue-50');
                    statusDiv.classList.add('bg-red-50');
                    statusDiv.querySelector('p').textContent = '✗ Sync failed: ' + err.message;
                    statusDiv.querySelector('p').className = 'text-sm text-red-800';
                    showNotification('Failed to sync customers', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-users mr-2"></i> Sync Customers';
                }
            };
        }

        const syncOrdersBtn = document.getElementById('syncOrdersBtn');
        if (syncOrdersBtn) {
            syncOrdersBtn.onclick = async () => {
                const statusDiv = document.getElementById('syncStatus');
                const btn = syncOrdersBtn;
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Syncing...';
                statusDiv.classList.remove('hidden', 'bg-green-50', 'bg-red-50');
                statusDiv.classList.add('bg-blue-50');
                statusDiv.querySelector('p').textContent = 'Syncing orders from Zoho Books...';
                
                try {
                    const response = await fetch(`/api/dashboard/sync-orders/${state.session.tenantId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        statusDiv.classList.remove('bg-blue-50');
                        statusDiv.classList.add('bg-green-50');
                        statusDiv.querySelector('p').textContent = '✓ Orders synced successfully!';
                        statusDiv.querySelector('p').className = 'text-sm text-green-800';
                        showNotification('Orders synced from Zoho', 'success');
                        if (state.currentTab === 'orders') loadOrders();
                    } else {
                        throw new Error(result.error || 'Sync failed');
                    }
                } catch (err) {
                    console.error(err);
                    statusDiv.classList.remove('bg-blue-50');
                    statusDiv.classList.add('bg-red-50');
                    statusDiv.querySelector('p').textContent = '✗ Sync failed: ' + err.message;
                    statusDiv.querySelector('p').className = 'text-sm text-red-800';
                    showNotification('Failed to sync orders', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-shopping-cart mr-2"></i> Sync Orders';
                }
            };
        }
    }

    // ---------- Notifications ----------
    let notifications = [];
    
    function toggleNotifications() {
        const panel = document.getElementById('notificationsPanel');
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden')) {
            loadNotifications();
        }
    }

    async function loadNotifications() {
        try {
            const tenantId = state.session.tenantId;
            if (!tenantId) return;

            // Get recent orders and conversations for notifications
            const [ordersData, convsData] = await Promise.all([
                api.fetchData(`orders`),
                api.fetchData(`conversations`)
            ]);

            notifications = [];

            // Add new orders as notifications
            if (ordersData.success && ordersData.orders) {
                const recentOrders = ordersData.orders.slice(0, 5);
                recentOrders.forEach(order => {
                    notifications.push({
                        id: order.id,
                        type: 'order',
                        icon: 'fa-shopping-cart',
                        color: 'text-green-400',
                        title: 'New Order',
                        message: `Order #${order.id.substring(0, 8)} - ${fmtINR(order.total_amount || order.total)}`,
                        time: new Date(order.created_at).toLocaleTimeString(),
                        date: new Date(order.created_at)
                    });
                });
            }

            // Add recent conversations as notifications
            if (convsData.success && convsData.conversations) {
                const recentConvs = convsData.conversations.slice(0, 5);
                recentConvs.forEach(conv => {
                    notifications.push({
                        id: conv.id,
                        type: 'conversation',
                        icon: 'fa-comments',
                        color: 'text-blue-400',
                        title: 'New Message',
                        message: `From ${conv.customer_name || conv.phone_number || 'Unknown'}`,
                        time: new Date(conv.updated_at).toLocaleTimeString(),
                        date: new Date(conv.updated_at)
                    });
                });
            }

            // Sort by date (newest first)
            notifications.sort((a, b) => b.date - a.date);
            
            // Update badge
            document.getElementById('notifBadge').textContent = Math.min(notifications.length, 99);
            
            // Render notifications
            renderNotifications();
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    function renderNotifications() {
        const list = document.getElementById('notificationsList');
        
        if (notifications.length === 0) {
            list.innerHTML = `
                <div class="p-8 text-center">
                    <i class="fas fa-bell-slash text-white/30 text-4xl mb-3"></i>
                    <p class="text-white/50">No notifications yet</p>
                </div>
            `;
            return;
        }

        list.innerHTML = notifications.map(notif => `
            <div class="p-4 border-b border-white/10 hover:bg-white/5 transition-colors cursor-pointer" onclick="handleNotificationClick('${notif.id}', '${notif.type}')">
                <div class="flex items-start space-x-3">
                    <div class="${notif.color}">
                        <i class="fas ${notif.icon} text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-white font-semibold text-sm">${escapeHtml(notif.title)}</h4>
                        <p class="text-white/70 text-sm mt-1">${escapeHtml(notif.message)}</p>
                        <span class="text-white/40 text-xs mt-1 block">${escapeHtml(notif.time)}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function handleNotificationClick(id, type) {
        // Close notifications panel
        document.getElementById('notificationsPanel').classList.add('hidden');
        
        // Switch to relevant tab and show details
        if (type === 'order') {
            switchTab('orders');
            setTimeout(() => viewOrderDetails(id), 500);
        } else if (type === 'conversation') {
            switchTab('conversations');
            setTimeout(() => viewConversationDetails(id), 500);
        }
    }

    function clearAllNotifications() {
        notifications = [];
        document.getElementById('notifBadge').textContent = '0';
        renderNotifications();
    }

    // Close notifications panel when clicking outside
    document.addEventListener('click', function(event) {
        const panel = document.getElementById('notificationsPanel');
        const bellButton = event.target.closest('button[onclick="toggleNotifications()"]');
        
        if (!panel?.contains(event.target) && !bellButton) {
            panel?.classList.add('hidden');
        }
    });

    async function handleLogout(){
        localStorage.removeItem('dashboardToken');
        localStorage.removeItem('dashboardSession');
        showNotification('Logged out successfully', 'success');
        setTimeout(() => {
            location.href = '/login.html';
        }, 500);
    }

    async function init() {
        // Check if we already have a valid session
        const existingSession = localStorage.getItem('dashboardSession');
        if (existingSession) {
            try {
                state.session = JSON.parse(existingSession);
                console.log('Restored session from localStorage:', state.session);
                
                // Validate session has required fields
                if (!state.session.tenantId || !state.session.businessName) {
                    throw new Error('Invalid session data');
                }
                
                // Load and apply feature settings
                applyFeatureSettings(state.session.tenantId);
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                await loadStats();
                switchTab('whatsapp-web');
                loadNotifications();
                showNotification('Welcome back, ' + state.session.businessName + '!', 'success');
                return;
            } catch (err) {
                console.log('Failed to restore session, redirecting to login:', err);
                localStorage.removeItem('dashboardSession');
                localStorage.removeItem('dashboardToken');
                window.location.href = '/login.html';
                return;
            }
        }

        // No session found - redirect to login
        console.log('No session found, redirecting to login');
        window.location.href = '/login.html';
    }

    // Apply feature settings to show/hide tabs
    function applyFeatureSettings(tenantId) {
        // Load saved feature settings from localStorage (set by admin in clients.html)
        const savedFeatures = JSON.parse(localStorage.getItem(`tenant_features_${tenantId}`)) || {};
        console.log('Loading feature settings for tenant:', tenantId, savedFeatures);
        
        // Map features to tab data attributes
        const featureTabMap = {
            'tab_products': 'products',
            'tab_customers': 'customers',
            'tab_orders': 'orders',
            'tab_discounts': 'discounts',
            'tab_broadcast': 'broadcast',
            'tab_whatsapp_web': 'whatsapp-web',
            'tab_analytics': 'analytics'
        };
        
        // Show/hide tabs based on feature settings
        Object.keys(featureTabMap).forEach(feature => {
            const tabName = featureTabMap[feature];
            const isEnabled = savedFeatures.hasOwnProperty(feature) ? savedFeatures[feature] : true; // Default to enabled
            
            // Find all sidebar items with this tab
            const tabElements = document.querySelectorAll(`[data-tab="${tabName}"]`);
            tabElements.forEach(el => {
                if (isEnabled) {
                    el.style.display = ''; // Show
                    console.log(`✅ Enabled tab: ${tabName}`);
                } else {
                    el.style.display = 'none'; // Hide
                    console.log(`❌ Disabled tab: ${tabName}`);
                }
            });
        });
    }

    // ---------- Event listeners ----------
    document.addEventListener('DOMContentLoaded', function(){
        // Initialize bulk upload handlers
        initBulkUploadHandlers();
        // Initialize manage categories handler
        initManageCategoriesHandler();
        
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('view-order-btn') || event.target.closest('.view-order-btn')) {
                const button = event.target.closest('.view-order-btn') || event.target;
                const orderId = button.getAttribute('data-order-id');
                const tenantId = button.getAttribute('data-tenant-id') || state.session?.tenantId;
                if (orderId && tenantId) {
                    loadOrderAndShowModal(orderId, tenantId);
                }
            }
        });

        document.getElementById('globalSearch')?.addEventListener('input', function(e){
            state.searchQuery = e.target.value.trim().toLowerCase();
            if (state.currentTab === 'conversations') loadConversations();
            else if (state.currentTab === 'orders') loadOrders();
        });
        // Customer search filter listeners
        document.getElementById('customerSearchBtn')?.addEventListener('click', loadCustomers);
        ['customerSearchInput','customerMinSpent','customerMaxSpent','customerMinOrderDate','customerMaxOrderDate'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') loadCustomers(); });
        });

        document.getElementById('closeConvBtn')?.addEventListener('click', () => document.getElementById('conversationModal').classList.add('hidden'));
        document.getElementById('closeOrderModal')?.addEventListener('click', () => {
            const modal = document.getElementById('orderModal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        });
        document.getElementById('closeEditProdBtn')?.addEventListener('click', () => document.getElementById('editProductModal').classList.add('hidden'));
        document.getElementById('cancelEditProd')?.addEventListener('click', () => document.getElementById('editProductModal').classList.add('hidden'));
        document.getElementById('saveEditProdBtn')?.addEventListener('click', saveProductEdits);
        document.getElementById('closeCustomerModalBtn')?.addEventListener('click', () => document.getElementById('customerModal').classList.add('hidden'));

        document.addEventListener('click', function(e){
            const btn = e.target.closest('.view-details-btn');
            if (!btn) return;
            const tenantId = btn.dataset.tenantId;
            const convId = btn.dataset.convId;
            openConversation(tenantId, convId);
        });

        document.getElementById('saveOrderStatusBtn')?.addEventListener('click', async () => {
            const orderId = window.currentOrderId;
            if (!orderId) return alert('Order id missing');

            const statusSelect = document.getElementById('orderStatusSelect');
            const saveBtn = document.getElementById('saveOrderStatusBtn');
            const newStatus = statusSelect.value;
            
            saveBtn.disabled = true;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';

            try {
                const resp = await fetch(`/api/orders/${encodeURIComponent(orderId)}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const json = await resp.json();
                if (!resp.ok) {
                    console.error('Status update failed', json);
                    alert('Failed to update status: ' + (json.error || JSON.stringify(json)));
                    return;
                }

                const statusLabel = document.getElementById('orderStatusLabel');
                if (statusLabel) statusLabel.textContent = newStatus;

                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                if (orderCard) {
                    const badge = orderCard.querySelector('.order-status-badge');
                    if (badge) badge.textContent = newStatus;
                }

                showNotification('Order status updated successfully', 'success');
            } catch (err) {
                console.error('Error updating order status', err);
                alert('Error updating order status');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        });
    });

    // ========== Website Content Functions ==========
    
    async function loadWebsiteContent() {
        try {
            // Load stats
            const statsRes = await fetch(`/api/dashboard/website-content/stats/${state.session.tenantId}`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const statsData = await statsRes.json();
            
            if (statsData.success) {
                document.getElementById('websiteUrlCount').textContent = statsData.stats.totalUrls || 0;
                document.getElementById('websiteChunkCount').textContent = statsData.stats.totalChunks || 0;
            }

            // Load crawled URLs list
            await refreshWebsiteList();
        } catch (error) {
            console.error('Error loading website content:', error);
            showNotification('Failed to load website content', 'error');
        }
    }

    async function crawlWebsiteUrl() {
        const urlInput = document.getElementById('websiteUrlInput');
        const url = urlInput.value.trim();
        
        if (!url) {
            showNotification('Please enter a URL', 'error');
            return;
        }

        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            showNotification('URL must start with http:// or https://', 'error');
            return;
        }

        try {
            showNotification('Crawling website... This may take a moment', 'info');
            
            const res = await fetch(`/api/dashboard/website-content/crawl/${state.session.tenantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({ url })
            });

            const data = await res.json();
            
            if (data.success) {
                showNotification(`Successfully crawled: ${data.pageTitle || url} (${data.chunksCreated} chunks)`, 'success');
                urlInput.value = '';
                await refreshWebsiteList();
                await loadWebsiteContent();
            } else {
                showNotification(`Failed to crawl: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Error crawling website:', error);
            showNotification('Failed to crawl website', 'error');
        }
    }

    async function crawlEntireWebsite() {
        const urlInput = document.getElementById('websiteFullUrlInput');
        const url = urlInput.value.trim();
        
        if (!url) {
            showNotification('Please enter a website URL', 'error');
            return;
        }

        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            showNotification('URL must start with http:// or https://', 'error');
            return;
        }

        const maxPages = parseInt(document.getElementById('maxPages').value) || 100;
        const maxDepth = parseInt(document.getElementById('maxDepth').value) || 3;
        const useSitemap = document.getElementById('useSitemap').checked;

        // Show progress indicator
        const progressDiv = document.getElementById('crawlProgress');
        const progressBar = document.getElementById('crawlProgressBar');
        const progressCount = document.getElementById('crawlProgressCount');
        progressDiv.classList.remove('hidden');
        progressBar.style.width = '10%';
        progressCount.textContent = 'Starting...';

        try {
            showNotification('Starting full website crawl... This may take several minutes', 'info');
            
            const res = await fetch(`/api/dashboard/website-content/crawl-all/${state.session.tenantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({ 
                    url,
                    options: {
                        maxPages,
                        maxDepth,
                        useSitemap,
                        delayBetweenRequests: 1000
                    }
                })
            });

            const data = await res.json();
            
            progressDiv.classList.add('hidden');
            
            if (data.success) {
                showNotification(
                    `✅ Successfully crawled entire website!\n` +
                    `📄 Pages: ${data.pagesCrawled}\n` +
                    `📦 Chunks: ${data.totalChunks}`, 
                    'success'
                );
                urlInput.value = '';
                await refreshWebsiteList();
                await loadWebsiteContent();
            } else {
                showNotification(`Failed to crawl website: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Error crawling entire website:', error);
            progressDiv.classList.add('hidden');
            showNotification('Failed to crawl entire website', 'error');
        }
    }

    async function refreshWebsiteList() {
        try {
            const res = await fetch(`/api/dashboard/website-content/list/${state.session.tenantId}`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const data = await res.json();
            
            const tbody = document.getElementById('websiteUrlsList');
            
            if (!data.success || !data.urls || data.urls.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-globe text-4xl mb-3 block"></i>
                            <p>No websites crawled yet. Add a URL above to get started!</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.urls.map(item => `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="px-4 py-3">${escapeHtml(item.pageTitle || 'Untitled')}</td>
                    <td class="px-4 py-3">
                        <a href="${escapeHtml(item.url)}" target="_blank" class="text-blue-600 hover:underline text-xs">
                            ${escapeHtml(item.url.substring(0, 50))}${item.url.length > 50 ? '...' : ''}
                        </a>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${escapeHtml(item.contentType || 'general')}</span>
                    </td>
                    <td class="px-4 py-3">${item.chunkCount || 0}</td>
                    <td class="px-4 py-3 text-xs text-gray-600">${item.crawlDate ? new Date(item.crawlDate).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-4 py-3">
                        <button 
                            onclick="deleteWebsiteContent('${escapeHtml(item.url)}')" 
                            class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error refreshing website list:', error);
            document.getElementById('websiteUrlsList').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-8 text-red-500">
                        Failed to load: ${escapeHtml(error.message)}
                    </td>
                </tr>
            `;
        }
    }

    async function searchWebsiteContent() {
        const query = document.getElementById('websiteSearchQuery').value.trim();
        
        if (!query) {
            showNotification('Please enter a search query', 'error');
            return;
        }

        try {
            const res = await fetch(`/api/dashboard/website-content/search/${state.session.tenantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({ query, limit: 5, minSimilarity: 0.7 })
            });

            const data = await res.json();
            
            const resultsDiv = document.getElementById('websiteSearchResults');
            const resultsList = document.getElementById('websiteSearchResultsList');
            
            if (!data.success || !data.results || data.results.length === 0) {
                resultsDiv.classList.remove('hidden');
                resultsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-search text-3xl mb-3"></i>
                        <p>No results found for "${escapeHtml(query)}"</p>
                        <p class="text-sm mt-2">Try different keywords or crawl more content</p>
                    </div>
                `;
                return;
            }

            resultsDiv.classList.remove('hidden');
            resultsList.innerHTML = data.results.map(result => `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-2">
                        <h5 class="font-semibold text-gray-800">${escapeHtml(result.pageTitle || 'Untitled')}</h5>
                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">${result.relevanceScore}% match</span>
                    </div>
                    <a href="${escapeHtml(result.url)}" target="_blank" class="text-xs text-blue-600 hover:underline mb-2 block">
                        ${escapeHtml(result.url)}
                    </a>
                    <p class="text-sm text-gray-600 mb-2">${escapeHtml(result.content.substring(0, 200))}${result.content.length > 200 ? '...' : ''}</p>
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                        <span class="px-2 py-1 bg-gray-100 rounded">${escapeHtml(result.contentType)}</span>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error searching website content:', error);
            showNotification('Failed to search content', 'error');
        }
    }

    async function deleteWebsiteContent(url) {
        if (!confirm(`Are you sure you want to delete all content from:\n${url}`)) {
            return;
        }

        try {
            const res = await fetch(`/api/dashboard/website-content/${state.session.tenantId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.session.token}`
                },
                body: JSON.stringify({ url })
            });

            const data = await res.json();
            
            if (data.success) {
                showNotification(`Deleted ${data.deletedCount} chunks`, 'success');
                await refreshWebsiteList();
                await loadWebsiteContent();
            } else {
                showNotification('Failed to delete content', 'error');
            }
        } catch (error) {
            console.error('Error deleting website content:', error);
            showNotification('Failed to delete content', 'error');
        }
    }

    init();
    </script>
</body>
</html>