<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesmate - Field Sales App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Leaflet.js for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Heat for heatmaps -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #48bb78;
            --warning: #f6ad55;
            --danger: #f56565;
            --info: #4fd1c5;
            --bg-light: #f7fafc;
            --text-dark: #2d3748;
            --text-muted: #718096;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-light);
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar.collapsed .sidebar-header h1 span {
            display: none;
        }

        .sidebar-profile {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .profile-details {
            flex: 1;
        }

        .sidebar.collapsed .profile-details {
            display: none;
        }

        .profile-name {
            font-weight: 600;
            font-size: 15px;
        }

        .profile-role {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-nav {
            flex: 1;
            padding: 10px 0;
            overflow-y: auto;
        }

        .nav-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255,255,255,0.8);
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left: 4px solid white;
        }

        .nav-item i {
            width: 24px;
            font-size: 18px;
        }

        .sidebar.collapsed .nav-item span {
            display: none;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .top-bar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            position: relative;
        }

        .notif-wrapper {
            position: relative;
        }

        .notif-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 18px;
            height: 18px;
            padding: 0 6px;
            border-radius: 999px;
            background: var(--danger);
            color: white;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .notif-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 10px);
            width: 360px;
            max-height: 420px;
            overflow: auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
            display: none;
            z-index: 50;
        }

        .notif-dropdown.open {
            display: block;
        }

        .notif-dropdown-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .notification-item.unread {
            background: rgba(102, 126, 234, 0.08);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-outline {
            background: white;
            border: 2px solid var(--border);
            color: var(--text-dark);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }

        .stat-card.success { border-left-color: var(--success); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-card.danger { border-left-color: var(--danger); }
        .stat-card.info { border-left-color: var(--info); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-card .stat-icon { background: #ebf4ff; color: var(--primary); }
        .stat-card.success .stat-icon { background: #f0fff4; color: var(--success); }
        .stat-card.warning .stat-icon { background: #fffaf0; color: var(--warning); }
        .stat-card.danger .stat-icon { background: #fff5f5; color: var(--danger); }
        .stat-card.info .stat-icon { background: #e6fffa; color: var(--info); }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .stat-subtext {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg-light);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Table */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 12px;
            background: var(--bg-light);
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .table td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-dark);
        }

        .table tr:hover {
            background: var(--bg-light);
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success { background: #f0fff4; color: var(--success); }
        .badge-warning { background: #fffaf0; color: var(--warning); }
        .badge-danger { background: #fff5f5; color: var(--danger); }
        .badge-info { background: #e6fffa; color: var(--info); }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        @media (max-width: 968px) {
            .sidebar {
                position: fixed;
                left: -260px;
                z-index: 1000;
            }

            .sidebar.open {
                left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>
                    <i class="fas fa-rocket"></i>
                    <span>Salesmate</span>
                </h1>
            </div>

            <div class="sidebar-profile">
                <div class="profile-info">
                    <div class="profile-avatar" id="profileAvatar">?</div>
                    <div class="profile-details">
                        <div class="profile-name" id="profileName">Loading...</div>
                        <div class="profile-role">Field Salesman</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-page="visits">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>My Visits</span>
                </div>
                <div class="nav-item" data-page="customers">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </div>
                <div class="nav-item" data-page="targets">
                    <i class="fas fa-bullseye"></i>
                    <span>Targets</span>
                </div>
                <div class="nav-item" data-page="expenses">
                    <i class="fas fa-receipt"></i>
                    <span>Expenses</span>
                </div>
                <div class="nav-item" data-page="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="btn btn-outline" onclick="logout()" style="width: 100%; color: white; border-color: rgba(255,255,255,0.5); background-color: rgba(255,255,255,0.1); transition: all 0.3s;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <h2 class="top-bar-title" id="pageTitle">Dashboard</h2>
                <div class="top-bar-actions">
                    <div class="notif-wrapper">
                        <button class="btn btn-outline" onclick="toggleNotifications(event)" title="Notifications" style="padding: 10px 12px;">
                            <i class="fas fa-bell"></i>
                        </button>
                        <span id="notificationBadge" class="notif-badge">0</span>
                        <div id="notificationDropdown" class="notif-dropdown">
                            <div class="notif-dropdown-header">
                                <span>Notifications</span>
                                <button class="btn btn-outline" onclick="refreshNotifications()" style="padding: 6px 10px; font-size: 12px;">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div id="notificationList"></div>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="refreshData()">
                        <i class="fas fa-sync"></i>
                        Refresh
                    </button>
                    <button class="btn btn-primary" onclick="newVisit()">
                        <i class="fas fa-plus"></i>
                        New Visit
                    </button>
                </div>
            </div>

            <div class="content-area">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active">
                    <!-- Stats Row -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Today's Visits</span>
                                <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                            </div>
                            <div class="stat-value" id="todayVisits">-</div>
                            <div class="stat-subtext">Loading...</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-header">
                                <span class="stat-label">Orders Today</span>
                                <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                            </div>
                            <div class="stat-value" id="todayOrders">0</div>
                            <div class="stat-subtext" id="todayOrdersValue">‚Çπ0</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-header">
                                <span class="stat-label">Target Progress</span>
                                <div class="stat-icon"><i class="fas fa-bullseye"></i></div>
                            </div>
                            <div class="stat-value" id="targetProgress">0%</div>
                            <div class="stat-subtext" id="targetSubtext">of monthly goal</div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-header">
                                <span class="stat-label">My Rank</span>
                                <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                            </div>
                            <div class="stat-value" id="myRank">#-</div>
                            <div class="stat-subtext" id="rankChange">Loading...</div>
                        </div>
                    </div>

                    <!-- AI Recommendations & Alerts Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- AI Visit Recommendations -->
                        <div class="card" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 2px solid #667eea30;">
                            <div class="card-header">
                                <h3 class="card-title">ü§ñ AI Recommends - Visit These Today</h3>
                                <button class="btn btn-outline" onclick="refreshAIRecommendations()" style="padding: 6px 12px;">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div id="aiRecommendations" style="padding: 16px;">
                                <div class="empty-state" style="padding: 20px;">
                                    <i class="fas fa-robot fa-2x" style="color: #667eea; margin-bottom: 10px;"></i>
                                    <p>Analyzing your customers...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Smart Alerts -->
                        <div class="card" style="background: linear-gradient(135deg, #f5656515 0%, #f6ad5515 100%); border: 2px solid #f5656530;">
                            <div class="card-header">
                                <h3 class="card-title">‚ö†Ô∏è Smart Alerts</h3>
                                <span id="alertCount" class="badge" style="background: #f56565; color: white; padding: 4px 10px; border-radius: 12px;">0</span>
                            </div>
                            <div id="smartAlerts" style="padding: 16px; max-height: 200px; overflow-y: auto;">
                                <div class="empty-state" style="padding: 20px;">
                                    <i class="fas fa-check-circle fa-2x" style="color: #48bb78; margin-bottom: 10px;"></i>
                                    <p>No alerts - great job!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Performance Chart -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üìà Performance Trend (Last 7 Days)</h3>
                            </div>
                            <div style="padding: 16px; height: 300px;">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>

                        <!-- Conversion Funnel -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üîÑ Conversion Funnel</h3>
                            </div>
                            <div id="conversionFunnel" style="padding: 16px;">
                                <div class="funnel-stage" style="background: #667eea; width: 100%; padding: 12px; color: white; text-align: center; border-radius: 8px 8px 0 0;">
                                    <strong>Visits</strong>: <span id="funnelVisits">0</span>
                                </div>
                                <div class="funnel-stage" style="background: #4fd1c5; width: 80%; margin: 0 auto; padding: 12px; color: white; text-align: center;">
                                    <strong>Engaged</strong>: <span id="funnelEngaged">0</span>
                                </div>
                                <div class="funnel-stage" style="background: #f6ad55; width: 60%; margin: 0 auto; padding: 12px; color: white; text-align: center;">
                                    <strong>Quoted</strong>: <span id="funnelQuoted">0</span>
                                </div>
                                <div class="funnel-stage" style="background: #48bb78; width: 40%; margin: 0 auto; padding: 12px; color: white; text-align: center; border-radius: 0 0 8px 8px;">
                                    <strong>Orders</strong>: <span id="funnelOrders">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Territory Map & Leaderboard Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Territory Heat Map -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üìç Territory Heat Map</h3>
                                <select id="mapFilter" onchange="updateHeatMap()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
                                    <option value="visits">Visits</option>
                                    <option value="revenue">Revenue</option>
                                    <option value="potential">Potential</option>
                                </select>
                            </div>
                            <div id="territoryMap" style="height: 300px; border-radius: 8px;"></div>
                        </div>

                        <!-- Live Leaderboard -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üèÜ Live Leaderboard</h3>
                                <span style="font-size: 12px; color: #718096;">This Month</span>
                            </div>
                            <div id="leaderboard" style="padding: 0;">
                                <div class="empty-state" style="padding: 20px;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading rankings...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Best Time to Visit & Cross-sell -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Best Time to Visit -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‚è∞ Best Time to Visit</h3>
                            </div>
                            <div id="bestTimeChart" style="padding: 16px; height: 200px;">
                                <canvas id="bestTimeHeatmap"></canvas>
                            </div>
                        </div>

                        <!-- Top Cross-sell Opportunities -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üí∞ Cross-sell Opportunities</h3>
                            </div>
                            <div id="crossSellList" style="padding: 16px;">
                                <div class="empty-state" style="padding: 20px;">
                                    <i class="fas fa-lightbulb fa-2x" style="color: #f6ad55; margin-bottom: 10px;"></i>
                                    <p>Analyzing purchase patterns...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Schedule -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìÖ Today's Schedule</h3>
                            <button class="btn btn-primary" onclick="aiAutoSchedule()" style="padding: 8px 16px;">
                                <i class="fas fa-magic"></i> AI Auto-Plan My Day
                            </button>
                        </div>
                        <table class="table" id="todayVisitsTable">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5">
                                        <div class="empty-state">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <h3>Loading your schedule...</h3>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Visits Page -->
                <div id="visits" class="page">
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-label">Total Visits</span>
                                <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                            </div>
                            <div class="stat-value" id="visitsTotal">0</div>
                            <div class="stat-subtext">This month</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-header">
                                <span class="stat-label">Completed</span>
                                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            </div>
                            <div class="stat-value" id="visitsCompleted">0</div>
                            <div class="stat-subtext">Success rate</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-header">
                                <span class="stat-label">Pending</span>
                                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            </div>
                            <div class="stat-value" id="visitsPending">0</div>
                            <div class="stat-subtext">Need attention</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Visits</h3>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Type</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="visitsTableBody">
                                <tr><td colspan="6"><div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading visits...</p></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Customers Page -->
                <div id="customers" class="page">
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card info">
                            <div class="stat-header">
                                <span class="stat-label">Total Customers</span>
                                <div class="stat-icon"><i class="fas fa-users"></i></div>
                            </div>
                            <div class="stat-value" id="customersTotal">0</div>
                            <div class="stat-subtext">In your territory</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-header">
                                <span class="stat-label">Active Customers</span>
                                <div class="stat-icon"><i class="fas fa-user-check"></i></div>
                            </div>
                            <div class="stat-value" id="customersActive">0</div>
                            <div class="stat-subtext">Recent orders</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-header">
                                <span class="stat-label">Needs Follow-up</span>
                                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            </div>
                            <div class="stat-value" id="customersFollowup">0</div>
                            <div class="stat-subtext">Inactive 30+ days</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">My Customers</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="customerSearch" placeholder="Search customers..." style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px; width: 250px;">
                                <button class="btn btn-primary" onclick="alert('Add new customer - Name, phone, address, business type')">
                                    <i class="fas fa-plus"></i> Add Customer
                                </button>
                            </div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Phone</th>
                                    <th>Location</th>
                                    <th>Last Visit</th>
                                    <th>Total Orders</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                <tr><td colspan="6"><div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading customers...</p></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Targets Page -->
                <div id="targets" class="page">
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <h3 class="card-title">üéØ January 2026 Target</h3>
                        </div>
                        <div id="targetProgressDetail" style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                                <div style="text-align: center; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Target Amount</div>
                                    <div style="font-size: 32px; font-weight: bold; color: var(--primary);" id="targetAmount">‚Çπ0</div>
                                </div>
                                <div style="text-align: center; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Achieved</div>
                                    <div style="font-size: 32px; font-weight: bold; color: var(--success);" id="achievedAmount">‚Çπ0</div>
                                </div>
                                <div style="text-align: center; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Remaining</div>
                                    <div style="font-size: 32px; font-weight: bold; color: var(--danger);" id="remainingAmount">‚Çπ0</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 16px; font-weight: 600;">Progress</span>
                                <span style="font-size: 24px; font-weight: bold; color: var(--primary);" id="achievementPercent">0%</span>
                            </div>
                            <div style="height: 30px; background: #e2e8f0; border-radius: 15px; overflow: hidden;">
                                <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%); width: 0%; transition: width 1s ease;"></div>
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #f0fff4; border-left: 4px solid var(--success); border-radius: 8px;">
                                <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 5px;">Daily Target (Remaining days)</div>
                                <div style="font-size: 20px; font-weight: 600; color: var(--text-dark);" id="dailyTarget">‚Çπ0 per day</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Target History</h3>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Target</th>
                                    <th>Achieved</th>
                                    <th>Achievement %</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="targetHistoryBody">
                                <tr><td colspan="5"><div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading history...</p></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Expenses Page -->
                <div id="expenses" class="page">
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card warning">
                            <div class="stat-header">
                                <span class="stat-label">This Month</span>
                                <div class="stat-icon"><i class="fas fa-receipt"></i></div>
                            </div>
                            <div class="stat-value">‚Çπ2,450</div>
                            <div class="stat-subtext">Total expenses</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-header">
                                <span class="stat-label">Approved</span>
                                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            </div>
                            <div class="stat-value">‚Çπ1,800</div>
                            <div class="stat-subtext">6 claims</div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-header">
                                <span class="stat-label">Pending</span>
                                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            </div>
                            <div class="stat-value">‚Çπ650</div>
                            <div class="stat-subtext">2 claims</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Submit Expense</h3>
                        </div>
                        <form style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;" onsubmit="submitExpense(event)">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Category</label>
                                <select style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px;">
                                    <option>Travel</option>
                                    <option>Food & Accommodation</option>
                                    <option>Client Entertainment</option>
                                    <option>Communication</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Amount</label>
                                <input type="number" placeholder="‚Çπ 0" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px;">
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Description</label>
                                <textarea placeholder="Describe the expense..." style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; resize: vertical; min-height: 80px;"></textarea>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Submit Expense
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Expenses</h3>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jan 16, 2026</td>
                                    <td>Travel</td>
                                    <td>Client visit - Fuel</td>
                                    <td>‚Çπ450</td>
                                    <td><span class="badge badge-warning">Pending</span></td>
                                </tr>
                                <tr>
                                    <td>Jan 15, 2026</td>
                                    <td>Food</td>
                                    <td>Lunch with client</td>
                                    <td>‚Çπ350</td>
                                    <td><span class="badge badge-success">Approved</span></td>
                                </tr>
                                <tr>
                                    <td>Jan 14, 2026</td>
                                    <td>Communication</td>
                                    <td>Mobile recharge</td>
                                    <td>‚Çπ200</td>
                                    <td><span class="badge badge-success">Approved</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reports" class="page">
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <h3 class="card-title">Performance Overview</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px;">
                            <div style="text-align: center; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                                <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Visits This Month</div>
                                <div style="font-size: 28px; font-weight: bold; color: var(--primary);">24</div>
                                <div style="font-size: 12px; color: var(--success); margin-top: 5px;">‚Üë 12% vs last month</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                                <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Orders</div>
                                <div style="font-size: 28px; font-weight: bold; color: var(--success);">18</div>
                                <div style="font-size: 12px; color: var(--success); margin-top: 5px;">75% conversion</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                                <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Avg. Order Value</div>
                                <div style="font-size: 28px; font-weight: bold; color: var(--warning);">‚Çπ12,500</div>
                                <div style="font-size: 12px; color: var(--success); margin-top: 5px;">‚Üë ‚Çπ1,200</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--bg-light); border-radius: 12px;">
                                <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Customer Satisfaction</div>
                                <div style="font-size: 28px; font-weight: bold; color: var(--info);">4.8/5</div>
                                <div style="font-size: 12px; color: var(--success); margin-top: 5px;">Excellent</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Top Customers</h3>
                            </div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Orders</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>Fairdeal corporation</td><td>5</td><td>‚Çπ85,000</td></tr>
                                    <tr><td>XYZ Corporation</td><td>4</td><td>‚Çπ62,000</td></tr>
                                    <tr><td>Patel Enterprises</td><td>3</td><td>‚Çπ45,000</td></tr>
                                    <tr><td>Kumar & Sons</td><td>3</td><td>‚Çπ38,000</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Activity Summary</h3>
                            </div>
                            <div style="padding: 20px;">
                                <div style="margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px;">Visit Completion Rate</span>
                                        <span style="font-weight: 600;">92%</span>
                                    </div>
                                    <div style="height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="height: 100%; background: var(--success); width: 92%;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px;">Order Conversion</span>
                                        <span style="font-weight: 600;">75%</span>
                                    </div>
                                    <div style="height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="height: 100%; background: var(--primary); width: 75%;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px;">Customer Retention</span>
                                        <span style="font-weight: 600;">88%</span>
                                    </div>
                                    <div style="height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="height: 100%; background: var(--info); width: 88%;"></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px;">Target Achievement</span>
                                        <span style="font-weight: 600;">65%</span>
                                    </div>
                                    <div style="height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden;">
                                        <div style="height: 100%; background: var(--warning); width: 65%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Visit Modal -->
    <div id="newVisitModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:9999; overflow-y:auto; padding:20px;">
        <div style="background:white; border-radius:16px; max-width:600px; width:100%; margin:0 auto; box-shadow:0 8px 32px rgba(0,0,0,0.2);">
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:20px; border-radius:16px 16px 0 0; color:white;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0; font-size:24px;">üìç New Visit</h2>
                    <button onclick="closeNewVisitModal()" style="background:rgba(255,255,255,0.2); border:none; width:36px; height:36px; border-radius:50%; font-size:24px; cursor:pointer; color:white;">&times;</button>
                </div>
                <div id="visitTimer" style="margin-top:10px; font-size:14px; opacity:0.9;"></div>
            </div>
            
            <form id="newVisitForm" onsubmit="event.preventDefault(); submitNewVisit();" style="padding:24px;">
                <!-- Visit Type Toggle -->
                <div style="margin-bottom:24px; padding:16px; background:#f8f9fa; border-radius:8px;">
                    <label style="display:block; margin-bottom:12px; color:#333; font-weight:600; font-size:14px;">Visit Type</label>
                    <div style="display:flex; gap:12px;">
                        <div class="radio-item selected" data-value="now" onclick="toggleVisitType('now')" style="flex:1; text-align:center;">
                            <i class="fas fa-play-circle"></i> Start Visit Now
                        </div>
                        <div class="radio-item" data-value="later" onclick="toggleVisitType('later')" style="flex:1; text-align:center;">
                            <i class="fas fa-calendar-plus"></i> Schedule for Later
                        </div>
                    </div>
                </div>

                <!-- Scheduled Date/Time (shown only for 'later') -->
                <div id="scheduledDateTime" style="display:none; margin-bottom:20px; padding:16px; background:#fff3cd; border-radius:8px; border:2px solid #ffc107;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Visit Date <span style="color:#e74c3c;">*</span></label>
                            <input type="date" id="scheduledDate" style="width:100%; padding:12px; border:2px solid #ffc107; border-radius:8px; font-size:14px;">
                        </div>
                        <div>
                            <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Visit Time</label>
                            <input type="time" id="scheduledTime" style="width:100%; padding:12px; border:2px solid #ffc107; border-radius:8px; font-size:14px;">
                        </div>
                    </div>
                </div>

                <!-- Customer Name -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Customer Name <span style="color:#e74c3c;">*</span></label>
                    <input type="text" id="newVisitCustomer" required list="customerList" placeholder="Enter or select customer" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; transition:border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">
                    <datalist id="customerList"></datalist>
                </div>

                <!-- Contact Person -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Contact Person</label>
                    <input type="text" id="newVisitContact" placeholder="Enter contact person name" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; transition:border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">
                </div>

                <!-- Email -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Email</label>
                    <input type="email" id="newVisitEmail" placeholder="customer@example.com" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; transition:border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e0e0e0'">
                </div>

                <!-- Plants/Branches -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Plant/Branch</label>
                    <div id="plants" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:8px;">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Meeting Types -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Meeting Type <span style="color:#e74c3c;">*</span></label>
                    <div id="meetingTypes" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:8px;">
                        <div class="checkbox-item" data-value="Introduction">Introduction</div>
                        <div class="checkbox-item" data-value="Enquiry">Enquiry</div>
                        <div class="checkbox-item" data-value="Demo">Demo</div>
                        <div class="checkbox-item" data-value="Price Discussion">Price Discussion</div>
                        <div class="checkbox-item" data-value="Order">Order</div>
                        <div class="checkbox-item" data-value="Payment">Payment</div>
                        <div class="checkbox-item" data-value="Follow-up">Follow-up</div>
                        <div class="checkbox-item" data-value="Meeting">Meeting</div>
                    </div>
                </div>

                <!-- Products Discussed - Multi-select Dropdown -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Products Discussed</label>
                    <div style="position:relative;">
                        <input type="text" id="productSearch" placeholder="Search and select products..." style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px;" onfocus="showProductDropdown()" oninput="filterProducts()">
                        <div id="productDropdown" style="display:none; position:absolute; top:100%; left:0; right:0; background:white; border:2px solid #e0e0e0; border-top:none; border-radius:0 0 8px 8px; max-height:250px; overflow-y:auto; z-index:1000; box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                    </div>
                    <div id="selectedProducts" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;"></div>
                </div>

                <!-- Next Action -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Next Action</label>
                    <div id="nextActions" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:8px;">
                        <div class="checkbox-item" data-value="Call">Call</div>
                        <div class="checkbox-item" data-value="Meeting">Meeting</div>
                        <div class="checkbox-item" data-value="Demo">Demo</div>
                        <div class="checkbox-item" data-value="Send Quote">Send Quote</div>
                        <div class="checkbox-item" data-value="Visit">Visit</div>
                    </div>
                </div>

                <!-- Next Action Date -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Next Action Date</label>
                    <input type="date" id="nextActionDate" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px;">
                </div>

                <!-- Potential -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Potential <span style="color:#e74c3c;">*</span></label>
                    <div id="potential" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">
                        <div class="radio-item" data-value="High">üî• High</div>
                        <div class="radio-item" data-value="Medium">‚ö° Medium</div>
                        <div class="radio-item selected" data-value="Low">üíß Low</div>
                    </div>
                </div>

                <!-- Competitor -->
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Competitor Name (if any)</label>
                    <input type="text" id="competitorName" placeholder="Enter competitor name" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px;">
                </div>

                <!-- Switchable (shows only if competitor entered) -->
                <div id="switchableGroup" style="margin-bottom:20px; display:none;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Can be switched?</label>
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;">
                        <div class="radio-item" data-value="yes">‚úÖ Yes</div>
                        <div class="radio-item" data-value="no">‚ùå No</div>
                    </div>
                </div>

                <!-- Remarks -->
                <div style="margin-bottom:24px;">
                    <label style="display:block; margin-bottom:8px; color:#333; font-weight:600; font-size:14px;">Remarks / Notes</label>
                    <textarea id="remarks" rows="4" placeholder="Any additional notes..." style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; resize:vertical;"></textarea>
                </div>

                <!-- Submit Buttons -->
                <div style="display:flex; gap:12px; justify-content:flex-end;">
                    <button type="button" onclick="closeNewVisitModal()" style="padding:12px 24px; border:2px solid #e0e0e0; background:white; border-radius:8px; cursor:pointer; font-weight:600; color:#666;">Cancel</button>
                    <button type="submit" id="submitVisitBtn" style="padding:12px 24px; border:none; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 4px 12px rgba(102,126,234,0.4);">üìç Submit Visit</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .checkbox-item, .radio-item {
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            user-select: none;
        }
        .checkbox-item:hover, .radio-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .checkbox-item.selected, .radio-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102,126,234,0.3);
        }
        .product-dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .product-dropdown-item:hover {
            background: #f8f9ff;
        }
        .product-dropdown-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .selected-product-tag {
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .selected-product-tag button {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
    </style>

    <script>
        const DEFAULT_TENANT_ID = '101f04af63cbefc2bf8f0a98b9ae1205';

        function getTenantId() {
            const urlTenantId = new URLSearchParams(window.location.search).get('tenant_id');
            const storedTenantId = localStorage.getItem('tenantId');
            return urlTenantId || storedTenantId || DEFAULT_TENANT_ID;
        }

        const tenantId = getTenantId();
        localStorage.setItem('tenantId', tenantId);

        const salesmanId = localStorage.getItem('salesmanId');
        const salesmanName = localStorage.getItem('salesmanName');
        const salesmanToken = localStorage.getItem('salesmanToken');
        const deviceId = localStorage.getItem('deviceId');

        const OFFLINE_QUEUE_KEY = 'salesmanOfflineQueue';

        function getOfflineQueue() {
            try {
                return JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function setOfflineQueue(queue) {
            localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
        }

        function enqueueOfflineChange(change) {
            const queue = getOfflineQueue();
            queue.push(change);
            setOfflineQueue(queue);
            return queue.length;
        }

        async function apiFetch(path, options = {}) {
            const headers = Object.assign({}, options.headers || {});
            if (salesmanToken) headers['Authorization'] = `Bearer ${salesmanToken}`;
            if (!headers['Content-Type'] && options.body) headers['Content-Type'] = 'application/json';
            headers['X-Tenant-Id'] = tenantId;

            const res = await fetch(path, Object.assign({}, options, { headers }));
            const json = await res.json().catch(() => ({}));
            if (!res.ok || json.success === false) {
                if (res.status === 401 || res.status === 403) {
                    localStorage.removeItem('salesmanToken');
                    localStorage.removeItem('salesmanTokenExpiresAt');
                    window.location.href = '/salesman-login.html';
                    return;
                }
                const msg = json.error || `Request failed (${res.status})`;
                throw new Error(msg);
            }
            return json;
        }

        async function flushOfflineQueue() {
            const queue = getOfflineQueue();
            if (!queue.length) return;
            if (!navigator.onLine) return;
            if (!salesmanId || !deviceId || !salesmanToken) return;

            try {
                const payload = { tenant_id: tenantId, device_id: deviceId, changes: queue };
                const result = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/sync-upload`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                // On success, clear queue (server returns per-change failures; keep it simple for now)
                if (result?.results?.failed > 0) {
                    console.warn('Some offline changes failed to sync:', result.results);
                } else {
                    setOfflineQueue([]);
                }
            } catch (e) {
                console.warn('Offline queue flush failed:', e.message);
            }
        }

        // Check authentication
        if (!salesmanId || !salesmanToken) {
            window.location.href = '/salesman-login.html';
        }

        // Flush queued changes when online
        window.addEventListener('online', () => {
            flushOfflineQueue();
        });

        // Initialize
        document.getElementById('profileName').textContent = salesmanName || 'Salesman';
        document.getElementById('profileAvatar').textContent = (salesmanName || 'S').charAt(0).toUpperCase();

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.dataset.page;
                navigateTo(page);
            });
        });

        function navigateTo(page) {
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            // Update page
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');

            // Update title
            const titles = {
                dashboard: 'Dashboard',
                visits: 'My Visits',
                customers: 'Customers',
                targets: 'Targets',
                expenses: 'Expenses',
                reports: 'Reports'
            };
            document.getElementById('pageTitle').textContent = titles[page] || page;
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const response = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/dashboard?tenant_id=${encodeURIComponent(tenantId)}`);
                const data = response.data;

                renderDashboard(data);
                renderVisitsPage(data);
                await renderCustomersPage();
                renderTargetsPage(data);

                await loadRecentExpenses();
                await flushOfflineQueue();

                // Initialize enhanced dashboard features (charts, maps, AI)
                await initDashboardFeatures();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function renderVisitsPage(data) {
            // Update stats
            const month = data.month_stats || {};
            document.getElementById('visitsTotal').textContent = month.total_visits || 0;
            document.getElementById('visitsCompleted').textContent = month.completed_visits || 0;
            document.getElementById('visitsPending').textContent = (data.pending_visits || []).length;

            // Load all visits
            loadAllVisits();
        }

        async function loadAllVisits() {
            try {
                const response = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/visits?tenant_id=${encodeURIComponent(tenantId)}&limit=50`);
                const visits = response.data || [];

                const tbody = document.getElementById('visitsTableBody');
                if (visits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-calendar-check"></i><h3>No visits found</h3><p>Start by scheduling your first visit!</p></div></td></tr>';
                    return;
                }

                tbody.innerHTML = visits.map(visit => {
                    const duration = visit.checkout_time && visit.checkin_time 
                        ? Math.round((new Date(visit.checkout_time) - new Date(visit.checkin_time)) / 60000) + ' mins'
                        : '-';
                    
                    let statusBadge = 'badge-warning';
                    if (visit.status === 'completed') statusBadge = 'badge-success';
                    else if (visit.status === 'cancelled') statusBadge = 'badge-danger';

                    return `
                        <tr>
                            <td>${new Date(visit.created_at).toLocaleDateString()}</td>
                            <td><strong>${visit.customer_name || 'Unknown'}</strong></td>
                            <td>${visit.visit_type || 'Regular'}</td>
                            <td>${duration}</td>
                            <td><span class="badge ${statusBadge}">${visit.status || 'Pending'}</span></td>
                            <td><button class="btn btn-outline" style="padding: 6px 12px; font-size: 12px;" onclick="viewVisit('${visit.id}')">View</button></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading visits:', error);
            }
        }

        async function renderCustomersPage() {
            try {
                const response = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/customers?tenant_id=${encodeURIComponent(tenantId)}&limit=200`);
                const customers = response.data || [];

                // Update stats
                document.getElementById('customersTotal').textContent = customers.length;
                document.getElementById('customersActive').textContent = customers.filter(c => c.status === 'active').length;
                document.getElementById('customersFollowup').textContent = customers.filter(c => c.status === 'inactive').length;

                // Render table
                const tbody = document.getElementById('customersTableBody');
                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-users"></i><h3>No customers found</h3><p>Add your first customer to get started!</p></div></td></tr>';
                    return;
                }

                tbody.innerHTML = customers.map(customer => {
                    const lastVisit = customer.last_visit_date 
                        ? new Date(customer.last_visit_date).toLocaleDateString()
                        : 'Never';

                    return `
                        <tr>
                            <td><strong>${customer.name}</strong></td>
                            <td>${customer.phone || '-'}</td>
                            <td>${customer.location || '-'}</td>
                            <td>${lastVisit}</td>
                            <td>${customer.total_orders || 0}</td>
                            <td>
                                <button class="btn btn-outline" style="padding: 6px 12px; font-size: 12px;" onclick="viewCustomer('${customer.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Add search functionality
                document.getElementById('customerSearch').addEventListener('input', function(e) {
                    const search = e.target.value.toLowerCase();
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(search) ? '' : 'none';
                    });
                });
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function renderTargetsPage(data) {
            const month = data.month_stats || {};
            const target = month.target_value || 0;
            const achieved = month.achieved_value || 0;
            const remaining = target - achieved;
            const percent = target > 0 ? Math.round((achieved / target) * 100) : 0;

            document.getElementById('targetAmount').textContent = '‚Çπ' + target.toLocaleString();
            document.getElementById('achievedAmount').textContent = '‚Çπ' + achieved.toLocaleString();
            document.getElementById('remainingAmount').textContent = '‚Çπ' + remaining.toLocaleString();
            document.getElementById('achievementPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = Math.min(percent, 100) + '%';

            // Calculate daily target
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const remainingDays = daysInMonth - today.getDate() + 1;
            const dailyTarget = remainingDays > 0 ? Math.round(remaining / remainingDays) : 0;
            document.getElementById('dailyTarget').textContent = '‚Çπ' + dailyTarget.toLocaleString() + ' per day (' + remainingDays + ' days left)';

            // Load target history
            loadTargetHistory();
        }

        async function loadTargetHistory() {
            try {
                const response = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/targets?tenant_id=${encodeURIComponent(tenantId)}&limit=6`);
                const targets = response.data || [];

                const tbody = document.getElementById('targetHistoryBody');
                if (targets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-bullseye"></i><p>No target history available</p></div></td></tr>';
                    return;
                }

                tbody.innerHTML = targets.map(target => {
                    const achieved = target.achieved_value || 0;
                    const targetVal = target.target_value || 0;
                    const percent = targetVal > 0 ? Math.round((achieved / targetVal) * 100) : 0;
                    const statusBadge = percent >= 100 ? 'badge-success' : percent >= 75 ? 'badge-info' : 'badge-warning';
                    const statusText = percent >= 100 ? 'Achieved' : percent >= 75 ? 'Good' : 'In Progress';

                    return `
                        <tr>
                            <td>${target.target_month || '-'}</td>
                            <td>‚Çπ${targetVal.toLocaleString()}</td>
                            <td>‚Çπ${achieved.toLocaleString()}</td>
                            <td>${percent}%</td>
                            <td><span class="badge ${statusBadge}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading target history:', error);
            }
        }

        async function submitExpense(event) {
            event.preventDefault();

            const form = event.target;
            const dateInput = form.querySelector('input[type="date"]');
            const typeSelect = form.querySelector('select');
            const amountInput = form.querySelector('input[type="number"]');
            const descTextarea = form.querySelector('textarea');

            const expense = {
                expense_date: dateInput?.value,
                expense_type: typeSelect?.value,
                amount: amountInput?.value,
                description: descTextarea?.value
            };

            if (!expense.expense_date || !expense.expense_type || !expense.amount) {
                alert('Please fill date, type, and amount.');
                return;
            }

            // If offline, enqueue
            const change = {
                entity_type: 'expense',
                action: 'create',
                data: expense,
                client_id: (crypto?.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)) + '-' + Date.now(),
                client_timestamp: new Date().toISOString()
            };

            try {
                if (!navigator.onLine) {
                    const count = enqueueOfflineChange(change);
                    alert(`Saved offline. Will sync when online. Pending: ${count}`);
                    form.reset();
                    return;
                }

                await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/expenses?tenant_id=${encodeURIComponent(tenantId)}`, {
                    method: 'POST',
                    body: JSON.stringify({ tenant_id: tenantId, ...expense })
                });

                alert('Expense submitted successfully!');
                form.reset();
                await loadRecentExpenses();
            } catch (e) {
                // If server fails, fall back to offline queue
                const count = enqueueOfflineChange(change);
                alert(`Could not submit now. Saved offline to retry. Pending: ${count}`);
            }
        }

        async function loadRecentExpenses() {
            try {
                const resp = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/expenses?tenant_id=${encodeURIComponent(tenantId)}&limit=10`);
                const expenses = resp.data || [];

                const totalEl = document.getElementById('expensesTotal');
                const pendingEl = document.getElementById('expensesPending');
                const approvedEl = document.getElementById('expensesApproved');
                
                if (totalEl) totalEl.textContent = '‚Çπ' + expenses.reduce((s, e) => s + Number(e.amount || 0), 0).toLocaleString();
                if (pendingEl) pendingEl.textContent = expenses.filter(e => (e.status || '').toLowerCase() === 'pending').length;
                if (approvedEl) approvedEl.textContent = expenses.filter(e => (e.status || '').toLowerCase() === 'approved').length;

                const tbody = document.getElementById('expensesTableBody');
                if (!tbody) return;

                if (!expenses.length) {
                    tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-receipt"></i><p>No expenses yet</p></div></td></tr>';
                    return;
                }

                tbody.innerHTML = expenses.map(e => `
                    <tr>
                        <td>${new Date(e.expense_date).toLocaleDateString()}</td>
                        <td>${e.expense_type}</td>
                        <td>‚Çπ${Number(e.amount || 0).toLocaleString()}</td>
                        <td>${e.status || 'pending'}</td>
                        <td>${e.description || '-'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.warn('Failed to load expenses:', e.message);
            }
        }

        function viewVisit(id) {
            alert('Visit details coming soon! ID: ' + id);
        }

        function viewCustomer(id) {
            alert('Customer details coming soon! ID: ' + id);
        }

        function renderDashboard(data) {
            const today = data.today_stats || {};
            const month = data.month_stats || {};
            const commission = data.commission_stats || {};

            // Update stats
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Today's Visits</span>
                        <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                    </div>
                    <div class="stat-value">${today.total_visits || 0}</div>
                    <div class="stat-subtext">${today.completed_visits || 0} completed</div>
                </div>

                <div class="stat-card success">
                    <div class="stat-header">
                        <span class="stat-label">Today's Orders</span>
                        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                    </div>
                    <div class="stat-value">${today.total_orders || 0}</div>
                    <div class="stat-subtext">‚Çπ${(today.total_value || 0).toLocaleString()}</div>
                </div>

                <div class="stat-card warning">
                    <div class="stat-header">
                        <span class="stat-label">Target Achievement</span>
                        <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                    </div>
                    <div class="stat-value">${month.target_achievement_percent || 0}%</div>
                    <div class="stat-subtext">‚Çπ${(month.achieved_value || 0).toLocaleString()} / ‚Çπ${(month.target_value || 0).toLocaleString()}</div>
                </div>

                <div class="stat-card info">
                    <div class="stat-header">
                        <span class="stat-label">Commission Pending</span>
                        <div class="stat-icon"><i class="fas fa-coins"></i></div>
                    </div>
                    <div class="stat-value">‚Çπ${(commission.pending_amount || 0).toLocaleString()}</div>
                    <div class="stat-subtext">${commission.pending_count || 0} orders</div>
                </div>
            `;

            // Update visits table
            const tbody = document.querySelector('#todayVisitsTable tbody');
            const visits = data.pending_visits || [];

            if (visits.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5">
                        <div class="empty-state">
                            <i class="fas fa-calendar-check"></i>
                            <h3>No visits scheduled</h3>
                            <p>You're all caught up for today!</p>
                        </div>
                    </td></tr>
                `;
            } else {
                tbody.innerHTML = visits.map(visit => `
                    <tr>
                        <td><strong>${visit.customer_name || 'Unknown'}</strong></td>
                        <td>${new Date(visit.scheduled_time || visit.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</td>
                        <td>${visit.visit_type || 'Regular'}</td>
                        <td><span class="badge badge-warning">${visit.status || 'Pending'}</span></td>
                        <td>
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">
                                <i class="fas fa-check"></i> Check In
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function refreshData() {
            loadDashboard();
        }

        let selectedProductsList = new Set();
        let allProducts = [
            'Hex Bolts', 'Carriage Bolts', 'U-Bolts', 'Eye Bolts', 'Anchor Bolts',
            'Hex Nuts', 'Lock Nuts', 'Wing Nuts', 'Cap Nuts', 'Flange Nuts',
            'Flat Washers', 'Spring Washers', 'Lock Washers', 'Fender Washers',
            'Wood Screws', 'Machine Screws', 'Self-Tapping Screws', 'Sheet Metal Screws', 'Drywall Screws',
            'Expansion Anchors', 'Wedge Anchors', 'Drop-In Anchors', 'Sleeve Anchors',
            'Threaded Rods', 'Studs', 'Dowel Pins', 'Cotter Pins', 'Clevis Pins',
            'Rivets', 'Clamps', 'Brackets', 'Hinges', 'Latches'
        ];

        function showProductDropdown() {
            const dropdown = document.getElementById('productDropdown');
            dropdown.style.display = 'block';
            filterProducts();
        }

        function hideProductDropdown() {
            setTimeout(() => {
                document.getElementById('productDropdown').style.display = 'none';
            }, 200);
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const dropdown = document.getElementById('productDropdown');
            
            const filtered = allProducts.filter(p => 
                p.toLowerCase().includes(searchTerm) && !selectedProductsList.has(p)
            );
            
            dropdown.innerHTML = filtered.map(product => `
                <div class="product-dropdown-item" onclick="toggleProduct('${product}', this)">
                    <input type="checkbox" ${selectedProductsList.has(product) ? 'checked' : ''}>
                    <span>${product}</span>
                </div>
            `).join('');
        }

        function toggleProduct(product, element) {
            if (selectedProductsList.has(product)) {
                selectedProductsList.delete(product);
            } else {
                selectedProductsList.add(product);
            }
            updateSelectedProducts();
            filterProducts();
        }

        function removeProduct(product) {
            selectedProductsList.delete(product);
            updateSelectedProducts();
            filterProducts();
        }

        function updateSelectedProducts() {
            const container = document.getElementById('selectedProducts');
            container.innerHTML = Array.from(selectedProductsList).map(product => `
                <span class="selected-product-tag">
                    ${product}
                    <button onclick="removeProduct('${product}')" type="button">√ó</button>
                </span>
            `).join('');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const searchBox = document.getElementById('productSearch');
            const dropdown = document.getElementById('productDropdown');
            if (searchBox && !searchBox.contains(e.target) && !dropdown.contains(e.target)) {
                hideProductDropdown();
            }
        });

        async function newVisit() {
            // Load customers and plants
            try {
                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/customers?tenant_id=${encodeURIComponent(tenantId)}`);
                if (!data.success) throw new Error(data.error);
                
                const customers = data.data || [];
                const customerList = document.getElementById('customerList');
                customerList.innerHTML = customers.map(c => `<option value="${c.business_name || c.name}">`).join('');
                
                // Load plants/branches
                const plantsResp = await apiFetch(`/api/fsm/plants?tenant_id=${encodeURIComponent(tenantId)}`);
                if (plantsResp.success && plantsResp.data) {
                    const plantsContainer = document.getElementById('plants');
                    plantsContainer.innerHTML = plantsResp.data.map(p => 
                        `<div class="checkbox-item" data-value="${p.id}">${p.name || p.plant_name}</div>`
                    ).join('');
                }
                
                // Setup interactive elements
                setupCheckboxGroups();
                setupCompetitorField();
                startVisitTimer();
                
                // Clear previous selections
                selectedProductsList.clear();
                updateSelectedProducts();
                document.getElementById('productSearch').value = '';
                
                // Show modal
                document.getElementById('newVisitModal').style.display = 'block';
            } catch (error) {
                alert('Error loading customers: ' + error.message);
            }
        }

        function toggleVisitType(type) {
            // Update radio selection
            document.querySelectorAll('#newVisitForm .radio-item[data-value="now"], #newVisitForm .radio-item[data-value="later"]').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.classList.add('selected');

            const scheduledSection = document.getElementById('scheduledDateTime');
            const timerSection = document.getElementById('visitTimer');
            const scheduledDateInput = document.getElementById('scheduledDate');
            const scheduledTimeInput = document.getElementById('scheduledTime');

            if (type === 'later') {
                // Show scheduled date/time fields
                scheduledSection.style.display = 'block';
                scheduledDateInput.required = true;
                
                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                scheduledDateInput.min = today;
                
                // Set default to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                scheduledDateInput.value = tomorrow.toISOString().split('T')[0];
                
                // Hide/stop timer
                if (timerSection) timerSection.style.display = 'none';
                if (visitTimerInterval) {
                    clearInterval(visitTimerInterval);
                    visitTimerInterval = null;
                }
            } else {
                // Hide scheduled fields
                scheduledSection.style.display = 'none';
                scheduledDateInput.required = false;
                scheduledDateInput.value = '';
                scheduledTimeInput.value = '';
                
                // Show/start timer
                if (timerSection) timerSection.style.display = 'block';
                startVisitTimer();
            }
        }

        let visitTimerInterval = null;
        let visitStartTime = null;

        function startVisitTimer() {
            visitStartTime = new Date();
            const timeDisplay = visitStartTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('visitTimer').textContent = `‚è±Ô∏è Visit started at ${timeDisplay}`;
            
            if (visitTimerInterval) clearInterval(visitTimerInterval);
            visitTimerInterval = setInterval(() => {
                const mins = Math.floor((Date.now() - visitStartTime) / 60000);
                document.getElementById('visitTimer').textContent = `‚è±Ô∏è Visit duration: ${mins} min${mins !== 1 ? 's' : ''}`;
            }, 60000);
        }

        function setupCheckboxGroups() {
            // Multi-select checkboxes (meeting types, next actions, plants)
            document.querySelectorAll('#meetingTypes .checkbox-item, #nextActions .checkbox-item, #plants .checkbox-item').forEach(item => {
                item.addEventListener('click', function() {
                    this.classList.toggle('selected');
                });
            });

            // Single-select radio buttons
            document.querySelectorAll('#potential .radio-item').forEach(item => {
                item.addEventListener('click', function() {
                    this.parentElement.querySelectorAll('.radio-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            document.querySelectorAll('#switchableGroup .radio-item').forEach(item => {
                item.addEventListener('click', function() {
                    this.parentElement.querySelectorAll('.radio-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }

        function setupCompetitorField() {
            document.getElementById('competitorName').addEventListener('input', function() {
                const group = document.getElementById('switchableGroup');
                if (this.value.trim()) {
                    group.style.display = 'block';
                } else {
                    group.style.display = 'none';
                }
            });
        }

        function closeNewVisitModal() {
            document.getElementById('newVisitModal').style.display = 'none';
            document.getElementById('newVisitForm').reset();
            document.querySelectorAll('.checkbox-item, .radio-item').forEach(i => i.classList.remove('selected'));
            document.getElementById('potential').querySelector('[data-value="Low"]').classList.add('selected');
            selectedProductsList.clear();
            updateSelectedProducts();
            if (visitTimerInterval) clearInterval(visitTimerInterval);
        }

        async function submitNewVisit() {
            const visitType = document.querySelector('#newVisitForm .radio-item.selected[data-value]')?.dataset.value || 'now';
            const customerName = document.getElementById('newVisitCustomer').value.trim();
            const contactPerson = document.getElementById('newVisitContact').value.trim();
            const email = document.getElementById('newVisitEmail').value.trim();
            const meetingTypes = Array.from(document.querySelectorAll('#meetingTypes .checkbox-item.selected')).map(i => i.dataset.value);
            const products = Array.from(selectedProductsList);
            const plantIds = Array.from(document.querySelectorAll('#plants .checkbox-item.selected')).map(i => i.dataset.value);
            const nextAction = document.querySelector('#nextActions .checkbox-item.selected')?.dataset.value;
            const nextActionDate = document.getElementById('nextActionDate').value;
            const potential = document.querySelector('#potential .radio-item.selected').dataset.value;
            const competitorName = document.getElementById('competitorName').value.trim();
            const canBeSwitched = document.querySelector('#switchableGroup .radio-item.selected')?.dataset.value === 'yes';
            const remarks = document.getElementById('remarks').value.trim();
            
            // Get scheduled date/time if scheduling for later
            const scheduledDate = document.getElementById('scheduledDate').value;
            const scheduledTime = document.getElementById('scheduledTime').value;

            if (!customerName) {
                alert('Please enter customer name');
                return;
            }
            if (meetingTypes.length === 0) {
                alert('Please select at least one meeting type');
                return;
            }
            if (visitType === 'later' && !scheduledDate) {
                alert('Please select a date for the scheduled visit');
                return;
            }

            const submitBtn = document.getElementById('submitVisitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'üì§ Submitting...';

            try {
                let visitDateTime;
                let isScheduled = visitType === 'later';
                
                if (isScheduled) {
                    // Scheduled visit
                    visitDateTime = scheduledTime ? `${scheduledDate}T${scheduledTime}:00` : `${scheduledDate}T09:00:00`;
                } else {
                    // Immediate visit
                    visitDateTime = visitStartTime.toISOString();
                }

                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/visits?tenant_id=${encodeURIComponent(tenantId)}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        customer_name: customerName,
                        contact_person: contactPerson,
                        email: email,
                        plant_ids: plantIds,
                        meeting_types: meetingTypes,
                        products_discussed: products,
                        next_action: nextAction,
                        next_action_date: nextActionDate,
                        potential: potential,
                        competitor_name: competitorName,
                        can_be_switched: canBeSwitched,
                        remarks: remarks,
                        time_in: visitDateTime,
                        visit_date: isScheduled ? scheduledDate : new Date().toISOString().split('T')[0],
                        scheduled_time: isScheduled ? visitDateTime : null,
                        is_scheduled: isScheduled,
                        gps_latitude: 0,
                        gps_longitude: 0
                    })
                });

                if (!data.success) throw new Error(data.error);

                alert(isScheduled ? '‚úÖ Visit scheduled successfully!' : '‚úÖ Visit submitted successfully!');
                closeNewVisitModal();
                loadDashboard();
            } catch (error) {
                alert('Error creating visit: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'üìç Submit Visit';
            }
        }

        // ========== ENHANCED DASHBOARD FEATURES ==========
        
        let performanceChart = null;
        let bestTimeChart = null;
        let territoryMap = null;
        let heatLayer = null;

        // Initialize all dashboard features
        async function initDashboardFeatures() {
            try {
                await Promise.all([
                    loadPerformanceChart(),
                    loadLeaderboard(),
                    loadAIRecommendations(),
                    loadSmartAlerts(),
                    loadConversionFunnel(),
                    loadCrossSellOpportunities(),
                    loadBestTimeChart(),
                    initTerritoryMap()
                ]);
            } catch (error) {
                console.error('Dashboard features error:', error);
            }
        }

        // Performance Trend Chart
        async function loadPerformanceChart() {
            try {
                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/analytics/performance?tenant_id=${encodeURIComponent(tenantId)}&days=7`);
                
                const ctx = document.getElementById('performanceChart')?.getContext('2d');
                if (!ctx) return;

                if (performanceChart) performanceChart.destroy();

                const labels = data.data?.dates || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const visits = data.data?.visits || [3, 5, 4, 6, 4, 2, 0];
                const orders = data.data?.orders || [1, 2, 1, 3, 2, 1, 0];

                performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Visits',
                                data: visits,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Orders',
                                data: orders,
                                borderColor: '#48bb78',
                                backgroundColor: 'rgba(72, 187, 120, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('Performance chart error:', error);
                // Show sample data on error
                loadSamplePerformanceChart();
            }
        }

        function loadSamplePerformanceChart() {
            const ctx = document.getElementById('performanceChart')?.getContext('2d');
            if (!ctx) return;

            if (performanceChart) performanceChart.destroy();

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [
                        {
                            label: 'Visits',
                            data: [3, 5, 4, 6, 4, 2, 0],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Orders',
                            data: [1, 2, 1, 3, 2, 1, 0],
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Live Leaderboard
        async function loadLeaderboard() {
            const container = document.getElementById('leaderboard');
            if (!container) return;

            try {
                const data = await apiFetch(`/api/fsm/analytics/leaderboard?tenant_id=${encodeURIComponent(tenantId)}`);
                
                const salesmen = data.data || [];
                
                if (salesmen.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #718096;">
                            <i class="fas fa-users" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <p>No leaderboard data yet</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                salesmen.forEach((s, idx) => {
                    const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`;
                    const isMe = s.id === salesmanId;
                    const bgColor = isMe ? '#667eea15' : (idx % 2 === 0 ? '#f8fafc' : 'white');
                    
                    html += `
                        <div style="display: flex; align-items: center; padding: 12px 16px; background: ${bgColor}; border-bottom: 1px solid #e2e8f0; ${isMe ? 'border-left: 4px solid #667eea;' : ''}">
                            <span style="font-size: 20px; width: 40px;">${medal}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748;">${s.name} ${isMe ? '(You)' : ''}</div>
                                <div style="font-size: 12px; color: #718096;">${s.visits || 0} visits ‚Ä¢ ${s.orders || 0} orders</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: #48bb78;">‚Çπ${(s.revenue || 0).toLocaleString()}</div>
                                <div style="font-size: 11px; color: #718096;">${s.conversion || 0}% conv.</div>
                            </div>
                        </div>
                    `;

                    // Update my rank
                    if (isMe) {
                        const myRankEl = document.getElementById('myRank');
                        const rankChangeEl = document.getElementById('rankChange');
                        if (myRankEl) myRankEl.textContent = `#${idx + 1}`;
                        if (rankChangeEl) rankChangeEl.textContent = idx < 3 ? 'üî• Top 3!' : 'Keep pushing!';
                    }
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('Leaderboard error:', error);
                loadSampleLeaderboard();
            }
        }

        function loadSampleLeaderboard() {
            const container = document.getElementById('leaderboard');
            if (!container) return;

            const sampleData = [
                { name: 'Ahmed Khan', visits: 45, orders: 28, revenue: 185000, conversion: 62 },
                { name: 'You', visits: 38, orders: 22, revenue: 156000, conversion: 58, isMe: true },
                { name: 'Raj Patel', visits: 35, orders: 20, revenue: 142000, conversion: 57 },
                { name: 'Priya Sharma', visits: 32, orders: 18, revenue: 125000, conversion: 56 },
                { name: 'Ali Hassan', visits: 28, orders: 15, revenue: 98000, conversion: 54 }
            ];

            let html = '';
            sampleData.forEach((s, idx) => {
                const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`;
                const bgColor = s.isMe ? '#667eea15' : (idx % 2 === 0 ? '#f8fafc' : 'white');
                
                html += `
                    <div style="display: flex; align-items: center; padding: 12px 16px; background: ${bgColor}; border-bottom: 1px solid #e2e8f0; ${s.isMe ? 'border-left: 4px solid #667eea;' : ''}">
                        <span style="font-size: 20px; width: 40px;">${medal}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2d3748;">${s.name}</div>
                            <div style="font-size: 12px; color: #718096;">${s.visits} visits ‚Ä¢ ${s.orders} orders</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: #48bb78;">‚Çπ${s.revenue.toLocaleString()}</div>
                            <div style="font-size: 11px; color: #718096;">${s.conversion}% conv.</div>
                        </div>
                    </div>
                `;

                if (s.isMe) {
                    const myRankEl = document.getElementById('myRank');
                    const rankChangeEl = document.getElementById('rankChange');
                    if (myRankEl) myRankEl.textContent = `#${idx + 1}`;
                    if (rankChangeEl) rankChangeEl.textContent = 'üî• Top 3!';
                }
            });

            container.innerHTML = html;
        }

        // AI Visit Recommendations
        async function loadAIRecommendations() {
            const container = document.getElementById('aiRecommendations');
            if (!container) return;

            try {
                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/ai/recommendations?tenant_id=${encodeURIComponent(tenantId)}`);
                
                const recommendations = data.data || [];
                
                if (recommendations.length === 0) {
                    loadSampleRecommendations();
                    return;
                }

                renderRecommendations(recommendations);
            } catch (error) {
                console.error('AI recommendations error:', error);
                loadSampleRecommendations();
            }
        }

        function loadSampleRecommendations() {
            const recommendations = [
                { customer: 'Fairdeal corporation', reason: 'High potential - not visited in 15 days', score: 95, potential: 'High', bestTime: '10:00 AM' },
                { customer: 'Sachira industries', reason: 'Frequent buyer - order due soon', score: 88, potential: 'High', bestTime: '2:00 PM' },
                { customer: 'Jayant impex', reason: 'Follow-up scheduled today', score: 82, potential: 'Medium', bestTime: '11:30 AM' }
            ];
            renderRecommendations(recommendations);
        }

        function renderRecommendations(recommendations) {
            const container = document.getElementById('aiRecommendations');
            if (!container) return;

            let html = '';
            recommendations.slice(0, 3).forEach((rec, idx) => {
                const scoreColor = rec.score >= 90 ? '#48bb78' : rec.score >= 70 ? '#f6ad55' : '#718096';
                html += `
                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; margin-right: 12px;">
                            ${idx + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2d3748;">${rec.customer}</div>
                            <div style="font-size: 12px; color: #718096;">${rec.reason}</div>
                            <div style="font-size: 11px; color: #667eea; margin-top: 4px;">‚è∞ Best time: ${rec.bestTime}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: ${scoreColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${rec.score}% match
                            </div>
                            <button onclick="quickVisit('${rec.customer}')" style="margin-top: 6px; padding: 4px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                Visit Now
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function refreshAIRecommendations() {
            loadAIRecommendations();
        }

        function quickVisit(customerName) {
            newVisit();
            setTimeout(() => {
                document.getElementById('newVisitCustomer').value = customerName;
            }, 500);
        }

        // Smart Alerts
        async function loadSmartAlerts() {
            const container = document.getElementById('smartAlerts');
            const countBadge = document.getElementById('alertCount');
            if (!container) return;

            try {
                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/ai/alerts?tenant_id=${encodeURIComponent(tenantId)}`);
                
                const alerts = data.data || [];
                
                if (alerts.length === 0) {
                    loadSampleAlerts();
                    return;
                }

                renderAlerts(alerts);
            } catch (error) {
                console.error('Smart alerts error:', error);
                loadSampleAlerts();
            }
        }

        function loadSampleAlerts() {
            const alerts = [
                { type: 'warning', icon: 'exclamation-triangle', message: 'Hydrolift crane has not ordered in 25 days', action: 'Visit Now', customer: 'Hydrolift crane' },
                { type: 'danger', icon: 'arrow-down', message: 'Hawa valve order value dropped 40%', action: 'Review', customer: 'Hawa valve' },
                { type: 'info', icon: 'calendar', message: 'Follow-up due: Redical steel industries (scheduled yesterday)', action: 'Call', customer: 'Redical steel industries' }
            ];
            renderAlerts(alerts);
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('smartAlerts');
            const countBadge = document.getElementById('alertCount');
            if (!container) return;

            if (countBadge) countBadge.textContent = alerts.length;

            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <i class="fas fa-check-circle fa-2x" style="color: #48bb78; margin-bottom: 10px;"></i>
                        <p>No alerts - great job!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            alerts.forEach(alert => {
                const colors = {
                    warning: { bg: '#fef3cd', border: '#f6ad55', icon: '#f6ad55' },
                    danger: { bg: '#fed7d7', border: '#f56565', icon: '#f56565' },
                    info: { bg: '#bee3f8', border: '#4fd1c5', icon: '#4fd1c5' }
                };
                const c = colors[alert.type] || colors.info;

                html += `
                    <div style="display: flex; align-items: center; padding: 10px; background: ${c.bg}; border-left: 4px solid ${c.border}; border-radius: 4px; margin-bottom: 8px;">
                        <i class="fas fa-${alert.icon}" style="color: ${c.icon}; margin-right: 10px;"></i>
                        <div style="flex: 1; font-size: 13px; color: #2d3748;">${alert.message}</div>
                        <button onclick="quickVisit('${alert.customer}')" style="padding: 4px 10px; background: ${c.border}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            ${alert.action}
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Conversion Funnel
        async function loadConversionFunnel() {
            try {
                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/analytics/funnel?tenant_id=${encodeURIComponent(tenantId)}`);
                
                document.getElementById('funnelVisits').textContent = data.data?.visits || 38;
                document.getElementById('funnelEngaged').textContent = data.data?.engaged || 28;
                document.getElementById('funnelQuoted').textContent = data.data?.quoted || 18;
                document.getElementById('funnelOrders').textContent = data.data?.orders || 12;
            } catch (error) {
                // Use sample data
                document.getElementById('funnelVisits').textContent = '38';
                document.getElementById('funnelEngaged').textContent = '28';
                document.getElementById('funnelQuoted').textContent = '18';
                document.getElementById('funnelOrders').textContent = '12';
            }
        }

        // Cross-sell Opportunities
        async function loadCrossSellOpportunities() {
            const container = document.getElementById('crossSellList');
            if (!container) return;

            try {
                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/ai/cross-sell?tenant_id=${encodeURIComponent(tenantId)}`);
                
                const opportunities = data.data || [];
                
                if (opportunities.length === 0) {
                    loadSampleCrossSell();
                    return;
                }

                renderCrossSell(opportunities);
            } catch (error) {
                console.error('Cross-sell error:', error);
                loadSampleCrossSell();
            }
        }

        function loadSampleCrossSell() {
            const opportunities = [
                { customer: 'Mamta interiors', currentProduct: 'Hex Bolts', suggestedProduct: 'Lock Nuts', reason: '85% of Hex Bolt buyers also buy Lock Nuts', potential: '‚Çπ15,000' },
                { customer: 'Om Kitchen and Railings', currentProduct: 'Washers', suggestedProduct: 'Spring Washers', reason: 'Complementary product', potential: '‚Çπ8,500' },
                { customer: 'Sawariya Interiors', currentProduct: 'Anchors', suggestedProduct: 'Expansion Anchors', reason: 'Upgrade opportunity', potential: '‚Çπ22,000' }
            ];
            renderCrossSell(opportunities);
        }

        function renderCrossSell(opportunities) {
            const container = document.getElementById('crossSellList');
            if (!container) return;

            let html = '';
            opportunities.slice(0, 3).forEach(opp => {
                html += `
                    <div style="padding: 10px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; color: #2d3748; font-size: 13px;">${opp.customer}</div>
                                <div style="font-size: 11px; color: #718096; margin-top: 2px;">
                                    ${opp.currentProduct} ‚Üí <span style="color: #667eea; font-weight: 600;">${opp.suggestedProduct}</span>
                                </div>
                            </div>
                            <div style="background: #48bb78; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">
                                ${opp.potential}
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #718096; margin-top: 4px; font-style: italic;">üí° ${opp.reason}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Best Time to Visit Heatmap
        async function loadBestTimeChart() {
            const ctx = document.getElementById('bestTimeHeatmap')?.getContext('2d');
            if (!ctx) return;

            try {
                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/ai/best-times?tenant_id=${encodeURIComponent(tenantId)}`);
                renderBestTimeChart(ctx, data.data);
            } catch (error) {
                // Sample data
                const sampleData = {
                    labels: ['9 AM', '10 AM', '11 AM', '12 PM', '2 PM', '3 PM', '4 PM', '5 PM'],
                    conversions: [45, 72, 85, 55, 78, 82, 65, 40]
                };
                renderBestTimeChart(ctx, sampleData);
            }
        }

        function renderBestTimeChart(ctx, data) {
            if (bestTimeChart) bestTimeChart.destroy();

            const labels = data?.labels || ['9 AM', '10 AM', '11 AM', '12 PM', '2 PM', '3 PM', '4 PM', '5 PM'];
            const conversions = data?.conversions || [45, 72, 85, 55, 78, 82, 65, 40];

            bestTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversion Rate %',
                        data: conversions,
                        backgroundColor: conversions.map(v => 
                            v >= 80 ? '#48bb78' : v >= 60 ? '#f6ad55' : '#e2e8f0'
                        ),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.parsed.y}% conversion`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });
        }

        // Territory Heat Map
        async function initTerritoryMap() {
            const mapContainer = document.getElementById('territoryMap');
            if (!mapContainer) return;

            try {
                // Initialize map centered on India
                territoryMap = L.map('territoryMap').setView([20.5937, 78.9629], 5);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(territoryMap);

                // Load customer locations
                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/customers/locations?tenant_id=${encodeURIComponent(tenantId)}`);
                
                const locations = data.data || [];
                
                if (locations.length > 0) {
                    updateHeatMapWithData(locations);
                } else {
                    loadSampleHeatMap();
                }
            } catch (error) {
                console.error('Map error:', error);
                loadSampleHeatMap();
            }
        }

        function loadSampleHeatMap() {
            if (!territoryMap) return;

            // Sample customer locations in India
            const sampleLocations = [
                [19.0760, 72.8777, 0.8], // Mumbai
                [28.6139, 77.2090, 0.6], // Delhi
                [12.9716, 77.5946, 0.7], // Bangalore
                [17.3850, 78.4867, 0.5], // Hyderabad
                [13.0827, 80.2707, 0.4], // Chennai
                [22.5726, 88.3639, 0.3], // Kolkata
                [18.5204, 73.8567, 0.6], // Pune
                [23.0225, 72.5714, 0.5], // Ahmedabad
            ];

            if (heatLayer) territoryMap.removeLayer(heatLayer);
            
            heatLayer = L.heatLayer(sampleLocations, {
                radius: 25,
                blur: 15,
                maxZoom: 10,
                gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}
            }).addTo(territoryMap);

            // Add markers
            sampleLocations.forEach((loc, idx) => {
                L.circleMarker([loc[0], loc[1]], {
                    radius: 8,
                    fillColor: '#667eea',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.8
                }).bindPopup(`Customer ${idx + 1}`).addTo(territoryMap);
            });
        }

        function updateHeatMapWithData(locations) {
            if (!territoryMap) return;

            const heatData = locations.map(loc => [
                loc.latitude || loc.lat,
                loc.longitude || loc.lng,
                loc.intensity || 0.5
            ]).filter(loc => loc[0] && loc[1]);

            if (heatData.length === 0) {
                loadSampleHeatMap();
                return;
            }

            if (heatLayer) territoryMap.removeLayer(heatLayer);
            
            heatLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 10,
                gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'}
            }).addTo(territoryMap);

            // Center map on data
            if (heatData.length > 0) {
                const bounds = L.latLngBounds(heatData.map(d => [d[0], d[1]]));
                territoryMap.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        function updateHeatMap() {
            const filter = document.getElementById('mapFilter').value;
            // In real implementation, reload with different data based on filter
            console.log('Map filter:', filter);
        }

        // AI Auto-Scheduler
        async function aiAutoSchedule() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Planning...';

            try {
                const data = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/ai/auto-schedule?tenant_id=${encodeURIComponent(tenantId)}`, {
                    method: 'POST'
                });

                if (data.success && data.schedule) {
                    alert(`‚úÖ AI has planned your day!\n\n${data.schedule.length} visits scheduled:\n\n` + 
                        data.schedule.map((v, i) => `${i+1}. ${v.time} - ${v.customer}`).join('\n'));
                    loadDashboard();
                } else {
                    showSampleSchedule();
                }
            } catch (error) {
                console.error('Auto-schedule error:', error);
                showSampleSchedule();
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> AI Auto-Plan My Day';
        }

        function showSampleSchedule() {
            alert(`ü§ñ AI-Planned Schedule:\n\n` +
                `1. 9:30 AM - Fairdeal corporation (High Priority)\n` +
                `2. 11:00 AM - Sachira industries (Follow-up)\n` +
                `3. 12:30 PM - Jayant impex (Order Due)\n` +
                `4. 2:30 PM - Tech Solutions (Demo)\n` +
                `5. 4:00 PM - Metro Fasteners (New Lead)\n\n` +
                `üìç Route optimized for minimum travel time!`);
        }

        // ========== END ENHANCED DASHBOARD FEATURES ==========

        let notificationsTimer = null;

        function toggleNotifications(event) {
            event?.stopPropagation?.();
            const dropdown = document.getElementById('notificationDropdown');
            if (!dropdown) return;
            dropdown.classList.toggle('open');
            if (dropdown.classList.contains('open')) {
                refreshNotifications();
            }
        }

        function closeNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) dropdown.classList.remove('open');
        }

        async function startNotificationsPolling() {
            if (notificationsTimer) clearInterval(notificationsTimer);
            await refreshNotifications();
            notificationsTimer = setInterval(refreshNotifications, 30000);
        }

        async function refreshNotifications() {
            try {
                const resp = await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/notifications?tenant_id=${encodeURIComponent(tenantId)}&limit=20`);
                const notifications = resp.data || [];

                const unread = notifications.filter(n => !n.read_at).length;
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    badge.textContent = unread;
                    badge.style.display = unread ? 'inline-flex' : 'none';
                }

                const list = document.getElementById('notificationList');
                if (!list) return;

                if (!notifications.length) {
                    list.innerHTML = '<div class="empty-state" style="padding:16px;"><i class="fas fa-bell"></i><p>No notifications</p></div>';
                    return;
                }

                list.innerHTML = notifications.map(n => {
                    const created = n.created_at ? new Date(n.created_at).toLocaleString() : '';
                    const isUnread = !n.read_at;
                    const title = n.title || 'Notification';
                    const message = n.message || '';
                    const id = String(n.id ?? '');

                    return `
                        <div class="notification-item ${isUnread ? 'unread' : ''}">
                            <div style="display:flex; gap:10px; align-items:flex-start;">
                                <div style="flex:1;">
                                    <div style="font-weight:600;">${escapeHtml(title)}</div>
                                    <div style="opacity:0.9;">${escapeHtml(message)}</div>
                                    <div style="font-size:12px; opacity:0.7; margin-top:4px;">${escapeHtml(created)}</div>
                                </div>
                                ${isUnread ? `<button class="btn btn-outline" style="padding: 6px 10px; font-size: 12px;" onclick="markNotificationRead('${escapeAttr(id)}')">Mark read</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.warn('Notifications refresh failed:', e.message);
            }
        }

        async function markNotificationRead(notificationId) {
            try {
                await apiFetch(`/api/fsm/salesman/${encodeURIComponent(salesmanId)}/notifications/${encodeURIComponent(notificationId)}/read?tenant_id=${encodeURIComponent(tenantId)}`, {
                    method: 'POST',
                    body: JSON.stringify({ tenant_id: tenantId })
                });
                await refreshNotifications();
            } catch (e) {
                alert('Failed to mark notification read.');
            }
        }

        function escapeHtml(str) {
            return String(str ?? '').replace(/[&<>'"]/g, (c) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[c]));
        }

        function escapeAttr(str) {
            return String(str ?? '')
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r');
        }

        async function logout() {
            try {
                await apiFetch('/api/fsm/salesman/logout', { method: 'POST', body: JSON.stringify({ tenant_id: tenantId }) });
            } catch (e) {
                // ignore
            }

            localStorage.removeItem('salesmanId');
            localStorage.removeItem('salesmanName');
            localStorage.removeItem('loginTime');
            localStorage.removeItem('salesmanToken');
            localStorage.removeItem('salesmanTokenExpiresAt');
            window.location.href = '/salesman-login.html';
        }

        // Load data on startup
        loadDashboard();

        // Notifications
        startNotificationsPolling();

        // Close notifications on outside click
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('notificationDropdown');
            const wrapper = document.querySelector('.notif-wrapper');
            if (!dropdown || !wrapper) return;
            if (!wrapper.contains(e.target)) closeNotifications();
        });

        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
